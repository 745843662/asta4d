<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
   <title>Asta4D Framework User Guide</title><link rel="stylesheet" type="text/css" href="css/manual-singlepage.css"><meta name="generator" content="DocBook XSL Stylesheets V1.78.1"><meta name="keywords" content="java, view first, framework"></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div class="book"><div class="titlepage"><div><div><h1 class="title"><a name="asta4d-user-guide"></a>Asta4D Framework User Guide</h1></div><div><div class="authorgroup"><h2>Authors</h2>
      <span class="author"><span class="firstname">Rui</span> <span class="surname">Liu</span></span>
      , <span class="author"><span class="firstname">Shunsuke</span> <span class="surname">Otani</span></span>	  
    </div></div><div><p class="releaseinfo">Version: 0.14.2.10</p></div><div><p class="pubdate">Last update at: 2014-02-16 01:05</p></div></div><hr></div><div class="toc"><p><b>Table of Contents</b></p><dl class="toc"><dt><span class="part"><a href="#asta4d-introduction">I. Introduction</a></span></dt><dd><dl><dt><span class="chapter"><a href="#chapter-overview">1. Overview</a></span></dt><dd><dl><dt><span class="section"><a href="#d5e26">1.1. Why Asta4D</a></span></dt><dt><span class="section"><a href="#d5e39">1.2. How Asta4D helps us</a></span></dt><dt><span class="section"><a href="#d5e63">1.3. What does the name of "Asta4D" mean</a></span></dt></dl></dd></dl></dd><dt><span class="part"><a href="#asta4d-user-guide">II. User Guide</a></span></dt><dd><dl><dt><span class="chapter"><a href="#chapter-Inheritable-template">2. Flexible template</a></span></dt><dd><dl><dt><span class="section"><a href="#d5e83">2.1. Inheritable template</a></span></dt><dt><span class="section"><a href="#d5e107">2.2. Parametrized embeding</a></span></dt></dl></dd><dt><span class="chapter"><a href="#renderer">3. Renderer: easy to use, secure, testable</a></span></dt><dd><dl><dt><span class="section"><a href="#d5e117">3.1. Split rendering logic from template</a></span></dt><dt><span class="section"><a href="#d5e140">3.2. Render data to page</a></span></dt><dt><span class="section"><a href="#d5e158">3.3. Immune from cross-site hole</a></span></dt><dt><span class="section"><a href="#d5e161">3.4. Test your rendering logic</a></span></dt></dl></dd><dt><span class="chapter"><a href="#url-mapping">4. View first URL mapping and variable injection</a></span></dt><dd><dl><dt><span class="section"><a href="#d5e172">4.1. View first</a></span></dt><dt><span class="section"><a href="#d5e180">4.2. The grammer of URL rule and path variable</a></span></dt><dt><span class="section"><a href="#d5e187">4.3. Variable Injection</a></span></dt></dl></dd><dt><span class="chapter"><a href="#chapter-side-effect">5. Side effect and request handler</a></span></dt><dd><dl><dt><span class="section"><a href="#d5e234">5.1. The role with responsibility to http request: Request Handler</a></span></dt><dt><span class="section"><a href="#d5e239">5.2. Side effect of system operations</a></span></dt><dt><span class="section"><a href="#d5e243">5.3. Isolate side effect and multi thread rendering</a></span></dt><dt><span class="section"><a href="#d5e253">5.4. Compatibility to MVC</a></span></dt></dl></dd><dt><span class="chapter"><a href="#chapter-request-handler">6. Impement request handler and url mapping</a></span></dt><dd><dl><dt><span class="section"><a href="#d5e261">6.1. @RequestHandler</a></span></dt><dt><span class="section"><a href="#d5e267">6.2. delcare url rule for request handler</a></span></dt><dt><span class="section"><a href="#d5e296">6.3. Default request handler</a></span></dt><dt><span class="section"><a href="#d5e310">6.4. Global forward/redirect</a></span></dt></dl></dd></dl></dd><dt><span class="part"><a href="#asta4d-reference">III. Reference</a></span></dt><dd><dl><dt><span class="chapter"><a href="#chapter-detail-template">7. Details of Template</a></span></dt><dd><dl><dt><span class="sect1"><a href="#d5e335">7.1. Supported tags</a></span></dt><dt><span class="sect1"><a href="#d5e436">7.2. Additional</a></span></dt></dl></dd><dt><span class="chapter"><a href="#chapter-detail-snippet">8. Details of snippet class</a></span></dt><dd><dl><dt><span class="sect1"><a href="#d5e482">8.1. Rendering APIs</a></span></dt><dt><span class="sect1"><a href="#d5e756">8.2. Other things about snippet and rendering</a></span></dt></dl></dd><dt><span class="chapter"><a href="#overview">9. Variable injection</a></span></dt><dd><dl><dt><span class="sect1"><a href="#d5e796">9.1. Context</a></span></dt><dt><span class="sect1"><a href="#d5e886">9.2. Injection</a></span></dt></dl></dd><dt><span class="chapter"><a href="#overview">10. URL rule</a></span></dt><dt><span class="chapter"><a href="#overview">11. Request Handler</a></span></dt><dd><dl><dt><span class="section"><a href="#d5e903">11.1. Implementation</a></span></dt><dt><span class="section"><a href="#d5e905">11.2. Content provider</a></span></dt><dt><span class="section"><a href="#d5e907">11.3. Request handler chain</a></span></dt><dt><span class="section"><a href="#d5e909">11.4. Request Interceptor</a></span></dt></dl></dd><dt><span class="chapter"><a href="#overview">12. Extended request handler usage</a></span></dt><dd><dl><dt><span class="section"><a href="#d5e913">12.1. Restful</a></span></dt><dt><span class="section"><a href="#d5e915">12.2. Handle static resouce files and generic path mapping</a></span></dt><dt><span class="section"><a href="#d5e917">12.3. Normalize http request</a></span></dt><dt><span class="section"><a href="#d5e919">12.4. As MVC's Controller</a></span></dt></dl></dd><dt><span class="chapter"><a href="#chapter-detail-i18n">13. i18n</a></span></dt><dt><span class="chapter"><a href="#overview">14. Asta4dServlet and configuration</a></span></dt><dt><span class="chapter"><a href="#overview">15. Integration with Spring</a></span></dt><dd><dl><dt><span class="section"><a href="#d5e929">15.1. Integrate with Spring IOC</a></span></dt><dt><span class="section"><a href="#d5e932">15.2. Integrate with Spring MVC</a></span></dt></dl></dd></dl></dd></dl></div>
  

  

  

  <div class="part"><div class="titlepage"><div><div><h1 class="title"><a name="asta4d-introduction"></a>Part&nbsp;I.&nbsp;Introduction</h1></div></div></div>
    
    
    <div class="partintro"><div></div>
      <p>
      Asta4D is a web application framework which is friendly to designer and flexible to developer. Asta4D affords
      high productivity than traditional MVC architecture by View First architecture. It also allows front-end engineers 
      and back-end engineers work independently without interference by separating rendering logic from template files.
      </p>
      
      <p>
      Asta4D is inspired by lift which is a famous scala web application framework and it is developed by astamuse company Ltd.
      locating at Tokyo Japan. We are concentrating on global innovation support and developing Asta4D for our own services.
      Currently, Asta4D is driving our new service development.

      </p>
    </div>
    <div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="chapter-overview"></a>1.&nbsp;Overview</h2></div></div></div>
  
  
  <div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d5e26"></a>1.1&nbsp;Why Asta4D</h2></div></div></div>
    
    <p>In the past decade, plenty of Java based web application frameworks are generated. Especially the MVC 
    architecture and JSP tag libs (or other traditional template technologies) that has greatly released our productivity. 
    But unfortunately, we are still suffering from the following situations:
    </p>
    
    <div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
        <p>The designers or front-end engineers are keeping complaining the mixed-in dynamic code, as they disturb 
        their efforts of redesigning the page style or structure. And in the mean time, the back-end developers are also 
        complaining that the front-end guys break the working page frequently,  because redesign or the new design is hard 
        to merge due to the huge cost of source refactoring. </p>
        <br>
      </li><li class="listitem">
        <p>The developers are complaining about the poor functionalities of template language which they are using 
        and tired from the various magic skills for complex rendering logic.</p>
        <br>
      </li><li class="listitem">
        <p>The developers are discontented with the counterproductivity of MVC architecture and desire a more efficient 
        approach like traditional PHP/ASP development.</p>
        <br>
      </li></ul></div>
  </div>
  
  <div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d5e39"></a>1.2&nbsp;How Asta4D helps us</h2></div></div></div>
    
    <p>Asta4D is our solution to combat those issues. Thanks to lift, from where we learn a lot. We designed Asta4D complying
    with the following points:
    </p>
    
    <div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
        <p>Separate template and rendering logic</p>
        <p>Asta4D affords front-end engineers a friendly environment by separating rendering logic from template files which
        are pure html files. At the mean time, back-end engineers can use the powerful Java language to implement the rendering
        logic without being suffering from the "poor and sometimes magic" template languages.
        </p>
        <br>
      </li><li class="listitem">
        <p>View first without controller</p>
        <p>Asta4D also affords higher productivity than traditional MVC architecture by View First mechanism. And it is also
        easier to change than MVC architecture.</p>
        <br>
      </li><li class="listitem">
        <p>High security of being immune from cross-site(XSS/CSRF)</p>
        <p>Asta4D is, by nature, immune from cross-site(XSS/CSRF) problems. You do not need to take care of cross-site any more. 
        All the rendered value would be escaped by default and your clients have no chance to put malicious contents to your server.
        </p>
        <br>
      </li><li class="listitem">
        <p>View first without controller</p>
        <p>Asta4D also affords higher productivity than traditional MVC architecture by View First mechanism. And it is also easier 
        to change than MVC architecture.
        </p>
        <br>
      </li><li class="listitem">
        <p>Isolate side effect with request handler</p>
        <p>Asta4D imports the conception of "side-effect" from functional programming languages and separating the "side-effect"
        by request handlers, which afford more flexibility on page rendering because the view layer is side-effect free now. Therefore
        Asta4D allows parallel page rendering in multiple threads as a built-in feature.
        </p>
        <br>
      </li></ul></div>
  </div>

  <div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d5e63"></a>1.3&nbsp;What does the name of "Asta4D" mean</h2></div></div></div>
    
    <p>The name of Asta4D is from our company's name: astamuse. We explain the "4D" as following ways:</p> 
    
    <div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
        <p>For Designer</p>
        <p>Asta4D consider the design friendliness as the most important factor of itself. We hope web designers can fulfil their
        maximum potential of creativity without squandering their time on the back-end technologies which they could never be adept at.
        </p>
        <br>
      </li><li class="listitem">
        <p>For developer</p>
        <p>We hope Asta4D can help developers to achieve their work more easily. Developers would never be afflicted with complex
        rendering logic because they can use powerful Java language to do whatever they want since the rendering has been split from
        template files. View first also releases developers from the cumbersome MVC architecture, now they have more time to have a cup
        of coffee.</p>
        <br>
      </li><li class="listitem">
        <p>4 Dimension</p>
        <p>We believe that Asta4D can act as a wormhole that connects the front-end and the back-end. We can move quicker by Asta4D just
        like we are going through the 4 dimensional space.
        </p>
        <br>
      </li></ul></div>
  </div>
</div>
  </div>

  <div class="part"><div class="titlepage"><div><div><h1 class="title"><a name="asta4d-user-guide"></a>Part&nbsp;II.&nbsp;User Guide</h1></div></div></div>
    
    <div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="chapter-Inheritable-template"></a>2.&nbsp;Flexible template</h2></div></div></div>
  
  
    <div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d5e83"></a>2.1&nbsp;Inheritable template</h2></div></div></div>
      
      <p>
      The template of Asta4D is inheritable, child template can override, append or insert content to certain place
      in parent template. Let's see a sample:
      </p>
      <div class="example"><a name="d5e86"></a><p class="title"><b>Example&nbsp;2.1.&nbsp;parent.html</b></p><div class="example-contents">
      <pre class="programlisting">

<span class="hl-tag">&lt;html&gt;</span>   
    <span class="hl-tag">&lt;head&gt;</span>   
        <span class="hl-tag">&lt;afd:block</span> <span class="hl-attribute">id</span>=<span class="hl-value">"block1"</span><span class="hl-tag">&gt;</span>   
            <span class="hl-tag">&lt;link</span> <span class="hl-attribute">href</span>=<span class="hl-value">"parent1.css"</span> <span class="hl-attribute">rel</span>=<span class="hl-value">"stylesheet"</span> <span class="hl-attribute">type</span>=<span class="hl-value">"text/css"</span><span class="hl-tag"> /&gt;</span>   
        <span class="hl-tag">&lt;/afd:block&gt;</span>   
           
        <span class="hl-tag">&lt;afd:block</span> <span class="hl-attribute">id</span>=<span class="hl-value">"block2"</span><span class="hl-tag">&gt;</span>   
            <span class="hl-tag">&lt;link</span> <span class="hl-attribute">href</span>=<span class="hl-value">"parent2.css"</span> <span class="hl-attribute">rel</span>=<span class="hl-value">"stylesheet"</span> <span class="hl-attribute">type</span>=<span class="hl-value">"text/css"</span><span class="hl-tag"> /&gt;</span>   
        <span class="hl-tag">&lt;/afd:block&gt;</span>   
  
        <span class="hl-tag">&lt;title&gt;</span>extension sample<span class="hl-tag">&lt;/title&gt;</span>   
    <span class="hl-tag">&lt;/head&gt;</span>   
    <span class="hl-tag">&lt;body&gt;</span>   
        <span class="hl-tag">&lt;afd:block</span> <span class="hl-attribute">id</span>=<span class="hl-value">"content"</span><span class="hl-tag">&gt;</span>content<span class="hl-tag">&lt;/afd:block&gt;</span>   
    <span class="hl-tag">&lt;/body&gt;</span>   
<span class="hl-tag">&lt;/html&gt;</span>

      </pre>
      </div></div><br class="example-break">

      <p>Child template can declare inheritance by "afd:extension" and overriding can be declared by "afd:block":</p>
      <div class="example"><a name="template-child"></a><p class="title"><b>Example&nbsp;2.2.&nbsp;child.html</b></p><div class="example-contents">
      <pre class="programlisting">

<span class="hl-tag">&lt;afd:extension</span> <span class="hl-attribute">parent</span>=<span class="hl-value">"parent.html"</span><span class="hl-tag">&gt;</span>   
  
    <span class="hl-tag">&lt;afd:block</span> <span class="hl-attribute">append</span>=<span class="hl-value">"block1"</span><span class="hl-tag">&gt;</span>   
        <span class="hl-tag">&lt;link</span> <span class="hl-attribute">href</span>=<span class="hl-value">"child1.css"</span> <span class="hl-attribute">rel</span>=<span class="hl-value">"stylesheet"</span> <span class="hl-attribute">type</span>=<span class="hl-value">"text/css"</span><span class="hl-tag"> /&gt;</span>   
    <span class="hl-tag">&lt;/afd:block&gt;</span>   
  
    <span class="hl-tag">&lt;afd:block</span> <span class="hl-attribute">insert</span>=<span class="hl-value">"block2"</span><span class="hl-tag">&gt;</span>   
        <span class="hl-tag">&lt;link</span> <span class="hl-attribute">href</span>=<span class="hl-value">"child2.css"</span> <span class="hl-attribute">rel</span>=<span class="hl-value">"stylesheet"</span> <span class="hl-attribute">type</span>=<span class="hl-value">"text/css"</span><span class="hl-tag"> /&gt;</span>   
    <span class="hl-tag">&lt;/afd:block&gt;</span>   
  
    <span class="hl-tag">&lt;afd:block</span> <span class="hl-attribute">override</span>=<span class="hl-value">"content "</span><span class="hl-tag">&gt;</span>   
        <span class="hl-tag">&lt;div&gt;</span>hello<span class="hl-tag">&lt;/div&gt;</span>   
        <span class="hl-tag">&lt;afd:embed</span> <span class="hl-attribute">target</span>=<span class="hl-value">"/templates/embed.html"</span><span class="hl-tag"> &gt;</span><span class="hl-tag">&lt;/afd:embed&gt;</span>   
    <span class="hl-tag">&lt;/afd:block&gt;</span>   
  
<span class="hl-tag">&lt;/afd:extension&gt;</span>   

      </pre>
      </div></div><br class="example-break">
      
      <p>
      "afd:block" support 3 types action: insert, append and override. 
      </p>
      
      <br>
      
      <p>
      In the <a class="xref" href="#template-child" title="Example&nbsp;2.2.&nbsp;child.html">Example&nbsp;2.2, &#8220;child.html&#8221;</a>, there is an additional declaration of including by "afd:embed" which embed 
      the target file to the current place of the current file. Let's see the embed.html:
      </p>
      <div class="example"><a name="d5e97"></a><p class="title"><b>Example&nbsp;2.3.&nbsp;embed.html</b></p><div class="example-contents">
      <pre class="programlisting">

    <span class="hl-tag">&lt;afd:block</span> <span class="hl-attribute">append</span>=<span class="hl-value">"block1"</span><span class="hl-tag">&gt;</span>   
        <span class="hl-tag">&lt;link</span> <span class="hl-attribute">href</span>=<span class="hl-value">"embed.css"</span> <span class="hl-attribute">rel</span>=<span class="hl-value">"stylesheet"</span> <span class="hl-attribute">type</span>=<span class="hl-value">"text/css"</span><span class="hl-tag"> /&gt;</span>   
    <span class="hl-tag">&lt;/afd:block&gt;</span>   
    <span class="hl-tag">&lt;div&gt;</span>good embed<span class="hl-tag">&lt;/div&gt;</span>   

      </pre>
      </div></div><br class="example-break">
      
      <p>
      The "afd:block" declaration in the embeded target file is available after the content of target file is inserted into the
      <a class="xref" href="#template-child" title="Example&nbsp;2.2.&nbsp;child.html">Example&nbsp;2.2, &#8220;child.html&#8221;</a>, all "afd:block" tags will be treated as overriding(inserting/appending) to the parent template
      and the contents out of "afd:blocks" will be inserted at the place where the "afd:embed" is declared.
      </p>
      
      <br>
      
      <p>After all the template files are merged, we will get the following result:</p>
      <div class="example"><a name="d5e104"></a><p class="title"><b>Example&nbsp;2.4.&nbsp;The result of template merging:</b></p><div class="example-contents">
      <pre class="programlisting">

<span class="hl-tag">&lt;html&gt;</span>   
<span class="hl-tag">&lt;head&gt;</span>   
       
    <span class="hl-comment">&lt;!-- block1 --&gt;</span>   
    <span class="hl-tag">&lt;link</span> <span class="hl-attribute">href</span>=<span class="hl-value">"parent1.css"</span> <span class="hl-attribute">rel</span>=<span class="hl-value">"stylesheet"</span> <span class="hl-attribute">type</span>=<span class="hl-value">"text/css"</span><span class="hl-tag"> /&gt;</span>   
    <span class="hl-tag">&lt;link</span> <span class="hl-attribute">href</span>=<span class="hl-value">"child1.css"</span> <span class="hl-attribute">rel</span>=<span class="hl-value">"stylesheet"</span> <span class="hl-attribute">type</span>=<span class="hl-value">"text/css"</span><span class="hl-tag"> /&gt;</span>   
    <span class="hl-tag">&lt;link</span> <span class="hl-attribute">href</span>=<span class="hl-value">"embed.css"</span> <span class="hl-attribute">rel</span>=<span class="hl-value">"stylesheet"</span> <span class="hl-attribute">type</span>=<span class="hl-value">"text/css"</span><span class="hl-tag"> /&gt;</span>   
  
    <span class="hl-comment">&lt;!-- block2 --&gt;</span>   
    <span class="hl-tag">&lt;link</span> <span class="hl-attribute">href</span>=<span class="hl-value">"child2.css"</span> <span class="hl-attribute">rel</span>=<span class="hl-value">"stylesheet"</span> <span class="hl-attribute">type</span>=<span class="hl-value">"text/css"</span><span class="hl-tag"> /&gt;</span>   
    <span class="hl-tag">&lt;link</span> <span class="hl-attribute">href</span>=<span class="hl-value">"parent2.css"</span> <span class="hl-attribute">rel</span>=<span class="hl-value">"stylesheet"</span> <span class="hl-attribute">type</span>=<span class="hl-value">"text/css"</span><span class="hl-tag"> /&gt;</span>   
  
    <span class="hl-tag">&lt;title&gt;</span>extension sample<span class="hl-tag">&lt;/title&gt;</span>   
  
<span class="hl-tag">&lt;/head&gt;</span>   
<span class="hl-tag">&lt;body&gt;</span>   
  
    <span class="hl-comment">&lt;!-- content --&gt;</span>   
    <span class="hl-tag">&lt;div&gt;</span>hello<span class="hl-tag">&lt;/div&gt;</span>   
  
    <span class="hl-comment">&lt;!-- embed --&gt;</span>   
    <span class="hl-tag">&lt;div&gt;</span>good embed<span class="hl-tag">&lt;/div&gt;</span>   
  
<span class="hl-tag">&lt;/body&gt;</span>   
<span class="hl-tag">&lt;/html&gt;</span>  

      </pre>
      </div></div><br class="example-break">
      
      
    </div>

    <div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d5e107"></a>2.2&nbsp;Parametrized embeding</h2></div></div></div>
      
      
      <p>
      Extra parameters can be passed to the target embeded file by specifying the DOM attribute of "afd:embed" when we
      are embeding files.
      </p>
      
      <div class="example"><a name="d5e110"></a><p class="title"><b>Example&nbsp;2.5.&nbsp;Sample of parametrized embeding:</b></p><div class="example-contents">
      <pre class="programlisting">

<span class="hl-tag">&lt;afd:embed</span> <span class="hl-attribute">target</span>=<span class="hl-value">"/xxx/showList.html"</span> <span class="hl-attribute">limit</span>=<span class="hl-value">"30"</span><span class="hl-tag">&gt;</span><span class="hl-tag">&lt;/afd:embed&gt;</span>

      </pre>
      </div></div><br class="example-break">

      <p>
      The "limit" parameter can be accessed by variable injection in the rendering logic of showList.html, by which we can
      parameterize the embeding. This feature is very useful for creating a page component which encapsulates common
      html snippets and can be controlled by the passed parameters. Basically, embeding a file in a template file
      is similar to calling a function with(or without) arguments. Especially, the parameters are not limited to
      specified static values in the template file, they can be valued dynamicaly at runtime too. Further, the
      type of parameters is not restricted to the stringizable types such as String or Integer/Long, arbitrary Java type
      can be specified dynamically at runtime. See the reference of Renering logic to learn more details. 
      </p>
    </div>

  <p>
  Simply, the idea of Asta4D's template system is akin to the traditional OOP model, the parent and child templates can be 
  regarded as parent/child classes and the block can be viewed as a overridable virtual method. The embed external files can
  be also treated as funcation calling. As a matter of fact, since arbitrary type of value can be passed to the embed files, 
  there is actually no difference between Asta4D's embeding and common function calling.
  </p>
</div>
    <div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="renderer"></a>3.&nbsp;Renderer: easy to use, secure, testable</h2></div></div></div>
  
  
  <div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d5e117"></a>3.1&nbsp;Split rendering logic from template</h2></div></div></div>
    
    
    <p>
    There is no dynamic code in a template file. An Asta4D template file is always a pure HTML file which can be easily 
    maintained by front-end developers, it is very design friendly and we can reduce the workload for source 
    refactoring by over 90%.
    </p>
    
    <div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
        <p>Declare snippet class in template file</p>
        <div class="example"><a name="d5e123"></a><p class="title"><b>Example&nbsp;3.1.&nbsp;Sample of snippet declaration:</b></p><div class="example-contents">
        <pre class="programlisting">

<span class="hl-tag">&lt;section&gt;</span>  
    <span class="hl-tag">&lt;article&gt;</span>  
        <span class="hl-tag">&lt;div</span> <span class="hl-attribute">afd:render</span>=<span class="hl-value">"SimpleSnippet"</span><span class="hl-tag">&gt;</span>dummy text<span class="hl-tag">&lt;/div&gt;</span>  
        <span class="hl-tag">&lt;afd:snippet</span> <span class="hl-attribute">render</span>=<span class="hl-value">"SimpleSnippet:setProfile"</span><span class="hl-tag">&gt;</span>  
            <span class="hl-tag">&lt;p</span> <span class="hl-attribute">id</span>=<span class="hl-value">"name"</span><span class="hl-tag">&gt;</span>name:<span class="hl-tag">&lt;span&gt;</span>dummy name<span class="hl-tag">&lt;/span&gt;</span><span class="hl-tag">&lt;/p&gt;</span>  
            <span class="hl-tag">&lt;p</span> <span class="hl-attribute">id</span>=<span class="hl-value">"age"</span><span class="hl-tag">&gt;</span>age:<span class="hl-tag">&lt;span&gt;</span>0<span class="hl-tag">&lt;/span&gt;</span><span class="hl-tag">&lt;/p&gt;</span>  
        <span class="hl-tag">&lt;/afd:snippet&gt;</span>  
    <span class="hl-tag">&lt;/article&gt;</span>  
<span class="hl-tag">&lt;/section&gt;</span>

        </pre>
        </div></div><br class="example-break">
    
        <p>
        The "afd:render" attribute in div tag declares a Java class which is in charge of the concrete rendering logic, such Java
        class is usually called as a snippet class. A snippet class can be declared by a "afd:snippet" tag too, as you have seen
        in above sample. The rendering logic is secluded to independent Java classes by snippet declaration and it is not necessary
        to learn any new template language for back-end developers. The back-end guys can achieve all the rendering logic easily
        by powerful Java language which they have been adept to, no learning costs, no magic codes, succinct Java source only.
        </p>
        
        <br>
        
      </li><li class="listitem">
        <p>Implement a snippet class</p>
        <div class="example"><a name="d5e130"></a><p class="title"><b>Example&nbsp;3.2.&nbsp;Sample of snippet class:</b></p><div class="example-contents">
        <pre class="programlisting">

<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> SimpleSnippet {  
  
    <span class="hl-keyword">public</span> Renderer render(String name) {  
        <span class="hl-keyword">if</span> (StringUtils.isEmpty(name)) {  
            name = <span class="hl-string">"Asta4D"</span>;  
        }  
        Element element = ElementUtil.parseAsSingle(<span class="hl-string">"&lt;span&gt;Hello "</span> + name + <span class="hl-string">"!&lt;/span&gt;"</span>);  
        <span class="hl-keyword">return</span> Renderer.create(<span class="hl-string">"*"</span>, element);  
    }  
  
    <span class="hl-keyword">public</span> Renderer setProfile() {  
        Renderer render = <span class="hl-keyword">new</span> GoThroughRenderer();  
        render.add(<span class="hl-string">"p#name span"</span>, <span class="hl-string">"asta4d"</span>);  
        render.add(<span class="hl-string">"p#age span"</span>, <span class="hl-number">20</span>);  
        <span class="hl-keyword">return</span> render;  
    }  
}

        </pre>
        </div></div><br class="example-break">
        
        <p>
        The Renderer class is provided by framework to declare rendering actions. Renderer uses traditional CSS selector to
        reference the rendering target and receive the rendering value at the same time, amazing and powerful.
        </p>
        <br>
        
        <p>If the above template file and snippet class are executed, we would get the following result:</p>
        <div class="example"><a name="d5e136"></a><p class="title"><b>Example&nbsp;3.3.&nbsp;Result of snippet execution:</b></p><div class="example-contents">
        <pre class="programlisting">

<span class="hl-tag">&lt;section&gt;</span>  
    <span class="hl-tag">&lt;article&gt;</span>  
        <span class="hl-tag">&lt;span&gt;</span>Hello Asta4D<span class="hl-tag">&lt;/span&gt;</span>  
            <span class="hl-tag">&lt;p</span> <span class="hl-attribute">id</span>=<span class="hl-value">"name"</span><span class="hl-tag">&gt;</span>name:<span class="hl-tag">&lt;span&gt;</span>asta4d/span&gt;<span class="hl-tag">&lt;/p&gt;</span>  
            <span class="hl-tag">&lt;p</span> <span class="hl-attribute">id</span>=<span class="hl-value">"age"</span><span class="hl-tag">&gt;</span>age:<span class="hl-tag">&lt;span&gt;</span>20<span class="hl-tag">&lt;/span&gt;</span><span class="hl-tag">&lt;/p&gt;</span>  
    <span class="hl-tag">&lt;/article&gt;</span>  
<span class="hl-tag">&lt;/section&gt;</span>

        </pre>
        </div></div><br class="example-break">
      </li></ul></div>

    <p>
    Asta4D introduces 4 extra tags to the html template file: afd:extension, afd:block, afd:embed, afd:snippet, which will not
    disturb most html editors, accordingly Asta4D is extremely friendly to front-end engineers. On the other hand, we can see
    that all the rendering logic is fulfiled by Java code and the back-end engineers can compose their back-end logic and rendering logic
    very smoothly without magic skills and extra learning costs, which means highly boost of productivity.
    </p>
  </div>
  
  <div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d5e140"></a>3.2&nbsp;Render data to page</h2></div></div></div>
    
    <div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
        <p>In Asta4D, all the rendering logic is declared by a Renderer class which accepts various types as rendering value.</p>
        <div class="example"><a name="d5e145"></a><p class="title"><b>Example&nbsp;3.4.&nbsp;Sample usage of Renderer</b></p><div class="example-contents">
        <pre class="programlisting">

Renderer render = <span class="hl-keyword">new</span> GoThroughRenderer();  
render.add(<span class="hl-string">"#someIdForInt"</span>, <span class="hl-number">12345</span>);  
render.add(<span class="hl-string">"#someIdForLong"</span>, <span class="hl-number">12345L</span>);  
render.add(<span class="hl-string">"#someIdForBool"</span>, true);  
render.add(<span class="hl-string">"#someIdForStr"</span>, <span class="hl-string">"a str"</span>);  
render.add(<span class="hl-string">"#someIdForNull"</span>, (Object) null);  
render.add(<span class="hl-string">"#someIdForClear"</span>, Clear);  
  
Element newChild = ElementUtil.parseAsSingle(<span class="hl-string">"&lt;div&gt;&lt;/div&gt;"</span>);  
render.add(<span class="hl-string">"#someIdForElementSetter"</span>, <span class="hl-keyword">new</span> ChildReplacer(newChild));  
  
render.add(<span class="hl-string">"#someIdForElement"</span>, ElementUtil.parseAsSingle(<span class="hl-string">"&lt;div&gt;eee&lt;/div&gt;"</span>));  
  
render.add(<span class="hl-string">"#someIdForRenderer"</span>, Renderer.create(<span class="hl-string">"#value"</span>, <span class="hl-string">"value"</span>));  

        </pre>
        </div></div><br class="example-break">
      </li><li class="listitem">
        <p>List of data can be rendered via Renderer too:</p>
        <div class="example"><a name="d5e150"></a><p class="title"><b>Example&nbsp;3.5.&nbsp;Sample of list rendering</b></p><div class="example-contents">
        <pre class="programlisting">

Renderer render = <span class="hl-keyword">new</span> GoThroughRenderer();  
render.add(<span class="hl-string">"#someIdForInt"</span>, Arrays.asList(<span class="hl-number">123</span>, <span class="hl-number">456</span>, <span class="hl-number">789</span>));  
render.add(<span class="hl-string">"#someIdForLong"</span>, Arrays.asList(<span class="hl-number">123L</span>, <span class="hl-number">456L</span>, <span class="hl-number">789L</span>));  
render.add(<span class="hl-string">"#someIdForBool"</span>, Arrays.asList(true, true, false));  
render.add(<span class="hl-string">"#someIdForStr"</span>, Arrays.asList(<span class="hl-string">"str1"</span>, <span class="hl-string">"str2"</span>, <span class="hl-string">"str3"</span>));  
  
Element newChild1 = ElementUtil.parseAsSingle(<span class="hl-string">"&lt;div&gt;1&lt;/div&gt;"</span>);  
Element newChild2 = ElementUtil.parseAsSingle(<span class="hl-string">"&lt;div&gt;2&lt;/div&gt;"</span>);  
  
render.add(<span class="hl-string">"#someIdForElementSetter"</span>, Arrays.asList(<span class="hl-keyword">new</span> ChildReplacer(newChild1), <span class="hl-keyword">new</span> ChildReplacer(newChild2)));  
  
render.add(<span class="hl-string">"#someIdForElement"</span>, Arrays.asList(newChild1, newChild2));  
  
render.add(<span class="hl-string">"#someIdForRenderer"</span>, Arrays.asList(<span class="hl-number">123</span>, <span class="hl-number">456</span>, <span class="hl-number">789</span>), <span class="hl-keyword">new</span> RowRenderer&lt;Integer&gt;() {  
    <em><span class="hl-annotation" style="color: gray">@Override</span></em>  
    <span class="hl-keyword">public</span> Renderer convert(<span class="hl-keyword">int</span> rowIndex, Integer obj) {  
        <span class="hl-keyword">return</span> Renderer.create(<span class="hl-string">"#id"</span>, <span class="hl-string">"id-"</span> + obj).add(<span class="hl-string">"#otherId"</span>, <span class="hl-string">"otherId-"</span> + obj);  
    }  
});   

        </pre>
        </div></div><br class="example-break">
      </li><li class="listitem">
        <p>DOM attribution can be done too:</p>
        <div class="example"><a name="d5e155"></a><p class="title"><b>Example&nbsp;3.6.&nbsp;Sample of DOM attribution rendering</b></p><div class="example-contents">
        <pre class="programlisting">

render.add(<span class="hl-string">"#id"</span>, <span class="hl-string">"+class"</span>, <span class="hl-string">"yyy"</span>);  
render.add(<span class="hl-string">"#id"</span>, <span class="hl-string">"-class"</span>, <span class="hl-string">"zzz"</span>);  
  
render.add(<span class="hl-string">"#id"</span>, <span class="hl-string">"+class"</span>, <span class="hl-string">"xxx"</span>);  
  
render.add(<span class="hl-string">"#id"</span>, <span class="hl-string">"value"</span>, <span class="hl-string">"hg"</span>);  
render.add(<span class="hl-string">"#id"</span>, <span class="hl-string">"href"</span>, null);  
  
render.add(<span class="hl-string">"#X"</span>, <span class="hl-string">"value"</span>, <span class="hl-keyword">new</span> Date(<span class="hl-number">123456L</span>));

        </pre>
        </div></div><br class="example-break">
      </li></ul></div>
  </div>

  <div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d5e158"></a>3.3&nbsp;Immune from cross-site hole</h2></div></div></div>
    
    <p>
    The previous samples show us that all the operations to DOM are delegated by Renderer except create DOM
    from String value by "ElementUtil#parseAsSingle". As a matter of fact, all the delegated operations cause
    all the rendering values are escaped by force, which means that your system is, by nature, immune from
    cross-site problems if there is no "ElementUtil#parseAsSingle" calling in your system. You do not need
    to be wary of illegal characters by from the clients since all the values will be escaped as HTML compulsorily.
    </p>
    
    On the other hand, according to our practice, it is rarely that you have to call &#8220;ElementUtil.parseAsSingle&#8221;
    to generate the rendering content from a raw HTML string, so just take care of your usage of this exceptional api
    then you can say bye-bye to the cross-site holes.    
  </div>
  
  <div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d5e161"></a>3.4&nbsp;Test your rendering logic</h2></div></div></div>
    
    <p>
    Testing web page is always a complex task and we usually verify rendering results by selenuim which is as a common
    technology. By Asta4D, testable Renderer can replace over than half of selenium tests to simpler junit tests.
    </p>
    
    <p>
    According to the previous samples, all the rendering logic is holded by an instance of Renderer class, so simply,
    we can verify almost rendering logic by testing the returned Renderer instance from the snippet method. 
    </p>
    
    <div class="example"><a name="d5e165"></a><p class="title"><b>Example&nbsp;3.7.&nbsp;Sample RendererTester</b></p><div class="example-contents">
    <pre class="programlisting">

RendererTester tester = RendererTester.forRenderer(render);  
Assert.assertEquals(tester.get(<span class="hl-string">"#someIdForInt"</span>), <span class="hl-number">12345</span>);  
Assert.assertEquals(tester.get(<span class="hl-string">"#someIdForLong"</span>), <span class="hl-number">12345L</span>);  
Assert.assertEquals(tester.get(<span class="hl-string">"#someIdForBool"</span>), true);  
Assert.assertEquals(tester.get(<span class="hl-string">"#someIdForStr"</span>), <span class="hl-string">"a str"</span>);  
Assert.assertEquals(tester.get(<span class="hl-string">"#someIdForNull"</span>), null);  
Assert.assertEquals(tester.get(<span class="hl-string">"#someIdForClear"</span>), Clear);  

    </pre>
    <p>More samples can be found in <a class="ulink" href="https://github.com/astamuse/asta4d/blob/develop/asta4d-core/src/test/java/com/astamuse/asta4d/test/unit/RenderTesterTest.java" target="_top">source</a></p>
    </div></div><br class="example-break">

  </div>
  
</div>
    <div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="url-mapping"></a>4.&nbsp;View first URL mapping and variable injection</h2></div></div></div>
  
  
  <div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d5e172"></a>4.1&nbsp;View first</h2></div></div></div>
    

    <p>
    In Asta4D, we follow the principle of view first rather than the tradition MVC architecture. The declaration of URL rules
    does not need to include a controller and one url can be mapped to one template file directly, which is called as View First.
    </p>
    
    <p>
    In Asta4D, URL mapping rules are not managed in a configuration file. The Framework provides a sort of DSL by a set of convinient
    APIs, which means the declaration of Asta4D's URL mapping rule is programmable and it affords much flexibility than the way with a
    static configuration file.    
    </p>
    
    <p>
    Users declare their own URL rules via implementing the interface UrlMappingRuleInitializer of Asta4D:
    </p>
    
    <div class="example"><a name="d5e177"></a><p class="title"><b>Example&nbsp;4.1.&nbsp;Sample of declaring url rules:</b></p><div class="example-contents">
    <pre class="programlisting">

<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> UrlRules <span class="hl-keyword">implements</span> UrlMappingRuleInitializer {    
    
    <em><span class="hl-annotation" style="color: gray">@Override</span></em>    
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> initUrlMappingRules(UrlMappingRuleHelper rules) {    
        <span class="hl-comment">//@formatter:off    </span>
        rules.add(GET, <span class="hl-string">"/"</span>)    
             .redirect(<span class="hl-string">"/app/index"</span>);    
            
        rules.add(GET, <span class="hl-string">"/redirect-to-index"</span>)    
             .redirect(<span class="hl-string">"p:/app/index"</span>);    
            
        rules.add(<span class="hl-string">"/app/"</span>, <span class="hl-string">"/templates/index.html"</span>);    
        rules.add(<span class="hl-string">"/app/index"</span>, <span class="hl-string">"/templates/index.html"</span>);    
        rules.add(<span class="hl-string">"/app/{name}/{age}"</span>, <span class="hl-string">"/templates/variableinjection.html"</span>)&#65307;    
        ...    
    
        <span class="hl-comment">//@formatter:on    </span>
    }
}

    </pre>
    </div></div><br class="example-break">
  </div>
  
  <div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d5e180"></a>4.2&nbsp;The grammer of URL rule and path variable</h2></div></div></div>
    
    <p>
    The grammer of Asta4D's URL rule is almost the same as Spring MVC's URL mapping rule and the parts surrounded by braces are 
    treated as path variables which can be retrieved in following process(in snippet classes or request handlers).
    </p>
    
    <p>
    Further, extra path variables can be declared in a url rule by calling the method of "var" as following:
    </p>
    <div class="example"><a name="d5e184"></a><p class="title"><b>Example&nbsp;4.2.&nbsp;Sample of declaring extra path variable:</b></p><div class="example-contents">
    <pre class="programlisting">

rules.add(<span class="hl-string">"/app/{name}/{age}"</span>, <span class="hl-string">"/templates/variableinjection.html"</span>)  
     .var(<span class="hl-string">"extraVar"</span>, <span class="hl-number">1234</span>);  

    </pre>
    </div></div><br class="example-break">
  </div>
  
  <div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d5e187"></a>4.3&nbsp;Variable Injection</h2></div></div></div>
    
    <p>
    Asta4D implements a variable injection mechanism which is very closed to Spring MVC, all of the instance fields 
    and method parameters in the implementation of snippet classes can be injected automatically by framework.
    </p>
    
    <p>
    Further, all the snippet classes are singleton in request scope.In other words, there will be only one istance of any 
    snippet class in a single request scope regardless of how many times the snippet class is called. Let us see some samples
    of variable injection in the snippet class.
    </p>
    
    <div class="example"><a name="d5e191"></a><p class="title"><b>Example&nbsp;4.3.&nbsp;</b></p><div class="example-contents">
    <pre class="programlisting">

<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> InitSnippet <span class="hl-keyword">implements</span> InitializableSnippet {    
    
    <em><span class="hl-annotation" style="color: gray">@ContextData</span></em>    
    <span class="hl-keyword">private</span> String value; <span class="hl-comment">// (1)    </span>
    <span class="hl-keyword">private</span> <span class="hl-keyword">long</span> id;    
    <span class="hl-keyword">private</span> String resolvedValue;    
    <span class="hl-keyword">private</span> <span class="hl-keyword">int</span> count = <span class="hl-number">0</span>;    

}    

    </pre>
    <p>
    @ContextData indicates that the instance field "value" need to be injected after the instance of InitSnippet is created. 
    Since the snippet instance is singeleton in the current request scope, the instance field "value" will be injected and 
    initialized only once in the current request scope. The framework will search a variable named "value" in all the available
    variable scopes and inject the found value. The name of "value" is decided by the field name by default and can be
    sepcified by extra declaration(see the following samples).
    </p>
    </div></div><br class="example-break">
    
    <div class="example"><a name="d5e194"></a><p class="title"><b>Example&nbsp;4.4.&nbsp;</b></p><div class="example-contents">
    <pre class="programlisting">

<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> InitSnippet <span class="hl-keyword">implements</span> InitializableSnippet {    

    <em><span class="hl-annotation" style="color: gray">@ContextData</span></em>    
    <span class="hl-keyword">private</span> <span class="hl-keyword">void</span> setId(<span class="hl-keyword">long</span> id) {&#12288;<span class="hl-comment">//(3)    </span>
        <span class="hl-keyword">this</span>.id = id;    
    }    

}    

    </pre>
    <p>Instance field can be injected via setter methods too.</p>
    </div></div><br class="example-break">
    
    <div class="example"><a name="d5e197"></a><p class="title"><b>Example&nbsp;4.5.&nbsp;</b></p><div class="example-contents">
    <pre class="programlisting">

<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> InitSnippet <span class="hl-keyword">implements</span> InitializableSnippet {    
    
    <em><span class="hl-annotation" style="color: gray">@Override</span></em>    
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> init() <span class="hl-keyword">throws</span> SnippetInvokeException { <span class="hl-comment">//(2)    </span>
        resolvedValue = value + <span class="hl-string">"-resolved"</span>;    
        count++;    
    }  

}    

    </pre>
    <p>
    The init method of InitializableSnippet is being implemented. This is not necessary but if a snippet class implements 
    the interface of InitializableSnippet, the init method will be called once after all the instance fields are injected,
    by which customized snippet initial logic can be performed.
    </p>
    </div></div><br class="example-break">
    
    <div class="example"><a name="d5e200"></a><p class="title"><b>Example&nbsp;4.6.&nbsp;</b></p><div class="example-contents">
    <pre class="programlisting">

<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> InitSnippet <span class="hl-keyword">implements</span> InitializableSnippet {    

    <span class="hl-comment">// (4)    </span>
    <span class="hl-keyword">public</span> Renderer getPathVarName(    
    <em><span class="hl-annotation" style="color: gray">@ContextData(scope = WebApplicationContext.SCOPE_PATHVAR)</span></em>    
    <span class="hl-keyword">int</span> count) {    
    }

}    

    </pre>
    <p>
    Variable injection on snippet method. In this sample the extra search scope are delcared, which cause framework searches
    a variable named "count" in the path variable scope. As the same as the injection on instance field, the searching variable
    name is decided by the parameter name by default.
    </p>
    </div></div><br class="example-break">
    
    <div class="example"><a name="d5e203"></a><p class="title"><b>Example&nbsp;4.7.&nbsp;</b></p><div class="example-contents">
    <pre class="programlisting">

<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> InitSnippet <span class="hl-keyword">implements</span> InitializableSnippet {    

    <span class="hl-comment">// (5)    </span>
    <span class="hl-keyword">public</span> Renderer getQueryParamName(    
    <em><span class="hl-annotation" style="color: gray">@ContextData(name = "var", scope = WebApplicationContext.SCOPE_QUERYPARAM)</span></em>    
    String name) {    
    }    

}    

    </pre>
    <p>
    In this sample, an extra variable name and search scope are declared, the framework will search a variable named "var" in the
    request parameters.
    </p>
    </div></div><br class="example-break">    

    <div class="example"><a name="d5e206"></a><p class="title"><b>Example&nbsp;4.8.&nbsp;</b></p><div class="example-contents">
    <pre class="programlisting">

<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> InitSnippet <span class="hl-keyword">implements</span> InitializableSnippet {    

    <span class="hl-comment">// (6)    </span>
    <span class="hl-keyword">public</span> Renderer getDefaultName(String name) {    
    } 

}    

    </pre>
    <p>
    There is a difference between instance field injection and method parameter injection. A instance field without @ContextData
    annotation will not be injected, but for method paramters, all the paramters will be injected compulsorily. In this sample,
    the framework will search a variable named "name" in all the available scopes as following order:
    </p>
    <div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">
        <p>HTML tag attribution(SCOPE_ATTR)</p>
        <p>Trace back to the top tag of the current HTML document recursively. This scope is only available to the snippet method.</p>
      </li><li class="listitem">
        <p>path variable(SCOPE_PATHVAR)</p>
      </li><li class="listitem">
        <p>request parameter(SCOPE_QUERYPARAM)</p>
      </li><li class="listitem">
        <p>flash variable(SCOPE_FLASH)</p>
        <p>The variables passed from one request to another request, usually acrross a redirect.</p>
      </li><li class="listitem">
        <p>cookie(SCOPE_COOKIE)</p>
      </li><li class="listitem">
        <p>request hearder(SCOPE_HEADER)</p>
      </li><li class="listitem">
        <p>request attribute(SCOPE_REQUEST)</p>
      </li><li class="listitem">
        <p>session(SCOPE_SESSION)</p>
      </li><li class="listitem">
        <p>global(SCOPE_GLOBAL)</p>
        <p>A global static variable pool</p>
      </li></ol></div>
    <p>
      This search order is applied to the instance field injection too except that the first scope of HTML tag attribution is not available.
    </p>
    </div></div><br class="example-break">


    
  </div>

</div>
    <div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="chapter-side-effect"></a>5.&nbsp;Side effect and request handler</h2></div></div></div>
  
 
  <div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d5e234"></a>5.1&nbsp;The role with responsibility to http request: Request Handler</h2></div></div></div>
    
    <p>
    Even Asta4D complies with the principle of view first, there is still a role similar with the controller in MVC
    architecture, such role is called request handler. We believe that there should be a role who takes responsiblity
    of a certain http request and such role can be considered as an alternative to controller of MVC in some situations
    too.
    </p>
    
    <p>
    According to the view first rule, a request handler can be ignored in most cases. You can also assume that there is
    is a default request handler which navigates all the http requests to the corresponding template files(The real 
    story is more complex but you can try to understand the theory conceptually by this way).
    </p>
    
    <p>
    Now the question is when we need a request handler? Before we can answer this question, we have to discuss the conception
    of "side effect".
    </p>
  </div>

  <div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d5e239"></a>5.2&nbsp;Side effect of system operations</h2></div></div></div>
    

    <p>
    A system always afford users various operations such as query, update, etc. All of these operations will affect the status
    of system in various ways. In Asta4D, we say that there are two types of action in a system, one is with &#8220;side effect&#8221;, 
    another one is without &#8220;side effect&#8221;. &#8220;actions with side effect&#8221; are ones that will change the system status once they are
    performed. For instance, for the same URL, a login request (if succeeded) will cause a client&#8217;s privilege to be changed and 
    the client could probably get a different page view from what the client get before login, because of which we say a login 
    request is an action with side effect. Another obvious example is a database update operation. Once an update is committed, 
    all the related clients will get a different output from the result before the update, which is also classified as &#8220;an action 
    with side effect&#8221;. 
    </p>
    
    <p>
    How about a query? We consider a query as an operation without side effect, it means that a client will always get the same
    result regardless of how many times the query is executed. Some people may ask how about counting on query times? For counting
    on query times, we can still split the counting and query to two individual operations, one is with side effect and another one
    is without side effect.
    </p>
  </div>
  
  <div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d5e243"></a>5.3&nbsp;Isolate side effect and multi thread rendering</h2></div></div></div>
    

    <p>
    We believe the actions with side effect should be managed seriously and we do that by putting all the actions with side effect
    to request handlers so that the view layer is purified and this makes the source more clear and maintainable. This is also means 
    with Asta4D we can easily perform multi thread rendering on a single page because they are now all side-effect free, which is a
    high light function of Asta4D.
    </p>

    <p>
    In traditional MVC architecture, the responsibility of controller is tangled, a controller does not only handle the duty of altering
    system status(date update), but also takes the responsibility of preparing data for view layer. We often have to expand the database
    session(transaction) to the view layer for handling lazy load issue, which makes transaction management more complicated. Additionally,
    especially for the pages that can be split to relatively individual blocks, hypothetically we can accelerate the page loading
    by retrieving data in multi threads for each block, but in reality it is impossible due to the source complexity and development costs.
    The developers still have to access each data source sequentially to retrieve data for each block even the page is splitable as individual
    blocks.
    </p>

    <p>
    For Asta4D, the logic layers of system is clarified by isolating side effects at architecture level. The database session(transaction)
    does no longer need keep opening cross layers, it is clear that the duty of request handler is altering system status but not preparing
    data for view layer. At the mean time, at the view layer, acquiring data and rendering data are performed at the same time, at the same
    place: We access data source and retrieve data in snippet method, and pass the data to Renderer to perform rendering immediately in the
    same snippet method. Further, the complexity can be reduced drastically because all the accesses to certain data are isolated in certain
    snippet methods and there is no cross layer invoking and coupling any more.
    </p>
    
    <p>
    On the other hand, we can simply perform multi thread rendering by calling each snippet method in different threads, which is transparent to
    developer. Because all the side effects has been isolated in request handler layer, we do not need to considerate sync or mutex even we
    are performing multi thread rendering since the view layer is side effect free now.
    </p>
    
    <p>
    Let us see how easy we can achieve parallel rendering 
    </p>
    
    <div class="example"><a name="d5e250"></a><p class="title"><b>Example&nbsp;5.1.&nbsp;</b></p><div class="example-contents">
      <pre class="programlisting">

<span class="hl-tag">&lt;div</span> <span class="hl-attribute">afd:render</span>=<span class="hl-value">"ParallelTest$TestRender:snippetInDiv"</span> <span class="hl-attribute">afd:parallel&gt;</span>  
    <span class="hl-attribute">&lt;div</span> <span class="hl-attribute">id</span>=<span class="hl-value">"test"</span><span class="hl-tag">&gt;</span>xx<span class="hl-tag">&lt;/div&gt;</span>  
<span class="hl-tag">&lt;/div&gt;</span>  
  
<span class="hl-tag">&lt;afd:snippet</span> <span class="hl-attribute">render</span>=<span class="hl-value">"ParallelTest$TestRender:snippetReplaceDiv"</span> <span class="hl-attribute">parallel&gt;</span>  
    <span class="hl-attribute">&lt;div</span> <span class="hl-attribute">id</span>=<span class="hl-value">"test"</span><span class="hl-tag">&gt;</span>xx<span class="hl-tag">&lt;/div&gt;</span>  
<span class="hl-tag">&lt;/afd:snippet&gt;</span>

      </pre>
      <p>
      All the snippets declared with parallel(afd:parallel) attribution will not block the http request main thread, the http request main thread
      will wait for the parallel rendering after all the non-parallel rendering finished, then merge the result and output to the client.
      </p>
    </div></div><br class="example-break">
  </div>

  <div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d5e253"></a>5.4&nbsp;Compatibility to MVC</h2></div></div></div>
    
    <p>
    Someone may ask: "Is it true that we do not need MVC?", "Is it true that we do not need a controller?". The answer is "No". We
    admit that MVC architecture is more convenient than view first for some certain cases, for instance, when we are handling form
    submission, the MVC structure is required naturally. By Asta4D, you can simply handle this case by implement the request handler
    as a controller.
    </p>
    
    <p>
    Further, perhaps you cannot agree with the idea of view first. You believe a controller is necessary in any case but you are also
    interested in the split template mechanism of Asta4D, the same answer for you: implement your request handler as a controller. 
    </p>
    
    <p>
      <em><span class="remark">You can also integrate Asta4D's template only as a view layer implementation for Spring MVC. More details can be found in reference.</span></em>
    </p>
  </div>

</div>
    <div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="chapter-request-handler"></a>6.&nbsp;Impement request handler and url mapping</h2></div></div></div>
  

  <div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d5e261"></a>6.1&nbsp;@RequestHandler</h2></div></div></div>
    
    <p>It is not complicated to implement a request handler. @RequestHandler can be used to annotate a handle
    method in arbitrary Java class which will be treated as a request handler.</p>
    
    <div class="example"><a name="d5e264"></a><p class="title"><b>Example&nbsp;6.1.&nbsp;</b></p><div class="example-contents">
      <pre class="programlisting">

<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> LoginHandler {  
  
    <em><span class="hl-annotation" style="color: gray">@RequestHandler</span></em>  
    <span class="hl-keyword">public</span> LoginFailure doLogin(String flag) <span class="hl-keyword">throws</span> LoginFailure {  
        <span class="hl-keyword">if</span> (StringUtils.isEmpty(flag)) {  
            <span class="hl-keyword">return</span> null;  
        }  
        <span class="hl-keyword">if</span> (<span class="hl-string">"error"</span>.equals(flag)) {  
            <span class="hl-keyword">throw</span> <span class="hl-keyword">new</span> LoginFailure();  
        }  
        <span class="hl-keyword">if</span> (!Boolean.parseBoolean(flag)) {  
            <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> LoginFailure();  
        }  
        <span class="hl-keyword">return</span> null;  
    }  
}  

      </pre>
      <p>
      Take a look at the parameters of the handle method, the handle method of a request handler accepts parameter injection
      as same as the snippet method. More details can be found at the descriptions of the snippet method.
      </p>
    </div></div><br class="example-break">
  </div>
 
  <div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d5e267"></a>6.2&nbsp;delcare url rule for request handler</h2></div></div></div>
    
    <p>Previously we have introduced how to forward a http request to a certain template file by url mapping. We can declare 
    a request handler for q http request by the same way:
    </p>
    
    <div class="example"><a name="d5e270"></a><p class="title"><b>Example&nbsp;6.2.&nbsp;</b></p><div class="example-contents">
      <pre class="programlisting">

rules.add(<span class="hl-string">"/app/handler"</span>)  
     .handler(LoginHandler.<span class="hl-keyword">class</span>) <span class="hl-comment">// (1)  </span>
     .forward(LoginFailure.<span class="hl-keyword">class</span>, <span class="hl-string">"/templates/error.html"</span>) <span class="hl-comment">//(2)  </span>
     .redirect(FurtherConfirm.<span class="hl-keyword">class</span>, <span class="hl-string">"/app/furtherConfirm"</span>)<span class="hl-comment">//(3)  </span>
     .forward(<span class="hl-string">"/templates/success.html"</span>); <span class="hl-comment">//(4)  </span>

      </pre>
      <p>
      Simply explain:
        </p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">
            <p>Forward the request to "/app/handler" to the request handler "LoginHandler".</p>
          </li><li class="listitem">
            <p>If "LoginHandler" returns a result of "LoginFailure", forward the request to the template file "error.html".</p>
          </li><li class="listitem">
            <p>If "LoginHandler" returns a result of "FurtherConfirm", redirect the current request to "/app/furtherConfirm" 
            by http code 302(302 is by default).</p>
          </li><li class="listitem">
            <p>If "LoginHandler" does not return a meaningful result(it usually means success by a null return) , forward the request 
            to the template file "success.html".</p>
          </li></ol></div><p>
      </p>
    </div></div><br class="example-break">
    
    <p>
      More verbose details:
    </p>
    
    <p>
      The handler method is used to add a request handler and accepts arbitrary type as the the parameter: an instance of java.lang.Class or an
      arbitrary instance. The framework explains received parameters by the implementation of DeclareInstanceResolver configured by
      WebApplicationConfiguration. Thee default implementation provided by framework follows the following rules to explain the declaration
      of request handler:
      </p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">
          <p>If an instance of java.lang.Class is specified, the instance of request handler will be created by invoke "newInstance()"
          on the specified Class.</p>
        </li><li class="listitem">
          <p>If a string is specified, the string will be treated as a class name and an instance of java.lang.Class will be created by 
          calling "Class#forName", then the instance of request handler will be created by invoke "newInstance()" on the created Class.</p>
        </li><li class="listitem">
          <p>The specified parameter will be treated as a request handler directly if it is neither a Class nor a string. By this rule,
          it is interesting that we can declare an anonymous class as a request handler:</p>
          <div class="example"><a name="d5e291"></a><p class="title"><b>Example&nbsp;6.3.&nbsp;</b></p><div class="example-contents">
            <pre class="programlisting">

rules.add(<span class="hl-string">"/app/handler"</span>)  
     .handler(<span class="hl-keyword">new</span> Object(){  
        <em><span class="hl-annotation" style="color: gray">@RequestHandler</span></em>  
        <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> handle(){  
            <span class="hl-comment">//  </span>
        }  
     }); 

            </pre>
          </div></div><br class="example-break">
        </li></ol></div><p>
      <em><span class="remark">The asta4d-spring package also provides a resolver based on Spring IOC container, the request handler instance will be retrieved by
      passing the specified parameter to the "Context#getBean" method of spring container.</span></em>
    </p>
    
    <p>
    The forward method adds a transforming rule for the result of request handler.There must be a handler method annotated by @RequestHandler and the
    returned value of the handle method is viewed as the result of the request handler, thrown exceptions in the handle method are treated as the result
    too. The framework will attempt to match the result to the expected result specified by forward method then transforms the result to the corresponding
    template file(The real mechanism of result transforming is more complicated and is explained at ...). When the matching attempt is performed, the
    equals method will be used at first, if the equals method returns false and the expected result by forward method is an instance of java.lang.Class,
    "Class#isAssignableFrom" will be utilized, if false again, skip the current forward rule and do the same check on the next forward rule. A forward rule
    without the expected result specified will be viewed as a default rule, if matched forward rule for a result is missing or the request handler returns
    a pointless result(void declaration of handle method or returns null), the default rule will be applied.
    </p>
    
    <p>
    The redirect method follows the same rule of forward method except it will cause a 302 redirect(302 is default, 301 can be declared) instead of forwarding
    to a template file.
    </p>
  </div>
  
  <div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d5e296"></a>6.3&nbsp;Default request handler</h2></div></div></div>
    
    <p>
    You can not only declare request handler to a certain url, but also declare global request handlers which is available to
    all the urls and prior to the request handlers declared on certain urls. There is a conception of request handler chain
    for multi handlers, we will explain it in a later chapter.
    </p>
    
    <div class="example"><a name="d5e299"></a><p class="title"><b>Example&nbsp;6.4.&nbsp;Default request handler</b></p><div class="example-contents">
      
      <pre class="programlisting">

rules.addDefaultRequestHandler(GlobalHandler.<span class="hl-keyword">class</span>);  
  
rules.addDefaultRequestHandler(<span class="hl-string">"authcheck"</span>, AuthCheckHandler.<span class="hl-keyword">class</span>);  

      </pre>
    </div></div><br class="example-break">
    
    <p>
    At the second line declaration for AuthCheckHandler, an attribute can be specified at the same time, which cause the declared request handler
    is only available to the rules that declared the same attribute.
    </p>
    
    <div class="example"><a name="d5e303"></a><p class="title"><b>Example&nbsp;6.5.&nbsp;</b></p><div class="example-contents">
      <pre class="programlisting">

rules.add(<span class="hl-string">"/app/handler"</span>).attribute(<span class="hl-string">"authcheck"</span>)  
        ...  

      </pre>
    </div></div><br class="example-break">
    
    <p class="remark"><em><span class="remark">
    In the framework's internal implementation, a static match rule table will be generated after all the url mapping declaration finished. A global
    request handler that is only available to certain rules will be configured to the the certain url rules only, by which unnecessary performance
    cost is avoid.
    </span></em></p>
    
    <p>
    In our practice, we found that it is very inconvenient to declare necessary attribute on every rule. In most situations, we will
    want to do something like configure a same default request handler to all the url paths under "/xxx", which can be done by delcaring
    a non attribute default request handler which judges the url pattern by itself, but such way will lose the performance benefit of
    attribute declaration. Thus, we provide an alternative way for this situation: url rule rewrite.
    </p>
    
    <div class="example"><a name="d5e307"></a><p class="title"><b>Example&nbsp;6.6.&nbsp;</b></p><div class="example-contents">
      <pre class="programlisting">

rules.addRuleRewriter(<span class="hl-keyword">new</span> UrlMappingRuleRewriter() {  
    <em><span class="hl-annotation" style="color: gray">@Override</span></em>  
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> rewrite(UrlMappingRule rule) {  
        <span class="hl-keyword">if</span>(rule.getSourcePath().startsWith(<span class="hl-string">"/privatedata/"</span>)){  
            rule.getAttributeList().add(<span class="hl-string">"authcheck"</span>);  
        }  
    }  
});   

      </pre>
    </div></div><br class="example-break">

    <p>
    Please note that, untill now all the introduced configuration for url mapping are achieved by a group of interface called
    HandyRule which convert all the declaration to the instance of UrlMappingRule which is used by framework internally. But in
    the url rule rewritter implementation, developers have to cope with the raw UrlMappingRule which is difficult to understand,
    so complex url rewriting is not appreciated. Basically, the scenario of url rule rewriting is only for add attributes to rules in
    bulk.
    </p>
  </div>
  
  <div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d5e310"></a>6.4&nbsp;Global forward/redirect</h2></div></div></div>
    

    <p>
    Previously we mentioned that the result of a request handler will be matched in the forward declaration, if there is no matched forward found,
    the global forward rule will be checked.
    </p>
    
    <div class="example"><a name="d5e313"></a><p class="title"><b>Example&nbsp;6.7.&nbsp;Global forward</b></p><div class="example-contents">
      
      <pre class="programlisting">

rules.addGlobalForward(PageNotFoundException.<span class="hl-keyword">class</span>, <span class="hl-string">"/pagenotfound.html"</span>, <span class="hl-number">404</span>);  

      </pre>

      <p>
      The above source declares that if the result of request handler is PageNotFoundException(Exception is treated as the result of the request handler),
      forward the request to pagenotfound.html by http status code 404.
      </p>
      
    </div></div><br class="example-break">
    
    <p>
    Global redirect can be declared by the same way.
    </p>
    
    <div class="example"><a name="d5e318"></a><p class="title"><b>Example&nbsp;6.8.&nbsp;Global redirect</b></p><div class="example-contents">
      
      <pre class="programlisting">

rules.addGlobalRedirect(REDIRECT_TO_SOMEWHERE, <span class="hl-string">"/somewhere"</span>);  

      </pre>
    </div></div><br class="example-break">

    <p>
    The global forward rules are applied before the default forward rule(the forward rule without result) on certain url mapping rule.
    </p>

    <div class="example"><a name="d5e322"></a><p class="title"><b>Example&nbsp;6.9.&nbsp;</b></p><div class="example-contents">
      <pre class="programlisting">

rules.addGlobalForward(PageNotFoundException.<span class="hl-keyword">class</span>, <span class="hl-string">"/pagenotfound.html"</span>, <span class="hl-number">404</span>);  

rules.addGlobalRedirect(REDIRECT_TO_SOMEWHERE, <span class="hl-string">"/somewhere"</span>);  

rules.add(<span class="hl-string">"/app/handler"</span>)  
     .handler(LoginHandler.<span class="hl-keyword">class</span>) 
     .forward(LoginFailure.<span class="hl-keyword">class</span>, <span class="hl-string">"/templates/error.html"</span>) 
     .redirect(FurtherConfirm.<span class="hl-keyword">class</span>, <span class="hl-string">"/app/furtherConfirm"</span>)  
     .forward(<span class="hl-string">"/templates/success.html"</span>);

      </pre>
    </div></div><br class="example-break">
    
    <p>
    In the above sample, the result of LoginHandler will be matched by the following order:
    </p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">LoginFailer</li><li class="listitem">FurtherConfirm</li><li class="listitem">PageNotFoundException</li><li class="listitem">REDIRECT_TO_SOMEWHERE</li><li class="listitem">(default-&gt; "success.html")</li></ol></div><p>
    </p>
  </div>

</div>
  </div>  

  <div class="part"><div class="titlepage"><div><div><h1 class="title"><a name="asta4d-reference"></a>Part&nbsp;III.&nbsp;Reference</h1></div></div></div>
    
    <div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="chapter-detail-template"></a>7.&nbsp;Details of Template</h2></div></div></div>
  
  
  <div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d5e335"></a>7.1.&nbsp;Supported tags</h2></div></div></div><div class="toc"><p><b>Table of Contents</b></p><dl class="toc"><dt><span class="sect2"><a href="#d5e338">7.1.1. afd:extension</a></span></dt><dt><span class="sect2"><a href="#d5e350">7.1.2. afd:block</a></span></dt><dt><span class="sect2"><a href="#d5e379">7.1.3. afd:embed</a></span></dt><dt><span class="sect2"><a href="#d5e393">7.1.4. afd:snippet</a></span></dt><dt><span class="sect2"><a href="#d5e416">7.1.5. afd:group</a></span></dt><dt><span class="sect2"><a href="#d5e424">7.1.6. afd:msg</a></span></dt></dl></div>
    
    
    <div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="d5e338"></a>7.1.1.&nbsp;afd:extension</h3></div></div></div>
      
      <p>A "afd:extension" tag declares the relationship of inheritance between child template and parent template.</p>
      <div class="example"><a name="d5e341"></a><p class="title"><b>Example&nbsp;7.1.&nbsp;child.html</b></p><div class="example-contents">
      <pre class="programlisting">

<span class="hl-tag">&lt;afd:extension</span> <span class="hl-attribute">parent</span>=<span class="hl-value">"parent.html"</span><span class="hl-tag">&gt;</span>   

...

<span class="hl-tag">&lt;/afd:extension&gt;</span>   

      </pre>
      </div></div><br class="example-break">
      <div class="variablelist"><p class="title"><b>Attributes:</b></p><dl class="variablelist"><dt><span class="term">parent</span></dt><dd>
            <p>Identifies the parent template file of the current template.</p>
          </dd></dl></div>
    </div>
    <div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="d5e350"></a>7.1.2.&nbsp;afd:block</h3></div></div></div>
      
      <p>A "afd:block" tag declares a referenceable block in the template file. Child template file can reference the
      blocks in parent template by the same tag "afd:block" with extra action declaration: append, insert, override.
      </p>
      <div class="example"><a name="d5e353"></a><p class="title"><b>Example&nbsp;7.2.&nbsp;parent.html</b></p><div class="example-contents">
      <pre class="programlisting">

<span class="hl-tag">&lt;html&gt;</span>   
    <span class="hl-tag">&lt;head&gt;</span>   
        <span class="hl-tag">&lt;afd:block</span> <span class="hl-attribute">id</span>=<span class="hl-value">"block1"</span><span class="hl-tag">&gt;</span>   
            <span class="hl-tag">&lt;link</span> <span class="hl-attribute">href</span>=<span class="hl-value">"parent1.css"</span> <span class="hl-attribute">rel</span>=<span class="hl-value">"stylesheet"</span> <span class="hl-attribute">type</span>=<span class="hl-value">"text/css"</span><span class="hl-tag"> /&gt;</span>   
        <span class="hl-tag">&lt;/afd:block&gt;</span>   
           
        <span class="hl-tag">&lt;afd:block</span> <span class="hl-attribute">id</span>=<span class="hl-value">"block2"</span><span class="hl-tag">&gt;</span>   
            <span class="hl-tag">&lt;link</span> <span class="hl-attribute">href</span>=<span class="hl-value">"parent2.css"</span> <span class="hl-attribute">rel</span>=<span class="hl-value">"stylesheet"</span> <span class="hl-attribute">type</span>=<span class="hl-value">"text/css"</span><span class="hl-tag"> /&gt;</span>   
        <span class="hl-tag">&lt;/afd:block&gt;</span>   
  
        <span class="hl-tag">&lt;title&gt;</span>extension sample<span class="hl-tag">&lt;/title&gt;</span>   
    <span class="hl-tag">&lt;/head&gt;</span>   
    <span class="hl-tag">&lt;body&gt;</span>   
        <span class="hl-tag">&lt;afd:block</span> <span class="hl-attribute">id</span>=<span class="hl-value">"content"</span><span class="hl-tag">&gt;</span>content<span class="hl-tag">&lt;/afd:block&gt;</span>   
    <span class="hl-tag">&lt;/body&gt;</span>   
<span class="hl-tag">&lt;/html&gt;</span> 

      </pre>
      </div></div><br class="example-break">
      <div class="example"><a name="d5e356"></a><p class="title"><b>Example&nbsp;7.3.&nbsp;child.html</b></p><div class="example-contents">
      <pre class="programlisting">

<span class="hl-tag">&lt;afd:extension</span> <span class="hl-attribute">parent</span>=<span class="hl-value">"parent.html"</span><span class="hl-tag">&gt;</span>   

    <span class="hl-tag">&lt;afd:block</span> <span class="hl-attribute">append</span>=<span class="hl-value">"block1"</span><span class="hl-tag">&gt;</span>   
        <span class="hl-tag">&lt;link</span> <span class="hl-attribute">href</span>=<span class="hl-value">"child1.css"</span> <span class="hl-attribute">rel</span>=<span class="hl-value">"stylesheet"</span> <span class="hl-attribute">type</span>=<span class="hl-value">"text/css"</span><span class="hl-tag"> /&gt;</span>   
    <span class="hl-tag">&lt;/afd:block&gt;</span>   
  
    <span class="hl-tag">&lt;afd:block</span> <span class="hl-attribute">insert</span>=<span class="hl-value">"block2"</span><span class="hl-tag">&gt;</span>   
        <span class="hl-tag">&lt;link</span> <span class="hl-attribute">href</span>=<span class="hl-value">"child2.css"</span> <span class="hl-attribute">rel</span>=<span class="hl-value">"stylesheet"</span> <span class="hl-attribute">type</span>=<span class="hl-value">"text/css"</span><span class="hl-tag"> /&gt;</span>   
    <span class="hl-tag">&lt;/afd:block&gt;</span>   
  
    <span class="hl-tag">&lt;afd:block</span> <span class="hl-attribute">override</span>=<span class="hl-value">"content"</span><span class="hl-tag">&gt;</span>   
        <span class="hl-tag">&lt;div&gt;</span>hello<span class="hl-tag">&lt;/div&gt;</span>   
    <span class="hl-tag">&lt;/afd:block&gt;</span>   
  
<span class="hl-tag">&lt;/afd:extension&gt;</span>

      </pre>
      </div></div><br class="example-break">
      <div class="variablelist"><p class="title"><b>Attributes:</b></p><dl class="variablelist"><dt><span class="term">id</span></dt><dd>
            <p>The referenceable id of a block.</p>
          </dd><dt><span class="term">append</span></dt><dd>
            <p>
            Append all the children of current tag to the tail of the parent's block which id equals the declared
            value of the append attribute.
            </p>
          </dd><dt><span class="term">insert</span></dt><dd>
            <p>
            Insert all the children of current tag to the head of the parent's block which id equals the declared
            value of the insert attribute.
            </p>
          </dd><dt><span class="term">override</span></dt><dd>
            <p>
            Override the parent's block which id equals the declared value of the override attribute by all the
            children of current tag.
            </p>
          </dd></dl></div>
      <p class="remark"><em><span class="remark">The result of merging the above two files by Asta4D's template engine can be found at <a class="xref" href="#chapter-Inheritable-template" title="2.&nbsp;Flexible template">Chapter&nbsp;2, <i>Flexible template</i></a>.</span></em></p>
    </div>
    <div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="d5e379"></a>7.1.3.&nbsp;afd:embed</h3></div></div></div>
      
      <p>A "afd:embed" tag declares an action of extracting and inserting an external file's content to the site where
      the "afd:embed" tag is declared.</p>
      <div class="example"><a name="d5e382"></a><p class="title"><b>Example&nbsp;7.4.&nbsp;child.html</b></p><div class="example-contents">
      <pre class="programlisting">

<span class="hl-tag">&lt;afd:extension</span> <span class="hl-attribute">parent</span>=<span class="hl-value">"parent.html"</span><span class="hl-tag">&gt;</span>   
  
    <span class="hl-tag">&lt;afd:block</span> <span class="hl-attribute">override</span>=<span class="hl-value">"content "</span><span class="hl-tag">&gt;</span>   
        <span class="hl-tag">&lt;div&gt;</span>hello<span class="hl-tag">&lt;/div&gt;</span>   
        <span class="hl-tag">&lt;afd:embed</span> <span class="hl-attribute">target</span>=<span class="hl-value">"/templates/embed.html"</span><span class="hl-tag"> &gt;</span><span class="hl-tag">&lt;/afd:embed&gt;</span>   
    <span class="hl-tag">&lt;/afd:block&gt;</span>   
  
<span class="hl-tag">&lt;/afd:extension&gt;</span>  

      </pre>
      </div></div><br class="example-break">
      <div class="variablelist"><p class="title"><b>Attributes:</b></p><dl class="variablelist"><dt><span class="term">target</span></dt><dd>
            <p>The path of which file should be included at the declaration site.</p>
          </dd></dl></div>
      <p class="remark"><em><span class="remark">In the embed target file, afd:block can also be used to append/insert/override the blocks in source template.
      Samples and the merging result can be found at <a class="xref" href="#chapter-Inheritable-template" title="2.&nbsp;Flexible template">Chapter&nbsp;2, <i>Flexible template</i></a>.
      </span></em></p>
    </div>
    <div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="d5e393"></a>7.1.4.&nbsp;afd:snippet</h3></div></div></div>
      
      <p>A "afd:snippet" tag declares an Java class which assumes the duty of rendering data to the html snippet contained
      by the declaring tag.</p>
      <div class="example"><a name="d5e396"></a><p class="title"><b>Example&nbsp;7.5.&nbsp;</b></p><div class="example-contents">
      <pre class="programlisting">

<span class="hl-tag">&lt;afd:snippet</span> <span class="hl-attribute">render</span>=<span class="hl-value">"SimpleSnippet:setProfile"</span><span class="hl-tag">&gt;</span>  
    <span class="hl-tag">&lt;p</span> <span class="hl-attribute">id</span>=<span class="hl-value">"name"</span><span class="hl-tag">&gt;</span>name:<span class="hl-tag">&lt;span&gt;</span>dummy name<span class="hl-tag">&lt;/span&gt;</span><span class="hl-tag">&lt;/p&gt;</span>  
    <span class="hl-tag">&lt;p</span> <span class="hl-attribute">id</span>=<span class="hl-value">"age"</span><span class="hl-tag">&gt;</span>age:<span class="hl-tag">&lt;span&gt;</span>0<span class="hl-tag">&lt;/span&gt;</span><span class="hl-tag">&lt;/p&gt;</span>  
<span class="hl-tag">&lt;/afd:snippet&gt;</span>

      </pre>
      </div></div><br class="example-break">
      <div class="variablelist"><p class="title"><b>Attributes:</b></p><dl class="variablelist"><dt><span class="term">render</span></dt><dd>
            <p>The snippet class name and render method name by format:&lt;class name&gt;:&lt;method name&gt;, the class name
            and the method name are split by colon. If the method name is omitted, the default method name "render" will be used.
            </p>
          </dd><dt><span class="term">parallel</span></dt><dd>
            <p>A snippet tag with "parallel" attribute will be executed in a separated thread from the main thread of current
            http request. It is not necessary to assign a value to this attribute.
            </p>
          </dd><dt><span class="term">clear</span></dt><dd>
            <p>A snippet tag with "clear" attribute will not be executed and will be removed from the final output page. This
            is useful for disabling certain contents temporarily in certain situations such as debug. It is not necessary to assign
            a value to this attribute.
            </p>
          </dd></dl></div>
      <p>
      There is an alternative way to declare a snippet by "afd:render" attribute.
      </p>
      <div class="example"><a name="d5e413"></a><p class="title"><b>Example&nbsp;7.6.&nbsp;</b></p><div class="example-contents">
      <pre class="programlisting">

<span class="hl-tag">&lt;div</span> <span class="hl-attribute">afd:render</span>=<span class="hl-value">"SimpleSnippet:setProfile"</span><span class="hl-tag">&gt;</span>  
    <span class="hl-tag">&lt;p</span> <span class="hl-attribute">id</span>=<span class="hl-value">"name"</span><span class="hl-tag">&gt;</span>name:<span class="hl-tag">&lt;span&gt;</span>dummy name<span class="hl-tag">&lt;/span&gt;</span><span class="hl-tag">&lt;/p&gt;</span>  
    <span class="hl-tag">&lt;p</span> <span class="hl-attribute">id</span>=<span class="hl-value">"age"</span><span class="hl-tag">&gt;</span>age:<span class="hl-tag">&lt;span&gt;</span>0<span class="hl-tag">&lt;/span&gt;</span><span class="hl-tag">&lt;/p&gt;</span>  
<span class="hl-tag">&lt;/div&gt;</span>

      </pre>
      </div></div><br class="example-break">
      <p>By the same way, "afd:paralell" and "afd:clear" can be used on arbitrary html tags which will be treated as the same as
      a "afd:snippet" tag. Note that "afd:paralell" will not be available except the "afd:render" is declared too, but the 
      "afd:clear" will be always available even there is no declaration of "afd:render" on the html tag.
      </p>
    </div>
    <div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="d5e416"></a>7.1.5.&nbsp;afd:group</h3></div></div></div>
      
      <p>A "afd:group" tag declares a referenceable DOM element for back-end Java snippet class. It is useful to reference certain
      text without wrapping html tag or combine a group of coordinate html tags as a single node.</p>
      <div class="example"><a name="d5e419"></a><p class="title"><b>Example&nbsp;7.7.&nbsp;</b></p><div class="example-contents">
      <pre class="programlisting">


<span class="hl-tag">&lt;p&gt;</span>We found <span class="hl-tag">&lt;afd:group</span> <span class="hl-attribute">id</span>=<span class="hl-value">"item-count"</span><span class="hl-tag">&gt;</span>3<span class="hl-tag">&lt;/afd:group&gt;</span> matched items in our database.<span class="hl-tag">&lt;/p&gt;</span> 

<span class="hl-tag">&lt;afd:group</span> <span class="hl-attribute">id</span>=<span class="hl-value">"list-item"</span><span class="hl-tag">&gt;</span>
  <span class="hl-tag">&lt;div</span> <span class="hl-attribute">id</span>=<span class="hl-value">"title"</span><span class="hl-tag">&gt;</span>the title<span class="hl-tag">&lt;/div&gt;</span>
  <span class="hl-tag">&lt;div</span> <span class="hl-attribute">id</span>=<span class="hl-value">"content"</span><span class="hl-tag">&gt;</span>the content<span class="hl-tag">&lt;/div&gt;</span>
<span class="hl-tag">&lt;/afd:group&gt;</span>


      </pre>
      </div></div><br class="example-break">
      <div class="variablelist"><p class="title"><b>Attributes:</b></p><em><span class="remark">None.</span></em><dl class="variablelist"></dl></div>
    </div>
    <div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="d5e424"></a>7.1.6.&nbsp;afd:msg</h3></div></div></div>
      
      <p>A "afd:msg" tag declares a message managed in external files. This tag is mainly designed for i18n support, but
      it also can be used as a simple string replacer. Please see <a class="xref" href="#chapter-detail-i18n" title="13.&nbsp;i18n">Chapter&nbsp;13, <i>i18n</i></a> for more details.</p>
      <div class="example"><a name="d5e428"></a><p class="title"><b>Example&nbsp;7.8.&nbsp;</b></p><div class="example-contents">
      <pre class="programlisting">

<span class="hl-tag">&lt;afd:msg</span> <span class="hl-attribute">key</span>=<span class="hl-value">"search.result.count"</span><span class="hl-tag">&gt;</span><span class="hl-tag">&lt;/afd:message&gt;</span>

      </pre>
      </div></div><br class="example-break">
      <div class="variablelist"><p class="title"><b>Attributes:</b></p><dl class="variablelist"><dt><span class="term">key</span></dt><dd>
            <p>The message key which should can be found in the configured message file.</p>
          </dd></dl></div>
    </div>
  </div>
  <div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d5e436"></a>7.2.&nbsp;Additional</h2></div></div></div>
    
    <div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
        <p>HTML5 convention</p>
        <p>
        Asta4D's template engine does only support html5, which relies on the underline library <a class="ulink" href="http://jsoup.org" target="_top">jsoup(verion 1.6.3)</a>.
        jsoup implements the <a class="ulink" href="http://whatwg.org/html" target="_top">WHATWG HTML5</a> specification and requires compliance from the target file.
        jsoup can fix some cases of breaking specification but you would still get unexpected result for certain cases. Basically, you should take care
        of the following things:
        </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><p>All tags and attributes are converted to lower case.</p></li><li class="listitem"><p>Self closed tags such as &lt;div /&gt; or &lt;afd:embed target="embed.html" /&gt; is not legal.</p></li><li class="listitem"><p>There are some tags that the parser "ensures".For example a &lt;tbody&gt; tag must be the first tag inside &lt;table&gt;, which
          breas the following example:</p>
            <div class="example"><a name="d5e451"></a><p class="title"><b>Example&nbsp;7.9.&nbsp;</b></p><div class="example-contents">
            <pre class="programlisting">

<span class="hl-tag">&lt;table&gt;</span>
<span class="hl-tag">&lt;afd:snippet</span> <span class="hl-attribute">render</span>=<span class="hl-value">"ListSnippet"</span><span class="hl-tag">&gt;</span>
<span class="hl-tag">&lt;tr&gt;</span><span class="hl-tag">&lt;td&gt;</span><span class="hl-tag">&lt;/td&gt;</span><span class="hl-tag">&lt;/tr&gt;</span>
<span class="hl-tag">&lt;/afd:snippet&gt;</span>
<span class="hl-tag">&lt;/table&gt;</span> 

            </pre>
            </div></div><br class="example-break">
            <p>But it can be replaced by the following:</p>
            <div class="example"><a name="d5e454"></a><p class="title"><b>Example&nbsp;7.10.&nbsp;</b></p><div class="example-contents">
            <pre class="programlisting">

<span class="hl-tag">&lt;table&gt;</span>
<span class="hl-tag">&lt;tr</span> <span class="hl-attribute">afd:render</span>=<span class="hl-value">"ListSnippet"</span><span class="hl-tag">&gt;</span><span class="hl-tag">&lt;td&gt;</span><span class="hl-tag">&lt;/td&gt;</span><span class="hl-tag">&lt;/tr&gt;</span>
<span class="hl-tag">&lt;/table&gt;</span> 

            </pre>
            </div></div><br class="example-break">
          </li></ul></div><p>
        </p>
      </li><li class="listitem">
        <p>body convention</p>
        <p>When a child template file uses "afd:extension" to declare its parent template, only the body part(all the 
        children of the body except the body tag itself) of the child template will be processed by the template engine 
        and the parts out of body will be ignored simply. The same convention is applied to the embed target file. The 
        following two sample will not cause different results by Asta4D.</p>
        <div class="example"><a name="d5e459"></a><p class="title"><b>Example&nbsp;7.11.&nbsp;child.html without body tag:</b></p><div class="example-contents">
        <pre class="programlisting">

<span class="hl-tag">&lt;afd:extension</span> <span class="hl-attribute">parent</span>=<span class="hl-value">"parent.html"</span><span class="hl-tag">&gt;</span>   
  
    <span class="hl-tag">&lt;afd:block</span> <span class="hl-attribute">override</span>=<span class="hl-value">"content "</span><span class="hl-tag">&gt;</span>   
        <span class="hl-tag">&lt;div&gt;</span>hello<span class="hl-tag">&lt;/div&gt;</span>   
        <span class="hl-tag">&lt;afd:embed</span> <span class="hl-attribute">target</span>=<span class="hl-value">"/templates/embed.html"</span><span class="hl-tag"> &gt;</span><span class="hl-tag">&lt;/afd:embed&gt;</span>   
    <span class="hl-tag">&lt;/afd:block&gt;</span>   
  
<span class="hl-tag">&lt;/afd:extension&gt;</span>  

        </pre>
        </div></div><br class="example-break">
        <div class="example"><a name="child-with-body-tag"></a><p class="title"><b>Example&nbsp;7.12.&nbsp;child.html with body tag:</b></p><div class="example-contents">
        <pre class="programlisting">

<span class="hl-tag">&lt;html&gt;</span>
<span class="hl-tag">&lt;head&gt;</span>
<span class="hl-tag">&lt;meta</span> <span class="hl-attribute">charset</span>=<span class="hl-value">"UTF-8"</span><span class="hl-tag">&gt;</span>
<span class="hl-tag">&lt;/head&gt;</span>
<span class="hl-tag">&lt;body&gt;</span>
<span class="hl-tag">&lt;afd:extension</span> <span class="hl-attribute">parent</span>=<span class="hl-value">"parent.html"</span><span class="hl-tag">&gt;</span>   
  
    <span class="hl-tag">&lt;afd:block</span> <span class="hl-attribute">override</span>=<span class="hl-value">"content "</span><span class="hl-tag">&gt;</span>   
        <span class="hl-tag">&lt;div&gt;</span>hello<span class="hl-tag">&lt;/div&gt;</span>   
        <span class="hl-tag">&lt;afd:embed</span> <span class="hl-attribute">target</span>=<span class="hl-value">"/templates/embed.html"</span><span class="hl-tag"> &gt;</span><span class="hl-tag">&lt;/afd:embed&gt;</span>   
    <span class="hl-tag">&lt;/afd:block&gt;</span>   
  
<span class="hl-tag">&lt;/afd:extension&gt;</span>
<span class="hl-tag">&lt;/body&gt;</span>
<span class="hl-tag">&lt;/html&gt;</span>  

        </pre>
        </div></div><br class="example-break">
        <p>
        This convention can be used for editor compatibility in case of your prefer html editor requires correct meta information
        (We add charset="UTF-8" to all of our template files for this reason). Note that this convention is only available on extended
        child template file or embedded target file, the parts out of body tag will be processed normally in the parent template file
        which is as a root template without further parent.
        </p>
        <p>
        Further, explicit parameter information can be commented at body tag in parameterizable embed target file for better source
        readability.
        </p>
        <div class="example"><a name="embed-with-parameter-declaring"></a><p class="title"><b>Example&nbsp;7.13.&nbsp;embed.html</b></p><div class="example-contents">
          <pre class="programlisting">

<span class="hl-tag">&lt;html&gt;</span>
<span class="hl-tag">&lt;head&gt;</span><span class="hl-tag">&lt;meta</span> <span class="hl-attribute">charset</span>=<span class="hl-value">"UTF-8"</span><span class="hl-tag">&gt;</span><span class="hl-tag">&lt;/head&gt;</span>
<span class="hl-tag">&lt;body</span> <span class="hl-attribute">itemsize</span>=<span class="hl-value">"{Integer}"</span> <span class="hl-attribute">itemlist</span>=<span class="hl-value">"{List}"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;afd:block</span> <span class="hl-attribute">append</span>=<span class="hl-value">"block1"</span><span class="hl-tag">&gt;</span>   
        <span class="hl-tag">&lt;link</span> <span class="hl-attribute">href</span>=<span class="hl-value">"embed.css"</span> <span class="hl-attribute">rel</span>=<span class="hl-value">"stylesheet"</span> <span class="hl-attribute">type</span>=<span class="hl-value">"text/css"</span><span class="hl-tag"> /&gt;</span>   
    <span class="hl-tag">&lt;/afd:block&gt;</span>   
    <span class="hl-tag">&lt;div&gt;</span>good embed<span class="hl-tag">&lt;/div&gt;</span>   
<span class="hl-tag">&lt;/body&gt;</span>
<span class="hl-tag">&lt;/html&gt;</span>

          </pre>
          <p>
            In <a class="xref" href="#embed-with-parameter-declaring" title="Example&nbsp;7.13.&nbsp;embed.html">Example&nbsp;7.13, &#8220;embed.html&#8221;</a>, we put some "strange" information in the body tag, which suggests that
            when this file is embedded, it requires an Integer parameter named "itemsize" and a List parameter named "itemlist". Note
            that such declaration can only be regarded as a hint for source reader and there is no warranty about any parameter check.
            You should consider it as a sample of how you can make interesting use of the body convention.
          </p>
        </div></div><br class="example-break">
        <br>
      </li><li class="listitem">
        <p>"afd" name space</p>
        <p>The "afd" name space is configured as the default name space of Asta4D's special tags. This name space can be
        changed by Configuration#setTagNameSpace.</p>
        <br>
      </li><li class="listitem">
        <p>TemplateResolver</p>
        <p>Asta4D searches certain template file by configured TemplateResolver. There are three pre-implemented TemplateResolver:
        FileTemplateResolver, ClasspathTemplateResolver and WebApplicationTemplateResolver. The default configured WebApplicationTemplateResolver
        will search template files with awareness of servlet container. The FileTemplateResolver and ClasspathTemplateResolver
        can be used for test purpose, you can also provide your own TemplateResolver for special search mechanism.
        </p>
      </li></ul></div>
  </div>

</div>
    <div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="chapter-detail-snippet"></a>8.&nbsp;Details of snippet class</h2></div></div></div>
  
  
  <div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d5e482"></a>8.1.&nbsp;Rendering APIs</h2></div></div></div><div class="toc"><p><b>Table of Contents</b></p><dl class="toc"><dt><span class="sect2"><a href="#d5e486">8.1.1. Create and add Renderer instance</a></span></dt><dt><span class="sect2"><a href="#d5e502">8.1.2. CSS Selector</a></span></dt><dt><span class="sect2"><a href="#d5e638">8.1.3. Render text</a></span></dt><dt><span class="sect2"><a href="#d5e646">8.1.4. Render DOM attribution</a></span></dt><dt><span class="sect2"><a href="#d5e683">8.1.5. Clear an Element</a></span></dt><dt><span class="sect2"><a href="#d5e690">8.1.6. Render raw Element</a></span></dt><dt><span class="sect2"><a href="#d5e697">8.1.7. Arbitrary rendering for an Element</a></span></dt><dt><span class="sect2"><a href="#d5e707">8.1.8. Recursive rendering</a></span></dt><dt><span class="sect2"><a href="#d5e712">8.1.9. Debug renderer</a></span></dt><dt><span class="sect2"><a href="#d5e718">8.1.10. Missing selector warning</a></span></dt><dt><span class="sect2"><a href="#d5e726">8.1.11. List rendering</a></span></dt></dl></div>
    
    <p>Asta4D provides various rendering APIs to help developers render value to the page. By those APIs, developer can render
    text under a DOM element, set the attribute value for a DOM element, also can convert a list data to a list of DOM element,
    and also other various manipulation on DOM elements.
    </p>
    
    <div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="d5e486"></a>8.1.1.&nbsp;Create and add Renderer instance</h3></div></div></div>
      
      <p>There are almost same two sets of overloaded methods: create and add. The create methods are static and can be
      used to create a Renderer instance. The add methods are instance methods and can be used to add a implicitly created
      Renderer instance to an existing Renderer instance. Both of the create and add methods return the created Renderer
      instance therefore chain invoking can be performed as well.</p>
      <div class="example"><a name="d5e489"></a><p class="title"><b>Example&nbsp;8.1.&nbsp;</b></p><div class="example-contents">
        <pre class="programlisting">


Renderer renderer = Renderer.create(<span class="hl-string">"#someId"</span>, <span class="hl-string">"xyz"</span>).add(<span class="hl-string">"sometag"</span>, <span class="hl-string">"hello"</span>);
renderer.add(<span class="hl-string">".someclass"</span>, <span class="hl-string">"abc"</span>).add(<span class="hl-string">".someclass2"</span>, <span class="hl-string">"abc2"</span>);

Renderer renderer2 = Renderer.create(<span class="hl-string">"#someId2"</span>, <span class="hl-string">"xyz2"</span>);
Renderer renderer3 = Renderer.create(<span class="hl-string">"#someId3"</span>, <span class="hl-string">"xyz3"</span>);

<span class="hl-comment">//add renderer2 and renderer3 to renderer</span>
renderer.add(renderer2);
renderer.add(renderer3);

        </pre>
      </div></div><br class="example-break">
      <p>Note that the order of a Renderer instance being added is significant but the target instance which a Renderer
      is added to has no effect on the rendering order. In the following example, "add renderer2 to renderer then add renderer3 to renderer2"
      is completely equal to "add renderer2 and renderer3 to renderer" at above example.
      </p>
      <div class="example"><a name="d5e492"></a><p class="title"><b>Example&nbsp;8.2.&nbsp;</b></p><div class="example-contents">
        <pre class="programlisting">


<span class="hl-comment">//add renderer2 to renderer then add renderer3 to renderer2</span>
renderer.add(renderer2);
renderer2.add(renderer3);


        </pre>
      </div></div><br class="example-break">
      <p>The following is equal too:</p>
      <div class="example"><a name="d5e495"></a><p class="title"><b>Example&nbsp;8.3.&nbsp;</b></p><div class="example-contents">
        <pre class="programlisting">


<span class="hl-comment">//add renderer3 to renderer2 then add renderer2 to renderer</span>
renderer2.add(renderer3);
renderer.add(renderer2);


        </pre>
      </div></div><br class="example-break">
      <p>A instance of Renderer should not be considered as a single rendering declaration only, A instance of Renderer is exactly a
      rendering chain holder, you can call add method on any instance of the chain but the added Renderer instance will be always added
      to the tail of the chain. If the added Renderer instance is holding over than one Renderer instance in its own chain, the held chain
      will be added to the tail of the chain of the target Renderer.</p>
      
      <p>There is also a non-parameter create method which can by used to create a "do nothing" Renderer for source convenience. In our
      practice, we write the following line at the beginning of most of our snippet methods.</p>
      <div class="example"><a name="d5e499"></a><p class="title"><b>Example&nbsp;8.4.&nbsp;</b></p><div class="example-contents">
        <pre class="programlisting">

Renderer renderer = Renderer.create();

        </pre>
      </div></div><br class="example-break">
      
      <p>In following sections, we will introduce add method only, but you should remember that there should be a equal create method for most
      cases. You can also read the Java doc of Renderer for more details.</p>
    </div>
    <div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="d5e502"></a>8.1.2.&nbsp;CSS Selector</h3></div></div></div>
      
      <p>Asta4D is using a modified version of <a class="ulink" href="http://jsoup.org/" target="_top">jsoup library</a> to afford CSS selector function.
      Currently, we support the following selectors:
      </p>
      
      <div class="table"><a name="d5e506"></a><p class="title"><b>Table&nbsp;8.1.&nbsp;Supported selectors</b></p><div class="table-contents">
      <table summary="Supported selectors" style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col align="left" class="c1"><col align="left" class="c2"><col align="left" class="c3"></colgroup><thead><tr><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">Pattern</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">Matches</th><th style="border-bottom: 0.5pt solid ; " align="left">Example</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">*</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">any element</td><td style="border-bottom: 0.5pt solid ; " align="left">*</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">tag</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">elements with the given tag name</td><td style="border-bottom: 0.5pt solid ; " align="left">div</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">ns|E</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">elements of type E in the namespace ns</td><td style="border-bottom: 0.5pt solid ; " align="left">fb|name finds &lt;fb:name&gt; elements</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">#id</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">elements with attribute ID of "id"</td><td style="border-bottom: 0.5pt solid ; " align="left">div#wrap, #logo</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">.class</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">elements with a class name of "class"</td><td style="border-bottom: 0.5pt solid ; " align="left">div.left, .result</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">[attr]</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">elements with an attribute named "attr" (with any value)</td><td style="border-bottom: 0.5pt solid ; " align="left">a[href], [title]</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">[^attrPrefix]</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">elements with an attribute name starting with "attrPrefix". Use to find elements with HTML5 datasets</td><td style="border-bottom: 0.5pt solid ; " align="left">[^data-], div[^data-]</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">[attr=val]</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">elements with an attribute named "attr", and value equal to "val"</td><td style="border-bottom: 0.5pt solid ; " align="left">img[width=500], a[rel=nofollow]</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">[attr^=valPrefix]</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">elements with an attribute named "attr", and value starting with "valPrefix"</td><td style="border-bottom: 0.5pt solid ; " align="left">a[href^=http:]</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">[attr$=valSuffix]</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">elements with an attribute named "attr", and value ending with "valSuffix"</td><td style="border-bottom: 0.5pt solid ; " align="left">img[src$=.png]</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">[attr*=valContaining]</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">elements with an attribute named "attr", and value containing "valContaining"</td><td style="border-bottom: 0.5pt solid ; " align="left">a[href*=/search/]</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">[attr~=regex]</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">elements with an attribute named "attr", and value matching the regular expression</td><td style="border-bottom: 0.5pt solid ; " align="left">img[src~=(?i)\\.(png|jpe?g)]</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">The above may be combined in any order</td><td style="border-bottom: 0.5pt solid ; " align="left">div.header[title]</td></tr><tr><td style="border-bottom: 0.5pt solid ; " rowspan="2" colspan="3" align="center" valign="bottom"><span class="emphasis"><em>Combinators</em></span></td></tr><tr><!-- This row intentionally left blank --></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">E &gt; F</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">an F direct child of E</td><td style="border-bottom: 0.5pt solid ; " align="left">ol &gt; li</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">E + F</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">an F element immediately preceded by sibling E</td><td style="border-bottom: 0.5pt solid ; " align="left">li + li, div.head + div</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">E ~ F</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">an F element preceded by sibling E</td><td style="border-bottom: 0.5pt solid ; " align="left">h1 ~ p</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">E, F, G</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">all matching elements E, F, or G</td><td style="border-bottom: 0.5pt solid ; " align="left">a[href], div, h3</td></tr><tr><td style="border-bottom: 0.5pt solid ; " rowspan="2" colspan="3" align="center" valign="bottom"><span class="emphasis"><em>Pseudo selectors</em></span></td></tr><tr><!-- This row intentionally left blank --></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">:gt(n)</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">elements whose sibling index is greater than n</td><td style="border-bottom: 0.5pt solid ; " align="left">td:gt(1) finds cells after skipping the first two</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">:eq(n)</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">elements whose sibling index is equal to n</td><td style="border-bottom: 0.5pt solid ; " align="left">td:eq(0) finds the first cell of each row</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">:has(selector)</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">elements that contains at least one element matching the selector</td><td style="border-bottom: 0.5pt solid ; " align="left">div:has(p) finds divs that contain p elements</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">:not(selector)</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">elements that do not match the selector. See also Elements.not(String)</td><td style="border-bottom: 0.5pt solid ; " align="left">
            <p>div:not(.logo) finds all divs that do not have the "logo" class.</p>
            <p>div:not(:has(div)) finds divs that do not contain divs.</p>
          </td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">:contains(text)</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">elements that contains the specified text. The search is case insensitive. The text may appear in the found element, or any of its descendants.</td><td style="border-bottom: 0.5pt solid ; " align="left">p:contains(jsoup) finds p elements containing the text "jsoup".</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">:matches(regex)</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">elements whose text matches the specified regular expression. The text may appear in the found element, or any of its descendants.</td><td style="border-bottom: 0.5pt solid ; " align="left">td:matches(\\d+) finds table cells containing digits. div:matches((?i)login) finds divs containing the text, case insensitively.</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">:containsOwn(text)</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">elements that directly contains the specified text. The search is case insensitive. The text must appear in the found element, not any of its descendants.</td><td style="border-bottom: 0.5pt solid ; " align="left">p:containsOwn(jsoup) finds p elements with own text "jsoup".</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">:matchesOwn(regex)</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">elements whose own text matches the specified regular expression. The text must appear in the found element, not any of its descendants.</td><td style="border-bottom: 0.5pt solid ; " align="left">td:matchesOwn(\\d+) finds table cells directly containing digits. div:matchesOwn((?i)login) finds divs containing the text, case insensitively.</td></tr><tr><td style="border-right: 0.5pt solid ; " align="left">&nbsp;</td><td style="border-right: 0.5pt solid ; " align="left">The above may be combined in any order and with other selectors</td><td style="" align="left">.light:contains(name):eq(0)</td></tr></tbody></table>
      </div></div><br class="table-break">
      
    </div>
    <div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="d5e638"></a>8.1.3.&nbsp;Render text</h3></div></div></div>
      
      <p>add(String selector, String value) can be used to render a text under the element specified by given selector.
      All child nodes of the target element specified by selector will be emptied and the given String value will be rendered as a single
      text node of the target element.</p>
      <div class="example"><a name="d5e641"></a><p class="title"><b>Example&nbsp;8.5.&nbsp;</b></p><div class="example-contents">
        <pre class="programlisting">

renderer.add(<span class="hl-string">"#someId"</span>, <span class="hl-string">"xyz"</span>);

        </pre>
      </div></div><br class="example-break">
      <p>Long/long, Integer/int, Boolean/boolean will be treated as text rendering too.</p>
      <div class="example"><a name="d5e644"></a><p class="title"><b>Example&nbsp;8.6.&nbsp;</b></p><div class="example-contents">
        <pre class="programlisting">

renderer.add(<span class="hl-string">"#someIdForLong"</span>, <span class="hl-number">123L</span>);
renderer.add(<span class="hl-string">"#someIdForInt"</span>, <span class="hl-number">123</span>);
renderer.add(<span class="hl-string">"#someIdForBool"</span>, true);

        </pre>
      </div></div><br class="example-break">
    </div>
    <div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="d5e646"></a>8.1.4.&nbsp;Render DOM attribution</h3></div></div></div>
      
      <p>add(String selector, String attr, String value) can be used to render attribute value of a DOM element. There are some rules will
      be applied for the pattern of specified "attr" and "value":</p>
      <div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
          <p>add("+class", value)</p>
          <p>call addClass(value) on target Element, null value will be treated as "null".</p>
        </li><li class="listitem">
          <p>add("-class", value)</p>
          <p>call removeClass(value) on target Element, null value will be treated as "null".</p>
        </li><li class="listitem">
          <p>add("class", value)</p>
          <p>call attr("class", value) on target Element if value is not null, for a null value, removeAttr("class") will be called.</p>
        </li><li class="listitem">
          <p>add("anyattr", value)</p>
          <p>call attr("anyattr", value) on target Element if value is not null, for a null value, removeAttr("anyattr") will be called.</p>
        </li><li class="listitem">
          <p>add("anyattr", SpecialRenderer.Clear)</p>
          <p>call removeAttr("anyattr") on target Element.</p>
        </li><li class="listitem">
          <p>add("+anyattr", value)</p>
          <p>call attr("anyattr", value) on target Element if value is not null, for a null value, removeAttr("anyattr") will be called.</p>
        </li><li class="listitem">
          <p>add("+anyattr", SpecialRenderer.Clear)</p>
          <p>call removeAttr("anyattr") on target Element.</p>
        </li><li class="listitem">
          <p>add("-anyattr", value)</p>
          <p>call removeAttr("anyattr") on target Element.</p>
        </li></ul></div>
      
      <p>There is also an add method for attribution rendering that accepts arbitrary data as Object type: add(String selector, String attr, Object value).
      When the "value" is specified as a non-string value and the "attr" is specified as "+class" or "-class", A IllegalArgumentException will be thrown.
      When an arbitrary Object value is rendered to attribute by such method, an internal object reference id will be rendered to the target attribute
      instead of the original object since it cannot be treated as attribute string value directly. The object reference id can be used by variable injection
      for the nested snippet rendering. See the following example, we pass a Date instance to the nested snippet method:
      </p>
      
      <div class="example"><a name="d5e675"></a><p class="title"><b>Example&nbsp;8.7.&nbsp;</b></p><div class="example-contents">
        <pre class="programlisting">

<span class="hl-tag">&lt;div</span> <span class="hl-attribute">afd:render</span>=<span class="hl-value">"MySnippet:outer"</span><span class="hl-tag">&gt;</span>
  <span class="hl-tag">&lt;div</span> <span class="hl-attribute">id</span>=<span class="hl-value">"inner"</span> <span class="hl-attribute">afd:render</span>=<span class="hl-value">"MySnippet:inner"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;span</span> <span class="hl-attribute">id</span>=<span class="hl-value">"current-date"</span><span class="hl-tag">&gt;</span><span class="hl-tag">&lt;/span&gt;</span>
  <span class="hl-tag">&lt;/div&gt;</span>
<span class="hl-tag">&lt;/div&gt;</span>

        </pre>
        <pre class="programlisting">

<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> MySnippet{

    <span class="hl-keyword">public</span> Renderer outer(){
        <span class="hl-keyword">return</span> Renderer.create(<span class="hl-string">"#innder"</span>, <span class="hl-string">"now"</span>, <span class="hl-keyword">new</span> Date());
    }
    
    <span class="hl-keyword">public</span> Renderer inner(Date now){
        <span class="hl-keyword">return</span> Renderer.create(<span class="hl-string">"#current-date"</span>, now);
    }
}

        </pre>
      </div></div><br class="example-break">
      
      <p>This mechanism can be used for parametrized embedding too. Parameters can be specified by attribution rendering 
      in the snippet method of parent template file and can be retrieved by the snippet method of child template file as same
      as the above example.
      </p>
      
      <div class="example"><a name="d5e679"></a><p class="title"><b>Example&nbsp;8.8.&nbsp;</b></p><div class="example-contents">
        <pre class="programlisting">

<span class="hl-comment">&lt;!-- parent template --&gt;</span>
<span class="hl-tag">&lt;div</span> <span class="hl-attribute">afd:render</span>=<span class="hl-value">"MySnippet:outer"</span><span class="hl-tag">&gt;</span>
  <span class="hl-tag">&lt;afd:embed</span> <span class="hl-attribute">id</span>=<span class="hl-value">"inner"</span> <span class="hl-attribute">target</span>=<span class="hl-value">"child.html"</span><span class="hl-tag">&gt;</span><span class="hl-tag">&lt;/afd:embed&gt;</span>
<span class="hl-tag">&lt;/div&gt;</span>

        </pre>
        <pre class="programlisting">

<span class="hl-comment">&lt;!-- child template --&gt;</span>
  <span class="hl-tag">&lt;div</span> <span class="hl-attribute">afd:render</span>=<span class="hl-value">"MySnippet:embed"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;span</span> <span class="hl-attribute">id</span>=<span class="hl-value">"current-date"</span><span class="hl-tag">&gt;</span><span class="hl-tag">&lt;/span&gt;</span>
  <span class="hl-tag">&lt;/div&gt;</span>

        </pre>
        <pre class="programlisting">

<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> MySnippet{

    <span class="hl-keyword">public</span> Renderer outer(){
        <span class="hl-keyword">return</span> Renderer.create(<span class="hl-string">"#innder"</span>, <span class="hl-string">"now"</span>, <span class="hl-keyword">new</span> Date());
    }
    
    <span class="hl-keyword">public</span> Renderer embed(Date now){
        <span class="hl-keyword">return</span> Renderer.create(<span class="hl-string">"#current-date"</span>, now);
    }
}

        </pre>
      </div></div><br class="example-break">
      
    </div>
    <div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="d5e683"></a>8.1.5.&nbsp;Clear an Element</h3></div></div></div>
      
      <p>On all the rendering methods, if the specified value is null, the target element will be removed. And there is also
      an enumeration value of SpecialRenderer.Clear which can be used to declare a remove operation for an element too.</p>
      <div class="example"><a name="d5e686"></a><p class="title"><b>Example&nbsp;8.9.&nbsp;</b></p><div class="example-contents">
        <pre class="programlisting">

<span class="hl-comment">//if the String value is null, the target element will be removed</span>
String txt = null;
Renderer.create(<span class="hl-string">"#someId"</span>, txt);

        </pre>
        <pre class="programlisting">

<span class="hl-keyword">import</span> <span class="hl-keyword">static</span> com.astamuse.asta4d.render.SpecialRenderer.Clear

Renderer.create(<span class="hl-string">"#someId"</span>, Clear);

        </pre>
      </div></div><br class="example-break">
      <p class="remark"><em><span class="remark">Note that on the attribute rendering methods, if null value or SpecialRenderer.Clear are specified, as we mentioned in
      the previous section, the target attribute will be removed and the target element will remain.</span></em></p>
    </div>
    <div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="d5e690"></a>8.1.6.&nbsp;Render raw Element</h3></div></div></div>
      
      <p>An existing DOM element can be replaced by a new element by specifying the new element as the rendering value. The new element
      can be generated by DOM APIs or simply parsed from raw html source.</p>
      <div class="example"><a name="d5e693"></a><p class="title"><b>Example&nbsp;8.10.&nbsp;</b></p><div class="example-contents">
        <pre class="programlisting">


Renderer renderer = Renderer.create();

Element ul = <span class="hl-keyword">new</span> Element(Tag.valueOf(<span class="hl-string">"ul"</span>), <span class="hl-string">""</span>);
List&lt;Node&gt; lis = <span class="hl-keyword">new</span> ArrayList&lt;&gt;();
ul.appendChild(<span class="hl-keyword">new</span> Element(Tag.valueOf(<span class="hl-string">"li"</span>), <span class="hl-string">""</span>).appendText(<span class="hl-string">"This text is created by snippet.(1)"</span>));
ul.appendChild(<span class="hl-keyword">new</span> Element(Tag.valueOf(<span class="hl-string">"li"</span>), <span class="hl-string">""</span>).appendText(<span class="hl-string">"This text is created by snippet.(2)"</span>));
ul.appendChild(<span class="hl-keyword">new</span> Element(Tag.valueOf(<span class="hl-string">"li"</span>), <span class="hl-string">""</span>).appendText(<span class="hl-string">"This text is created by snippet.(3)"</span>));

renderer.add(<span class="hl-string">"#someId"</span>, ul);

String html = <span class="hl-string">"&lt;a href=\"https://github.com/astamuse/asta4d\"&gt;asta4d hp&lt;/a&gt;"</span>;
renderer.add(<span class="hl-string">"#hp-link"</span>, ElementUtil.parseAsSingle(html));


        </pre>
      </div></div><br class="example-break">
      
      <p>There are several utility methods in ElementUtil that can help you operate DOM easier.</p>
      <p class="remark"><em><span class="remark">ElementUtil#parseAsSingle would cause potential cross-site issues, so take care of it and make sure that you have escaped
      all the raw html source correctly. Since Asta4D has provided plenty of rendering methods, you should try your best to avoid
      create element from raw html source. If you have to do something on raw element level, your first option should be DOM APIs
      and parsing raw html source should be your last alternative.</span></em></p>
    </div>
    <div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="d5e697"></a>8.1.7.&nbsp;Arbitrary rendering for an Element</h3></div></div></div>
      
      <p>Sometimes you will want to access the rendering target on raw element level and Asta4D allow you access the rendering
      target element by the interface of ElementSetter. ElementSetter asks the implementation of a callback method "set(Element elem)".
      As a matter of fact, the text rendering and attribute rendering are achieved by built-in implementation of ElementSetter(TextSetter
      and AttributeSetter).There is also another built-in ElementSetter implementation called ChildReplacer which can replace the children of rendering target
      by given element.</p>
      
      <div class="example"><a name="d5e700"></a><p class="title"><b>Example&nbsp;8.11.&nbsp;source of ChildReplacer</b></p><div class="example-contents">
        <pre class="programlisting">


<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> ChildReplacer <span class="hl-keyword">implements</span> ElementSetter {

    <span class="hl-keyword">private</span> Element newChild;

    <strong class="hl-tag" style="color: blue">/**
     * Constructor
     * 
     * @param newChild
     *            the new child node
     */</strong>
    <span class="hl-keyword">public</span> ChildReplacer(Element newChild) {
        <span class="hl-keyword">this</span>.newChild = newChild;
    }

    <em><span class="hl-annotation" style="color: gray">@Override</span></em>
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> set(Element elem) {
        elem.empty();
        elem.appendChild(newChild);
    }
}

        </pre>
      </div></div><br class="example-break">
      <p>You can regard the built-in TextSetter, AttributeSetter and ChildReplacer as
      reference implementation in case of you need implement your own ElementSetter. Following example shows how to use ChildReplacer
      or declare an anonymous class for ElementSetter on rendering.</p>
      
      <div class="example"><a name="d5e704"></a><p class="title"><b>Example&nbsp;8.12.&nbsp;</b></p><div class="example-contents">
        <pre class="programlisting">


Renderer renderer = Renderer.create();

renderer.add(<span class="hl-string">"#someId"</span>, <span class="hl-keyword">new</span> ChildReplacer(ElementUtil.parseAsSingle(<span class="hl-string">"&lt;div&gt;aaa&lt;/div&gt;"</span>)));

renderer.add(<span class="hl-string">"#someNode"</span>, <span class="hl-keyword">new</span> ElementSetter(){
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> set(Element elem) {
        <span class="hl-keyword">if</span>(elem.tagName().equals(<span class="hl-string">"div"</span>)){
            elem.addClass(<span class="hl-string">"someClass);
</span>        }
    }
});


        </pre>
      </div></div><br class="example-break">

      <p class="remark"><em><span class="remark">On element level, you can also parse element by Element#html(String html) method which will also cause potential
      cross-site issues. As same as the raw element rendering, parsing raw html source should be your last alternative.</span></em></p>
    </div>
    <div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="d5e707"></a>8.1.8.&nbsp;Recursive rendering</h3></div></div></div>
      
      <p>For a snippet method, the returned Renderer will be applied to the target element which declares the current snippet method.
      In the returned Renderer chain, you can also specify recursive Renderer which is only applied to the element specified by given
      CSS selector.</p>
      <div class="example"><a name="d5e710"></a><p class="title"><b>Example&nbsp;8.13.&nbsp;</b></p><div class="example-contents">
        <pre class="programlisting">

Renderer.create(<span class="hl-string">"#someId"</span>, Renderer.create(<span class="hl-string">"a"</span>, <span class="hl-string">"href"</span>, <span class="hl-string">"https://github.com/astamuse/asta4d"</span>));

        </pre>
      </div></div><br class="example-break">
    </div>
    <div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="d5e712"></a>8.1.9.&nbsp;Debug renderer</h3></div></div></div>
      
      <p>Because the Renderer is applied after your snippet method finished, it is difficult to debug if there is something wrong. Asta4D
      affords rendering debug function too. There are two overloaded debug method, one accepts a log message only and another accepts a log
      message and a selector. The debug renderer will output the current status of rendering target element to log file, if the selector is
      not specified, the whole rendering target of current snippet method will be output, if the selector is specified, only the matched child
      elements will be output. Log level can be configured by "com.astamuse.asta4d.render.DebugRenderer".</p>
      <div class="example"><a name="d5e715"></a><p class="title"><b>Example&nbsp;8.14.&nbsp;</b></p><div class="example-contents">
        <pre class="programlisting">


<span class="hl-comment">//the whole target rendering target will be output before and after</span>

renderer.addDebugger(<span class="hl-string">"before render value"</span>);

renderer.add(<span class="hl-string">"#someId"</span>, value);

renderer.addDebugger(<span class="hl-string">"after render value"</span>);


<span class="hl-comment">//only the a tag element will be output before and after</span>

renderer.addDebugger(<span class="hl-string">"before render value for link"</span>, <span class="hl-string">"a"</span>);

renderer.add(<span class="hl-string">"a"</span>, <span class="hl-string">"href"</span>, url);

renderer.addDebugger(<span class="hl-string">"after render value for link"</span>, <span class="hl-string">"a"</span>);


        </pre>
        <em><span class="remark">If you specified a selector on debugger but do not get any output, it usually means you specified wrong selector or the target
        element has been removed by previous rendering or outer snippet rendering.</span></em>
      </div></div><br class="example-break">
    </div>
    <div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="d5e718"></a>8.1.10.&nbsp;Missing selector warning</h3></div></div></div>
      
      <p>If your specified selector on rendering method cannot match any element, Asta4D will output a warning message to log as <em><span class="remark">"There is no element 
      found for selector [#someId] at [ com.astamuse.asta4d.test.render.RenderingTest$TestRender.classAttrSetting(RenderingTest.java:73) ], if it is 
      deserved, try Renderer#disableMissingSelectorWarning() to disable this message and Renderer#enableMissingSelectorWarning could enable this 
      warning again in your renderer chain"</span></em>.</p>
      <p>Note that the place where the missing selector declared is output to log too, which is disabled by default since it is expensive on production
      environment. You can enable the source row number output by Configuration#setSaveCallstackInfoOnRendererCreation.</p>
      <p>Sometimes, the missing selector may be designed by your logic, you can disable the warning message on your rendering chain temporarily as
      following:</p>
      <div class="example"><a name="d5e724"></a><p class="title"><b>Example&nbsp;8.15.&nbsp;</b></p><div class="example-contents">
        <pre class="programlisting">


renderer.disableMissingSelectorWarning();

renderer.add(<span class="hl-string">"#notExistsId"</span>, <span class="hl-string">"abc"</span>);

renderer.enableMissingSelectorWarning();

        </pre>
      </div></div><br class="example-break">
    </div>
    <div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="d5e726"></a>8.1.11.&nbsp;List rendering</h3></div></div></div>
      
      <p>Asta4D does not only allow you to rendering single value to an element, but also allow you to duplicate elements by list data, which is
      usually used to perform list rendering. java.lang.Iterable of String/Integer/Long/Boolean can be rendered directly as text rendering:</p>
      
      <div class="example"><a name="d5e729"></a><p class="title"><b>Example&nbsp;8.16.&nbsp;</b></p><div class="example-contents">
        <pre class="programlisting">


Renderer renderer = Renderer.create();

renderer.add(<span class="hl-string">"#strList"</span>, Arrays.asList(<span class="hl-string">"a"</span>, <span class="hl-string">"b"</span>, <span class="hl-string">"c"</span>));

renderer.add(<span class="hl-string">"#intList"</span>, Arrays.asList(<span class="hl-number">1</span>, <span class="hl-number">2</span>, <span class="hl-number">3</span>));

renderer.add(<span class="hl-string">"#longList"</span>, Arrays.asList(<span class="hl-number">1L</span>, <span class="hl-number">2L</span>, <span class="hl-number">3L</span>));

renderer.add(<span class="hl-string">"#boolList"</span>, Arrays.asList(true, false, true));


        </pre>
      </div></div><br class="example-break">
      <p>On list rendering, the matched element will be duplicated times as the size of the list and the value will be rendered to each duplicated element. You
      can also perform complex rendering for arbitrary list data by RowConvertor:</p>
      
      <div class="example"><a name="d5e732"></a><p class="title"><b>Example&nbsp;8.17.&nbsp;</b></p><div class="example-contents">
        <pre class="programlisting">


render.add(<span class="hl-string">"#someIdForRenderer"</span>, Arrays.asList(<span class="hl-number">123</span>, <span class="hl-number">456</span>, <span class="hl-number">789</span>), <span class="hl-keyword">new</span> RowConvertor&lt;Integer, Renderer&gt;() {
    <em><span class="hl-annotation" style="color: gray">@Override</span></em>
    <span class="hl-keyword">public</span> Renderer convert(<span class="hl-keyword">int</span> rowIndex, Integer obj) {
        <span class="hl-keyword">return</span> Renderer.create(<span class="hl-string">"#id"</span>, <span class="hl-string">"id-"</span> + obj).add(<span class="hl-string">"#otherId"</span>, <span class="hl-string">"otherId-"</span> + obj);
    }
});


        </pre>
      </div></div><br class="example-break">
      <p>Since we will return Renderer in most cases, the RowConvertor can be replaced by RowRenderer which can omit the type
      declaration of Renderer:</p>
      <div class="example"><a name="d5e735"></a><p class="title"><b>Example&nbsp;8.18.&nbsp;</b></p><div class="example-contents">
        <pre class="programlisting">


render.add(<span class="hl-string">"#someIdForRenderer"</span>, Arrays.asList(<span class="hl-number">123</span>, <span class="hl-number">456</span>, <span class="hl-number">789</span>), <span class="hl-keyword">new</span> RowRenderer&lt;Integer&gt;() {
    <em><span class="hl-annotation" style="color: gray">@Override</span></em>
    <span class="hl-keyword">public</span> Renderer convert(<span class="hl-keyword">int</span> rowIndex, Integer obj) {
        <span class="hl-keyword">return</span> Renderer.create(<span class="hl-string">"#id"</span>, <span class="hl-string">"id-"</span> + obj).add(<span class="hl-string">"#otherId"</span>, <span class="hl-string">"otherId-"</span> + obj);
    }
});


        </pre>
      </div></div><br class="example-break">
      <p>The returned Renderer by RowConvertor/RowRenderer will be applied to each duplicated element by the given list data.</p>
      
      <p>On list rendering, the rendering method accepts java.lang.Iterable rather than java.util.List, which afford more flexibilities to
      developers. Note that if the given iterable is empty, the target element will be duplicated 0 times, which means the target element
      will be removed.</p>
      
      <p>Asta4D also afford parallel list rendering for you, simply use ParallelRowConvertor/ParallelRowRenderer instead of
      RowConvertor/RowRenderer:</p>
      
      <div class="example"><a name="d5e740"></a><p class="title"><b>Example&nbsp;8.19.&nbsp;</b></p><div class="example-contents">
        <pre class="programlisting">


render.add(<span class="hl-string">"#someIdForRenderer"</span>, Arrays.asList(<span class="hl-number">123</span>, <span class="hl-number">456</span>, <span class="hl-number">789</span>), <span class="hl-keyword">new</span> ParallelRowRenderer&lt;Integer&gt;() {
    <em><span class="hl-annotation" style="color: gray">@Override</span></em>
    <span class="hl-keyword">public</span> Renderer convert(<span class="hl-keyword">int</span> rowIndex, Integer obj) {
        <span class="hl-keyword">return</span> Renderer.create(<span class="hl-string">"#id"</span>, <span class="hl-string">"id-"</span> + obj).add(<span class="hl-string">"#otherId"</span>, <span class="hl-string">"otherId-"</span> + obj);
    }
});


        </pre>
      </div></div><br class="example-break">
      
      <p>The parallel list rendering ability is provided by an utility class called ListConvertUtil which basically provides various
      transform methods for list data conversion like the map function in Scala/Java8. <em><span class="remark">For Java8, lambda and stream api support will
      be added in future.</span></em></p>
      
      <p>The ListConvertUtil uses a thread pool to perform parallel transforming, the size of pool can be configured by
      Configuration#listExecutorFactory#setPoolSize. There is also an import configuration of ParallelRecursivePolicy. When perform the parallel
      list transforming recursively, thread dead lock would potentially occur, so you have to choose a policy to handle this case:</p>
      
      <div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
          <p>EXCEPTION</p>
          <p>When recursive parallel list transforming is identified, throw an RuntimeException.</p>
        </li><li class="listitem">
          <p>CURRENT_THREAD</p>
          <p>When recursive parallel list transforming is identified, the child transforming will be performed in the same thread of
          parent transforming without picking up an usable thread from pool.</p>
        </li><li class="listitem">
          <p>NEW_THREAD</p>
          <p>When recursive parallel list transforming is identified, the child transforming will be performed in a newly generated
          thread out of the configured thread pool, the generated thread will be finished immediately after the child transforming
          finished.</p>
        </li></ul></div>
      
      <p>We recommend EXCEPTION or CURRENT_THREAD and the default is EXCEPTION.</p>
      
    </div>
  </div>
  
  <div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d5e756"></a>8.2.&nbsp;Other things about snippet and rendering</h2></div></div></div><div class="toc"><p><b>Table of Contents</b></p><dl class="toc"><dt><span class="sect2"><a href="#d5e758">8.2.1. Nested snippet</a></span></dt><dt><span class="sect2"><a href="#d5e766">8.2.2. InitializableSnippet</a></span></dt><dt><span class="sect2"><a href="#d5e772">8.2.3. Component rendering</a></span></dt><dt><span class="sect2"><a href="#d5e786">8.2.4. SnippetInterceptor</a></span></dt><dt><span class="sect2"><a href="#d5e788">8.2.5. SnippetExtractor</a></span></dt><dt><span class="sect2"><a href="#d5e790">8.2.6. SnippetResolver</a></span></dt><dt><span class="sect2"><a href="#d5e792">8.2.7. SnippetInvoker</a></span></dt></dl></div>
    
    <div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="d5e758"></a>8.2.1.&nbsp;Nested snippet</h3></div></div></div>
      
      <p>Snippet can be declared recursively.There is a convention that the outer snippet will always be executed on a prior order.</p>
      <div class="example"><a name="d5e761"></a><p class="title"><b>Example&nbsp;8.20.&nbsp;</b></p><div class="example-contents">
      <pre class="programlisting">

<span class="hl-tag">&lt;div</span> <span class="hl-attribute">afd:render</span>=<span class="hl-value">"OuterSnippet"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;div</span> <span class="hl-attribute">id</span>=<span class="hl-value">"inner"</span> <span class="hl-attribute">afd:render</span>=<span class="hl-value">"InnerSnippet"</span><span class="hl-tag">&gt;</span>  
        <span class="hl-tag">&lt;p</span> <span class="hl-attribute">id</span>=<span class="hl-value">"name"</span><span class="hl-tag">&gt;</span>name:<span class="hl-tag">&lt;span&gt;</span>dummy name<span class="hl-tag">&lt;/span&gt;</span><span class="hl-tag">&lt;/p&gt;</span>  
        <span class="hl-tag">&lt;p</span> <span class="hl-attribute">id</span>=<span class="hl-value">"age"</span><span class="hl-tag">&gt;</span>age:<span class="hl-tag">&lt;span&gt;</span>0<span class="hl-tag">&lt;/span&gt;</span><span class="hl-tag">&lt;/p&gt;</span>  
    <span class="hl-tag">&lt;/div&gt;</span>
<span class="hl-tag">&lt;/div&gt;</span>

      </pre>
      </div></div><br class="example-break">
      <p>In the above example, the "InnerSnippet" will be executed after the "OuterSnippet" has been executed, which also means you can
      configure the inner snippet dynamically.</p>
      <div class="example"><a name="d5e764"></a><p class="title"><b>Example&nbsp;8.21.&nbsp;</b></p><div class="example-contents">
      <pre class="programlisting">

<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> OuterSnippet{

    <span class="hl-keyword">public</span> Renderer render(){
        <span class="hl-keyword">return</span> Renderer.create(<span class="hl-string">"#inner"</span>, <span class="hl-string">"hasprofile"</span>, <span class="hl-string">"true"</span>);
    }

}

<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> InnerSnippet{

    <span class="hl-keyword">public</span> Renderer render(bool hasprofile){
        <span class="hl-keyword">if</span>(hasprofile){
            <span class="hl-keyword">return</span> Renderer.create(<span class="hl-string">"#name span"</span>, <span class="hl-string">"Bob"</span>).add(<span class="hl-string">"#age span"</span>, <span class="hl-number">27</span>);
        }<span class="hl-keyword">else</span>{
            <span class="hl-keyword">return</span> Renderer.create(<span class="hl-string">"*"</span>, Clear);
        }
    }

}

      </pre>
      </div></div><br class="example-break">
    </div>
    <div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="d5e766"></a>8.2.2.&nbsp;InitializableSnippet</h3></div></div></div>
      
      <p>The snippet class instance is singleton in request scope and will be created at the first time a snippet is required. 
      After the snippet class instance has been created, field value injection will be applied to the created instance once(About
      detail of value injection, see the later chapter). After all the field has been injected, the framework will check whether
      the current class implements the "InitializableSnippet" interface, if true, the init method of InitializableSnippet will
      be invoked once.</p>
      <div class="example"><a name="d5e769"></a><p class="title"><b>Example&nbsp;8.22.&nbsp;</b></p><div class="example-contents">
      <pre class="programlisting">

<span class="hl-keyword">public</span> <span class="hl-keyword">static</span> <span class="hl-keyword">class</span> InitSnippet <span class="hl-keyword">implements</span> InitializableSnippet {

    <em><span class="hl-annotation" style="color: gray">@ContextData</span></em>
    <span class="hl-keyword">private</span> String value;

    <span class="hl-keyword">private</span> String resolvedValue;

    <em><span class="hl-annotation" style="color: gray">@Override</span></em>
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> init() <span class="hl-keyword">throws</span> SnippetInvokeException {
        resolvedValue = value + <span class="hl-string">"-resolved"</span>;
    }
}

      </pre>
      </div></div><br class="example-break">
      <p>In the above example, the field "value" will be injected after the instance is created, then the init method will be
      applied to finish the complete initialization logic of the snippet class.</p>
    </div>
    <div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="d5e772"></a>8.2.3.&nbsp;Component rendering</h3></div></div></div>
      
      <p>For the view first policy, we will treat the template files as first class things. The embed file mechanism allow you
      separate some view blocks as independent components at template file layer. There is also a snippet class level mechanism that
      afford you the same ability as embed file, which is called "Component".</p>
      <p>Why we need "Component"? The embed file can only be include statically, but the "Component" is an extendible Java class
      which can be configured by arbitrary Java code and polymorphism can be easily performed too. Basically, The "Component" mechanism
      can help developer to build independent view component easier than static embed file.</p>

      <p>The constructor of Component accepts a string value as an embed file path or an instance of Element, and also an
      optional AttributesRequire can be specified to provide some initialization parameters as same as the parametrized embedding
      introduced in the previous section.</p>
      <div class="example"><a name="d5e777"></a><p class="title"><b>Example&nbsp;8.23.&nbsp;constructors of Component</b></p><div class="example-contents">
      <pre class="programlisting">

    <span class="hl-keyword">public</span> Component(Element elem, AttributesRequire attrs) <span class="hl-keyword">throws</span> Exception {
        ...
    }

    <span class="hl-keyword">public</span> Component(Element elem) <span class="hl-keyword">throws</span> Exception {
        ...
    }

    <span class="hl-keyword">public</span> Component(String path, AttributesRequire attrs) <span class="hl-keyword">throws</span> Exception {
        ...
    }

    <span class="hl-keyword">public</span> Component(String path) <span class="hl-keyword">throws</span> Exception {
        ...
    }

      </pre>
      </div></div><br class="example-break">
      
      <div class="example"><a name="d5e780"></a><p class="title"><b>Example&nbsp;8.24.&nbsp;render a component</b></p><div class="example-contents">
      <pre class="programlisting">

<span class="hl-keyword">public</span> Renderer render(<span class="hl-keyword">final</span> String ctype) <span class="hl-keyword">throws</span> Exception {
    <span class="hl-keyword">return</span> Renderer.create(<span class="hl-string">"span"</span>, <span class="hl-keyword">new</span> Component(<span class="hl-string">"/ComponentRenderingTest_component.html"</span>, <span class="hl-keyword">new</span> AttributesRequire() {
        <em><span class="hl-annotation" style="color: gray">@Override</span></em>
        <span class="hl-keyword">protected</span> <span class="hl-keyword">void</span> prepareAttributes() {
            <span class="hl-keyword">this</span>.add(<span class="hl-string">"value"</span>, ctype);
        }

    }));
}

      </pre>
      <p>In this example, the target element specified by the selector "span" will be completely replaced by the result of 
      Component#toElement().</p>
      </div></div><br class="example-break">
      
      <p>Commonly, we do not render a component as above example, we usually extend from Component and expose a constructor
      with business initialization parameters or supply a group of business initialization methods, by which we can build an
      independent view component simply.</p>
      
      <p>Further, Component also has a "toHtml" method which will return the html source of the component rendering result.
      This method can be used by ajax request to acquire a dynamically rendered component.</p>
    </div>

    <div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="d5e786"></a>8.2.4.&nbsp;SnippetInterceptor</h3></div></div></div>
      
    </div>
    <div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="d5e788"></a>8.2.5.&nbsp;SnippetExtractor</h3></div></div></div>
      
    </div>
    <div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="d5e790"></a>8.2.6.&nbsp;SnippetResolver</h3></div></div></div>
      
    </div>
    <div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="d5e792"></a>8.2.7.&nbsp;SnippetInvoker</h3></div></div></div>
      
    </div>
  </div>
</div>
    <div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="overview"></a>9.&nbsp;Variable injection</h2></div></div></div>
  
  
  <div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d5e796"></a>9.1.&nbsp;Context</h2></div></div></div><div class="toc"><p><b>Table of Contents</b></p><dl class="toc"><dt><span class="sect2"><a href="#d5e798">9.1.1. Context/WebApplicationContext</a></span></dt><dt><span class="sect2"><a href="#d5e822">9.1.2. Scope</a></span></dt><dt><span class="sect2"><a href="#d5e877">9.1.3. ContextBindData</a></span></dt></dl></div>
    
    <div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="d5e798"></a>9.1.1.&nbsp;Context/WebApplicationContext</h3></div></div></div>
      
      <p>Asta4D use "Context" to manage data life cycle. The "Context" in asta4d-core supplies the basic data management mechanism
      and the WebApplicationContext from asta4d-web afford more powerful extending for web application development. Commonly, we will
      only use WebApplicationContext in our application. There are two ways to retrieve an instance of WebApplicationContext.</p>
      <div class="example"><a name="d5e801"></a><p class="title"><b>Example&nbsp;9.1.&nbsp;Retrieve an instance of WebApplicationContext by static method</b></p><div class="example-contents">
      <pre class="programlisting">

WebApplicationContext context = Context.getCurrentThreadContext();

      </pre>
      </div></div><br class="example-break">
      <div class="example"><a name="d5e804"></a><p class="title"><b>Example&nbsp;9.2.&nbsp;Retrieve an instance of WebApplicationContext by injection</b></p><div class="example-contents">
      <pre class="programlisting">

<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> PageSnippet {

    <span class="hl-keyword">public</span> Renderer render(WebApplicationContext context) {
        ...
    }
}

      </pre>
      </div></div><br class="example-break">
      
      <p>As the name of "getCurrentThreadContext" suggested, the context is managed per thread, and also that the context will be
      initialized before every http request is processed and will be cleared after every http request process has finished.</p>
      
      <p>WebApplicationContext affords several methods to retrieving raw servlet apis and other helpful information:</p>
      <div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
          <p>getRequest</p>
          <p>Return the HttpServletRequest instance of current request.</p>
        </li><li class="listitem">
          <p>getResponse</p>
          <p>Return the HttpServletResponse instance of current request.</p>
        </li><li class="listitem">
          <p>getServletContext</p>
          <p>Return the ServletContext instance of current request.</p>
        </li><li class="listitem">
          <p>getAccessURI</p>
          <p>Return the rewritten url of current request. For details about URL rewritting, see later chapter.</p>
        </li></ul></div>
    </div>
    <div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="d5e822"></a>9.1.2.&nbsp;Scope</h3></div></div></div>
      
      
      <p>The context provides a mechanism to manage data by scopes. There are only 3 scopes supplied by asta4d-core's
      Context, but the WebApplicationContext from asta4d-web supply more scopes to help web application development.</p>
      
      <div class="variablelist"><p class="title"><b>Available scopes(with the constant name):</b></p><dl class="variablelist"><dt><span class="term">global(SCOPE_GLOBAL)</span></dt><dd>
            <p>The data saved in global scope can be accessed cross all the contexts, you can treat it as a static object pool.
            </p>
          </dd><dt><span class="term">default(SCOPE_DEFAULT)</span></dt><dd>
            <p>The data saved in default scope can only be access by the current context.
            </p>
          </dd><dt><span class="term">element attribute(SCOPE_ATTR)</span></dt><dd>
            <p>This scope is related to snippet rendering. An element attribute scope is a wrapping of element attribute. When you
            try to retrieve data from element attribute scope, the attribute of current rendering target element will be checked and the
            corresponding attribute value will be returned, further, if there is no corresponding attribute in the current rendering target
            element's attributes, all the parents of current rendering target element will be checked recursively.
            </p>
          </dd><dt><span class="term">request(SCOPE_REQUEST)</span></dt><dd>
            <p>The data saved in default scope can only be access in the current http request process. Note that the request scope is
            simply delegated to the default scope and it is different from servlet api's http request attribute.
            </p>
          </dd><dt><span class="term">path var(SCOPE_PATHVAR)</span></dt><dd>
            <p>Path var scope represents the variables declared in url rules.
            </p>
          </dd><dt><span class="term">query parameter(SCOPE_QUERYPARAM)</span></dt><dd>
            <p>Query parameter scope represents the query parameters specified at the part after question mark in an url.</p>
          </dd><dt><span class="term">session(SCOPE_SESSION)</span></dt><dd>
            <p>Session scope represents the data saved in http session.</p>
          </dd><dt><span class="term">header(SCOPE_HEADER)</span></dt><dd>
            <p>Session scope represents the header data from a http request.</p>
          </dd><dt><span class="term">cookie(SCOPE_COOKIE)</span></dt><dd>
            <p>Cookie scope represents the cookie data from a http request.</p>
          </dd><dt><span class="term">flash(SCOPE_FLASH)</span></dt><dd>
            <p>Asta4D affords a mechanism to allow pass data to the redirected http request, which is called flash data.</p>
          </dd></dl></div>

      <p>Normally, the data saved in context can be accessed by variable injection. If you need get data manually, you can do it as
      following:</p>      
      <div class="example"><a name="d5e868"></a><p class="title"><b>Example&nbsp;9.3.&nbsp;Retrieve data from context</b></p><div class="example-contents">
      <pre class="programlisting">

WebApplicationContext context = Context.getCurrentThreadContext();

<span class="hl-comment">//from default scope</span>
Integer count = context.get(<span class="hl-string">"saved-count"</span>);

<span class="hl-comment">//from session</span>
Integer sessionCount = context.get(WebApplicationContext.SCOPE_SESSION, <span class="hl-string">"saved-count"</span>);

      </pre>
      </div></div><br class="example-break">

      <p>You can implement your own customized scope or afford you customized implementation for existing scopes. You need extend from
      WebApplicationContext then override the method called "createMapForScope".<em><span class="remark">(If you only want to split your data from default scope, you
      can simply specify a new scope name and a new scope will be created automatically, the created scope's life cycle is as the same as
      default scope)</span></em>
      </p>
      
      <div class="example"><a name="d5e873"></a><p class="title"><b>Example&nbsp;9.4.&nbsp;Customized memcached drived session management</b></p><div class="example-contents">
      <pre class="programlisting">

<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> MyContext <span class="hl-keyword">extends</span> WebApplicationContext {
    <em><span class="hl-annotation" style="color: gray">@Override</span></em>
    <span class="hl-keyword">protected</span> ContextMap createMapForScope(String scope) {
        ContextMap map = null;
        <span class="hl-keyword">switch</span> (scope) {
        <span class="hl-keyword">case</span> SCOPE_SESSION: {
            HttpServletRequest request = getRequest();
            map = <span class="hl-keyword">new</span> MemcachedSessionMap(request);
        <span class="hl-keyword">default</span>:
            map = <span class="hl-keyword">super</span>.createMapForScope(scope);
        }
        <span class="hl-keyword">return</span> map;
    }
}

      </pre>
      </div></div><br class="example-break">
      <p>See later chapter of Asta4dServerlet for how to configure Asta4D to use the customized Context implementation instead of the
      default WebApplicationContext.</p>
    </div>
    
    <div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="d5e877"></a>9.1.3.&nbsp;ContextBindData</h3></div></div></div>
      
      <p>Since all the data query logic are performed at snippet class, we will want to avoid duplicated query on same page
      rendering. The recommended solution is caching your query result by cache library such as ehcache. But Asta4D also affords
      you an alternative solution for some simple cases, which is called ContextBindData.</p>
      
      <p>ContextBindData can be treated as a lazy load instance field for Java class. It is warranted that a ContextBindData
      will be initialized only once in a same Asta4D context and it will only be initialized when you first call it. There are 
      some exceptions for the warranty about initializing only once, we will explain them later.</p>
      
      <div class="example"><a name="d5e881"></a><p class="title"><b>Example&nbsp;9.5.&nbsp;</b></p><div class="example-contents">
      <pre class="programlisting">

<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> PageSnippet {
    
    <em><span class="hl-annotation" style="color: gray">@ContextData</span></em>
    <span class="hl-keyword">private</span> <span class="hl-keyword">int</span> count;

    <span class="hl-keyword">private</span> ContextBindData&lt;Integer&gt; data = <span class="hl-keyword">new</span> ContextBindData&lt;Integer&gt;(true) {
        <em><span class="hl-annotation" style="color: gray">@Override</span></em>
        <span class="hl-keyword">protected</span> Integer buildData() {
            <span class="hl-keyword">return</span> count + <span class="hl-number">1</span>;
        }

    };

    <span class="hl-keyword">public</span> Renderer render() {
        <span class="hl-keyword">return</span> Renderer.create(<span class="hl-string">"*"</span>, data.get());
    }
}

      </pre>
      </div></div><br class="example-break">
      
      <p>You should have noticed that we pass a "true" to the constructor of ContextBindData, which means we require the warranty
      that it should be only initialize once in the current context. If we pass nothing or pass a "false" to the constructor, the buildData
      method may be invoked multiple times in multi-thread rendering, but which is faster than warranted initialization simply because
      of skipping the multi-thread lock process.</p>
      
      <p>There is another case that the ContextBindData would be initialized multiple times even if you construct it by requiring warranty.
      In template file, we can declare a snippet as parallel, Asta4D will clone a new context from current context if parallel snippet rendering
      is required, so if the snippet class which holds the ContextBindData is first required in the cloned child context, the multi-thread lock
      will not be available in the parent context or other cloned child context because the lock is only saved into the current context and will
      not be spread to other contexts.
      </p>
      
      <p>Again, we recommend to use cache library to avoid duplicated query, but you can use ContextBindData as a simple, light weight
      alternative.</p>
      
    </div>
  </div>
  
  <div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d5e886"></a>9.2.&nbsp;Injection</h2></div></div></div><div class="toc"><p><b>Table of Contents</b></p><dl class="toc"><dt><span class="sect2"><a href="#d5e888">9.2.1. @ContextData</a></span></dt><dt><span class="sect2"><a href="#d5e890">9.2.2. @ContextDataSet</a></span></dt><dt><span class="sect2"><a href="#d5e892">9.2.3. ContextDataFinder</a></span></dt><dt><span class="sect2"><a href="#d5e894">9.2.4. DataConvertor</a></span></dt><dt><span class="sect2"><a href="#d5e896">9.2.5. ContextDataHolder</a></span></dt></dl></div>
    
    <div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="d5e888"></a>9.2.1.&nbsp;@ContextData</h3></div></div></div>
      
    </div>
    <div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="d5e890"></a>9.2.2.&nbsp;@ContextDataSet</h3></div></div></div>
      
    </div>
    <div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="d5e892"></a>9.2.3.&nbsp;ContextDataFinder</h3></div></div></div>
      
    </div>
    <div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="d5e894"></a>9.2.4.&nbsp;DataConvertor</h3></div></div></div>
      
    </div>
    <div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="d5e896"></a>9.2.5.&nbsp;ContextDataHolder</h3></div></div></div>
      
    </div>
  </div>
</div>
    <div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="overview"></a>10.&nbsp;URL rule</h2></div></div></div>
  
  
  <p>...</p>

</div>
    <div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="overview"></a>11.&nbsp;Request Handler</h2></div></div></div>
  
  
  <div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d5e903"></a>11.1&nbsp;Implementation</h2></div></div></div>
  
  </div>

  <div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d5e905"></a>11.2&nbsp;Content provider</h2></div></div></div>
  
  </div>

  <div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d5e907"></a>11.3&nbsp;Request handler chain</h2></div></div></div>
  
  </div>

  <div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d5e909"></a>11.4&nbsp;Request Interceptor</h2></div></div></div>
  
  </div>
  
</div>
    <div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="overview"></a>12.&nbsp;Extended request handler usage</h2></div></div></div>
  
  
  <div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d5e913"></a>12.1&nbsp;Restful</h2></div></div></div>
  
  </div>

  <div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d5e915"></a>12.2&nbsp;Handle static resouce files and generic path mapping</h2></div></div></div>
  
  </div>
  
  <div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d5e917"></a>12.3&nbsp;Normalize http request</h2></div></div></div>
  
  </div>
  
  <div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d5e919"></a>12.4&nbsp;As MVC's Controller</h2></div></div></div>
  
  </div>

</div>
    <div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="chapter-detail-i18n"></a>13.&nbsp;i18n</h2></div></div></div>
  
  
  <p>...</p>
  
</div>
    <div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="overview"></a>14.&nbsp;Asta4dServlet and configuration</h2></div></div></div>
  
  
  <p>...</p>
  
</div>
    <div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="overview"></a>15.&nbsp;Integration with Spring</h2></div></div></div>
  
  
  <div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d5e929"></a>15.1&nbsp;Integrate with Spring IOC</h2></div></div></div>
    
    <p>...</p>
  </div>
  
  <div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d5e932"></a>15.2&nbsp;Integrate with Spring MVC</h2></div></div></div>
    
    <p>...</p>
  </div>

  
</div>
  </div>  
  
</div></body></html>