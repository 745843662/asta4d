<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
   <title>Asta4D Framework User Guide</title><link rel="stylesheet" type="text/css" href="css/manual-singlepage.css"><meta name="generator" content="DocBook XSL Stylesheets V1.78.1"></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div class="book"><div class="titlepage"><div><div><h1 class="title"><a name="asta4d-user-guide"></a>Asta4D Framework User Guide</h1></div><div><div class="authorgroup"><h2>Authors</h2>
      <span class="author"><span class="firstname">Rui</span> <span class="surname">Liu</span></span>
      , <span class="author"><span class="firstname">Shunsuke</span> <span class="surname">Otani</span></span>	  
    </div></div><div><p class="releaseinfo">Version: 0.12.31-SNAPSHOT</p></div><div><p class="pubdate">Last update at: 2014-01-21 21:21</p></div></div><hr></div><div class="toc"><p><b>Table of Contents</b></p><dl class="toc"><dt><span class="part"><a href="#asta4d-introduction">I. Introduction</a></span></dt><dd><dl><dt><span class="chapter"><a href="#chapter-overview">1. Overview</a></span></dt><dd><dl><dt><span class="section"><a href="#d5e22">1.1. Why Asta4D</a></span></dt><dt><span class="section"><a href="#d5e32">1.2. How Asta4D helps us</a></span></dt><dt><span class="section"><a href="#d5e45">1.3. What does the name of "Asta4D" mean</a></span></dt></dl></dd></dl></dd><dt><span class="part"><a href="#asta4d-user-guide">II. User Guide</a></span></dt><dd><dl><dt><span class="chapter"><a href="#chapter-Inheritable-template">2. Flexible template</a></span></dt><dd><dl><dt><span class="section"><a href="#d5e62">2.1. Inheritable template</a></span></dt><dt><span class="section"><a href="#d5e86">2.2. Parameterized embeding</a></span></dt></dl></dd><dt><span class="chapter"><a href="#renderer">3. Renderer: easy to use, secure, testable</a></span></dt><dd><dl><dt><span class="section"><a href="#d5e96">3.1. Split rendering logic from template</a></span></dt><dt><span class="section"><a href="#d5e119">3.2. Render data to page</a></span></dt><dt><span class="section"><a href="#d5e137">3.3. Immune from cross-site hole</a></span></dt><dt><span class="section"><a href="#d5e140">3.4. Test your rendering logic</a></span></dt></dl></dd><dt><span class="chapter"><a href="#url-mapping">4. View first URL mapping and variable injection</a></span></dt><dd><dl><dt><span class="section"><a href="#d5e151">4.1. View first</a></span></dt><dt><span class="section"><a href="#d5e159">4.2. The grammer of URL rule and path variable</a></span></dt><dt><span class="section"><a href="#d5e166">4.3. Variable Injection</a></span></dt></dl></dd><dt><span class="chapter"><a href="#chapter-side-effect">5. Side effect and request handler</a></span></dt><dd><dl><dt><span class="section"><a href="#d5e213">5.1. The role with responsibility to http request: Request Handler</a></span></dt><dt><span class="section"><a href="#d5e218">5.2. Side effect of system operations</a></span></dt><dt><span class="section"><a href="#d5e222">5.3. Isolate side effect and multi thread rendering</a></span></dt><dt><span class="section"><a href="#d5e232">5.4. Compatibility to MVC</a></span></dt></dl></dd><dt><span class="chapter"><a href="#chapter-request-handler">6. Impement request handler and url mapping</a></span></dt><dd><dl><dt><span class="section"><a href="#d5e240">6.1. @RequestHandler</a></span></dt><dt><span class="section"><a href="#d5e246">6.2. delcare url rule for request handler</a></span></dt><dt><span class="section"><a href="#d5e275">6.3. Default request handler</a></span></dt><dt><span class="section"><a href="#d5e289">6.4. Global forward/redirect</a></span></dt></dl></dd></dl></dd><dt><span class="part"><a href="#asta4d-reference">III. Reference</a></span></dt><dd><dl><dt><span class="chapter"><a href="#overview">7. Template</a></span></dt><dt><span class="chapter"><a href="#overview">8. Snippet</a></span></dt><dt><span class="chapter"><a href="#overview">9. Variable injection</a></span></dt><dt><span class="chapter"><a href="#overview">10. URL rule</a></span></dt><dt><span class="chapter"><a href="#overview">11. Request Handler</a></span></dt><dd><dl><dt><span class="section"><a href="#d5e326">11.1. Implementation</a></span></dt><dt><span class="section"><a href="#d5e328">11.2. Content provider</a></span></dt><dt><span class="section"><a href="#d5e330">11.3. Request handler chain</a></span></dt><dt><span class="section"><a href="#d5e332">11.4. Request Interceptor</a></span></dt></dl></dd><dt><span class="chapter"><a href="#overview">12. Extended request handler usage</a></span></dt><dd><dl><dt><span class="section"><a href="#d5e336">12.1. Restful</a></span></dt><dt><span class="section"><a href="#d5e338">12.2. Handle static resouce files and generic path mapping</a></span></dt><dt><span class="section"><a href="#d5e340">12.3. Normalize http request</a></span></dt><dt><span class="section"><a href="#d5e342">12.4. As MVC's Controller</a></span></dt></dl></dd><dt><span class="chapter"><a href="#overview">13. i18n</a></span></dt><dt><span class="chapter"><a href="#overview">14. Asta4dServlet and configuration</a></span></dt><dt><span class="chapter"><a href="#overview">15. Integration with Spring</a></span></dt><dd><dl><dt><span class="section"><a href="#d5e352">15.1. Integrate with Spring IOC</a></span></dt><dt><span class="section"><a href="#d5e355">15.2. Integrate with Spring MVC</a></span></dt></dl></dd></dl></dd></dl></div>
  

  

  

  <div class="part"><div class="titlepage"><div><div><h1 class="title"><a name="asta4d-introduction"></a>Part&nbsp;I.&nbsp;Introduction</h1></div></div></div>
    
    
    <div class="partintro"><div></div>
      <p>
      Asta4D is a web application framework which is friendly to designer and flexible to developer. Asta4D affords
      high productivity than traditional MVC architecture by View First architecture. It also allows front-end engineers 
      and back-end engineers work independently without interference by separating rendering logic from template files.
      </p>
      
      <p>
      Asta4D is inspired by lift which is a famous scala web application framework and it is developed by astamuse company Ltd.
      locating at Tokyo Japan. We are concentrating on global innovation support and developing Asta4D for our own services.
      Currently, Asta4D is driving our new service development.

      </p>
    </div>
    <div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="chapter-overview"></a>1.&nbsp;Overview</h2></div></div></div>
  
  
  <div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d5e22"></a>1.1&nbsp;Why Asta4D</h2></div></div></div>
    
    <p>In the past decade, plenty of Java based web application frameworks are generated. Especially the MVC 
    architecture and JSP tag libs (or other traditional template technologies) that has greatly released our productivity. 
    But unfortunately, we are still suffering from the following situations:
    </p>
    
    <div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
        <p>The designers or front-end engineers are keeping complaining the mixed-in dynamic code, as they disturb 
        their efforts of redesigning the page style or structure. And in the mean time, the back-end developers are also 
        complaining that the front-end guys break the working page frequently,  because redesign or the new design is hard 
        to merge due to the huge cost of source refactoring. </p>
      </li><li class="listitem">
        <p>The developers are complaining about the poor functionalities of template language which they are using 
        and tired from the various magic skills for complex rendering logic.</p>
      </li><li class="listitem">
        <p>The developers are discontented with the counterproductivity of MVC architecture and desire a more efficient 
        approach like traditional PHP/ASP development.</p>
      </li></ul></div>
  </div>
  
  <div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d5e32"></a>1.2&nbsp;How Asta4D helps us</h2></div></div></div>
    
    <p>Asta4D is our solution to combat those issues. Thanks to lift, from where we learn a lot. We designed Asta4D complying
    with the following points:
    </p>
    
    <div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
        <p>Separate template and rendering logic</p>
        <p>Asta4D affords front-end engineers a friendly environment by separating rendering logic from template files which
        are pure html files. At the mean time, back-end engineers can use the powerful Java language to implement the rendering
        logic without being suffering from the "poor and sometimes magic" template languages.
        </p>
      </li><li class="listitem">
        <p>View first without controller</p>
        <p>Asta4D also affords higher productivity than traditional MVC architecture by View First mechanism. And it is also
        easier to change than MVC architecture.</p>
      </li><li class="listitem">
        <p>Isolate side effect with request handler</p>
        <p>Asta4D imports the conception of "side-effect" from functional programming languages and separating the "side-effect"
        by request handlers, which afford more flexibility on page rendering because the view layer is side-effect free now. Therefore
        Asta4D allows parallel page rendering in multiple threads as a built-in feature.
        </p>
      </li></ul></div>
  </div>

  <div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d5e45"></a>1.3&nbsp;What does the name of "Asta4D" mean</h2></div></div></div>
    
    <p>The name of Asta4D is from our company's name: astamuse. We explain the "4D" as following ways:</p> 
    
    <div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
        <p>For Designer</p>
        <p>Asta4D consider the design friendliness as the most important factor of itself. We hope web designers can fulfil their
        maximum potential of creativity without squandering their time on the back-end technologies which they could never be adept at.
        </p>
      </li><li class="listitem">
        <p>For developer</p>
        <p>We hope Asta4D can help developers to achieve their work more easily. Developers would never be afflicted with complex
        rendering logic because they can use powerful Java language to do whatever they want since the rendering has been split from
        template files. View first also releases developers from the cumbersome MVC architecture, now they have more time to have a cup
        of coffee.</p>
      </li><li class="listitem">
        <p>4 Dimension</p>
        <p>We believe that Asta4D can act as a wormhole that connects the front-end and the back-end. We can move quicker by Asta4D just
        like we are going through the 4 dimensional space.
        </p>
      </li></ul></div>
  </div>
</div>
  </div>

  <div class="part"><div class="titlepage"><div><div><h1 class="title"><a name="asta4d-user-guide"></a>Part&nbsp;II.&nbsp;User Guide</h1></div></div></div>
    
    <div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="chapter-Inheritable-template"></a>2.&nbsp;Flexible template</h2></div></div></div>
  
  
    <div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d5e62"></a>2.1&nbsp;Inheritable template</h2></div></div></div>
      
      <p>
      The template of Asta4D is inheritable, child template can override, append or insert content to certain place
      in parent template. Let's see a sample:
      </p>
      <div class="example"><a name="d5e65"></a><p class="title"><b>Example&nbsp;2.1.&nbsp;parent.html</b></p><div class="example-contents">
      <pre class="programlisting">

<span class="hl-tag">&lt;html&gt;</span>   
    <span class="hl-tag">&lt;head&gt;</span>   
        <span class="hl-tag">&lt;afd:block</span> <span class="hl-attribute">id</span>=<span class="hl-value">"block1"</span><span class="hl-tag">&gt;</span>   
            <span class="hl-tag">&lt;link</span> <span class="hl-attribute">href</span>=<span class="hl-value">"parent1.css"</span> <span class="hl-attribute">rel</span>=<span class="hl-value">"stylesheet"</span> <span class="hl-attribute">type</span>=<span class="hl-value">"text/css"</span><span class="hl-tag"> /&gt;</span>   
        <span class="hl-tag">&lt;/afd:block&gt;</span>   
           
        <span class="hl-tag">&lt;afd:block</span> <span class="hl-attribute">id</span>=<span class="hl-value">"block2"</span><span class="hl-tag">&gt;</span>   
            <span class="hl-tag">&lt;link</span> <span class="hl-attribute">href</span>=<span class="hl-value">"parent2.css"</span> <span class="hl-attribute">rel</span>=<span class="hl-value">"stylesheet"</span> <span class="hl-attribute">type</span>=<span class="hl-value">"text/css"</span><span class="hl-tag"> /&gt;</span>   
        <span class="hl-tag">&lt;/afd:block&gt;</span>   
  
        <span class="hl-tag">&lt;title&gt;</span>extension sample<span class="hl-tag">&lt;/title&gt;</span>   
    <span class="hl-tag">&lt;/head&gt;</span>   
    <span class="hl-tag">&lt;body&gt;</span>   
        <span class="hl-tag">&lt;afd:block</span> <span class="hl-attribute">id</span>=<span class="hl-value">"content"</span><span class="hl-tag">&gt;</span>content<span class="hl-tag">&lt;/afd:block&gt;</span>   
    <span class="hl-tag">&lt;/body&gt;</span>   
<span class="hl-tag">&lt;/html&gt;</span>

      </pre>
      </div></div><br class="example-break">

      <p>Child template can declare inheritance by "afd:extension" and overriding can be declared by "afd:block":</p>
      <div class="example"><a name="template-child"></a><p class="title"><b>Example&nbsp;2.2.&nbsp;child.html</b></p><div class="example-contents">
      <pre class="programlisting">

<span class="hl-tag">&lt;html&gt;</span>   
<span class="hl-tag">&lt;head&gt;</span><span class="hl-tag">&lt;/head&gt;</span>   
<span class="hl-tag">&lt;body&gt;</span>   
<span class="hl-comment">&lt;!-- (1) --&gt;</span>   
<span class="hl-tag">&lt;afd:extension</span> <span class="hl-attribute">parent</span>=<span class="hl-value">"parent.html"</span><span class="hl-tag">&gt;</span>   
  
    <span class="hl-comment">&lt;!-- (2) --&gt;</span>   
    <span class="hl-tag">&lt;afd:block</span> <span class="hl-attribute">append</span>=<span class="hl-value">"block1"</span><span class="hl-tag">&gt;</span>   
        <span class="hl-tag">&lt;link</span> <span class="hl-attribute">href</span>=<span class="hl-value">"child1.css"</span> <span class="hl-attribute">rel</span>=<span class="hl-value">"stylesheet"</span> <span class="hl-attribute">type</span>=<span class="hl-value">"text/css"</span><span class="hl-tag"> /&gt;</span>   
    <span class="hl-tag">&lt;/afd:block&gt;</span>   
  
    <span class="hl-comment">&lt;!-- (3) --&gt;</span>   
    <span class="hl-tag">&lt;afd:block</span> <span class="hl-attribute">insert</span>=<span class="hl-value">"block2"</span><span class="hl-tag">&gt;</span>   
        <span class="hl-tag">&lt;link</span> <span class="hl-attribute">href</span>=<span class="hl-value">"child2.css"</span> <span class="hl-attribute">rel</span>=<span class="hl-value">"stylesheet"</span> <span class="hl-attribute">type</span>=<span class="hl-value">"text/css"</span><span class="hl-tag"> /&gt;</span>   
    <span class="hl-tag">&lt;/afd:block&gt;</span>   
  
    <span class="hl-comment">&lt;!-- (4) --&gt;</span>   
    <span class="hl-tag">&lt;afd:block</span> <span class="hl-attribute">override</span>=<span class="hl-value">"content "</span><span class="hl-tag">&gt;</span>   
        <span class="hl-tag">&lt;div&gt;</span>hello<span class="hl-tag">&lt;/div&gt;</span>   
        <span class="hl-comment">&lt;!-- (5) --&gt;</span>   
        <span class="hl-tag">&lt;afd:embed</span> <span class="hl-attribute">target</span>=<span class="hl-value">"/templates/embed.html"</span><span class="hl-tag"> &gt;</span><span class="hl-tag">&lt;/afd:embed&gt;</span>   
    <span class="hl-tag">&lt;/afd:block&gt;</span>   
  
<span class="hl-tag">&lt;/afd:extension&gt;</span>   
<span class="hl-tag">&lt;/body&gt;</span>   
<span class="hl-tag">&lt;/html&gt;</span> 

      </pre>
      </div></div><br class="example-break">
      
      <p>
      "afd:block" support 3 types action: insert, append and override. 
      </p>
      
      <br>
      
      <p>
      In the <a class="xref" href="#template-child" title="Example&nbsp;2.2.&nbsp;child.html">Example&nbsp;2.2, &#8220;child.html&#8221;</a>, there is an additional declaration of including by "afd:embed" which embed 
      the target file to the current place of the current file. Let's see the embed.html:
      </p>
      <div class="example"><a name="template-child"></a><p class="title"><b>Example&nbsp;2.3.&nbsp;embed.html</b></p><div class="example-contents">
      <pre class="programlisting">

<span class="hl-tag">&lt;html&gt;</span>   
<span class="hl-tag">&lt;head&gt;</span><span class="hl-tag">&lt;/head&gt;</span>   
<span class="hl-tag">&lt;body&gt;</span>   
    <span class="hl-comment">&lt;!-- (6) --&gt;</span>   
    <span class="hl-tag">&lt;afd:block</span> <span class="hl-attribute">append</span>=<span class="hl-value">"block1"</span><span class="hl-tag">&gt;</span>   
        <span class="hl-tag">&lt;link</span> <span class="hl-attribute">href</span>=<span class="hl-value">"embed.css"</span> <span class="hl-attribute">rel</span>=<span class="hl-value">"stylesheet"</span> <span class="hl-attribute">type</span>=<span class="hl-value">"text/css"</span><span class="hl-tag"> /&gt;</span>   
    <span class="hl-tag">&lt;/afd:block&gt;</span>   
    <span class="hl-tag">&lt;div&gt;</span>good embed<span class="hl-tag">&lt;/div&gt;</span>   
<span class="hl-tag">&lt;/body&gt;</span>   
<span class="hl-tag">&lt;/html&gt;</span>   

      </pre>
      </div></div><br class="example-break">
      
      <p>
      The "afd:block" declaration in the embeded target file is available after the content of target file is inserted into the
      <a class="xref" href="#template-child" title="Example&nbsp;2.2.&nbsp;child.html">Example&nbsp;2.2, &#8220;child.html&#8221;</a>, all "afd:block" tags will be treated as overriding(inserting/appending) to the parent template
      and the contents out of "afd:blocks" will be inserted at the place where the "afd:embed" is declared.
      </p>
      
      <br>
      
      <p>After all the template files are merged, we will get the following result:</p>
      <div class="example"><a name="d5e83"></a><p class="title"><b>Example&nbsp;2.4.&nbsp;The result of template merging:</b></p><div class="example-contents">
      <pre class="programlisting">

<span class="hl-tag">&lt;html&gt;</span>   
<span class="hl-tag">&lt;head&gt;</span>   
       
    <span class="hl-comment">&lt;!-- block1 --&gt;</span>   
    <span class="hl-tag">&lt;link</span> <span class="hl-attribute">href</span>=<span class="hl-value">"parent1.css"</span> <span class="hl-attribute">rel</span>=<span class="hl-value">"stylesheet"</span> <span class="hl-attribute">type</span>=<span class="hl-value">"text/css"</span><span class="hl-tag"> /&gt;</span>   
    <span class="hl-tag">&lt;link</span> <span class="hl-attribute">href</span>=<span class="hl-value">"child1.css"</span> <span class="hl-attribute">rel</span>=<span class="hl-value">"stylesheet"</span> <span class="hl-attribute">type</span>=<span class="hl-value">"text/css"</span><span class="hl-tag"> /&gt;</span>   
    <span class="hl-tag">&lt;link</span> <span class="hl-attribute">href</span>=<span class="hl-value">"embed.css"</span> <span class="hl-attribute">rel</span>=<span class="hl-value">"stylesheet"</span> <span class="hl-attribute">type</span>=<span class="hl-value">"text/css"</span><span class="hl-tag"> /&gt;</span>   
  
    <span class="hl-comment">&lt;!-- block2 --&gt;</span>   
    <span class="hl-tag">&lt;link</span> <span class="hl-attribute">href</span>=<span class="hl-value">"child2.css"</span> <span class="hl-attribute">rel</span>=<span class="hl-value">"stylesheet"</span> <span class="hl-attribute">type</span>=<span class="hl-value">"text/css"</span><span class="hl-tag"> /&gt;</span>   
    <span class="hl-tag">&lt;link</span> <span class="hl-attribute">href</span>=<span class="hl-value">"parent2.css"</span> <span class="hl-attribute">rel</span>=<span class="hl-value">"stylesheet"</span> <span class="hl-attribute">type</span>=<span class="hl-value">"text/css"</span><span class="hl-tag"> /&gt;</span>   
  
    <span class="hl-tag">&lt;title&gt;</span>extension sample<span class="hl-tag">&lt;/title&gt;</span>   
  
<span class="hl-tag">&lt;/head&gt;</span>   
<span class="hl-tag">&lt;body&gt;</span>   
  
    <span class="hl-comment">&lt;!-- content --&gt;</span>   
    <span class="hl-tag">&lt;div&gt;</span>hello<span class="hl-tag">&lt;/div&gt;</span>   
  
    <span class="hl-comment">&lt;!-- embed --&gt;</span>   
    <span class="hl-tag">&lt;div&gt;</span>good embed<span class="hl-tag">&lt;/div&gt;</span>   
  
<span class="hl-tag">&lt;/body&gt;</span>   
<span class="hl-tag">&lt;/html&gt;</span>  

      </pre>
      </div></div><br class="example-break">
      
      
    </div>

    <div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d5e86"></a>2.2&nbsp;Parameterized embeding</h2></div></div></div>
      
      
      <p>
      Extra parameters can be passed to the target embeded file by specifying the DOM attribute of "afd:embed" when we
      are embeding files.
      </p>
      
      <div class="example"><a name="d5e89"></a><p class="title"><b>Example&nbsp;2.5.&nbsp;Sample of parameterized embeding:</b></p><div class="example-contents">
      <pre class="programlisting">

<span class="hl-tag">&lt;afd:embed</span> <span class="hl-attribute">target</span>=<span class="hl-value">"/xxx/showList.html"</span> <span class="hl-attribute">limit</span>=<span class="hl-value">"30"</span><span class="hl-tag">&gt;</span><span class="hl-tag">&lt;/afd:embed&gt;</span>

      </pre>
      </div></div><br class="example-break">

      <p>
      The "limit" parameter can be accessed by variable injection in the rendering logic of showList.html, by which we can
      parameterize the embeding. This feature is very useful for creating a page component which encapsulates common
      html snippets and can be controlled by the passed parameters. Basically, embeding a file in a template file
      is similar to calling a function with(or without) arguments. Especially, the parameters are not limited to
      specified static values in the template file, they can be valued dynamicaly at runtime too. Further, the
      type of parameters is not restricted to the stringizable types such as String or Integer/Long, arbitrary Java type
      can be specified dynamically at runtime. See the reference of Renering logic to learn more details. 
      </p>
    </div>

  <p>
  Simply, the idea of Asta4D's template system is akin to the traditional OOP model, the parent and child templates can be 
  regarded as parent/child classes and the block can be viewed as a overridable virtual method. The embed external files can
  be also treated as funcation calling. As a matter of fact, since arbitrary type of value can be passed to the embed files, 
  there is actually no difference between Asta4D's embeding and common function calling.
  </p>
</div>
    <div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="renderer"></a>3.&nbsp;Renderer: easy to use, secure, testable</h2></div></div></div>
  
  
  <div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d5e96"></a>3.1&nbsp;Split rendering logic from template</h2></div></div></div>
    
    
    <p>
    There is no dynamic code in a template file. An Asta4D template file is always a pure HTML file which can be easily 
    maintained by front-end developers, it is very design friendly and we can reduce the workload for source 
    refactoring by over 90%.
    </p>
    
    <div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
        <p>Declare snippet class in template file</p>
        <div class="example"><a name="d5e102"></a><p class="title"><b>Example&nbsp;3.1.&nbsp;Sample of snippet declaration:</b></p><div class="example-contents">
        <pre class="programlisting">

<span class="hl-tag">&lt;section&gt;</span>  
    <span class="hl-tag">&lt;article&gt;</span>  
        <span class="hl-tag">&lt;div</span> <span class="hl-attribute">afd:render</span>=<span class="hl-value">"SimpleSnippet"</span><span class="hl-tag">&gt;</span>dummy text<span class="hl-tag">&lt;/div&gt;</span>  
        <span class="hl-tag">&lt;afd:snippet</span> <span class="hl-attribute">render</span>=<span class="hl-value">"SimpleSnippet:setProfile"</span><span class="hl-tag">&gt;</span>  
            <span class="hl-tag">&lt;p</span> <span class="hl-attribute">id</span>=<span class="hl-value">"name"</span><span class="hl-tag">&gt;</span>name:<span class="hl-tag">&lt;span&gt;</span>dummy name<span class="hl-tag">&lt;/span&gt;</span><span class="hl-tag">&lt;/p&gt;</span>  
            <span class="hl-tag">&lt;p</span> <span class="hl-attribute">id</span>=<span class="hl-value">"age"</span><span class="hl-tag">&gt;</span>age:<span class="hl-tag">&lt;span&gt;</span>0<span class="hl-tag">&lt;/span&gt;</span><span class="hl-tag">&lt;/p&gt;</span>  
        <span class="hl-tag">&lt;/afd:snippet&gt;</span>  
    <span class="hl-tag">&lt;/article&gt;</span>  
<span class="hl-tag">&lt;/section&gt;</span>

        </pre>
        </div></div><br class="example-break">
    
        <p>
        The "afd:render" attribute in div tag declares a Java class which is in charge of the concrete rendering logic, such Java
        class is usually called as a snippet class. A snippet class can be declared by a "afd:snippet" tag too, as you have seen
        in above sample. The rendering logic is secluded to independent Java classes by snippet declaration and it is not necessary
        to learn any new template language for back-end developers. The back-end guys can achieve all the rendering logic easily
        by powerful Java language which they have been adept to, no learning costs, no magic codes, succinct Java source only.
        </p>
        
        <br>
        
      </li><li class="listitem">
        <p>Implement a snippet class</p>
        <div class="example"><a name="d5e109"></a><p class="title"><b>Example&nbsp;3.2.&nbsp;Sample of snippet class:</b></p><div class="example-contents">
        <pre class="programlisting">

<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> SimpleSnippet {  
  
    <span class="hl-keyword">public</span> Renderer render(String name) {  
        <span class="hl-keyword">if</span> (StringUtils.isEmpty(name)) {  
            name = <span class="hl-string">"Asta4D"</span>;  
        }  
        Element element = ElementUtil.parseAsSingle(<span class="hl-string">"&lt;span&gt;Hello "</span> + name + <span class="hl-string">"!&lt;/span&gt;"</span>);  
        <span class="hl-keyword">return</span> Renderer.create(<span class="hl-string">"*"</span>, element);  
    }  
  
    <span class="hl-keyword">public</span> Renderer setProfile() {  
        Renderer render = <span class="hl-keyword">new</span> GoThroughRenderer();  
        render.add(<span class="hl-string">"p#name span"</span>, <span class="hl-string">"asta4d"</span>);  
        render.add(<span class="hl-string">"p#age span"</span>, <span class="hl-number">20</span>);  
        <span class="hl-keyword">return</span> render;  
    }  
}

        </pre>
        </div></div><br class="example-break">
        
        <p>
        The Renderer class is provided by framework to declare rendering actions. Renderer uses traditional CSS selector to
        reference the rendering target and receive the rendering value at the same time, amazing and powerful.
        </p>
        <br>
        
        <p>If the above template file and snippet class are executed, we would get the following result:</p>
        <div class="example"><a name="d5e115"></a><p class="title"><b>Example&nbsp;3.3.&nbsp;Result of snippet execution:</b></p><div class="example-contents">
        <pre class="programlisting">

<span class="hl-tag">&lt;section&gt;</span>  
    <span class="hl-tag">&lt;article&gt;</span>  
        <span class="hl-tag">&lt;span&gt;</span>Hello Asta4D<span class="hl-tag">&lt;/span&gt;</span>  
            <span class="hl-tag">&lt;p</span> <span class="hl-attribute">id</span>=<span class="hl-value">"name"</span><span class="hl-tag">&gt;</span>name:<span class="hl-tag">&lt;span&gt;</span>asta4d/span&gt;<span class="hl-tag">&lt;/p&gt;</span>  
            <span class="hl-tag">&lt;p</span> <span class="hl-attribute">id</span>=<span class="hl-value">"age"</span><span class="hl-tag">&gt;</span>age:<span class="hl-tag">&lt;span&gt;</span>20<span class="hl-tag">&lt;/span&gt;</span><span class="hl-tag">&lt;/p&gt;</span>  
    <span class="hl-tag">&lt;/article&gt;</span>  
<span class="hl-tag">&lt;/section&gt;</span>

        </pre>
        </div></div><br class="example-break">
      </li></ul></div>

    <p>
    Asta4D introduces 4 extra tags to the html template file: afd:extension, afd:block, afd:embed, afd:snippet, which will not
    disturb most html editors, accordingly Asta4D is extremely friendly to front-end engineers. On the other hand, we can see
    that all the rendering logic is fulfiled by Java code and the back-end engineers can compose their back-end logic and rendering logic
    very smoothly without magic skills and extra learning costs, which means highly boost of productivity.
    </p>
  </div>
  
  <div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d5e119"></a>3.2&nbsp;Render data to page</h2></div></div></div>
    
    <div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
        <p>In Asta4D, all the rendering logic is declared by a Renderer class which accepts various types as rendering value.</p>
        <div class="example"><a name="d5e124"></a><p class="title"><b>Example&nbsp;3.4.&nbsp;Sample usage of Renderer</b></p><div class="example-contents">
        <pre class="programlisting">

Renderer render = <span class="hl-keyword">new</span> GoThroughRenderer();  
render.add(<span class="hl-string">"#someIdForInt"</span>, <span class="hl-number">12345</span>);  
render.add(<span class="hl-string">"#someIdForLong"</span>, <span class="hl-number">12345L</span>);  
render.add(<span class="hl-string">"#someIdForBool"</span>, true);  
render.add(<span class="hl-string">"#someIdForStr"</span>, <span class="hl-string">"a str"</span>);  
render.add(<span class="hl-string">"#someIdForNull"</span>, (Object) null);  
render.add(<span class="hl-string">"#someIdForClear"</span>, Clear);  
  
Element newChild = ElementUtil.parseAsSingle(<span class="hl-string">"&lt;div&gt;&lt;/div&gt;"</span>);  
render.add(<span class="hl-string">"#someIdForElementSetter"</span>, <span class="hl-keyword">new</span> ChildReplacer(newChild));  
  
render.add(<span class="hl-string">"#someIdForElement"</span>, ElementUtil.parseAsSingle(<span class="hl-string">"&lt;div&gt;eee&lt;/div&gt;"</span>));  
  
render.add(<span class="hl-string">"#someIdForRenderer"</span>, Renderer.create(<span class="hl-string">"#value"</span>, <span class="hl-string">"value"</span>));  

        </pre>
        </div></div><br class="example-break">
      </li><li class="listitem">
        <p>List of data can be rendered via Renderer too:</p>
        <div class="example"><a name="d5e129"></a><p class="title"><b>Example&nbsp;3.5.&nbsp;Sample of list rendering</b></p><div class="example-contents">
        <pre class="programlisting">

Renderer render = <span class="hl-keyword">new</span> GoThroughRenderer();  
render.add(<span class="hl-string">"#someIdForInt"</span>, Arrays.asList(<span class="hl-number">123</span>, <span class="hl-number">456</span>, <span class="hl-number">789</span>));  
render.add(<span class="hl-string">"#someIdForLong"</span>, Arrays.asList(<span class="hl-number">123L</span>, <span class="hl-number">456L</span>, <span class="hl-number">789L</span>));  
render.add(<span class="hl-string">"#someIdForBool"</span>, Arrays.asList(true, true, false));  
render.add(<span class="hl-string">"#someIdForStr"</span>, Arrays.asList(<span class="hl-string">"str1"</span>, <span class="hl-string">"str2"</span>, <span class="hl-string">"str3"</span>));  
  
Element newChild1 = ElementUtil.parseAsSingle(<span class="hl-string">"&lt;div&gt;1&lt;/div&gt;"</span>);  
Element newChild2 = ElementUtil.parseAsSingle(<span class="hl-string">"&lt;div&gt;2&lt;/div&gt;"</span>);  
  
render.add(<span class="hl-string">"#someIdForElementSetter"</span>, Arrays.asList(<span class="hl-keyword">new</span> ChildReplacer(newChild1), <span class="hl-keyword">new</span> ChildReplacer(newChild2)));  
  
render.add(<span class="hl-string">"#someIdForElement"</span>, Arrays.asList(newChild1, newChild2));  
  
render.add(<span class="hl-string">"#someIdForRenderer"</span>, Arrays.asList(<span class="hl-number">123</span>, <span class="hl-number">456</span>, <span class="hl-number">789</span>), <span class="hl-keyword">new</span> RowRenderer&lt;Integer&gt;() {  
    <em><span class="hl-annotation" style="color: gray">@Override</span></em>  
    <span class="hl-keyword">public</span> Renderer convert(<span class="hl-keyword">int</span> rowIndex, Integer obj) {  
        <span class="hl-keyword">return</span> Renderer.create(<span class="hl-string">"#id"</span>, <span class="hl-string">"id-"</span> + obj).add(<span class="hl-string">"#otherId"</span>, <span class="hl-string">"otherId-"</span> + obj);  
    }  
});   

        </pre>
        </div></div><br class="example-break">
      </li><li class="listitem">
        <p>DOM attribution can be done too:</p>
        <div class="example"><a name="d5e134"></a><p class="title"><b>Example&nbsp;3.6.&nbsp;Sample of DOM attribution rendering</b></p><div class="example-contents">
        <pre class="programlisting">

render.add(<span class="hl-string">"#id"</span>, <span class="hl-string">"+class"</span>, <span class="hl-string">"yyy"</span>);  
render.add(<span class="hl-string">"#id"</span>, <span class="hl-string">"-class"</span>, <span class="hl-string">"zzz"</span>);  
  
render.add(<span class="hl-string">"#id"</span>, <span class="hl-string">"+class"</span>, <span class="hl-string">"xxx"</span>);  
  
render.add(<span class="hl-string">"#id"</span>, <span class="hl-string">"value"</span>, <span class="hl-string">"hg"</span>);  
render.add(<span class="hl-string">"#id"</span>, <span class="hl-string">"href"</span>, null);  
  
render.add(<span class="hl-string">"#X"</span>, <span class="hl-string">"value"</span>, <span class="hl-keyword">new</span> Date(<span class="hl-number">123456L</span>));

        </pre>
        </div></div><br class="example-break">
      </li></ul></div>
  </div>

  <div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d5e137"></a>3.3&nbsp;Immune from cross-site hole</h2></div></div></div>
    
    <p>
    The previous samples show us that all the operations to DOM are delegated by Renderer except create DOM
    from String value by "ElementUtil#parseAsSingle". As a matter of fact, all the delegated operations cause
    all the rendering values are escaped by force, which means that your system is, by nature, immune from
    cross-site problems if there is no "ElementUtil#parseAsSingle" calling in your system. You do not need
    to be wary of illegal characters by from the clients since all the values will be escaped as HTML compulsorily.
    </p>
    
    On the other hand, according to our practice, it is rarely that you have to call &#8220;ElementUtil.parseAsSingle&#8221;
    to generate the rendering content from a raw HTML string, so just take care of your usage of this exceptional api
    then you can say bye-bye to the cross-site holes.    
  </div>
  
  <div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d5e140"></a>3.4&nbsp;Test your rendering logic</h2></div></div></div>
    
    <p>
    Testing web page is always a complex task and we usually verify rendering results by selenuim which is as a common
    technology. By Asta4D, testable Renderer can replace over than half of selenium tests to simpler junit tests.
    </p>
    
    <p>
    According to the previous samples, all the rendering logic is holded by an instance of Renderer class, so simply,
    we can verify almost rendering logic by testing the returned Renderer instance from the snippet method. 
    </p>
    
    <div class="example"><a name="d5e144"></a><p class="title"><b>Example&nbsp;3.7.&nbsp;Sample RendererTester</b></p><div class="example-contents">
    <pre class="programlisting">

RendererTester tester = RendererTester.forRenderer(render);  
Assert.assertEquals(tester.get(<span class="hl-string">"#someIdForInt"</span>), <span class="hl-number">12345</span>);  
Assert.assertEquals(tester.get(<span class="hl-string">"#someIdForLong"</span>), <span class="hl-number">12345L</span>);  
Assert.assertEquals(tester.get(<span class="hl-string">"#someIdForBool"</span>), true);  
Assert.assertEquals(tester.get(<span class="hl-string">"#someIdForStr"</span>), <span class="hl-string">"a str"</span>);  
Assert.assertEquals(tester.get(<span class="hl-string">"#someIdForNull"</span>), null);  
Assert.assertEquals(tester.get(<span class="hl-string">"#someIdForClear"</span>), Clear);  

    </pre>
    <p>More samples can be found in <a class="ulink" href="https://github.com/astamuse/asta4d/blob/develop/asta4d-core/src/test/java/com/astamuse/asta4d/test/unit/RenderTesterTest.java" target="_top">source</a></p>
    </div></div><br class="example-break">

  </div>
  
</div>
    <div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="url-mapping"></a>4.&nbsp;View first URL mapping and variable injection</h2></div></div></div>
  
  
  <div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d5e151"></a>4.1&nbsp;View first</h2></div></div></div>
    

    <p>
    In Asta4D, we follow the principle of view first rather than the tradition MVC architecture. The declaration of URL rules
    does not need to include a controller and one url can be mapped to one template file directly, which is called as View First.
    </p>
    
    <p>
    In Asta4D, URL mapping rules are not managed in a configuration file. The Framework provides a sort of DSL by a set of convinient
    APIs, which means the declaration of Asta4D's URL mapping rule is programmable and it affords much flexibility than the way with a
    static configuration file.    
    </p>
    
    <p>
    Users declare their own URL rules via implementing the interface UrlMappingRuleInitializer of Asta4D:
    </p>
    
    <div class="example"><a name="d5e156"></a><p class="title"><b>Example&nbsp;4.1.&nbsp;Sample of declaring url rules:</b></p><div class="example-contents">
    <pre class="programlisting">

<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> UrlRules <span class="hl-keyword">implements</span> UrlMappingRuleInitializer {    
    
    <em><span class="hl-annotation" style="color: gray">@Override</span></em>    
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> initUrlMappingRules(UrlMappingRuleHelper rules) {    
        <span class="hl-comment">//@formatter:off    </span>
        rules.add(GET, <span class="hl-string">"/"</span>)    
             .redirect(<span class="hl-string">"/app/index"</span>);    
            
        rules.add(GET, <span class="hl-string">"/redirect-to-index"</span>)    
             .redirect(<span class="hl-string">"p:/app/index"</span>);    
            
        rules.add(<span class="hl-string">"/app/"</span>, <span class="hl-string">"/templates/index.html"</span>);    
        rules.add(<span class="hl-string">"/app/index"</span>, <span class="hl-string">"/templates/index.html"</span>);    
        rules.add(<span class="hl-string">"/app/{name}/{age}"</span>, <span class="hl-string">"/templates/variableinjection.html"</span>)&#65307;    
        ...    
    
        <span class="hl-comment">//@formatter:on    </span>
    }
}

    </pre>
    </div></div><br class="example-break">
  </div>
  
  <div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d5e159"></a>4.2&nbsp;The grammer of URL rule and path variable</h2></div></div></div>
    
    <p>
    The grammer of Asta4D's URL rule is almost the same as Spring MVC's URL mapping rule and the parts surrounded by braces are 
    treated as path variables which can be retrieved in following process(in snippet classes or request handlers).
    </p>
    
    <p>
    Further, extra path variables can be declared in a url rule by calling the method of "var" as following:
    </p>
    <div class="example"><a name="d5e163"></a><p class="title"><b>Example&nbsp;4.2.&nbsp;Sample of declaring extra path variable:</b></p><div class="example-contents">
    <pre class="programlisting">

rules.add(<span class="hl-string">"/app/{name}/{age}"</span>, <span class="hl-string">"/templates/variableinjection.html"</span>)  
     .var(<span class="hl-string">"extraVar"</span>, <span class="hl-number">1234</span>);  

    </pre>
    </div></div><br class="example-break">
  </div>
  
  <div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d5e166"></a>4.3&nbsp;Variable Injection</h2></div></div></div>
    
    <p>
    Asta4D implements a variable injection mechanism which is very closed to Spring MVC, all of the instance fields 
    and method parameters in the implementation of snippet classes can be injected automatically by framework.
    </p>
    
    <p>
    Further, all the snippet classes are singleton in request scope.In other words, there will be only one istance of any 
    snippet class in a single request scope regardless of how many times the snippet class is called. Let us see some samples
    of variable injection in the snippet class.
    </p>
    
    <div class="example"><a name="d5e170"></a><p class="title"><b>Example&nbsp;4.3.&nbsp;</b></p><div class="example-contents">
    <pre class="programlisting">

<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> InitSnippet <span class="hl-keyword">implements</span> InitializableSnippet {    
    
    <em><span class="hl-annotation" style="color: gray">@ContextData</span></em>    
    <span class="hl-keyword">private</span> String value; <span class="hl-comment">// (1)    </span>
    <span class="hl-keyword">private</span> <span class="hl-keyword">long</span> id;    
    <span class="hl-keyword">private</span> String resolvedValue;    
    <span class="hl-keyword">private</span> <span class="hl-keyword">int</span> count = <span class="hl-number">0</span>;    

}    

    </pre>
    <p>
    @ContextData indicates that the instance field "value" need to be injected after the instance of InitSnippet is created. 
    Since the snippet instance is singeleton in the current request scope, the instance field "value" will be injected and 
    initialized only once in the current request scope. The framework will search a variable named "value" in all the available
    variable scopes and inject the found value. The name of "value" is decided by the field name by default and can be
    sepcified by extra declaration(see the following samples).
    </p>
    </div></div><br class="example-break">
    
    <div class="example"><a name="d5e173"></a><p class="title"><b>Example&nbsp;4.4.&nbsp;</b></p><div class="example-contents">
    <pre class="programlisting">

<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> InitSnippet <span class="hl-keyword">implements</span> InitializableSnippet {    

    <em><span class="hl-annotation" style="color: gray">@ContextData</span></em>    
    <span class="hl-keyword">private</span> <span class="hl-keyword">void</span> setId(<span class="hl-keyword">long</span> id) {&#12288;<span class="hl-comment">//(3)    </span>
        <span class="hl-keyword">this</span>.id = id;    
    }    

}    

    </pre>
    <p>Instance field can be injected via setter methods too.</p>
    </div></div><br class="example-break">
    
    <div class="example"><a name="d5e176"></a><p class="title"><b>Example&nbsp;4.5.&nbsp;</b></p><div class="example-contents">
    <pre class="programlisting">

<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> InitSnippet <span class="hl-keyword">implements</span> InitializableSnippet {    
    
    <em><span class="hl-annotation" style="color: gray">@Override</span></em>    
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> init() <span class="hl-keyword">throws</span> SnippetInvokeException { <span class="hl-comment">//(2)    </span>
        resolvedValue = value + <span class="hl-string">"-resolved"</span>;    
        count++;    
    }  

}    

    </pre>
    <p>
    The init method of InitializableSnippet is being implemented. This is not necessary but if a snippet class implements 
    the interface of InitializableSnippet, the init method will be called once after all the instance fields are injected,
    by which customized snippet initial logic can be performed.
    </p>
    </div></div><br class="example-break">
    
    <div class="example"><a name="d5e179"></a><p class="title"><b>Example&nbsp;4.6.&nbsp;</b></p><div class="example-contents">
    <pre class="programlisting">

<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> InitSnippet <span class="hl-keyword">implements</span> InitializableSnippet {    

    <span class="hl-comment">// (4)    </span>
    <span class="hl-keyword">public</span> Renderer getPathVarName(    
    <em><span class="hl-annotation" style="color: gray">@ContextData(scope = WebApplicationContext.SCOPE_PATHVAR)</span></em>    
    <span class="hl-keyword">int</span> count) {    
    }

}    

    </pre>
    <p>
    Variable injection on snippet method. In this sample the extra search scope are delcared, which cause framework searches
    a variable named "count" in the path variable scope. As the same as the injection on instance field, the searching variable
    name is decided by the parameter name by default.
    </p>
    </div></div><br class="example-break">
    
    <div class="example"><a name="d5e182"></a><p class="title"><b>Example&nbsp;4.7.&nbsp;</b></p><div class="example-contents">
    <pre class="programlisting">

<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> InitSnippet <span class="hl-keyword">implements</span> InitializableSnippet {    

    <span class="hl-comment">// (5)    </span>
    <span class="hl-keyword">public</span> Renderer getQueryParamName(    
    <em><span class="hl-annotation" style="color: gray">@ContextData(name = "var", scope = WebApplicationContext.SCOPE_QUERYPARAM)</span></em>    
    String name) {    
    }    

}    

    </pre>
    <p>
    In this sample, an extra variable name and search scope are declared, the framework will search a variable named "var" in the
    request parameters.
    </p>
    </div></div><br class="example-break">    

    <div class="example"><a name="d5e185"></a><p class="title"><b>Example&nbsp;4.8.&nbsp;</b></p><div class="example-contents">
    <pre class="programlisting">

<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> InitSnippet <span class="hl-keyword">implements</span> InitializableSnippet {    

    <span class="hl-comment">// (6)    </span>
    <span class="hl-keyword">public</span> Renderer getDefaultName(String name) {    
    } 

}    

    </pre>
    <p>
    There is a difference between instance field injection and method parameter injection. A instance field without @ContextData
    annotation will not be injected, but for method paramters, all the paramters will be injected compulsorily. In this sample,
    the framework will search a variable named "name" in all the available scopes as following order:
    </p>
    <div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">
        <p>HTML tag attribution(SCOPE_ATTR)</p>
        <p>Trace back to the top tag of the current HTML document recursively. This scope is only available to the snippet method.</p>
      </li><li class="listitem">
        <p>path variable(SCOPE_PATHVAR)</p>
      </li><li class="listitem">
        <p>request parameter(SCOPE_QUERYPARAM)</p>
      </li><li class="listitem">
        <p>flash variable(SCOPE_FLASH)</p>
        <p>The variables passed from one request to another request, usually acrross a redirect.</p>
      </li><li class="listitem">
        <p>cookie(SCOPE_COOKIE)</p>
      </li><li class="listitem">
        <p>request hearder(SCOPE_HEADER)</p>
      </li><li class="listitem">
        <p>request attribute(SCOPE_REQUEST)</p>
      </li><li class="listitem">
        <p>session(SCOPE_SESSION)</p>
      </li><li class="listitem">
        <p>global(SCOPE_GLOBAL)</p>
        <p>A global static variable pool</p>
      </li></ol></div>
    <p>
      This search order is applied to the instance field injection too except that the first scope of HTML tag attribution is not available.
    </p>
    </div></div><br class="example-break">


    
  </div>

</div>
    <div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="chapter-side-effect"></a>5.&nbsp;Side effect and request handler</h2></div></div></div>
  
 
  <div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d5e213"></a>5.1&nbsp;The role with responsibility to http request: Request Handler</h2></div></div></div>
    
    <p>
    Even Asta4D complies with the principle of view first, there is still a role similar with the controller in MVC
    architecture, such role is called request handler. We believe that there should be a role who takes responsiblity
    of a certain http request and such role can be considered as an alternative to controller of MVC in some situations
    too.
    </p>
    
    <p>
    According to the view first rule, a request handler can be ignored in most cases. You can also assume that there is
    is a default request handler which navigates all the http requests to the corresponding template files(The real 
    story is more complex but you can try to understand the theory conceptually by this way).
    </p>
    
    <p>
    Now the question is when we need a request handler? Before we can answer this question, we have to discuss the conception
    of "side effect".
    </p>
  </div>

  <div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d5e218"></a>5.2&nbsp;Side effect of system operations</h2></div></div></div>
    

    <p>
    A system always afford users various operations such as query, update, etc. All of these operations will affect the status
    of system in various ways. In Asta4D, we say that there are two types of action in a system, one is with &#8220;side effect&#8221;, 
    another one is without &#8220;side effect&#8221;. &#8220;actions with side effect&#8221; are ones that will change the system status once they are
    performed. For instance, for the same URL, a login request (if succeeded) will cause a client&#8217;s privilege to be changed and 
    the client could probably get a different page view from what the client get before login, because of which we say a login 
    request is an action with side effect. Another obvious example is a database update operation. Once an update is committed, 
    all the related clients will get a different output from the result before the update, which is also classified as &#8220;an action 
    with side effect&#8221;. 
    </p>
    
    <p>
    How about a query? We consider a query as an operation without side effect, it means that a client will always get the same
    result regardless of how many times the query is executed. Some people may ask how about counting on query times? For counting
    on query times, we can still split the counting and query to two individual operations, one is with side effect and another one
    is without side effect.
    </p>
  </div>
  
  <div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d5e222"></a>5.3&nbsp;Isolate side effect and multi thread rendering</h2></div></div></div>
    

    <p>
    We believe the actions with side effect should be managed seriously and we do that by putting all the actions with side effect
    to request handlers so that the view layer is purified and this makes the source more clear and maintainable. This is also means 
    with Asta4D we can easily perform multi thread rendering on a single page because they are now all side-effect free, which is a
    high light function of Asta4D.
    </p>

    <p>
    In traditional MVC architecture, the responsibility of controller is tangled, a controller does not only handle the duty of altering
    system status(date update), but also takes the responsibility of preparing data for view layer. We often have to expand the database
    session(transaction) to the view layer for handling lazy load issue, which makes transaction management more complicated. Additionally,
    especially for the pages that can be split to relatively individual blocks, hypothetically we can accelerate the page loading
    by retrieving data in multi threads for each block, but in reality it is impossible due to the source complexity and development costs.
    The developers still have to access each data source sequentially to retrieve data for each block even the page is splitable as individual
    blocks.
    </p>

    <p>
    For Asta4D, the logic layers of system is clarified by isolating side effects at architecture level. The database session(transaction)
    does no longer need keep opening cross layers, it is clear that the duty of request handler is altering system status but not preparing
    data for view layer. At the mean time, at the view layer, acquiring data and rendering data are performed at the same time, at the same
    place: We access data source and retrieve data in snippet method, and pass the data to Renderer to perform rendering immediately in the
    same snippet method. Further, the complexity can be reduced drastically because all the accesses to certain data are isolated in certain
    snippet methods and there is no cross layer invoking and coupling any more.
    </p>
    
    <p>
    On the other hand, we can simply perform multi thread rendering by calling each snippet method in different threads, which is transparent to
    developer. Because all the side effects has been isolated in request handler layer, we do not need to considerate sync or mutex even we
    are performing multi thread rendering since the view layer is side effect free now.
    </p>
    
    <p>
    Let us see how easy we can achieve parallel rendering 
    </p>
    
    <div class="example"><a name="d5e229"></a><p class="title"><b>Example&nbsp;5.1.&nbsp;</b></p><div class="example-contents">
      <pre class="programlisting">

<span class="hl-tag">&lt;div</span> <span class="hl-attribute">afd:render</span>=<span class="hl-value">"ParallelTest$TestRender:snippetInDiv"</span> <span class="hl-attribute">afd:parallel&gt;</span>  
    <span class="hl-attribute">&lt;div</span> <span class="hl-attribute">id</span>=<span class="hl-value">"test"</span><span class="hl-tag">&gt;</span>xx<span class="hl-tag">&lt;/div&gt;</span>  
<span class="hl-tag">&lt;/div&gt;</span>  
  
<span class="hl-tag">&lt;afd:snippet</span> <span class="hl-attribute">render</span>=<span class="hl-value">"ParallelTest$TestRender:snippetReplaceDiv"</span> <span class="hl-attribute">parallel&gt;</span>  
    <span class="hl-attribute">&lt;div</span> <span class="hl-attribute">id</span>=<span class="hl-value">"test"</span><span class="hl-tag">&gt;</span>xx<span class="hl-tag">&lt;/div&gt;</span>  
<span class="hl-tag">&lt;/afd:snippet&gt;</span>

      </pre>
      <p>
      All the snippets declared with parallel(afd:parallel) attribution will not block the http request main thread, the http request main thread
      will wait for the parallel rendering after all the non-parallel rendering finished, then merge the result and output to the client.
      </p>
    </div></div><br class="example-break">
  </div>

  <div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d5e232"></a>5.4&nbsp;Compatibility to MVC</h2></div></div></div>
    
    <p>
    Someone may ask: "Is it true that we do not need MVC?", "Is it true that we do not need a controller?". The answer is "No". We
    admit that MVC architecture is more convenient than view first for some certain cases, for instance, when we are handling form
    submission, the MVC structure is required naturally. By Asta4D, you can simply handle this case by implement the request handler
    as a controller.
    </p>
    
    <p>
    Further, perhaps you cannot agree with the idea of view first. You believe a controller is necessary in any case but you are also
    interested in the split template mechanism of Asta4D, the same answer for you: implement your request handler as a controller. 
    </p>
    
    <p>
      <em><span class="remark">You can also integrate Asta4D's template only as a view layer implementation for Spring MVC. More details can be found in reference.</span></em>
    </p>
  </div>

</div>
    <div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="chapter-request-handler"></a>6.&nbsp;Impement request handler and url mapping</h2></div></div></div>
  

  <div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d5e240"></a>6.1&nbsp;@RequestHandler</h2></div></div></div>
    
    <p>It is not complicated to implement a request handler. @RequestHandler can be used to annotate a handle
    method in arbitrary Java class which will be treated as a request handler.</p>
    
    <div class="example"><a name="d5e243"></a><p class="title"><b>Example&nbsp;6.1.&nbsp;</b></p><div class="example-contents">
      <pre class="programlisting">

<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> LoginHandler {  
  
    <em><span class="hl-annotation" style="color: gray">@RequestHandler</span></em>  
    <span class="hl-keyword">public</span> LoginFailure doLogin(String flag) <span class="hl-keyword">throws</span> LoginFailure {  
        <span class="hl-keyword">if</span> (StringUtils.isEmpty(flag)) {  
            <span class="hl-keyword">return</span> null;  
        }  
        <span class="hl-keyword">if</span> (<span class="hl-string">"error"</span>.equals(flag)) {  
            <span class="hl-keyword">throw</span> <span class="hl-keyword">new</span> LoginFailure();  
        }  
        <span class="hl-keyword">if</span> (!Boolean.parseBoolean(flag)) {  
            <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> LoginFailure();  
        }  
        <span class="hl-keyword">return</span> null;  
    }  
}  

      </pre>
      <p>
      Take a look at the parameters of the handle method, the handle method of a request handler accepts parameter injection
      as same as the snippet method. More details can be found at the descriptions of the snippet method.
      </p>
    </div></div><br class="example-break">
  </div>
 
  <div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d5e246"></a>6.2&nbsp;delcare url rule for request handler</h2></div></div></div>
    
    <p>Previously we have introduced how to forward a http request to a certain template file by url mapping. We can declare 
    a request handler for q http request by the same way:
    </p>
    
    <div class="example"><a name="d5e249"></a><p class="title"><b>Example&nbsp;6.2.&nbsp;</b></p><div class="example-contents">
      <pre class="programlisting">

rules.add(<span class="hl-string">"/app/handler"</span>)  
     .handler(LoginHandler.<span class="hl-keyword">class</span>) <span class="hl-comment">// (1)  </span>
     .forward(LoginFailure.<span class="hl-keyword">class</span>, <span class="hl-string">"/templates/error.html"</span>) <span class="hl-comment">//(2)  </span>
     .redirect(FurtherConfirm.<span class="hl-keyword">class</span>, <span class="hl-string">"/app/furtherConfirm"</span>)<span class="hl-comment">//(3)  </span>
     .forward(<span class="hl-string">"/templates/success.html"</span>); <span class="hl-comment">//(4)  </span>

      </pre>
      <p>
      Simply explain:
        </p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">
            <p>Forward the request to "/app/handler" to the request handler "LoginHandler".</p>
          </li><li class="listitem">
            <p>If "LoginHandler" returns a result of "LoginFailure", forward the request to the template file "error.html".</p>
          </li><li class="listitem">
            <p>If "LoginHandler" returns a result of "FurtherConfirm", redirect the current request to "/app/furtherConfirm" 
            by http code 302(302 is by default).</p>
          </li><li class="listitem">
            <p>If "LoginHandler" does not return a meaningful result(it usually means success by a null return) , forward the request 
            to the template file "success.html".</p>
          </li></ol></div><p>
      </p>
    </div></div><br class="example-break">
    
    <p>
      More verbose details:
    </p>
    
    <p>
      The handler method is used to add a request handler and accepts arbitrary type as the the parameter: an instance of java.lang.Class or an
      arbitrary instance. The framework explains received parameters by the implementation of DeclareInstanceResolver configured by
      WebApplicationConfiguration. Thee default implementation provided by framework follows the following rules to explain the declaration
      of request handler:
      </p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">
          <p>If an instance of java.lang.Class is specified, the instance of request handler will be created by invoke "newInstance()"
          on the specified Class.</p>
        </li><li class="listitem">
          <p>If a string is specified, the string will be treated as a class name and an instance of java.lang.Class will be created by 
          calling "Class#forName", then the instance of request handler will be created by invoke "newInstance()" on the created Class.</p>
        </li><li class="listitem">
          <p>The specified parameter will be treated as a request handler directly if it is neither a Class nor a string. By this rule,
          it is interesting that we can declare an anonymous class as a request handler:</p>
          <div class="example"><a name="d5e270"></a><p class="title"><b>Example&nbsp;6.3.&nbsp;</b></p><div class="example-contents">
            <pre class="programlisting">

rules.add(<span class="hl-string">"/app/handler"</span>)  
     .handler(<span class="hl-keyword">new</span> Object(){  
        <em><span class="hl-annotation" style="color: gray">@RequestHandler</span></em>  
        <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> handle(){  
            <span class="hl-comment">//  </span>
        }  
     }); 

            </pre>
          </div></div><br class="example-break">
        </li></ol></div><p>
      <em><span class="remark">The asta4d-spring package also provides a resolver based on Spring IOC container, the request handler instance will be retrieved by
      passing the specified parameter to the "Context#getBean" method of spring container.</span></em>
    </p>
    
    <p>
    The forward method adds a transforming rule for the result of request handler.There must be a handler method annotated by @RequestHandler and the
    returned value of the handle method is viewed as the result of the request handler, thrown exceptions in the handle method are treated as the result
    too. The framework will attempt to match the result to the expected result specified by forward method then transforms the result to the corresponding
    template file(The real mechanism of result transforming is more complicated and is explained at ...). When the matching attempt is performed, the
    equals method will be used at first, if the equals method returns false and the expected result by forward method is an instance of java.lang.Class,
    "Class#isAssignableFrom" will be utilized, if false again, skip the current forward rule and do the same check on the next forward rule. A forward rule
    without the expected result specified will be viewed as a default rule, if matched forward rule for a result is missing or the request handler returns
    a pointless result(void declaration of handle method or returns null), the default rule will be applied.
    </p>
    
    <p>
    The redirect method follows the same rule of forward method except it will cause a 302 redirect(302 is default, 301 can be declared) instead of forwarding
    to a template file.
    </p>
  </div>
  
  <div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d5e275"></a>6.3&nbsp;Default request handler</h2></div></div></div>
    
    <p>
    You can not only declare request handler to a certain url, but also declare global request handlers which is available to
    all the urls and prior to the request handlers declared on certain urls. There is a conception of request handler chain
    for multi handlers, we will explain it in a later chapter.
    </p>
    
    <div class="example"><a name="d5e278"></a><p class="title"><b>Example&nbsp;6.4.&nbsp;Default request handler</b></p><div class="example-contents">
      
      <pre class="programlisting">

rules.addDefaultRequestHandler(GlobalHandler.<span class="hl-keyword">class</span>);  
  
rules.addDefaultRequestHandler(<span class="hl-string">"authcheck"</span>, AuthCheckHandler.<span class="hl-keyword">class</span>);  

      </pre>
    </div></div><br class="example-break">
    
    <p>
    At the second line declaration for AuthCheckHandler, an attribute can be specified at the same time, which cause the declared request handler
    is only available to the rules that declared the same attribute.
    </p>
    
    <div class="example"><a name="d5e282"></a><p class="title"><b>Example&nbsp;6.5.&nbsp;</b></p><div class="example-contents">
      <pre class="programlisting">

rules.add(<span class="hl-string">"/app/handler"</span>).attribute(<span class="hl-string">"authcheck"</span>)  
        ...  

      </pre>
    </div></div><br class="example-break">
    
    <p class="remark"><em><span class="remark">
    In the framework's internal implementation, a static match rule table will be generated after all the url mapping declaration finished. A global
    request handler that is only available to certain rules will be configured to the the certain url rules only, by which unnecessary performance
    cost is avoid.
    </span></em></p>
    
    <p>
    In our practice, we found that it is very inconvenient to declare necessary attribute on every rule. In most situations, we will
    want to do something like configure a same default request handler to all the url paths under "/xxx", which can be done by delcaring
    a non attribute default request handler which judges the url pattern by itself, but such way will lose the performance benefit of
    attribute declaration. Thus, we provide an alternative way for this situation: url rule rewrite.
    </p>
    
    <div class="example"><a name="d5e286"></a><p class="title"><b>Example&nbsp;6.6.&nbsp;</b></p><div class="example-contents">
      <pre class="programlisting">

rules.addRuleRewriter(<span class="hl-keyword">new</span> UrlMappingRuleRewriter() {  
    <em><span class="hl-annotation" style="color: gray">@Override</span></em>  
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> rewrite(UrlMappingRule rule) {  
        <span class="hl-keyword">if</span>(rule.getSourcePath().startsWith(<span class="hl-string">"/privatedata/"</span>)){  
            rule.getAttributeList().add(<span class="hl-string">"authcheck"</span>);  
        }  
    }  
});   

      </pre>
    </div></div><br class="example-break">

    <p>
    Please note that, untill now all the introduced configuration for url mapping are achieved by a group of interface called
    HandyRule which convert all the declaration to the instance of UrlMappingRule which is used by framework internally. But in
    the url rule rewritter implementation, developers have to cope with the raw UrlMappingRule which is difficult to understand,
    so complex url rewriting is not appreciated. Basically, the scenario of url rule rewriting is only for add attributes to rules in
    bulk.
    </p>
  </div>
  
  <div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d5e289"></a>6.4&nbsp;Global forward/redirect</h2></div></div></div>
    

    <p>
    Previously we mentioned that the result of a request handler will be matched in the forward declaration, if there is no matched forward found,
    the global forward rule will be checked.
    </p>
    
    <div class="example"><a name="d5e292"></a><p class="title"><b>Example&nbsp;6.7.&nbsp;Global forward</b></p><div class="example-contents">
      
      <pre class="programlisting">

rules.addGlobalForward(PageNotFoundException.<span class="hl-keyword">class</span>, <span class="hl-string">"/pagenotfound.html"</span>, <span class="hl-number">404</span>);  

      </pre>

      <p>
      The above source declares that if the result of request handler is PageNotFoundException(Exception is treated as the result of the request handler),
      forward the request to pagenotfound.html by http status code 404.
      </p>
      
    </div></div><br class="example-break">
    
    <p>
    Global redirect can be declared by the same way.
    </p>
    
    <div class="example"><a name="d5e297"></a><p class="title"><b>Example&nbsp;6.8.&nbsp;Global redirect</b></p><div class="example-contents">
      
      <pre class="programlisting">

rules.addGlobalRedirect(REDIRECT_TO_SOMEWHERE, <span class="hl-string">"/somewhere"</span>);  

      </pre>
    </div></div><br class="example-break">

    <p>
    The global forward rules are applied before the default forward rule(the forward rule without result) on certain url mapping rule.
    </p>

    <div class="example"><a name="d5e301"></a><p class="title"><b>Example&nbsp;6.9.&nbsp;</b></p><div class="example-contents">
      <pre class="programlisting">

rules.addGlobalForward(PageNotFoundException.<span class="hl-keyword">class</span>, <span class="hl-string">"/pagenotfound.html"</span>, <span class="hl-number">404</span>);  

rules.addGlobalRedirect(REDIRECT_TO_SOMEWHERE, <span class="hl-string">"/somewhere"</span>);  

rules.add(<span class="hl-string">"/app/handler"</span>)  
     .handler(LoginHandler.<span class="hl-keyword">class</span>) 
     .forward(LoginFailure.<span class="hl-keyword">class</span>, <span class="hl-string">"/templates/error.html"</span>) 
     .redirect(FurtherConfirm.<span class="hl-keyword">class</span>, <span class="hl-string">"/app/furtherConfirm"</span>)  
     .forward(<span class="hl-string">"/templates/success.html"</span>);

      </pre>
    </div></div><br class="example-break">
    
    <p>
    In the above sample, the result of LoginHandler will be matched by the following order:
    </p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">LoginFailer</li><li class="listitem">FurtherConfirm</li><li class="listitem">PageNotFoundException</li><li class="listitem">REDIRECT_TO_SOMEWHERE</li><li class="listitem">(default-&gt; "success.html")</li></ol></div><p>
    </p>
  </div>

</div>
  </div>  

  <div class="part"><div class="titlepage"><div><div><h1 class="title"><a name="asta4d-reference"></a>Part&nbsp;III.&nbsp;Reference</h1></div></div></div>
    
    <div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="overview"></a>7.&nbsp;Template</h2></div></div></div>
  
  
  <p>...</p>

</div>
    <div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="overview"></a>8.&nbsp;Snippet</h2></div></div></div>
  
  
  <p>...</p>

</div>
    <div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="overview"></a>9.&nbsp;Variable injection</h2></div></div></div>
  
  
  <p>...</p>

</div>
    <div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="overview"></a>10.&nbsp;URL rule</h2></div></div></div>
  
  
  <p>...</p>

</div>
    <div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="overview"></a>11.&nbsp;Request Handler</h2></div></div></div>
  
  
  <div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d5e326"></a>11.1&nbsp;Implementation</h2></div></div></div>
  
  </div>

  <div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d5e328"></a>11.2&nbsp;Content provider</h2></div></div></div>
  
  </div>

  <div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d5e330"></a>11.3&nbsp;Request handler chain</h2></div></div></div>
  
  </div>

  <div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d5e332"></a>11.4&nbsp;Request Interceptor</h2></div></div></div>
  
  </div>
  
</div>
    <div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="overview"></a>12.&nbsp;Extended request handler usage</h2></div></div></div>
  
  
  <div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d5e336"></a>12.1&nbsp;Restful</h2></div></div></div>
  
  </div>

  <div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d5e338"></a>12.2&nbsp;Handle static resouce files and generic path mapping</h2></div></div></div>
  
  </div>
  
  <div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d5e340"></a>12.3&nbsp;Normalize http request</h2></div></div></div>
  
  </div>
  
  <div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d5e342"></a>12.4&nbsp;As MVC's Controller</h2></div></div></div>
  
  </div>

</div>
    <div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="overview"></a>13.&nbsp;i18n</h2></div></div></div>
  
  
  <p>...</p>
  
</div>
    <div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="overview"></a>14.&nbsp;Asta4dServlet and configuration</h2></div></div></div>
  
  
  <p>...</p>
  
</div>
    <div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="overview"></a>15.&nbsp;Integration with Spring</h2></div></div></div>
  
  
  <div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d5e352"></a>15.1&nbsp;Integrate with Spring IOC</h2></div></div></div>
    
    <p>...</p>
  </div>
  
  <div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d5e355"></a>15.2&nbsp;Integrate with Spring MVC</h2></div></div></div>
    
    <p>...</p>
  </div>

  
</div>
  </div>  
  
</div></body></html>