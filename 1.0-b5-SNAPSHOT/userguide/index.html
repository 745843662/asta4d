<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
   <title>Asta4D Framework User Guide</title><link rel="stylesheet" type="text/css" href="css/manual-singlepage.css"><meta name="generator" content="DocBook XSL Stylesheets V1.78.1"><meta name="keywords" content="java, view first, framework"></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div class="book"><div class="titlepage"><div><div><h1 class="title"><a name="asta4d-user-guide"></a>Asta4D Framework User Guide</h1></div><div><div class="authorgroup"><h2>Authors</h2>
      <span class="author"><span class="firstname">Rui</span> <span class="surname">Liu</span></span>
      , <span class="author"><span class="firstname">Shunsuke</span> <span class="surname">Otani</span></span>	  
    </div></div><div><p class="releaseinfo">Version: 1.0-b5-SNAPSHOT</p></div><div><p class="pubdate">Last update at: 2015-02-12 18:59</p></div></div><hr></div><div class="toc"><p><b>Table of Contents</b></p><dl class="toc"><dt><span class="part"><a href="#asta4d-introduction">I. Introduction</a></span></dt><dd><dl><dt><span class="chapter"><a href="#chapter-overview">1. Overview</a></span></dt><dd><dl><dt><span class="section"><a href="#d5e26">1.1. Why Asta4D</a></span></dt><dt><span class="section"><a href="#d5e39">1.2. How Asta4D helps us</a></span></dt><dt><span class="section"><a href="#d5e67">1.3. What does the name of "Asta4D" mean</a></span></dt></dl></dd></dl></dd><dt><span class="part"><a href="#asta4d-user-guide">II. User Guide</a></span></dt><dd><dl><dt><span class="chapter"><a href="#chapter-Inheritable-template">2. Flexible template</a></span></dt><dd><dl><dt><span class="section"><a href="#inheritable-template">2.1. Inheritable template</a></span></dt><dt><span class="section"><a href="#parametrized-embedding">2.2. Parametrized embedding</a></span></dt></dl></dd><dt><span class="chapter"><a href="#renderer">3. Renderer: easy to use, secure, testable</a></span></dt><dd><dl><dt><span class="section"><a href="#split-rendering">3.1. Split rendering logic from template</a></span></dt><dt><span class="section"><a href="#render-to-page">3.2. Render data to page</a></span></dt><dt><span class="section"><a href="#immune-from-xss">3.3. Immune from cross-site hole</a></span></dt><dt><span class="section"><a href="#test-rendering">3.4. Test your rendering logic</a></span></dt></dl></dd><dt><span class="chapter"><a href="#url-mapping">4. View first URL mapping and variable injection</a></span></dt><dd><dl><dt><span class="section"><a href="#view-first-mechanism">4.1. View first</a></span></dt><dt><span class="section"><a href="#url-rule-grammer">4.2. The grammer of URL rule and path variable</a></span></dt><dt><span class="section"><a href="#variable-injection">4.3. Variable Injection</a></span></dt></dl></dd><dt><span class="chapter"><a href="#chapter-side-effect">5. Side effect and request handler</a></span></dt><dd><dl><dt><span class="section"><a href="#d5e240">5.1. The role with responsibility to http request: Request Handler</a></span></dt><dt><span class="section"><a href="#d5e245">5.2. Side effect of system operations</a></span></dt><dt><span class="section"><a href="#d5e249">5.3. Isolate side effect and multi thread rendering</a></span></dt></dl></dd><dt><span class="chapter"><a href="#chapter-request-handler">6. Impement request handler and url mapping</a></span></dt><dd><dl><dt><span class="section"><a href="#d5e261">6.1. @RequestHandler</a></span></dt><dt><span class="section"><a href="#d5e267">6.2. delcare url rule for request handler</a></span></dt><dt><span class="section"><a href="#d5e296">6.3. Default request handler</a></span></dt><dt><span class="section"><a href="#d5e310">6.4. Global forward/redirect</a></span></dt></dl></dd><dt><span class="chapter"><a href="#chapter-adv-request-handler">7. Advanced usage of request handler</a></span></dt><dd><dl><dt><span class="sect1"><a href="#advanced-mvc">7.1. Advanced MVC architecture</a></span></dt><dt><span class="sect1"><a href="#normalize-page-url">7.2. Normalize page url patterns</a></span></dt><dt><span class="sect1"><a href="#rest-ajax">7.3. Restful and ajax</a></span></dt><dt><span class="sect1"><a href="#handle-static-resource">7.4. Handle static resouce files</a></span></dt><dt><span class="sect1"><a href="#handle-generic-path">7.5. Handle generic path template files</a></span></dt></dl></dd><dt><span class="chapter"><a href="#chapter-form-flow">8. Built in form flow</a></span></dt><dd><dl><dt><span class="sect1"><a href="#d5e412">8.1. Startup</a></span></dt><dd><dl><dt><span class="sect2"><a href="#d5e414">8.1.1. Form and form field</a></span></dt><dt><span class="sect2"><a href="#d5e424">8.1.2. Form handler</a></span></dt><dt><span class="sect2"><a href="#d5e480">8.1.3. HTML template of form</a></span></dt><dt><span class="sect2"><a href="#d5e492">8.1.4. Form snippet</a></span></dt><dt><span class="sect2"><a href="#d5e505">8.1.5. Validation</a></span></dt></dl></dd><dt><span class="sect1"><a href="#d5e516">8.2. Customize behaviours</a></span></dt><dd><dl><dt><span class="sect2"><a href="#d5e518">8.2.1. Cascade form POJO and array field</a></span></dt><dt><span class="sect2"><a href="#d5e520">8.2.2. Customize form flow definition</a></span></dt><dt><span class="sect2"><a href="#d5e523">8.2.3. Customize form field annotation</a></span></dt><dt><span class="sect2"><a href="#d5e525">8.2.4. Customize validation</a></span></dt><dt><span class="sect2"><a href="#d5e527">8.2.5. Customize message rendering</a></span></dt></dl></dd></dl></dd><dt><span class="chapter"><a href="#chapter-best-practice">9. Best practice</a></span></dt><dd><dl><dt><span class="sect1"><a href="#division-responsibilities">9.1. Division of responsibilities between request handler and snippet</a></span></dt><dd><dl><dt><span class="sect2"><a href="#do-update-by-request-handler">9.1.1. Do update by request handler</a></span></dt><dt><span class="sect2"><a href="#normalize-page-condition">9.1.2. Normalize page condition by request handler</a></span></dt></dl></dd><dt><span class="sect1"><a href="#common-usage-form-flow">9.2. Common usage of form flow</a></span></dt><dt><span class="sect1"><a href="#best-snippet-way">9.3. The best way of implementing a snippet</a></span></dt><dd><dl><dt><span class="sect2"><a href="#perform-queries-simple">9.3.1. Perform queries as simple as possible</a></span></dt><dt><span class="sect2"><a href="#make-use-of-parallelRowRender">9.3.2. Make use of ParallelRowRender</a></span></dt><dt><span class="sect2"><a href="#cache-data">9.3.3. Cache your data</a></span></dt><dt><span class="sect2"><a href="#avoid-duplicated-query">9.3.4. Avoid duplicated query</a></span></dt><dt><span class="sect2"><a href="#prepare-snippet-instance">9.3.5. Prepare snippet instance(set default value) by InitializableSnippet</a></span></dt><dt><span class="sect2"><a href="#selector-x-convention">9.3.6. "x-" convention selector</a></span></dt><dt><span class="sect2"><a href="#remove-rather-than-add">9.3.7. Remove contents rather than add contents for conditional rendering</a></span></dt></dl></dd></dl></dd></dl></dd><dt><span class="part"><a href="#asta4d-reference">III. Reference</a></span></dt><dd><dl><dt><span class="chapter"><a href="#chapter-detail-template">10. Details of Template</a></span></dt><dd><dl><dt><span class="sect1"><a href="#d5e678">10.1. Supported tags</a></span></dt><dd><dl><dt><span class="sect2"><a href="#d5e681">10.1.1. afd:extension</a></span></dt><dt><span class="sect2"><a href="#d5e693">10.1.2. afd:block</a></span></dt><dt><span class="sect2"><a href="#d5e722">10.1.3. afd:embed</a></span></dt><dt><span class="sect2"><a href="#d5e736">10.1.4. afd:snippet</a></span></dt><dt><span class="sect2"><a href="#d5e759">10.1.5. afd:group</a></span></dt><dt><span class="sect2"><a href="#d5e767">10.1.6. afd:comment</a></span></dt><dt><span class="sect2"><a href="#d5e775">10.1.7. afd:msg</a></span></dt></dl></dd><dt><span class="sect1"><a href="#d5e787">10.2. Additional</a></span></dt></dl></dd><dt><span class="chapter"><a href="#chapter-detail-snippet">11. Details of snippet class</a></span></dt><dd><dl><dt><span class="sect1"><a href="#d5e833">11.1. Rendering APIs</a></span></dt><dd><dl><dt><span class="sect2"><a href="#d5e837">11.1.1. Create and add Renderer instance</a></span></dt><dt><span class="sect2"><a href="#css-selector">11.1.2. CSS Selector</a></span></dt><dt><span class="sect2"><a href="#d5e1057">11.1.3. Render text</a></span></dt><dt><span class="sect2"><a href="#d5e1065">11.1.4. Render DOM attribution</a></span></dt><dt><span class="sect2"><a href="#d5e1102">11.1.5. Clear an Element</a></span></dt><dt><span class="sect2"><a href="#d5e1109">11.1.6. Render raw Element</a></span></dt><dt><span class="sect2"><a href="#d5e1116">11.1.7. Arbitrary rendering for an Element</a></span></dt><dt><span class="sect2"><a href="#d5e1126">11.1.8. Recursive rendering</a></span></dt><dt><span class="sect2"><a href="#d5e1131">11.1.9. Debug renderer</a></span></dt><dt><span class="sect2"><a href="#d5e1137">11.1.10. Missing selector warning</a></span></dt><dt><span class="sect2"><a href="#d5e1145">11.1.11. List rendering</a></span></dt></dl></dd><dt><span class="sect1"><a href="#d5e1175">11.2. Other things about snippet and rendering</a></span></dt><dd><dl><dt><span class="sect2"><a href="#d5e1177">11.2.1. Nested snippet</a></span></dt><dt><span class="sect2"><a href="#d5e1185">11.2.2. InitializableSnippet</a></span></dt><dt><span class="sect2"><a href="#d5e1191">11.2.3. Component rendering</a></span></dt><dt><span class="sect2"><a href="#d5e1205">11.2.4. SnippetInterceptor</a></span></dt><dt><span class="sect2"><a href="#d5e1207">11.2.5. SnippetExtractor</a></span></dt><dt><span class="sect2"><a href="#d5e1209">11.2.6. SnippetResolver</a></span></dt><dt><span class="sect2"><a href="#d5e1211">11.2.7. SnippetInvoker</a></span></dt></dl></dd></dl></dd><dt><span class="chapter"><a href="#chapter-detail-var-injection">12. Variable injection</a></span></dt><dd><dl><dt><span class="sect1"><a href="#vi-context">12.1. Context</a></span></dt><dd><dl><dt><span class="sect2"><a href="#d5e1217">12.1.1. Context/WebApplicationContext</a></span></dt><dt><span class="sect2"><a href="#vi-scope">12.1.2. Scope</a></span></dt><dt><span class="sect2"><a href="#vi-ContextBindData">12.1.3. ContextBindData</a></span></dt></dl></dd><dt><span class="sect1"><a href="#vi-injection">12.2. Injection</a></span></dt><dd><dl><dt><span class="sect2"><a href="#vi-contextdata">12.2.1. @ContextData</a></span></dt><dt><span class="sect2"><a href="#vi-contextdataset">12.2.2. @ContextDataSet</a></span></dt><dt><span class="sect2"><a href="#vi-ContextDataFinder">12.2.3. ContextDataFinder</a></span></dt><dt><span class="sect2"><a href="#d5e1396">12.2.4. DataConvertor</a></span></dt><dt><span class="sect2"><a href="#d5e1398">12.2.5. ContextDataHolder</a></span></dt></dl></dd></dl></dd><dt><span class="chapter"><a href="#chapter-detail-url-rule">13. URL rule</a></span></dt><dd><dl><dt><span class="sect1"><a href="#rule-apis">13.1. Rule apis</a></span></dt><dd><dl><dt><span class="sect2"><a href="#UrlMappingRuleInitializer">13.1.1. UrlMappingRuleInitializer</a></span></dt><dt><span class="sect2"><a href="#d5e1452">13.1.2. Handy rules</a></span></dt></dl></dd><dt><span class="sect1"><a href="#d5e1535">13.2. Request handler result process</a></span></dt><dd><dl><dt><span class="sect2"><a href="#d5e1538">13.2.1. Content provider</a></span></dt><dt><span class="sect2"><a href="#d5e1540">13.2.2. Result transforming</a></span></dt><dt><span class="sect2"><a href="#d5e1542">13.2.3. Request handler chain</a></span></dt></dl></dd></dl></dd><dt><span class="chapter"><a href="#chapter-detail-form-flow">14. details of form flow</a></span></dt><dt><span class="chapter"><a href="#chapter-detail-i18n">15. i18n</a></span></dt><dd><dl><dt><span class="sect1"><a href="#i18n-message">15.1. message stringization</a></span></dt><dd><dl><dt><span class="sect2"><a href="#i18n-I18nMessageHelper">15.1.1. I18nMessageHelper</a></span></dt><dt><span class="sect2"><a href="#i18n-MessagePatternRetriever">15.1.2. MessagePatternRetriever</a></span></dt><dt><span class="sect2"><a href="#i18n-default-locale-decision">15.1.3. Default locale</a></span></dt><dt><span class="sect2"><a href="#i18n-afd-msg">15.1.4. afd:msg</a></span></dt></dl></dd><dt><span class="sect1"><a href="#i18n-file-search">15.2. file search order</a></span></dt></dl></dd><dt><span class="chapter"><a href="#overview">16. Asta4dServlet and configuration</a></span></dt><dd><dl><dt><span class="sect1"><a href="#d5e1677">16.1. Asta4dServlet</a></span></dt><dt><span class="sect1"><a href="#d5e1703">16.2. Configuration file</a></span></dt></dl></dd><dt><span class="chapter"><a href="#chapter-integration-spring">17. Integration with Spring</a></span></dt><dd><dl><dt><span class="sect1"><a href="#integrate-spring-ioc">17.1. Integrate with Spring IOC</a></span></dt><dt><span class="sect1"><a href="#integrate-spring-mvc">17.2. Integrate with Spring MVC</a></span></dt></dl></dd></dl></dd></dl></div>
  

  

  

  <div class="part"><div class="titlepage"><div><div><h1 class="title"><a name="asta4d-introduction"></a>Part&nbsp;I.&nbsp;Introduction</h1></div></div></div>
    
    
    <div class="partintro"><div></div>
      <p>
      Asta4D is a web application framework which is friendly to designer and flexible to developer. Asta4D affords
      high productivity than traditional MVC architecture by View First architecture. It also allows front-end engineers 
      and back-end engineers work independently without interference by separating rendering logic from template files.
      </p>
      
      <p>
      Asta4D is inspired by lift which is a famous scala web application framework and it is developed by astamuse company Ltd.
      locating at Tokyo Japan. We are concentrating on global innovation support and developing Asta4D for our own services.
      Currently, Asta4D is driving our new service development.

      </p>
    </div>
    <div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="chapter-overview"></a>1.&nbsp;Overview</h2></div></div></div>
  
  
  <div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d5e26"></a>1.1&nbsp;Why Asta4D</h2></div></div></div>
    
    <p>In the past decade, plenty of Java based web application frameworks are generated. Especially the MVC 
    architecture and JSP tag libs (or other traditional template technologies) that has greatly released our productivity. 
    But unfortunately, we are still suffering from the following situations:
    </p>
    
    <div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
        <p>The designers or front-end engineers are keeping complaining the mixed-in dynamic code, as they disturb 
        their efforts of redesigning the page style or structure. And in the mean time, the back-end developers are also 
        complaining that the front-end guys break the working page frequently,  because redesign or the new design is hard 
        to merge due to the huge cost of source refactorying. </p>
        <br>
      </li><li class="listitem">
        <p>The developers are complaining about the poor functionalities of template language which they are using 
        and tired from the various magic skills for complex rendering logic.</p>
        <br>
      </li><li class="listitem">
        <p>The developers are discontented with the counterproductivity of traditional MVC architecture and desire a more efficient 
        approach.</p>
        <br>
      </li></ul></div>
  </div>
  
  <div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d5e39"></a>1.2&nbsp;How Asta4D helps us</h2></div></div></div>
    
    <p>Asta4D is our solution to combat those issues. Thanks to lift, from where we learn a lot. We designed Asta4D complying
    with the following points:
    </p>
    
    <div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
        <p>Separate template and rendering logic</p>
        <p>Asta4D affords front-end engineers a friendly environment by separating rendering logic from template files which
        are pure html files. At the mean time, back-end engineers can use the powerful Java language to implement the rendering
        logic without being suffering from the "poor and sometimes magic" template languages.
        </p>
        <br>
      </li><li class="listitem">
        <p>Testable rendering logic</p>
        <p>All of the rendering logic in Asta4D is testable and developers can simply test them by writing simple junit cases, 
        which could replace over than half of selenium tests</p>
        <br>
      </li><li class="listitem">
        <p>High security of being immune from cross-site(XSS/CSRF)</p>
        <p>Asta4D is, by nature, immune from cross-site(XSS/CSRF) problems. You do not need to take care of cross-site any more. 
        All the rendered value would be escaped by default and your clients have no chance to put malicious contents to your server.
        </p>
        <br>
      </li><li class="listitem">
        <p>View first</p>
        <p>Asta4D also affords higher productivity than traditional MVC architecture by View First mechanism. And it is also easier 
        to change than traditional MVC architecture.
        </p>
        <br>
      </li><li class="listitem">
        <p>Isolate side effect with request handler</p>
        <p>Asta4D imports the conception of "side-effect" from functional programming languages and separating the "side-effect"
        by request handlers, which afford more flexibility on page rendering because the view layer is side-effect free now. Therefore
        Asta4D allows parallel page rendering in multiple threads as a built-in feature.
        </p>
        <br>
      </li><li class="listitem">
        <p>Advanced MVC</p>
        <p>Asta4D affords developers a evolved MVC architecture which is more clarified for the duty of each application layer than
        the traditional MVC architecture. 
        </p>
        <br>
      </li></ul></div>
  </div>

  <div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d5e67"></a>1.3&nbsp;What does the name of "Asta4D" mean</h2></div></div></div>
    
    <p>The name of Asta4D is from our company's name: astamuse. We explain the "4D" as following ways:</p> 
    
    <div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
        <p>For Designer</p>
        <p>Asta4D consider the design friendliness as the most important factor of itself. We hope web designers can fulfil their
        maximum potential of creativity without squandering their time on the back-end technologies which they could never be adept at.
        </p>
        <br>
      </li><li class="listitem">
        <p>For developer</p>
        <p>We hope Asta4D can help developers to achieve their work more easily. Developers would never be afflicted with complex
        rendering logic because they can use powerful Java language to do whatever they want since the rendering has been split from
        template files. View first also releases developers from the cumbersome MVC architecture, now they have more time to have a cup
        of coffee.</p>
        <br>
      </li><li class="listitem">
        <p>4 Dimension</p>
        <p>We believe that Asta4D can act as a wormhole that connects the front-end and the back-end. We can move quicker by Asta4D just
        like we are going through the 4 dimensional space.
        </p>
        <br>
      </li></ul></div>
  </div>
</div>
  </div>

  <div class="part"><div class="titlepage"><div><div><h1 class="title"><a name="asta4d-user-guide"></a>Part&nbsp;II.&nbsp;User Guide</h1></div></div></div>
    
    <div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="chapter-Inheritable-template"></a>2.&nbsp;Flexible template</h2></div></div></div>
  
  
    <div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="inheritable-template"></a>2.1&nbsp;Inheritable template</h2></div></div></div>
      
      <p>
      The template of Asta4D is inheritable, child template can override, append or insert content to certain place
      in parent template. Let's see a sample:
      </p>
      <div class="example"><a name="d5e90"></a><p class="title"><b>Example&nbsp;2.1.&nbsp;parent.html</b></p><div class="example-contents">
      <pre class="programlisting">

<span class="hl-tag">&lt;html&gt;</span>   
    <span class="hl-tag">&lt;head&gt;</span>   
        <span class="hl-tag">&lt;afd:block</span> <span class="hl-attribute">id</span>=<span class="hl-value">"block1"</span><span class="hl-tag">&gt;</span>   
            <span class="hl-tag">&lt;link</span> <span class="hl-attribute">href</span>=<span class="hl-value">"parent1.css"</span> <span class="hl-attribute">rel</span>=<span class="hl-value">"stylesheet"</span> <span class="hl-attribute">type</span>=<span class="hl-value">"text/css"</span><span class="hl-tag"> /&gt;</span>   
        <span class="hl-tag">&lt;/afd:block&gt;</span>   
           
        <span class="hl-tag">&lt;afd:block</span> <span class="hl-attribute">id</span>=<span class="hl-value">"block2"</span><span class="hl-tag">&gt;</span>   
            <span class="hl-tag">&lt;link</span> <span class="hl-attribute">href</span>=<span class="hl-value">"parent2.css"</span> <span class="hl-attribute">rel</span>=<span class="hl-value">"stylesheet"</span> <span class="hl-attribute">type</span>=<span class="hl-value">"text/css"</span><span class="hl-tag"> /&gt;</span>   
        <span class="hl-tag">&lt;/afd:block&gt;</span>   
  
        <span class="hl-tag">&lt;title&gt;</span>extension sample<span class="hl-tag">&lt;/title&gt;</span>   
    <span class="hl-tag">&lt;/head&gt;</span>   
    <span class="hl-tag">&lt;body&gt;</span>   
        <span class="hl-tag">&lt;afd:block</span> <span class="hl-attribute">id</span>=<span class="hl-value">"content"</span><span class="hl-tag">&gt;</span>content<span class="hl-tag">&lt;/afd:block&gt;</span>   
    <span class="hl-tag">&lt;/body&gt;</span>   
<span class="hl-tag">&lt;/html&gt;</span>

      </pre>
      </div></div><br class="example-break">

      <p>Child template can declare inheritance by "afd:extension" and overriding can be declared by "afd:block":</p>
      <div class="example"><a name="template-child"></a><p class="title"><b>Example&nbsp;2.2.&nbsp;child.html</b></p><div class="example-contents">
      <pre class="programlisting">

<span class="hl-tag">&lt;afd:extension</span> <span class="hl-attribute">parent</span>=<span class="hl-value">"parent.html"</span><span class="hl-tag">&gt;</span>   
  
    <span class="hl-tag">&lt;afd:block</span> <span class="hl-attribute">append</span>=<span class="hl-value">"block1"</span><span class="hl-tag">&gt;</span>   
        <span class="hl-tag">&lt;link</span> <span class="hl-attribute">href</span>=<span class="hl-value">"child1.css"</span> <span class="hl-attribute">rel</span>=<span class="hl-value">"stylesheet"</span> <span class="hl-attribute">type</span>=<span class="hl-value">"text/css"</span><span class="hl-tag"> /&gt;</span>   
    <span class="hl-tag">&lt;/afd:block&gt;</span>   
  
    <span class="hl-tag">&lt;afd:block</span> <span class="hl-attribute">insert</span>=<span class="hl-value">"block2"</span><span class="hl-tag">&gt;</span>   
        <span class="hl-tag">&lt;link</span> <span class="hl-attribute">href</span>=<span class="hl-value">"child2.css"</span> <span class="hl-attribute">rel</span>=<span class="hl-value">"stylesheet"</span> <span class="hl-attribute">type</span>=<span class="hl-value">"text/css"</span><span class="hl-tag"> /&gt;</span>   
    <span class="hl-tag">&lt;/afd:block&gt;</span>   
  
    <span class="hl-tag">&lt;afd:block</span> <span class="hl-attribute">override</span>=<span class="hl-value">"content "</span><span class="hl-tag">&gt;</span>   
        <span class="hl-tag">&lt;div&gt;</span>hello<span class="hl-tag">&lt;/div&gt;</span>   
        <span class="hl-tag">&lt;afd:embed</span> <span class="hl-attribute">target</span>=<span class="hl-value">"/templates/embed.html"</span><span class="hl-tag"> &gt;</span><span class="hl-tag">&lt;/afd:embed&gt;</span>   
    <span class="hl-tag">&lt;/afd:block&gt;</span>   
  
<span class="hl-tag">&lt;/afd:extension&gt;</span>   

      </pre>
      </div></div><br class="example-break">
      
      <p>
      "afd:block" support 3 types action: insert, append and override. 
      </p>
      
      <br>
      
      <p>
      In the <a class="xref" href="#template-child" title="Example&nbsp;2.2.&nbsp;child.html">Example&nbsp;2.2, &#8220;child.html&#8221;</a>, there is an additional declaration of including by "afd:embed" which embed 
      the target file to the current place of the current file. Let's see the embed.html:
      </p>
      <div class="example"><a name="d5e101"></a><p class="title"><b>Example&nbsp;2.3.&nbsp;embed.html</b></p><div class="example-contents">
      <pre class="programlisting">

    <span class="hl-tag">&lt;afd:block</span> <span class="hl-attribute">append</span>=<span class="hl-value">"block1"</span><span class="hl-tag">&gt;</span>   
        <span class="hl-tag">&lt;link</span> <span class="hl-attribute">href</span>=<span class="hl-value">"embed.css"</span> <span class="hl-attribute">rel</span>=<span class="hl-value">"stylesheet"</span> <span class="hl-attribute">type</span>=<span class="hl-value">"text/css"</span><span class="hl-tag"> /&gt;</span>   
    <span class="hl-tag">&lt;/afd:block&gt;</span>   
    <span class="hl-tag">&lt;div&gt;</span>good embed<span class="hl-tag">&lt;/div&gt;</span>   

      </pre>
      </div></div><br class="example-break">
      
      <p>
      The "afd:block" declaration in the embeded target file is available after the content of target file is inserted into the
      <a class="xref" href="#template-child" title="Example&nbsp;2.2.&nbsp;child.html">Example&nbsp;2.2, &#8220;child.html&#8221;</a>, all "afd:block" tags will be treated as overriding(inserting/appending) to the parent template
      and the contents out of "afd:blocks" will be inserted at the place where the "afd:embed" is declared.
      </p>
      
      <br>
      
      <p>After all the template files are merged, we will get the following result:</p>
      <div class="example"><a name="d5e108"></a><p class="title"><b>Example&nbsp;2.4.&nbsp;The result of template merging:</b></p><div class="example-contents">
      <pre class="programlisting">

<span class="hl-tag">&lt;html&gt;</span>   
<span class="hl-tag">&lt;head&gt;</span>   
       
    <span class="hl-comment">&lt;!-- block1 --&gt;</span>   
    <span class="hl-tag">&lt;link</span> <span class="hl-attribute">href</span>=<span class="hl-value">"parent1.css"</span> <span class="hl-attribute">rel</span>=<span class="hl-value">"stylesheet"</span> <span class="hl-attribute">type</span>=<span class="hl-value">"text/css"</span><span class="hl-tag"> /&gt;</span>   
    <span class="hl-tag">&lt;link</span> <span class="hl-attribute">href</span>=<span class="hl-value">"child1.css"</span> <span class="hl-attribute">rel</span>=<span class="hl-value">"stylesheet"</span> <span class="hl-attribute">type</span>=<span class="hl-value">"text/css"</span><span class="hl-tag"> /&gt;</span>   
    <span class="hl-tag">&lt;link</span> <span class="hl-attribute">href</span>=<span class="hl-value">"embed.css"</span> <span class="hl-attribute">rel</span>=<span class="hl-value">"stylesheet"</span> <span class="hl-attribute">type</span>=<span class="hl-value">"text/css"</span><span class="hl-tag"> /&gt;</span>   
  
    <span class="hl-comment">&lt;!-- block2 --&gt;</span>   
    <span class="hl-tag">&lt;link</span> <span class="hl-attribute">href</span>=<span class="hl-value">"child2.css"</span> <span class="hl-attribute">rel</span>=<span class="hl-value">"stylesheet"</span> <span class="hl-attribute">type</span>=<span class="hl-value">"text/css"</span><span class="hl-tag"> /&gt;</span>   
    <span class="hl-tag">&lt;link</span> <span class="hl-attribute">href</span>=<span class="hl-value">"parent2.css"</span> <span class="hl-attribute">rel</span>=<span class="hl-value">"stylesheet"</span> <span class="hl-attribute">type</span>=<span class="hl-value">"text/css"</span><span class="hl-tag"> /&gt;</span>   
  
    <span class="hl-tag">&lt;title&gt;</span>extension sample<span class="hl-tag">&lt;/title&gt;</span>   
  
<span class="hl-tag">&lt;/head&gt;</span>   
<span class="hl-tag">&lt;body&gt;</span>   
  
    <span class="hl-comment">&lt;!-- content --&gt;</span>   
    <span class="hl-tag">&lt;div&gt;</span>hello<span class="hl-tag">&lt;/div&gt;</span>   
  
    <span class="hl-comment">&lt;!-- embed --&gt;</span>   
    <span class="hl-tag">&lt;div&gt;</span>good embed<span class="hl-tag">&lt;/div&gt;</span>   
  
<span class="hl-tag">&lt;/body&gt;</span>   
<span class="hl-tag">&lt;/html&gt;</span>  

      </pre>
      </div></div><br class="example-break">
      
      
    </div>

    <div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="parametrized-embedding"></a>2.2&nbsp;Parametrized embedding</h2></div></div></div>
      
      
      <p>
      Extra parameters can be passed to the target embeded file by specifying the DOM attribute of "afd:embed" when we
      are embeding files.
      </p>
      
      <div class="example"><a name="d5e114"></a><p class="title"><b>Example&nbsp;2.5.&nbsp;Sample of parametrized embeding:</b></p><div class="example-contents">
      <pre class="programlisting">

<span class="hl-tag">&lt;afd:embed</span> <span class="hl-attribute">target</span>=<span class="hl-value">"/xxx/showList.html"</span> <span class="hl-attribute">limit</span>=<span class="hl-value">"30"</span><span class="hl-tag">&gt;</span><span class="hl-tag">&lt;/afd:embed&gt;</span>

      </pre>
      </div></div><br class="example-break">

      <p>
      The "limit" parameter can be accessed by variable injection in the rendering logic of showList.html, by which we can
      parameterize the embeding. This feature is very useful for creating a page component which encapsulates common
      html snippets and can be controlled by the passed parameters. Basically, embeding a file in a template file
      is similar to calling a function with(or without) arguments. Especially, the parameters are not limited to
      specified static values in the template file, they can be valued dynamicaly at runtime too. Further, the
      type of parameters is not restricted to the stringizable types such as String or Integer/Long, arbitrary Java type
      can be specified dynamically at runtime. See the reference of Renering logic to learn more details. 
      </p>
    </div>

  <p>
  Simply, the idea of Asta4D's template system is akin to the traditional OOP model, the parent and child templates can be 
  regarded as parent/child classes and the block can be viewed as a overridable virtual method. The embed external files can
  be also treated as funcation calling. As a matter of fact, since arbitrary type of value can be passed to the embed files, 
  there is actually no difference between Asta4D's embeding and common function calling.
  </p>
</div>
    <div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="renderer"></a>3.&nbsp;Renderer: easy to use, secure, testable</h2></div></div></div>
  
  
  <div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="split-rendering"></a>3.1&nbsp;Split rendering logic from template</h2></div></div></div>
    
    
    <p>
    There is no dynamic code in a template file. An Asta4D template file is always a pure HTML file which can be easily 
    maintained by front-end developers, it is very design friendly and we can reduce the workload for source 
    refactoring by over 90%.
    </p>
    
    <div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
        <p>Declare snippet class in template file</p>
        <div class="example"><a name="d5e127"></a><p class="title"><b>Example&nbsp;3.1.&nbsp;Sample of snippet declaration:</b></p><div class="example-contents">
        <pre class="programlisting">

<span class="hl-tag">&lt;section&gt;</span>  
    <span class="hl-tag">&lt;article&gt;</span>  
        <span class="hl-tag">&lt;div</span> <span class="hl-attribute">afd:render</span>=<span class="hl-value">"SimpleSnippet"</span><span class="hl-tag">&gt;</span>dummy text<span class="hl-tag">&lt;/div&gt;</span>  
        <span class="hl-tag">&lt;afd:snippet</span> <span class="hl-attribute">render</span>=<span class="hl-value">"SimpleSnippet:setProfile"</span><span class="hl-tag">&gt;</span>  
            <span class="hl-tag">&lt;p</span> <span class="hl-attribute">id</span>=<span class="hl-value">"name"</span><span class="hl-tag">&gt;</span>name:<span class="hl-tag">&lt;span&gt;</span>dummy name<span class="hl-tag">&lt;/span&gt;</span><span class="hl-tag">&lt;/p&gt;</span>  
            <span class="hl-tag">&lt;p</span> <span class="hl-attribute">id</span>=<span class="hl-value">"age"</span><span class="hl-tag">&gt;</span>age:<span class="hl-tag">&lt;span&gt;</span>0<span class="hl-tag">&lt;/span&gt;</span><span class="hl-tag">&lt;/p&gt;</span>  
        <span class="hl-tag">&lt;/afd:snippet&gt;</span>  
    <span class="hl-tag">&lt;/article&gt;</span>  
<span class="hl-tag">&lt;/section&gt;</span>

        </pre>
        </div></div><br class="example-break">
    
        <p>
        The "afd:render" attribute in div tag declares a Java class which is in charge of the concrete rendering logic, such Java
        class is usually called as a snippet class. A snippet class can be declared by a "afd:snippet" tag too, as you have seen
        in above sample. The rendering logic is secluded to independent Java classes by snippet declaration and it is not necessary
        to learn any new template language for back-end developers. The back-end guys can achieve all the rendering logic easily
        by powerful Java language which they have been adept to, no learning costs, no magic codes, succinct Java source only.
        </p>
        
        <br>
        
      </li><li class="listitem">
        <p>Implement a snippet class</p>
        <div class="example"><a name="d5e134"></a><p class="title"><b>Example&nbsp;3.2.&nbsp;Sample of snippet class:</b></p><div class="example-contents">
        <pre class="programlisting">

<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> SimpleSnippet {  
  
    <span class="hl-keyword">public</span> Renderer render(String name) {  
        <span class="hl-keyword">if</span> (StringUtils.isEmpty(name)) {  
            name = <span class="hl-string">"Asta4D"</span>;  
        }
        <span class="hl-keyword">return</span> Renderer.create(<span class="hl-string">"div"</span>, name);  
    }  
  
    <span class="hl-keyword">public</span> Renderer setProfile() {  
        Renderer render = Renderer.create(); 
        render.add(<span class="hl-string">"p#name span"</span>, <span class="hl-string">"asta4d"</span>);  
        render.add(<span class="hl-string">"p#age span"</span>, <span class="hl-number">20</span>);  
        <span class="hl-keyword">return</span> render;  
    }  
}

        </pre>
        </div></div><br class="example-break">
        
        <p>
        The Renderer class is provided by framework to declare rendering actions. Renderer uses traditional CSS selector to
        reference the rendering target and receive the rendering value at the same time, amazing and powerful.
        </p>
        <br>
        
        <p>If the above template file and snippet class are executed, we would get the following result:</p>
        <div class="example"><a name="d5e140"></a><p class="title"><b>Example&nbsp;3.3.&nbsp;Result of snippet execution:</b></p><div class="example-contents">
        <pre class="programlisting">

<span class="hl-tag">&lt;section&gt;</span>  
    <span class="hl-tag">&lt;article&gt;</span>  
        <span class="hl-tag">&lt;span&gt;</span>Hello Asta4D<span class="hl-tag">&lt;/span&gt;</span>  
            <span class="hl-tag">&lt;p</span> <span class="hl-attribute">id</span>=<span class="hl-value">"name"</span><span class="hl-tag">&gt;</span>name:<span class="hl-tag">&lt;span&gt;</span>asta4d/span&gt;<span class="hl-tag">&lt;/p&gt;</span>  
            <span class="hl-tag">&lt;p</span> <span class="hl-attribute">id</span>=<span class="hl-value">"age"</span><span class="hl-tag">&gt;</span>age:<span class="hl-tag">&lt;span&gt;</span>20<span class="hl-tag">&lt;/span&gt;</span><span class="hl-tag">&lt;/p&gt;</span>  
    <span class="hl-tag">&lt;/article&gt;</span>  
<span class="hl-tag">&lt;/section&gt;</span>

        </pre>
        </div></div><br class="example-break">
      </li></ul></div>

    <p>
    Asta4D introduces 4 extra tags to the html template file: afd:extension, afd:block, afd:embed, afd:snippet, which will not
    disturb most html editors, accordingly Asta4D is extremely friendly to front-end engineers. On the other hand, we can see
    that all the rendering logic is fulfiled by Java code and the back-end engineers can compose their back-end logic and rendering logic
    very smoothly without magic skills and extra learning costs, which means highly boost of productivity.
    </p>
  </div>
  
  <div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="render-to-page"></a>3.2&nbsp;Render data to page</h2></div></div></div>
    
    <p class="remark"><em><span class="remark">Be careful of "ElementUtil.parseAsSingle" which would cause cross-site issues. Basically the parseAsSingle api is not recommended for
            common use. See more at<a class="xref" href="#immune-from-xss" title="3.3&nbsp;Immune from cross-site hole">Section&nbsp;3.3, &#8220;Immune from cross-site hole&#8221;</a>.</span></em></p>
    <div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
        <p>In Asta4D, all the rendering logic is declared by a Renderer class which accepts various types as rendering value.</p>
        <div class="example"><a name="d5e151"></a><p class="title"><b>Example&nbsp;3.4.&nbsp;Sample usage of Renderer</b></p><div class="example-contents">
        <pre class="programlisting">

Renderer render = Renderer.create();
render.add(<span class="hl-string">"#someIdForInt"</span>, <span class="hl-number">12345</span>);  
render.add(<span class="hl-string">"#someIdForLong"</span>, <span class="hl-number">12345L</span>);  
render.add(<span class="hl-string">"#someIdForBool"</span>, true);  
render.add(<span class="hl-string">"#someIdForStr"</span>, <span class="hl-string">"a str"</span>);  
render.add(<span class="hl-string">"#someIdForNull"</span>, (Object) null);  
render.add(<span class="hl-string">"#someIdForClear"</span>, Clear);  

<span class="hl-comment">// NOTE: parseAsSingle is not recommended to use</span>
Element newChild = ElementUtil.parseAsSingle(<span class="hl-string">"&lt;div&gt;&lt;/div&gt;"</span>);  

render.add(<span class="hl-string">"#someIdForElementSetter"</span>, <span class="hl-keyword">new</span> ChildReplacer(newChild));  
render.add(<span class="hl-string">"#someIdForElement"</span>, ElementUtil.parseAsSingle(<span class="hl-string">"&lt;div&gt;eee&lt;/div&gt;"</span>));  
render.add(<span class="hl-string">"#someIdForRenderer"</span>, Renderer.create(<span class="hl-string">"#value"</span>, <span class="hl-string">"value"</span>));  

        </pre>
        </div></div><br class="example-break">
      </li><li class="listitem">
        <p>List of data can be rendered via Renderer too:</p>
        <div class="example"><a name="d5e156"></a><p class="title"><b>Example&nbsp;3.5.&nbsp;Sample of list rendering</b></p><div class="example-contents">
        <pre class="programlisting">

Renderer render = Renderer.create()();  
render.add(<span class="hl-string">"#someIdForInt"</span>, Arrays.asList(<span class="hl-number">123</span>, <span class="hl-number">456</span>, <span class="hl-number">789</span>));  
render.add(<span class="hl-string">"#someIdForLong"</span>, Arrays.asList(<span class="hl-number">123L</span>, <span class="hl-number">456L</span>, <span class="hl-number">789L</span>));  
render.add(<span class="hl-string">"#someIdForBool"</span>, Arrays.asList(true, true, false));  
render.add(<span class="hl-string">"#someIdForStr"</span>, Arrays.asList(<span class="hl-string">"str1"</span>, <span class="hl-string">"str2"</span>, <span class="hl-string">"str3"</span>));  

<span class="hl-comment">// NOTE: parseAsSingle is not recommended to use</span>

Element newChild1 = ElementUtil.parseAsSingle(<span class="hl-string">"&lt;div&gt;1&lt;/div&gt;"</span>);  
Element newChild2 = ElementUtil.parseAsSingle(<span class="hl-string">"&lt;div&gt;2&lt;/div&gt;"</span>);  
  
render.add(<span class="hl-string">"#someIdForElementSetter"</span>, Arrays.asList(<span class="hl-keyword">new</span> ChildReplacer(newChild1), <span class="hl-keyword">new</span> ChildReplacer(newChild2)));  
render.add(<span class="hl-string">"#someIdForElement"</span>, Arrays.asList(newChild1, newChild2));  
render.add(<span class="hl-string">"#someIdForRenderer"</span>, Arrays.asList(<span class="hl-number">123</span>, <span class="hl-number">456</span>, <span class="hl-number">789</span>), <span class="hl-keyword">new</span> RowRenderer&lt;Integer&gt;() {  
    <em><span class="hl-annotation" style="color: gray">@Override</span></em>  
    <span class="hl-keyword">public</span> Renderer convert(<span class="hl-keyword">int</span> rowIndex, Integer obj) {  
        <span class="hl-keyword">return</span> Renderer.create(<span class="hl-string">"#id"</span>, <span class="hl-string">"id-"</span> + obj).add(<span class="hl-string">"#otherId"</span>, <span class="hl-string">"otherId-"</span> + obj);  
    }  
});   

        </pre>
        </div></div><br class="example-break">
      </li><li class="listitem">
        <p>DOM attribution can be done too:</p>
        <div class="example"><a name="d5e161"></a><p class="title"><b>Example&nbsp;3.6.&nbsp;Sample of DOM attribution rendering</b></p><div class="example-contents">
        <pre class="programlisting">

render.add(<span class="hl-string">"#id"</span>, <span class="hl-string">"+class"</span>, <span class="hl-string">"yyy"</span>);  
render.add(<span class="hl-string">"#id"</span>, <span class="hl-string">"-class"</span>, <span class="hl-string">"zzz"</span>);  
  
render.add(<span class="hl-string">"#id"</span>, <span class="hl-string">"+class"</span>, <span class="hl-string">"xxx"</span>);  
  
render.add(<span class="hl-string">"#id"</span>, <span class="hl-string">"value"</span>, <span class="hl-string">"hg"</span>);  
render.add(<span class="hl-string">"#id"</span>, <span class="hl-string">"href"</span>, null);  
  
render.add(<span class="hl-string">"#X"</span>, <span class="hl-string">"value"</span>, <span class="hl-keyword">new</span> Date(<span class="hl-number">123456L</span>));

        </pre>
        </div></div><br class="example-break">
      </li></ul></div>
  </div>

  <div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="immune-from-xss"></a>3.3&nbsp;Immune from cross-site hole</h2></div></div></div>
    
    <p>
    The previous samples show us that all the operations to DOM are delegated by Renderer except create DOM
    from String value by "ElementUtil#parseAsSingle". As a matter of fact, all the delegated operations cause
    all the rendering values are escaped by force, which means that your system is, by nature, immune from
    cross-site problems if there is no "ElementUtil#parseAsSingle" calling in your system. You do not need
    to be wary of illegal characters by from the clients since all the values will be escaped as HTML compulsorily.
    </p>
    
    On the other hand, according to our practice, it is rarely that you have to call &#8220;ElementUtil.parseAsSingle&#8221;
    to generate the rendering content from a raw HTML string, so just take care of your usage of this exceptional api
    then you can say bye-bye to the cross-site holes.    
  </div>
  
  <div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="test-rendering"></a>3.4&nbsp;Test your rendering logic</h2></div></div></div>
    
    <p>
    Testing web page is always a complex task and we usually verify rendering results by selenuim which is as a common
    technology. By Asta4D, testable Renderer can replace over than half of selenium tests to simpler junit tests.
    </p>
    
    <p>
    According to the previous samples, all the rendering logic is holded by an instance of Renderer class, so simply,
    we can verify almost rendering logic by testing the returned Renderer instance from the snippet method. 
    </p>
    
    <div class="example"><a name="d5e171"></a><p class="title"><b>Example&nbsp;3.7.&nbsp;Sample RendererTester</b></p><div class="example-contents">
    <pre class="programlisting">

RendererTester tester = RendererTester.forRenderer(render);  
Assert.assertEquals(tester.get(<span class="hl-string">"#someIdForInt"</span>), <span class="hl-number">12345</span>);  
Assert.assertEquals(tester.get(<span class="hl-string">"#someIdForLong"</span>), <span class="hl-number">12345L</span>);  
Assert.assertEquals(tester.get(<span class="hl-string">"#someIdForBool"</span>), true);  
Assert.assertEquals(tester.get(<span class="hl-string">"#someIdForStr"</span>), <span class="hl-string">"a str"</span>);  
Assert.assertEquals(tester.get(<span class="hl-string">"#someIdForNull"</span>), null);  
Assert.assertEquals(tester.get(<span class="hl-string">"#someIdForClear"</span>), Clear);  

    </pre>
    <p>More samples can be found in <a class="ulink" href="https://github.com/astamuse/asta4d/blob/develop/asta4d-core/src/test/java/com/astamuse/asta4d/test/unit/RenderTesterTest.java" target="_top">source</a></p>
    </div></div><br class="example-break">

  </div>
  
</div>
    <div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="url-mapping"></a>4.&nbsp;View first URL mapping and variable injection</h2></div></div></div>
  
  
  <div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="view-first-mechanism"></a>4.1&nbsp;View first</h2></div></div></div>
    

    <p>
    In Asta4D, we follow the principle of view first rather than the tradition MVC architecture. The declaration of URL rules
    does not need to include a controller and one url can be mapped to one template file directly, which is called as View First.
    </p>
    
    <p>
    In Asta4D, URL mapping rules are not managed in a configuration file. The Framework provides a sort of DSL by a set of convinient
    APIs, which means the declaration of Asta4D's URL mapping rule is programmable and it affords much flexibility than the way with a
    static configuration file.    
    </p>
    
    <p>
    Users declare their own URL rules via implementing the interface UrlMappingRuleInitializer of Asta4D:
    </p>
    
    <div class="example"><a name="d5e183"></a><p class="title"><b>Example&nbsp;4.1.&nbsp;Sample of declaring url rules:</b></p><div class="example-contents">
    <pre class="programlisting">

<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> UrlRules <span class="hl-keyword">implements</span> UrlMappingRuleInitializer {    
    
    <em><span class="hl-annotation" style="color: gray">@Override</span></em>    
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> initUrlMappingRules(UrlMappingRuleHelper rules) {    
        <span class="hl-comment">//@formatter:off    </span>
        rules.add(GET, <span class="hl-string">"/"</span>)    
             .redirect(<span class="hl-string">"/app/index"</span>);    
            
        rules.add(GET, <span class="hl-string">"/redirect-to-index"</span>)    
             .redirect(<span class="hl-string">"p:/app/index"</span>);    
            
        rules.add(<span class="hl-string">"/app/"</span>, <span class="hl-string">"/templates/index.html"</span>);    
        rules.add(<span class="hl-string">"/app/index"</span>, <span class="hl-string">"/templates/index.html"</span>);    
        rules.add(<span class="hl-string">"/app/{name}/{age}"</span>, <span class="hl-string">"/templates/variableinjection.html"</span>)&#65307;    
        ...    
    
        <span class="hl-comment">//@formatter:on    </span>
    }
}

    </pre>
    </div></div><br class="example-break">
  </div>
  
  <div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="url-rule-grammer"></a>4.2&nbsp;The grammer of URL rule and path variable</h2></div></div></div>
    
    <p>
    The grammer of Asta4D's URL rule is almost the same as Spring MVC's URL mapping rule and the parts surrounded by braces are 
    treated as path variables which can be retrieved in following process(in snippet classes or request handlers).
    </p>
    
    <p>
    Further, extra path variables can be declared in a url rule by calling the method of "var" as following:
    </p>
    <div class="example"><a name="d5e190"></a><p class="title"><b>Example&nbsp;4.2.&nbsp;Sample of declaring extra path variable:</b></p><div class="example-contents">
    <pre class="programlisting">

rules.add(<span class="hl-string">"/app/{name}/{age}"</span>, <span class="hl-string">"/templates/variableinjection.html"</span>)  
     .var(<span class="hl-string">"extraVar"</span>, <span class="hl-number">1234</span>);  

    </pre>
    </div></div><br class="example-break">
  </div>
  
  <div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="variable-injection"></a>4.3&nbsp;Variable Injection</h2></div></div></div>
    
    <p>
    Asta4D implements a variable injection mechanism which is very closed to Spring MVC, all of the instance fields 
    and method parameters in the implementation of snippet classes can be injected automatically by framework.
    </p>
    
    <p>
    Further, all the snippet classes are singleton in request scope.In other words, there will be only one istance of any 
    snippet class in a single request scope regardless of how many times the snippet class is called. Let us see some samples
    of variable injection in the snippet class.
    </p>
    
    <div class="example"><a name="d5e197"></a><p class="title"><b>Example&nbsp;4.3.&nbsp;</b></p><div class="example-contents">
    <pre class="programlisting">

<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> InitSnippet <span class="hl-keyword">implements</span> InitializableSnippet {    
    
    <em><span class="hl-annotation" style="color: gray">@ContextData</span></em>    
    <span class="hl-keyword">private</span> String value; <span class="hl-comment">// (1)    </span>
    <span class="hl-keyword">private</span> <span class="hl-keyword">long</span> id;    
    <span class="hl-keyword">private</span> String resolvedValue;    
    <span class="hl-keyword">private</span> <span class="hl-keyword">int</span> count = <span class="hl-number">0</span>;    

}    

    </pre>
    <p>
    @ContextData indicates that the instance field "value" need to be injected after the instance of InitSnippet is created. 
    Since the snippet instance is singeleton in the current request scope, the instance field "value" will be injected and 
    initialized only once in the current request scope. The framework will search a variable named "value" in all the available
    variable scopes and inject the found value. The name of "value" is decided by the field name by default and can be
    sepcified by extra declaration(see the following samples).
    </p>
    </div></div><br class="example-break">
    
    <div class="example"><a name="d5e200"></a><p class="title"><b>Example&nbsp;4.4.&nbsp;</b></p><div class="example-contents">
    <pre class="programlisting">

<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> InitSnippet <span class="hl-keyword">implements</span> InitializableSnippet {    

    <em><span class="hl-annotation" style="color: gray">@ContextData</span></em>    
    <span class="hl-keyword">private</span> <span class="hl-keyword">void</span> setId(<span class="hl-keyword">long</span> id) {&#12288;<span class="hl-comment">//(3)    </span>
        <span class="hl-keyword">this</span>.id = id;    
    }    

}    

    </pre>
    <p>Instance field can be injected via setter methods too.</p>
    </div></div><br class="example-break">
    
    <div class="example"><a name="d5e203"></a><p class="title"><b>Example&nbsp;4.5.&nbsp;</b></p><div class="example-contents">
    <pre class="programlisting">

<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> InitSnippet <span class="hl-keyword">implements</span> InitializableSnippet {    
    
    <em><span class="hl-annotation" style="color: gray">@Override</span></em>    
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> init() <span class="hl-keyword">throws</span> SnippetInvokeException { <span class="hl-comment">//(2)    </span>
        resolvedValue = value + <span class="hl-string">"-resolved"</span>;    
        count++;    
    }  

}    

    </pre>
    <p>
    The init method of InitializableSnippet is being implemented. This is not necessary but if a snippet class implements 
    the interface of InitializableSnippet, the init method will be called once after all the instance fields are injected,
    by which customized snippet initial logic can be performed.
    </p>
    </div></div><br class="example-break">
    
    <div class="example"><a name="d5e206"></a><p class="title"><b>Example&nbsp;4.6.&nbsp;</b></p><div class="example-contents">
    <pre class="programlisting">

<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> InitSnippet <span class="hl-keyword">implements</span> InitializableSnippet {    

    <span class="hl-comment">// (4)    </span>
    <span class="hl-keyword">public</span> Renderer getPathVarName(    
    <em><span class="hl-annotation" style="color: gray">@ContextData(scope = WebApplicationContext.SCOPE_PATHVAR)</span></em>    
    <span class="hl-keyword">int</span> count) {    
    }

}    

    </pre>
    <p>
    Variable injection on snippet method. In this sample the extra search scope are delcared, which cause framework searches
    a variable named "count" in the path variable scope. As the same as the injection on instance field, the searching variable
    name is decided by the parameter name by default.
    </p>
    </div></div><br class="example-break">
    
    <div class="example"><a name="d5e209"></a><p class="title"><b>Example&nbsp;4.7.&nbsp;</b></p><div class="example-contents">
    <pre class="programlisting">

<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> InitSnippet <span class="hl-keyword">implements</span> InitializableSnippet {    

    <span class="hl-comment">// (5)    </span>
    <span class="hl-keyword">public</span> Renderer getQueryParamName(    
    <em><span class="hl-annotation" style="color: gray">@ContextData(name = "var", scope = WebApplicationContext.SCOPE_QUERYPARAM)</span></em>    
    String name) {    
    }    

}    

    </pre>
    <p>
    In this sample, an extra variable name and search scope are declared, the framework will search a variable named "var" in the
    request parameters.
    </p>
    </div></div><br class="example-break">    

    <div class="example"><a name="d5e212"></a><p class="title"><b>Example&nbsp;4.8.&nbsp;</b></p><div class="example-contents">
    <pre class="programlisting">

<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> InitSnippet <span class="hl-keyword">implements</span> InitializableSnippet {    

    <span class="hl-comment">// (6)    </span>
    <span class="hl-keyword">public</span> Renderer getDefaultName(String name) {    
    } 

}    

    </pre>
    <p>
    There is a difference between instance field injection and method parameter injection. A instance field without @ContextData
    annotation will not be injected, but for method paramters, all the paramters will be injected compulsorily. In this sample,
    the framework will search a variable named "name" in all the available scopes as following order:
    </p>
    <div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">
        <p>HTML tag attribution(SCOPE_ATTR)</p>
        <p>Trace back to the top tag of the current HTML document recursively. This scope is only available to the snippet method.</p>
      </li><li class="listitem">
        <p>path variable(SCOPE_PATHVAR)</p>
      </li><li class="listitem">
        <p>request parameter(SCOPE_QUERYPARAM)</p>
      </li><li class="listitem">
        <p>flash variable(SCOPE_FLASH)</p>
        <p>The variables passed from one request to another request, usually acrross a redirect.</p>
      </li><li class="listitem">
        <p>cookie(SCOPE_COOKIE)</p>
      </li><li class="listitem">
        <p>request hearder(SCOPE_HEADER)</p>
      </li><li class="listitem">
        <p>request attribute(SCOPE_REQUEST)</p>
      </li><li class="listitem">
        <p>session(SCOPE_SESSION)</p>
      </li><li class="listitem">
        <p>global(SCOPE_GLOBAL)</p>
        <p>A global static variable pool</p>
      </li></ol></div>
    <p>
      This search order is applied to the instance field injection too except that the first scope of HTML tag attribution is not available.
    </p>
    </div></div><br class="example-break">


    
  </div>

</div>
    <div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="chapter-side-effect"></a>5.&nbsp;Side effect and request handler</h2></div></div></div>
  
 
  <div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d5e240"></a>5.1&nbsp;The role with responsibility to http request: Request Handler</h2></div></div></div>
    
    <p>
    Even Asta4D complies with the principle of view first, there is still a role similar with the controller in MVC
    architecture, such role is called request handler. We believe that there should be a role who takes responsiblity
    of a certain http request and such role can be considered as an alternative to controller of MVC in some situations
    too.
    </p>
    
    <p>
    According to the view first rule, a request handler can be ignored in most cases. You can also assume that there is
    is a default request handler which navigates all the http requests to the corresponding template files(The real 
    story is more complex but you can try to understand the theory conceptually by this way).
    </p>
    
    <p>
    Now the question is when we need a request handler? Before we can answer this question, we have to discuss the conception
    of "side effect".
    </p>
  </div>

  <div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d5e245"></a>5.2&nbsp;Side effect of system operations</h2></div></div></div>
    

    <p>
    A system always afford users various operations such as query, update, etc. All of these operations will affect the status
    of system in various ways. In Asta4D, we say that there are two types of action in a system, one is with &#8220;side effect&#8221;, 
    another one is without &#8220;side effect&#8221;. &#8220;actions with side effect&#8221; are ones that will change the system status once they are
    performed. For instance, for the same URL, a login request (if succeeded) will cause a client&#8217;s privilege to be changed and 
    the client could probably get a different page view from what the client get before login, because of which we say a login 
    request is an action with side effect. Another obvious example is a database update operation. Once an update is committed, 
    all the related clients will get a different output from the result before the update, which is also classified as &#8220;an action 
    with side effect&#8221;. 
    </p>
    
    <p>
    How about a query? We consider a query as an operation without side effect, it means that a client will always get the same
    result regardless of how many times the query is executed. Some people may ask how about counting on query times? For counting
    on query times, we can still split the counting and query to two individual operations, one is with side effect and another one
    is without side effect.
    </p>
  </div>
  
  <div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d5e249"></a>5.3&nbsp;Isolate side effect and multi thread rendering</h2></div></div></div>
    

    <p>
    We believe the actions with side effect should be managed seriously and we do that by putting all the actions with side effect
    to request handlers so that the view layer is purified and this makes the source more clear and maintainable. This is also means 
    with Asta4D we can easily perform multi thread rendering on a single page because they are now all side-effect free, which is a
    high light function of Asta4D.
    </p>

    <p>
    In traditional MVC architecture, the responsibility of controller is tangled, a controller does not only handle the duty of altering
    system status(date update), but also takes the responsibility of preparing data for view layer. We often have to expand the database
    session(transaction) to the view layer for handling lazy load issue, which makes transaction management more complicated. Additionally,
    especially for the pages that can be split to relatively individual blocks, hypothetically we can accelerate the page loading
    by retrieving data in multi threads for each block, but in reality it is impossible due to the source complexity and development costs.
    The developers still have to access each data source sequentially to retrieve data for each block even the page is splitable as individual
    blocks.
    </p>

    <p>
    For Asta4D, the logic layers of system is clarified by isolating side effects at architecture level. The database session(transaction)
    does no longer need keep opening cross layers, it is clear that the duty of request handler is altering system status but not preparing
    data for view layer. At the mean time, at the view layer, acquiring data and rendering data are performed at the same time, at the same
    place: We access data source and retrieve data in snippet method, and pass the data to Renderer to perform rendering immediately in the
    same snippet method. Further, the complexity can be reduced drastically because all the accesses to certain data are isolated in certain
    snippet methods and there is no cross layer invoking and coupling any more.
    </p>
    
    <p>
    On the other hand, we can simply perform multi thread rendering by calling each snippet method in different threads, which is transparent to
    developer. Because all the side effects has been isolated in request handler layer, we do not need to considerate sync or mutex even we
    are performing multi thread rendering since the view layer is side effect free now.
    </p>
    
    <p>
    Let us see how easy we can achieve parallel rendering 
    </p>
    
    <div class="example"><a name="d5e256"></a><p class="title"><b>Example&nbsp;5.1.&nbsp;</b></p><div class="example-contents">
      <pre class="programlisting">

<span class="hl-tag">&lt;div</span> <span class="hl-attribute">afd:render</span>=<span class="hl-value">"ParallelTest$TestRender:snippetInDiv"</span> <span class="hl-attribute">afd:parallel&gt;</span>  
    <span class="hl-attribute">&lt;div</span> <span class="hl-attribute">id</span>=<span class="hl-value">"test"</span><span class="hl-tag">&gt;</span>xx<span class="hl-tag">&lt;/div&gt;</span>  
<span class="hl-tag">&lt;/div&gt;</span>  
  
<span class="hl-tag">&lt;afd:snippet</span> <span class="hl-attribute">render</span>=<span class="hl-value">"ParallelTest$TestRender:snippetReplaceDiv"</span> <span class="hl-attribute">parallel&gt;</span>  
    <span class="hl-attribute">&lt;div</span> <span class="hl-attribute">id</span>=<span class="hl-value">"test"</span><span class="hl-tag">&gt;</span>xx<span class="hl-tag">&lt;/div&gt;</span>  
<span class="hl-tag">&lt;/afd:snippet&gt;</span>

      </pre>
      <p>
      All the snippets declared with parallel(afd:parallel) attribution will not block the http request main thread, the http request main thread
      will wait for the parallel rendering after all the non-parallel rendering finished, then merge the result and output to the client.
      </p>
    </div></div><br class="example-break">
  </div>



</div>
    <div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="chapter-request-handler"></a>6.&nbsp;Impement request handler and url mapping</h2></div></div></div>
  

  <div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d5e261"></a>6.1&nbsp;@RequestHandler</h2></div></div></div>
    
    <p>It is not complicated to implement a request handler. @RequestHandler can be used to annotate a handle
    method in arbitrary Java class which will be treated as a request handler.</p>
    
    <div class="example"><a name="d5e264"></a><p class="title"><b>Example&nbsp;6.1.&nbsp;</b></p><div class="example-contents">
      <pre class="programlisting">

<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> LoginHandler {  
  
    <em><span class="hl-annotation" style="color: gray">@RequestHandler</span></em>  
    <span class="hl-keyword">public</span> LoginFailure doLogin(String flag) <span class="hl-keyword">throws</span> LoginFailure {  
        <span class="hl-keyword">if</span> (StringUtils.isEmpty(flag)) {  
            <span class="hl-keyword">return</span> null;  
        }  
        <span class="hl-keyword">if</span> (<span class="hl-string">"error"</span>.equals(flag)) {  
            <span class="hl-keyword">throw</span> <span class="hl-keyword">new</span> LoginFailure();  
        }  
        <span class="hl-keyword">if</span> (!Boolean.parseBoolean(flag)) {  
            <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> LoginFailure();  
        }  
        <span class="hl-keyword">return</span> null;  
    }  
}  

      </pre>
      <p>
      Take a look at the parameters of the handle method, the handle method of a request handler accepts parameter injection
      as same as the snippet method. More details can be found at the descriptions of the snippet method.
      </p>
    </div></div><br class="example-break">
  </div>
 
  <div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d5e267"></a>6.2&nbsp;delcare url rule for request handler</h2></div></div></div>
    
    <p>Previously we have introduced how to forward a http request to a certain template file by url mapping. We can declare 
    a request handler for q http request by the same way:
    </p>
    
    <div class="example"><a name="d5e270"></a><p class="title"><b>Example&nbsp;6.2.&nbsp;</b></p><div class="example-contents">
      <pre class="programlisting">

rules.add(<span class="hl-string">"/app/handler"</span>)  
     .handler(LoginHandler.<span class="hl-keyword">class</span>) <span class="hl-comment">// (1)  </span>
     .forward(LoginFailure.<span class="hl-keyword">class</span>, <span class="hl-string">"/templates/error.html"</span>) <span class="hl-comment">//(2)  </span>
     .redirect(FurtherConfirm.<span class="hl-keyword">class</span>, <span class="hl-string">"/app/furtherConfirm"</span>)<span class="hl-comment">//(3)  </span>
     .forward(<span class="hl-string">"/templates/success.html"</span>); <span class="hl-comment">//(4)  </span>

      </pre>
      <p>
      Simply explain:
        </p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">
            <p>Forward the request to "/app/handler" to the request handler "LoginHandler".</p>
          </li><li class="listitem">
            <p>If "LoginHandler" returns a result of "LoginFailure", forward the request to the template file "error.html".</p>
          </li><li class="listitem">
            <p>If "LoginHandler" returns a result of "FurtherConfirm", redirect the current request to "/app/furtherConfirm" 
            by http code 302(302 is by default).</p>
          </li><li class="listitem">
            <p>If "LoginHandler" does not return a meaningful result(it usually means success by a null return) , forward the request 
            to the template file "success.html".</p>
          </li></ol></div><p>
      </p>
    </div></div><br class="example-break">
    
    <p>
      More verbose details:
    </p>
    
    <p>
      The handler method is used to add a request handler and accepts arbitrary type as the the parameter: an instance of java.lang.Class or an
      arbitrary instance. The framework explains received parameters by the implementation of DeclareInstanceResolver configured by
      WebApplicationConfiguration. Thee default implementation provided by framework follows the following rules to explain the declaration
      of request handler:
      </p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">
          <p>If an instance of java.lang.Class is specified, the instance of request handler will be created by invoke "newInstance()"
          on the specified Class.</p>
        </li><li class="listitem">
          <p>If a string is specified, the string will be treated as a class name and an instance of java.lang.Class will be created by 
          calling "Class#forName", then the instance of request handler will be created by invoke "newInstance()" on the created Class.</p>
        </li><li class="listitem">
          <p>The specified parameter will be treated as a request handler directly if it is neither a Class nor a string. By this rule,
          it is interesting that we can declare an anonymous class as a request handler:</p>
          <div class="example"><a name="d5e291"></a><p class="title"><b>Example&nbsp;6.3.&nbsp;</b></p><div class="example-contents">
            <pre class="programlisting">

rules.add(<span class="hl-string">"/app/handler"</span>)  
     .handler(<span class="hl-keyword">new</span> Object(){  
        <em><span class="hl-annotation" style="color: gray">@RequestHandler</span></em>  
        <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> handle(){  
            <span class="hl-comment">//  </span>
        }  
     }); 

            </pre>
          </div></div><br class="example-break">
        </li></ol></div><p>
      <em><span class="remark">The asta4d-spring package also provides a resolver based on Spring IOC container, the request handler instance will be retrieved by
      passing the specified parameter to the "Context#getBean" method of spring container.</span></em>
    </p>
    
    <p>
    The forward method adds a transforming rule for the result of request handler.There must be a handler method annotated by @RequestHandler and the
    returned value of the handle method is viewed as the result of the request handler, thrown exceptions in the handle method are treated as the result
    too. The framework will attempt to match the result to the expected result specified by forward method then transforms the result to the corresponding
    template file(The real mechanism of result transforming is more complicated and is explained at ...). When the matching attempt is performed, the
    equals method will be used at first, if the equals method returns false and the expected result by forward method is an instance of java.lang.Class,
    "Class#isAssignableFrom" will be utilized, if false again, skip the current forward rule and do the same check on the next forward rule. A forward rule
    without the expected result specified will be viewed as a default rule, if matched forward rule for a result is missing or the request handler returns
    a pointless result(void declaration of handle method or returns null), the default rule will be applied.
    </p>
    
    <p>
    The redirect method follows the same rule of forward method except it will cause a 302 redirect(302 is default, 301 can be declared) instead of forwarding
    to a template file.
    </p>
  </div>
  
  <div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d5e296"></a>6.3&nbsp;Default request handler</h2></div></div></div>
    
    <p>
    You can not only declare request handler to a certain url, but also declare global request handlers which is available to
    all the urls and prior to the request handlers declared on certain urls. There is a conception of request handler chain
    for multi handlers, we will explain it in a later chapter.
    </p>
    
    <div class="example"><a name="d5e299"></a><p class="title"><b>Example&nbsp;6.4.&nbsp;Default request handler</b></p><div class="example-contents">
      
      <pre class="programlisting">

rules.addDefaultRequestHandler(GlobalHandler.<span class="hl-keyword">class</span>);  
  
rules.addDefaultRequestHandler(<span class="hl-string">"authcheck"</span>, AuthCheckHandler.<span class="hl-keyword">class</span>);  

      </pre>
    </div></div><br class="example-break">
    
    <p>
    At the second line declaration for AuthCheckHandler, an attribute can be specified at the same time, which cause the declared request handler
    is only available to the rules that declared the same attribute.
    </p>
    
    <div class="example"><a name="d5e303"></a><p class="title"><b>Example&nbsp;6.5.&nbsp;</b></p><div class="example-contents">
      <pre class="programlisting">

rules.add(<span class="hl-string">"/app/handler"</span>).attribute(<span class="hl-string">"authcheck"</span>)  
        ...  

      </pre>
    </div></div><br class="example-break">
    
    <p class="remark"><em><span class="remark">
    In the framework's internal implementation, a static match rule table will be generated after all the url mapping declaration finished. A global
    request handler that is only available to certain rules will be configured to the the certain url rules only, by which unnecessary performance
    cost is avoid.
    </span></em></p>
    
    <p>
    In our practice, we found that it is very inconvenient to declare necessary attribute on every rule. In most situations, we will
    want to do something like configure a same default request handler to all the url paths under "/xxx", which can be done by delcaring
    a non attribute default request handler which judges the url pattern by itself, but such way will lose the performance benefit of
    attribute declaration. Thus, we provide an alternative way for this situation: url rule rewrite.
    </p>
    
    <div class="example"><a name="d5e307"></a><p class="title"><b>Example&nbsp;6.6.&nbsp;</b></p><div class="example-contents">
      <pre class="programlisting">

rules.addRuleRewriter(<span class="hl-keyword">new</span> UrlMappingRuleRewriter() {  
    <em><span class="hl-annotation" style="color: gray">@Override</span></em>  
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> rewrite(UrlMappingRule rule) {  
        <span class="hl-keyword">if</span>(rule.getSourcePath().startsWith(<span class="hl-string">"/privatedata/"</span>)){  
            rule.getAttributeList().add(<span class="hl-string">"authcheck"</span>);  
        }  
    }  
});   

      </pre>
    </div></div><br class="example-break">

    <p>
    Please note that, untill now all the introduced configuration for url mapping are achieved by a group of interface called
    HandyRule which convert all the declaration to the instance of UrlMappingRule which is used by framework internally. But in
    the url rule rewritter implementation, developers have to cope with the raw UrlMappingRule which is difficult to understand,
    so complex url rewriting is not appreciated. Basically, the scenario of url rule rewriting is only for add attributes to rules in
    bulk.
    </p>
  </div>
  
  <div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d5e310"></a>6.4&nbsp;Global forward/redirect</h2></div></div></div>
    

    <p>
    Previously we mentioned that the result of a request handler will be matched in the forward declaration, if there is no matched forward found,
    the global forward rule will be checked.
    </p>
    
    <div class="example"><a name="d5e313"></a><p class="title"><b>Example&nbsp;6.7.&nbsp;Global forward</b></p><div class="example-contents">
      
      <pre class="programlisting">

rules.addGlobalForward(PageNotFoundException.<span class="hl-keyword">class</span>, <span class="hl-string">"/pagenotfound.html"</span>, <span class="hl-number">404</span>);  

      </pre>

      <p>
      The above source declares that if the result of request handler is PageNotFoundException(Exception is treated as the result of the request handler),
      forward the request to pagenotfound.html by http status code 404.
      </p>
      
    </div></div><br class="example-break">
    
    <p>
    Global redirect can be declared by the same way.
    </p>
    
    <div class="example"><a name="d5e318"></a><p class="title"><b>Example&nbsp;6.8.&nbsp;Global redirect</b></p><div class="example-contents">
      
      <pre class="programlisting">

rules.addGlobalRedirect(REDIRECT_TO_SOMEWHERE, <span class="hl-string">"/somewhere"</span>);  

      </pre>
    </div></div><br class="example-break">

    <p>
    The global forward rules are applied before the default forward rule(the forward rule without result) on certain url mapping rule.
    </p>

    <div class="example"><a name="d5e322"></a><p class="title"><b>Example&nbsp;6.9.&nbsp;</b></p><div class="example-contents">
      <pre class="programlisting">

rules.addGlobalForward(PageNotFoundException.<span class="hl-keyword">class</span>, <span class="hl-string">"/pagenotfound.html"</span>, <span class="hl-number">404</span>);  

rules.addGlobalRedirect(REDIRECT_TO_SOMEWHERE, <span class="hl-string">"/somewhere"</span>);  

rules.add(<span class="hl-string">"/app/handler"</span>)  
     .handler(LoginHandler.<span class="hl-keyword">class</span>) 
     .forward(LoginFailure.<span class="hl-keyword">class</span>, <span class="hl-string">"/templates/error.html"</span>) 
     .redirect(FurtherConfirm.<span class="hl-keyword">class</span>, <span class="hl-string">"/app/furtherConfirm"</span>)  
     .forward(<span class="hl-string">"/templates/success.html"</span>);

      </pre>
    </div></div><br class="example-break">
    
    <p>
    In the above sample, the result of LoginHandler will be matched by the following order:
    </p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">LoginFailer</li><li class="listitem">FurtherConfirm</li><li class="listitem">PageNotFoundException</li><li class="listitem">REDIRECT_TO_SOMEWHERE</li><li class="listitem">(default-&gt; "success.html")</li></ol></div><p>
    </p>
  </div>

</div>
    <div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="chapter-adv-request-handler"></a>7.&nbsp;Advanced usage of request handler</h2></div></div></div>
  
  
  <p>This chapter is to show how you can make advanced usage of request handler on various situations.</p>
  
  <div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="advanced-mvc"></a>7.1.&nbsp;Advanced MVC architecture</h2></div></div></div>
  
  <p>Even we emphasize that Asta4D is a view first framework, it is still compatible with MVC architecture. Further, we would say that 
  Asta4D affords an advanced MVC architecture than traditional MVC frameworks by the view first mechanism.</p>
  
  <p>In the MVC theory, a controller would act as multi roles in a full request process, from wikipedia, it says: <em><span class="remark">"A controller 
  can send commands to the model to update the model's state (e.g., editing a document). It can also send commands to its associated 
  view to change the view's presentation of the model (e.g., by scrolling through a document)."</span></em> But those are not all in most
  situations, we usually have to do more things in a controller such as querying additional assistant data for page rendering.</p>
  
  <p>By traditional MVC architecture, we often have to expand the transaction from the controller layer across to the view layer to combat
  the lazy load issue, which ugly structure is essentially caused by the tangled controller which holds various unrelated duties.</p> 
  
  <p>It is also strange that we have to modify our controller's implementation at every time we change the page appearance at view layer.
  Such situation could not satisfy us since the layers are not uncoupled really.</p>
  
  <p>We would say that the traditional controller is indeed a tangled magic container for most logics, a controller will unfortunately
  be coupled to most layers in the system even our initial purpose of MVC is to uncouple our logics. By contrast, Asta4D allows developers
  to really uncouple all the tangled logics easily. Basically we could split the traditional controller's duty to following parts:</p>
  <div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
      <p>request handler</p>
      <p>Which takes the responsibilities of all the operations with side-effect.</p>
    </li><li class="listitem">
      <p>result matching in url rule</p>
      <p>Which dispatches the request to different views according to the result from request handler</p>
    </li><li class="listitem">
      <p>snippet class</p>
      <p>Which has the responsibility to render data to the page and also holds the obligation of preparing all the necessary data for
      page rendering.</p>
    </li></ul></div>
  
  <p>By above architecture, we could perfectly uncouple our logics by clarifying the obligation of each layer.</p>
  
  <p class="remark"><em><span class="remark">Need sample source ...</span></em></p>

  </div>
  
  
  
  <div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="normalize-page-url"></a>7.2.&nbsp;Normalize page url patterns</h2></div></div></div>
  
  <p>Commonly, we would probably have multiple path patterns for the same template file but we would hope our snippet implementation 
  could deal with a unified pattern, which can be simply achieved by a request handler.</p>
  
  <div class="example"><a name="d5e357"></a><p class="title"><b>Example&nbsp;7.1.&nbsp;Normalize page url</b></p><div class="example-contents">
    
    <pre class="programlisting">


rules.add(<span class="hl-string">"/user/name/{name}"</span>).id(<span class="hl-string">"user-page"</span>)

rules.add(<span class="hl-string">"/user/{id}"</span>).id(<span class="hl-string">"user-page"</span>)
     .handler(<span class="hl-keyword">new</span> Object(){
        <em><span class="hl-annotation" style="color: gray">@RequestHandler</span></em>
        <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> preparePage(Context context, Integer id, String name){
            User user = null;
            <span class="hl-keyword">if</span>(id != null){
                user = queryUserById(id);
            }<span class="hl-keyword">else</span> <span class="hl-keyword">if</span> (name != null){
                user = queryUserByName(name);
            }
            <span class="hl-keyword">if</span>(user != null){
                <span class="hl-comment">//in the snippet class, a @ContextData annotation can by use to retrieve this value by injection</span>
                context.setData(<span class="hl-string">"user-page-condition"</span>, user);
            }
        }
     }).forward(<span class="hl-string">"/user-page.html"</span>);

    </pre>
    <em><span class="remark">Somebody would argue that the above example is apparently a traditional MVC architecture, that is right or wrong. For the most simple situation, if 
    the snippet class will only show the data from entity class User without any extra query, it is true that the above source shows a traditional MVC architecture.
    But for the most situations, the page rendering would require more additional queries, which would be done at the snippet side. Such structure is so far from the
    traditional MVC that we would rather to call it as view first.</span></em>
  </div></div><br class="example-break">
  
  <p>In the above example, we do not cope with the case of user does not exist. The following source shows how we can cope with such situation: </p>
  
  <div class="example"><a name="d5e362"></a><p class="title"><b>Example&nbsp;7.2.&nbsp;Normalize page url and PageNotFoundException</b></p><div class="example-contents">
    
    <pre class="programlisting">


rules.addGlobalForward(PageNotFoundException.<span class="hl-keyword">class</span>, <span class="hl-string">"/template/PageNotFound.html"</span>, <span class="hl-number">404</span>);
rules.addGlobalForward(Throwable.<span class="hl-keyword">class</span>, <span class="hl-string">"/template/UnknownError.html"</span>, <span class="hl-number">500</span>);

rules.add(<span class="hl-string">"/user/name/{name}"</span>).id(<span class="hl-string">"user-page"</span>)

rules.add(<span class="hl-string">"/user/{id}"</span>).id(<span class="hl-string">"user-page"</span>)
     .handler(<span class="hl-keyword">new</span> Object(){
        <em><span class="hl-annotation" style="color: gray">@RequestHandler</span></em>
        <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> preparePage(Context context, Integer id, String name){
            User user = null;
            <span class="hl-keyword">if</span>(id != null){
                user = queryUserById(id);
            }<span class="hl-keyword">else</span> <span class="hl-keyword">if</span> (name != null){
                user = queryUserByName(name);
            }
            <span class="hl-keyword">if</span>(user == null){
                <span class="hl-keyword">throw</span> <span class="hl-keyword">new</span> PageNotFoundException();
            }<span class="hl-keyword">else</span>
                <span class="hl-comment">//in the snippet class, a @ContextData annotation can by use to retrieve this value by injection</span>
                context.setData(<span class="hl-string">"user-page-condition"</span>, user);
            }
        }
     }).forward(<span class="hl-string">"/user-page.html"</span>);

    </pre>
  </div></div><br class="example-break">
  <p>See more details at <a class="xref" href="#normalize-page-condition" title="9.1.2.&nbsp;Normalize page condition by request handler">Section&nbsp;9.1.2, &#8220;Normalize page condition by request handler&#8221;</a></p>
  </div>
  
  <div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="rest-ajax"></a>7.3.&nbsp;Restful and ajax</h2></div></div></div>
  
  <p>For the request which does not require response of html files, such as restful or ajax request, request handler can be used to cope
  with such situation.</p>
  <p>There is a rest() method which does nothing on the current rule by default but can be used as a hint to suggest that the current rule will 
  response customized contents as a restful api. A request handler can return a ContentProvider to supply customized response content. 
  Details of ContenProvider can be found at later chapters, here we only show examples of how to response customized contents.</p>
  
  <div class="example"><a name="d5e371"></a><p class="title"><b>Example&nbsp;7.3.&nbsp;Return header only response</b></p><div class="example-contents">
    
    <pre class="programlisting">

<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> UpdateHandler {  
  
    <em><span class="hl-annotation" style="color: gray">@RequestHandler</span></em>  
    <span class="hl-keyword">public</span> ContentProvider doUpdate(String id, String content) {
        <span class="hl-keyword">if</span> (idExists(id)) {
            <span class="hl-keyword">try</span> {
                updateContent(id, content);
                <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> HeaderInfoProvider();
            } <span class="hl-keyword">catch</span> (Exception ex) {
                HeaderInfoProvider header = <span class="hl-keyword">new</span> HeaderInfoProvider(<span class="hl-number">500</span>);
                header.addHeader(<span class="hl-string">"exception"</span>, ex.getMessage());
                <span class="hl-keyword">return</span> header;
            }
        } <span class="hl-keyword">else</span> {
            <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> HeaderInfoProvider(<span class="hl-number">404</span>);
        }
    }
}  

    </pre>
  </div></div><br class="example-break">
  
  <div class="example"><a name="d5e374"></a><p class="title"><b>Example&nbsp;7.4.&nbsp;Return customized binary data</b></p><div class="example-contents">
    
    <pre class="programlisting">

<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> GetHandler {  
  
    <em><span class="hl-annotation" style="color: gray">@RequestHandler</span></em>  
    <span class="hl-keyword">public</span> ContentProvider get(String id) {
        Object data = getContent(id);
        <span class="hl-keyword">if</span> (data == null) {
            <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> HeaderInfoProvider(<span class="hl-number">404</span>);
        } <span class="hl-keyword">else</span> {
            HeaderInfoProvider header = <span class="hl-keyword">new</span> HeaderInfoProvider();<span class="hl-comment">// default to 200</span>
            header.addHeader(<span class="hl-string">"Content-Type"</span>, <span class="hl-string">"application/json"</span>);

            String json = toJson(data);
            BinaryDataProvider binaryData = <span class="hl-keyword">new</span> BinaryDataProvider(json.getBytes());
            
            <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> SerialProvider(header, binaryData);
        }
    }
}  

    </pre>
  </div></div><br class="example-break">
  
  <p>For json data, there is a more convenience way to response a json string to client. A json() method can be used on 
  rule declaration to ask the framework to convert the returned result from request handler to a json string automatically.
  the above </p>
  
  <div class="example"><a name="d5e378"></a><p class="title"><b>Example&nbsp;7.5.&nbsp;Declare json at rule</b></p><div class="example-contents">
    
    <pre class="programlisting">


<span class="hl-comment">// in rule declaration</span>
rules.add(<span class="hl-string">"/get"</span>).handler(GetHandler.<span class="hl-keyword">class</span>).json();


<span class="hl-comment">//the handler implementation</span>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> GetHandler {  
  
    <em><span class="hl-annotation" style="color: gray">@RequestHandler</span></em>  
    <span class="hl-keyword">public</span> Object get(String id) {
        <span class="hl-keyword">return</span> getContent(id);
    }
}  

    </pre>
  </div></div><br class="example-break">
  
  <p class="remark"><em><span class="remark">By default, a rest rule will do nothing on the result of handler and a ContentProvider instance is expected, by contrast,
          there is a built-in json transformer for rules which are declared as json. However, developers can still register a customized
          result transformer for rest rules or even register a customized json transformer to override the default built-in implementation.
          See details at <a class="xref" href="#UrlMappingRuleInitializer" title="13.1.1.&nbsp;UrlMappingRuleInitializer">Section&nbsp;13.1.1, &#8220;UrlMappingRuleInitializer&#8221;</a></span></em></p>
  
  <p>Further, since a request handler can access HttpServletResponse instance directly, developer can do more complex customization
  on HttpServletResponse instance directly.</p>
  
  <div class="example"><a name="d5e384"></a><p class="title"><b>Example&nbsp;7.6.&nbsp;access HttpServletResponse directly</b></p><div class="example-contents">
    
    <pre class="programlisting">

<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> XXXHandler {  
  
    <em><span class="hl-annotation" style="color: gray">@RequestHandler</span></em>
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> handle(HttpServletResponse response) <span class="hl-keyword">throws</span> IOException {
        response.setStatus(<span class="hl-number">200</span>);
        response.addHeader(<span class="hl-string">"xxx"</span>, <span class="hl-string">""</span>);
        response.getOutputStream().write(<span class="hl-string">"OK"</span>.getBytes());
    }
}  

    </pre>
  </div></div><br class="example-break">

  <p>There are two built-in customized request handlers for handler static resouce files and mapping generic path template files.
  See the next section.</p>

  </div>

  <div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="handle-static-resource"></a>7.4.&nbsp;Handle static resouce files</h2></div></div></div>
  
  <p>The most simple way to handling static resource files is mapping their path in web.xml then they will be serviced by the servlet container.
  But Asta4D still affords a way to handle them at framework level.</p>
  
  <div class="example"><a name="d5e391"></a><p class="title"><b>Example&nbsp;7.7.&nbsp;handler static files</b></p><div class="example-contents">
    
    <pre class="programlisting">


rules.add(<span class="hl-string">"/js/**/*"</span>).handler(<span class="hl-keyword">new</span> StaticResourceHandler());

rules.add(<span class="hl-string">"/img/**/*"</span>).handler(<span class="hl-keyword">new</span> StaticResourceHandler(<span class="hl-string">"/resource/img"</span>));

rules.add(<span class="hl-string">"/favicon.ico"</span>).handler(<span class="hl-keyword">new</span> StaticResourceHandler(/img/favicon.ico));


    </pre>
  </div></div><br class="example-break">
  
  <p>The wild-card "/**/*" in source path is necessary if you want to mapping all the urls with same path prefix to a certain base folder. The base path
  parameter in constructor of StaticResourceHandler is not necessary. if the base path is not specified, StaticResourceHandler will treat the part before
  the wild-card "/**/*" in source path as the base path.
  </p>
  <p>StaticResourceHandler can be customized by path var configuration or overriding some protected methods by extending. See details in javadoc of 
  StaticResourceHandler.</p>
  
  <div class="example"><a name="d5e396"></a><p class="title"><b>Example&nbsp;7.8.&nbsp;customize StaticResourceHandler</b></p><div class="example-contents">
    
    <pre class="programlisting">


<span class="hl-comment">// by path var</span>

rules.add(<span class="hl-string">"/js/**/*"</span>)
    .var(StaticResourceHandler.VAR_CONTENT_TYPE, <span class="hl-string">"text/javascript"</span>) 
    .handler(StaticResourceHandler.<span class="hl-keyword">class</span>);

<span class="hl-comment">// by overring</span>
rules.add(<span class="hl-string">"/js/**/*"</span>).handler(<span class="hl-keyword">new</span> StaticResourceHandler(){
    <em><span class="hl-annotation" style="color: gray">@Override</span></em>
    <span class="hl-keyword">protected</span> <span class="hl-keyword">long</span> decideCacheTime(String path) {
        <span class="hl-keyword">return</span> <span class="hl-number">24</span> * <span class="hl-number">60</span> * <span class="hl-number">60</span> * <span class="hl-number">1000</span>; <span class="hl-comment">//force cache 24 hours</span>
    }
    
});


    </pre>
    <p>Note that it is not necessary to specify content type for most situations because StaticResourceHandler will guess 
    the content type by file name extension automatically.</p>
  </div></div><br class="example-break">
  
  </div>

  <div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="handle-generic-path"></a>7.5.&nbsp;Handle generic path template files</h2></div></div></div>
  
  <p>Basically Asta4D asks developers to declare the matching relationship between url and template file one by one, but it still allows
  to declare a generic path matching for all files in same folder, which can be achieved by GenericPathTemplateHandler.</p>
  </div>

  <div class="example"><a name="d5e403"></a><p class="title"><b>Example&nbsp;7.9.&nbsp;handler template files in bulk</b></p><div class="example-contents">
    
    <pre class="programlisting">


rules.add(<span class="hl-string">"/pages/**/*"</span>).handler(GenericPathTemplateHandler.<span class="hl-keyword">class</span>);


    </pre>
    <p>As same as the StaticResourceHandler, the wild-card "/**/*" is necessary and the base path parameter of constructor can be ignored.</p>
  </div></div><br class="example-break">


</div>
    <div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="chapter-form-flow"></a>8.&nbsp;Built in form flow</h2></div></div></div>
  
  <p class="remark"><em><span class="remark">(Being written. See the online sample: <a class="ulink" href="http://asta4dsample-xzer.rhcloud.com/form" target="_top">Form Flow Sample</a>)</span></em></p>
  <p>Asta4D affords built-in form flow to accelerate development of traditional form process. Asta4D's form flow mechanism supports 
  various flow style and supplies several classical flow style as built-in. For most cases, the developers only need to implement the init 
  and update method to complete the entire form related logic.</p>
  <div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d5e412"></a>8.1.&nbsp;Startup</h2></div></div></div><div class="toc"><p><b>Table of Contents</b></p><dl class="toc"><dt><span class="sect2"><a href="#d5e414">8.1.1. Form and form field</a></span></dt><dt><span class="sect2"><a href="#d5e424">8.1.2. Form handler</a></span></dt><dd><dl><dt><span class="sect3"><a href="#d5e426">AbstractFormFlowHandler and FormProcessData</a></span></dt><dt><span class="sect3"><a href="#d5e445">Built-in classical handlers: OneStepFormHandler and MultiStepFormFlowHandler</a></span></dt><dt><span class="sect3"><a href="#d5e468">Implement the handler</a></span></dt></dl></dd><dt><span class="sect2"><a href="#d5e480">8.1.3. HTML template of form</a></span></dt><dt><span class="sect2"><a href="#d5e492">8.1.4. Form snippet</a></span></dt><dt><span class="sect2"><a href="#d5e505">8.1.5. Validation</a></span></dt></dl></div>
    
    <div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="d5e414"></a>8.1.1.&nbsp;Form and form field</h3></div></div></div>
      
      <p>In a form process, the basic conception is a POJO which represents the whole form data. In Asta4D, we use @Form annotation to annotate a
      POJO as a form object which can be handled by the the form flow.</p>
      <p>Also, there must be fields to represent the concrete data of a form, which can also be annotated by a set of form field annotations.
      There are several built-in form field annotations for common cases and you can implement your own form field annotation too(See <a class="xref" href="#chapter-detail-form-flow" title="14.&nbsp;details of form flow">Chapter&nbsp;14, <i>details of form flow</i></a>
      for more details about form field annotation).</p>
      <div class="example"><a name="d5e419"></a><p class="title"><b>Example&nbsp;8.1.&nbsp;annotations on form POJO and form fields</b></p><div class="example-contents">
        
        <pre class="programlisting">

<em><span class="hl-annotation" style="color: gray">@Form</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> PersonForm <span class="hl-keyword">extends</span> Person{

    <em><span class="hl-annotation" style="color: gray">@Hidden</span></em>
    <span class="hl-keyword">public</span> Integer getId() {
        <span class="hl-keyword">return</span> <span class="hl-keyword">super</span>.getId();
    }

    <em><span class="hl-annotation" style="color: gray">@Input</span></em>
    <span class="hl-keyword">public</span> String getName() {
        <span class="hl-keyword">return</span> <span class="hl-keyword">super</span>.getName();
    }
    
    <em><span class="hl-annotation" style="color: gray">@Select(name = "bloodtype")</span></em>
    <span class="hl-keyword">public</span> BloodType getBloodType() {
        <span class="hl-keyword">return</span> <span class="hl-keyword">super</span>.getBloodType();
    }

}

        </pre>
        <em><span class="remark">The @Hidden represents a hidden input of html, @Input represents a traditional common input and @Select is matched to the pull-down element in html. 
                We also recommend to implement the form POJO by extending from the existing entity POJO, see details at <a class="xref" href="#common-usage-form-flow" title="9.2.&nbsp;Common usage of form flow">Section&nbsp;9.2, &#8220;Common usage of form flow&#8221;</a>.
        </span></em>
      </div></div><br class="example-break">
    </div>
    <div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="d5e424"></a>8.1.2.&nbsp;Form handler</h3></div></div></div><div class="toc"><p><b>Table of Contents</b></p><dl class="toc"><dt><span class="sect3"><a href="#d5e426">AbstractFormFlowHandler and FormProcessData</a></span></dt><dt><span class="sect3"><a href="#d5e445">Built-in classical handlers: OneStepFormHandler and MultiStepFormFlowHandler</a></span></dt><dt><span class="sect3"><a href="#d5e468">Implement the handler</a></span></dt></dl></div>
      
      <div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="d5e426"></a>AbstractFormFlowHandler and FormProcessData</h4></div></div></div>
          
          <p>After we defined our form POJO, we need to declare a request handler to handle the form request. There is an AbstractFormFlowHandler which affords most
                necessary common operations of form process.</p>
          <div class="example"><a name="d5e429"></a><p class="title"><b>Example&nbsp;8.2.&nbsp;AbstractFormFlowHandler</b></p><div class="example-contents">
            
            <pre class="programlisting">

<span class="hl-keyword">public</span> <span class="hl-keyword">abstract</span> <span class="hl-keyword">class</span> AbstractFormFlowHandler&lt;T&gt; {

    <span class="hl-keyword">public</span> AbstractFormFlowHandler(Class&lt;T&gt; formCls) {
        <span class="hl-keyword">this</span>(formCls, SimpleFormProcessData.<span class="hl-keyword">class</span>);
    }

    <span class="hl-keyword">public</span> AbstractFormFlowHandler(Class&lt;T&gt; formCls, Class&amp;lt;? <span class="hl-keyword">extends</span> FormProcessData&gt; formProcessDataCls) {
        <span class="hl-keyword">this</span>.formCls = formCls;
        <span class="hl-keyword">this</span>.formProcessDataCls = formProcessDataCls;
    }
}

            </pre>
          </div></div><br class="example-break">
          <p>As the above source suggests, the AbstractFormFlowHandler has two constructors which requires the type of form POJO and also the type of a sub class of
          "FormProcessData" in addition. In fact, FormProcessData is an interface as following:</p>
          <div class="example"><a name="d5e433"></a><p class="title"><b>Example&nbsp;8.3.&nbsp;FormProcessData</b></p><div class="example-contents">
            
            <pre class="programlisting">

<span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> FormProcessData {

    <span class="hl-keyword">public</span> <span class="hl-keyword">abstract</span> String getStepExit();

    <span class="hl-keyword">public</span> <span class="hl-keyword">abstract</span> String getStepCurrent();

    <span class="hl-keyword">public</span> <span class="hl-keyword">abstract</span> String getStepFailed();

    <span class="hl-keyword">public</span> <span class="hl-keyword">abstract</span> String getStepSuccess();

    <span class="hl-keyword">public</span> <span class="hl-keyword">abstract</span> String getStepBack();

    <span class="hl-keyword">public</span> <span class="hl-keyword">abstract</span> String getStepTraceData();

}

            </pre>
          </div></div><br class="example-break">
          <p>The FormProcessData requires the developer to tell how to handle a form submit, the name of current step, the target step for success and the target for
                failing, also want to know where to go if user want to go back to the previous step or exit. The getStepTraceData will return a data reference which holds
                all the state of current flow(can be considered as a "session" id for the current in-progress form flow).</p>
          <p>All the process data need to be submit every time so that the request handler can retrieve them from posted data and handle the data as expected. There is
                also a predefined implementation of FormProcessData: SimpleFormProcessData, which is used as the default FormProcessData holder when not being specified.</p>
          <div class="example"><a name="d5e438"></a><p class="title"><b>Example&nbsp;8.4.&nbsp;SimpleFormProcessData</b></p><div class="example-contents">
            
            <pre class="programlisting">

<em><span class="hl-annotation" style="color: gray">@ContextDataSet</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> SimpleFormProcessData <span class="hl-keyword">implements</span> FormProcessData {

    <em><span class="hl-annotation" style="color: gray">@QueryParam(name = "step-exit")</span></em>
    <span class="hl-keyword">private</span> String stepExit;

    <em><span class="hl-annotation" style="color: gray">@QueryParam(name = "step-current")</span></em>
    <span class="hl-keyword">private</span> String stepCurrent;

    <em><span class="hl-annotation" style="color: gray">@QueryParam(name = "step-failed")</span></em>
    <span class="hl-keyword">private</span> String stepFailed;

    <em><span class="hl-annotation" style="color: gray">@QueryParam(name = "step-success")</span></em>
    <span class="hl-keyword">private</span> String stepSuccess;

    <em><span class="hl-annotation" style="color: gray">@QueryParam(name = "step-back")</span></em>
    <span class="hl-keyword">private</span> String stepBack;

    <em><span class="hl-annotation" style="color: gray">@QueryParam(name = FormFlowConstants.FORM_STEP_TRACE_MAP_STR)</span></em>
    <span class="hl-keyword">private</span> String stepTraceData;
}

            </pre>
          </div></div><br class="example-break">
          <p>As the source suggests in the above source, the request parameter names have been decided so the developers have to comply with the convention of SimpleFormProcessData
                if you do not want to implement your own FormProcessData. Thus, we will include the following HTML in our template file side commonly:</p>
          <div class="example"><a name="d5e442"></a><p class="title"><b>Example&nbsp;8.5.&nbsp;HTML for FormProcessData</b></p><div class="example-contents">
            
            <pre class="programlisting">                                                                         

<span class="hl-tag">&lt;input</span> <span class="hl-attribute">type</span>=<span class="hl-value">"hidden"</span> <span class="hl-attribute">name</span>=<span class="hl-value">"step-current"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"confirm"</span><span class="hl-tag">&gt;</span>
<span class="hl-tag">&lt;input</span> <span class="hl-attribute">type</span>=<span class="hl-value">"hidden"</span> <span class="hl-attribute">name</span>=<span class="hl-value">"step-failed"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"input"</span><span class="hl-tag">&gt;</span>
<span class="hl-tag">&lt;button</span> <span class="hl-attribute">type</span>=<span class="hl-value">"submit"</span> <span class="hl-attribute">name</span>=<span class="hl-value">"step-success"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"btn btn-sm btn-default"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"complete"</span><span class="hl-tag">&gt;</span>send<span class="hl-tag">&lt;/button&gt;</span>
<span class="hl-tag">&lt;button</span> <span class="hl-attribute">type</span>=<span class="hl-value">"submit"</span> <span class="hl-attribute">name</span>=<span class="hl-value">"step-back"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"btn btn-sm btn-default"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"input"</span><span class="hl-tag">&gt;</span>back<span class="hl-tag">&lt;/button&gt;</span>
<span class="hl-tag">&lt;button</span> <span class="hl-attribute">type</span>=<span class="hl-value">"submit"</span> <span class="hl-attribute">name</span>=<span class="hl-value">"step-exit"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"btn btn-sm btn-default"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"exit"</span><span class="hl-tag">&gt;</span>cancel<span class="hl-tag">&lt;/button&gt;</span>

            </pre>
          </div></div><br class="example-break">
      </div>
      <div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="d5e445"></a>Built-in classical handlers: OneStepFormHandler and MultiStepFormFlowHandler</h4></div></div></div>
          
          <p>Let us back to the AbstractFormFlowHandler, although AbstractFormFlowHandler has afforded most common operations, it is not convenient to use AbstractFormFlowHandler
                directly. AbstractFormFlowHandler is designed as high layer abstraction of form flow and much concrete design is required for concrete cases. There are two built-in
                out-of-box implementation for classical situations: OneStepFormHandler and MultiStepFormFlowHandler.</p>
          <p>The OneStepFormHandler represents a most simple form process: there is a single input page, after submit, the submitted data will be handled and then return to a 
                before-input page which is usually a list page of items. To use OneStepFormHandler, you have to put the following HTML in your form template files:</p>
          <div class="example"><a name="d5e449"></a><p class="title"><b>Example&nbsp;8.6.&nbsp;FormProcessData HTML for OneStepFormHandler</b></p><div class="example-contents">
            
            <pre class="programlisting">

<span class="hl-tag">&lt;input</span> <span class="hl-attribute">type</span>=<span class="hl-value">"hidden"</span> <span class="hl-attribute">name</span>=<span class="hl-value">"step-current"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"input"</span><span class="hl-tag">&gt;</span>
<span class="hl-tag">&lt;input</span> <span class="hl-attribute">type</span>=<span class="hl-value">"hidden"</span> <span class="hl-attribute">name</span>=<span class="hl-value">"step-failed"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"input"</span><span class="hl-tag">&gt;</span>
<span class="hl-tag">&lt;button</span> <span class="hl-attribute">type</span>=<span class="hl-value">"submit"</span> <span class="hl-attribute">name</span>=<span class="hl-value">"step-success"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"btn btn-sm btn-default"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"complete"</span><span class="hl-tag">&gt;</span>save<span class="hl-tag">&lt;/button&gt;</span>
<span class="hl-tag">&lt;button</span> <span class="hl-attribute">type</span>=<span class="hl-value">"submit"</span> <span class="hl-attribute">name</span>=<span class="hl-value">"step-exit"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"btn btn-sm btn-default"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"exit"</span><span class="hl-tag">&gt;</span>cancel<span class="hl-tag">&lt;/button&gt;</span>

            </pre>
            <em><span class="remark">By OneStepFormHandler, the "step-current" and "step-failed" must be "input", the "step-success" must be "complete", the "step-exit" can be any non empty value
                    (usually "exit" is good enough).</span></em>
          </div></div><br class="example-break">
          <p>The MultiStepFormFlowHandler represents a little bit complicated situations: there are multiple steps in the flow. MultiStepFormFlowHandler assumes that there is 
                at least one input page and one confirm page with a possible complete page. For the single input page case, MultiStepFormFlowHandler can be used directly, but if
                there are multiple splitted input pages, the developer need to do more customization which will be introduced later.</p>
          <p>For a classical 3-step form flow(input, confirm, complete), the following HTML must be put into the form template files:</p>
          <div class="example"><a name="d5e455"></a><p class="title"><b>Example&nbsp;8.7.&nbsp;FormProcessData HTML for MultiStepFormFlowHandler - buttons of input page</b></p><div class="example-contents">
            
            <pre class="programlisting">

<span class="hl-tag">&lt;input</span> <span class="hl-attribute">type</span>=<span class="hl-value">"hidden"</span> <span class="hl-attribute">name</span>=<span class="hl-value">"step-current"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"input"</span><span class="hl-tag">&gt;</span>
<span class="hl-tag">&lt;input</span> <span class="hl-attribute">type</span>=<span class="hl-value">"hidden"</span> <span class="hl-attribute">name</span>=<span class="hl-value">"step-failed"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"input"</span><span class="hl-tag">&gt;</span>
<span class="hl-tag">&lt;button</span> <span class="hl-attribute">type</span>=<span class="hl-value">"submit"</span> <span class="hl-attribute">name</span>=<span class="hl-value">"step-success"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"btn btn-sm btn-default"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"confirm"</span><span class="hl-tag">&gt;</span>confirm<span class="hl-tag">&lt;/button&gt;</span>
<span class="hl-tag">&lt;button</span> <span class="hl-attribute">type</span>=<span class="hl-value">"submit"</span> <span class="hl-attribute">name</span>=<span class="hl-value">"step-exit"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"btn btn-sm btn-default"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"exit"</span><span class="hl-tag">&gt;</span>cancel<span class="hl-tag">&lt;/button&gt;</span>

            </pre>
            <em><span class="remark">At input page, the "step-current" and "step-failed" must be "input", the "step-success" must be "confirm", the "step-exit" can be any non empty value
                    (usually "exit" is good enough).</span></em>
          </div></div><br class="example-break">
          <div class="example"><a name="d5e459"></a><p class="title"><b>Example&nbsp;8.8.&nbsp;FormProcessData HTML for MultiStepFormFlowHandler - buttons of confirm page</b></p><div class="example-contents">
            
            <pre class="programlisting">

<span class="hl-tag">&lt;input</span> <span class="hl-attribute">type</span>=<span class="hl-value">"hidden"</span> <span class="hl-attribute">name</span>=<span class="hl-value">"step-current"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"confirm"</span><span class="hl-tag">&gt;</span>
<span class="hl-tag">&lt;input</span> <span class="hl-attribute">type</span>=<span class="hl-value">"hidden"</span> <span class="hl-attribute">name</span>=<span class="hl-value">"step-failed"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"input"</span><span class="hl-tag">&gt;</span>
<span class="hl-tag">&lt;button</span> <span class="hl-attribute">type</span>=<span class="hl-value">"submit"</span> <span class="hl-attribute">name</span>=<span class="hl-value">"step-success"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"btn btn-sm btn-default"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"complete"</span><span class="hl-tag">&gt;</span>send<span class="hl-tag">&lt;/button&gt;</span>
<span class="hl-tag">&lt;button</span> <span class="hl-attribute">type</span>=<span class="hl-value">"submit"</span> <span class="hl-attribute">name</span>=<span class="hl-value">"step-back"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"btn btn-sm btn-default"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"input"</span><span class="hl-tag">&gt;</span>back<span class="hl-tag">&lt;/button&gt;</span>
<span class="hl-tag">&lt;button</span> <span class="hl-attribute">type</span>=<span class="hl-value">"submit"</span> <span class="hl-attribute">name</span>=<span class="hl-value">"step-exit"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"btn btn-sm btn-default"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"exit"</span><span class="hl-tag">&gt;</span>cancel<span class="hl-tag">&lt;/button&gt;</span>

            </pre>
            <em><span class="remark">At confirm page, the "step-current" must be "confirm","the step-failed" must be "input", the "step-success" must be "complete", the "step-back" must be
                    "input", the "step-exit" can be any non empty value (usually "exit" is good enough).</span></em>
          </div></div><br class="example-break">
          <div class="example"><a name="d5e463"></a><p class="title"><b>Example&nbsp;8.9.&nbsp;FormProcessData HTML for MultiStepFormFlowHandler - buttons of complete page</b></p><div class="example-contents">
            
            <pre class="programlisting">

<span class="hl-tag">&lt;button</span> <span class="hl-attribute">type</span>=<span class="hl-value">"submit"</span> <span class="hl-attribute">name</span>=<span class="hl-value">"step-exit"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"exit"</span><span class="hl-tag">&gt;</span>return<span class="hl-tag">&lt;/button&gt;</span>

            </pre>
            <em><span class="remark">At complete page, a non empty value of "step-exit" is enough.</span></em>
          </div></div><br class="example-break">
          <p class="remark"><em><span class="remark">Note that the value of steps' name are not fixed and you can always define your own names by implement your own FormProcessData.</span></em></p>
      </div>
      <div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="d5e468"></a>Implement the handler</h4></div></div></div>
          
          <p>In both OneStepFormHandler and MultiStepFormFlowHandler, there are two methods which are required to be implemented by developers. </p>
          <p>The first one is createInitForm() which has been implemented as creating the form instance from current request context. For a handler of adding, 
          it is not necessary to override it, for a handler of updating or a handler mixing with adding and updating, this method should be overridden to 
          supply a initial form instance:</p>
          <div class="example"><a name="d5e472"></a><p class="title"><b>Example&nbsp;8.10.&nbsp;query updating target data from db</b></p><div class="example-contents">
            
            <pre class="programlisting">                                                                 

    <em><span class="hl-annotation" style="color: gray">@Override</span></em>
    <span class="hl-keyword">protected</span> PersonFormForMultiStep createInitForm() <span class="hl-keyword">throws</span> Exception {
        PersonFormForMultiStep form = <span class="hl-keyword">super</span>.createInitForm();
        <span class="hl-keyword">if</span> (form.getId() == null) {<span class="hl-comment">// add</span>
            <span class="hl-keyword">return</span> form;
        } <span class="hl-keyword">else</span> {<span class="hl-comment">// update</span>
            <span class="hl-comment">// retrieve the form form db again</span>
            <span class="hl-keyword">return</span> PersonFormForMultiStep.buildFromPerson(PersonDbManager.instance().find(form.getId()));
        }
    }

            </pre>
          </div></div><br class="example-break">
          <p>The second method you have to override is updateForm() which is supposed to perform the final update logic of current form flow.</p>
          <div class="example"><a name="d5e476"></a><p class="title"><b>Example&nbsp;8.11.&nbsp;update form data</b></p><div class="example-contents">
            
            <pre class="programlisting">                                                                 

    <em><span class="hl-annotation" style="color: gray">@Override</span></em>
    <span class="hl-keyword">protected</span> <span class="hl-keyword">void</span> updateForm(PersonFormForMultiStep form) {
        <span class="hl-keyword">if</span> (form.getId() == null) {
            PersonDbManager.instance().add(Person.createByForm(form));
            <span class="hl-comment">// output the success message to specified DOM rather than the global message bar</span>
            DefaultMessageRenderingHelper.getConfiguredInstance().info(<span class="hl-string">"data inserted"</span>);
        } <span class="hl-keyword">else</span> {
            Person p = Person.createByForm(form);
            PersonDbManager.instance().update(p);
            <span class="hl-comment">// output the success message to specified DOM rather than the global message bar</span>
            DefaultMessageRenderingHelper.getConfiguredInstance().info(<span class="hl-string">"update succeed"</span>);
        }
    }

            </pre>
            <em><span class="remark">Note that there is a built-in message rendering mechanism to help developer supply a responsive interaction more easily. The 
            details will be introduced later, simply remember that you can output message by info/warn/error levels.</span></em>
          </div></div><br class="example-break">
      </div>
    </div>
    <div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="d5e480"></a>8.1.3.&nbsp;HTML template of form</h3></div></div></div>
      
      <p>As the common pages of Asta4D, the HTML template of a form is as pure HTML too.</p>
      <div class="example"><a name="d5e483"></a><p class="title"><b>Example&nbsp;8.12.&nbsp;Form template</b></p><div class="example-contents">
        
        <pre class="programlisting">                                                                 

<span class="hl-tag">&lt;form</span> <span class="hl-attribute">method</span>=<span class="hl-value">"post"</span> <span class="hl-attribute">afd:render</span>=<span class="hl-value">"form.SingleInputFormSnippet"</span><span class="hl-tag">&gt;</span>

  <span class="hl-tag">&lt;input</span> <span class="hl-attribute">name</span>=<span class="hl-value">"name"</span> <span class="hl-attribute">type</span>=<span class="hl-value">"text"</span><span class="hl-tag">/&gt;</span>

  <span class="hl-tag">&lt;input</span> <span class="hl-attribute">name</span>=<span class="hl-value">"age"</span> <span class="hl-attribute">type</span>=<span class="hl-value">"text"</span><span class="hl-tag">/&gt;</span>

  <span class="hl-tag">&lt;input</span> <span class="hl-attribute">id</span>=<span class="hl-value">"sex"</span> <span class="hl-attribute">name</span>=<span class="hl-value">"sex"</span> <span class="hl-attribute">type</span>=<span class="hl-value">"radio"</span><span class="hl-tag">/&gt;</span><span class="hl-tag">&lt;label</span> <span class="hl-attribute">for</span>=<span class="hl-value">"sex"</span><span class="hl-tag">&gt;</span>M<span class="hl-tag">&lt;/label&gt;</span>

  <span class="hl-tag">&lt;select</span> <span class="hl-attribute">id</span>=<span class="hl-value">"bloodtype"</span> <span class="hl-attribute">name</span>=<span class="hl-value">"bloodtype"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;option</span> <span class="hl-attribute">value</span>=<span class="hl-value">"A"</span><span class="hl-tag">&gt;</span>A<span class="hl-tag">&lt;/option&gt;</span>
    <span class="hl-tag">&lt;option</span> <span class="hl-attribute">value</span>=<span class="hl-value">"R"</span> <span class="hl-attribute">afd:clear&gt;R&lt;/option&gt;</span>
  <span class="hl-attribute">&lt;/select&gt;</span>

  <span class="hl-attribute">&lt;input</span> <span class="hl-attribute">id</span>=<span class="hl-value">"language"</span> <span class="hl-attribute">name</span>=<span class="hl-value">"language"</span> <span class="hl-attribute">type</span>=<span class="hl-value">"checkbox"</span><span class="hl-tag">/&gt;</span><span class="hl-tag">&lt;label</span> <span class="hl-attribute">for</span>=<span class="hl-value">"language"</span><span class="hl-tag">&gt;</span>M<span class="hl-tag">&lt;/label&gt;</span>

  <span class="hl-tag">&lt;textarea</span> <span class="hl-attribute">name</span>=<span class="hl-value">"memo"</span><span class="hl-tag">&gt;</span><span class="hl-tag">&lt;/textarea&gt;</span>
  
  <span class="hl-tag">&lt;input</span> <span class="hl-attribute">type</span>=<span class="hl-value">"hidden"</span> <span class="hl-attribute">name</span>=<span class="hl-value">"id"</span><span class="hl-tag">&gt;</span>

  <span class="hl-tag">&lt;afd:embed</span> <span class="hl-attribute">target</span>=<span class="hl-value">"/templates/form/singleInput/btns.html"</span><span class="hl-tag"> /&gt;</span>
<span class="hl-tag">&lt;/form&gt;</span>

        </pre>
      </div></div><br class="example-break">
      <p>As you see in the above example, there is no special declaration in the template, let us see how to declare a form POJO to handle the 
      various form field types:</p>
      <div class="example"><a name="d5e487"></a><p class="title"><b>Example&nbsp;8.13.&nbsp;form template</b></p><div class="example-contents">
        
        <pre class="programlisting">                                                                 

<span class="hl-comment">//@Form to tell the framework this class can be initialized from context</span>
<span class="hl-comment">//extend from the entity POJO to annotate form field definitions on getters.</span>
<em><span class="hl-annotation" style="color: gray">@Form</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> PersonForm {
    <em><span class="hl-annotation" style="color: gray">@Hidden</span></em>
    <span class="hl-keyword">private</span> Integer id;

    <em><span class="hl-annotation" style="color: gray">@Input</span></em>
    <span class="hl-keyword">private</span> String name;

    <em><span class="hl-annotation" style="color: gray">@Input</span></em>
    <span class="hl-keyword">private</span> Integer age;

    <em><span class="hl-annotation" style="color: gray">@Select(name = "bloodtype")</span></em>
    <span class="hl-keyword">private</span> BloodType bloodType;

    <span class="hl-comment">// the field name would be displayed as "gender" rather than the original field name "sex" in validation messages</span>
    <em><span class="hl-annotation" style="color: gray">@Radio(nameLabel = "gender")</span></em>
    <span class="hl-keyword">private</span> SEX sex;

    <em><span class="hl-annotation" style="color: gray">@Checkbox</span></em>
    <span class="hl-keyword">private</span> Language[] language;

    <em><span class="hl-annotation" style="color: gray">@Textarea</span></em>
    <span class="hl-keyword">private</span> String memo;

}

        </pre>
      </div></div><br class="example-break">
      <p>The details of annotations will be introduced later, just remember that there is always an annotation which can represent a 
      certain type of form field.</p>
      <p>Another point here is that you can always declare all the fields by your business type rather than string type, the framework 
      will handle the value conversion correctly.</p>
    </div>
    <div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="d5e492"></a>8.1.4.&nbsp;Form snippet</h3></div></div></div>
      
      <p>To render the form values to template, we have to declare a snippet which extends from the AbstractFormFlowSnippet. As the same
        as the built-in two classical handler, there are two corresponding snippet class: OneStepFormSnippet and MultiStepFormFlowSnippet.
      </p>
      <div class="example"><a name="d5e495"></a><p class="title"><b>Example&nbsp;8.14.&nbsp;Form snippet implementation</b></p><div class="example-contents">
        
        <pre class="programlisting">                                                                 

<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> SingleInputFormSnippet <span class="hl-keyword">extends</span> OneStepFormSnippet {

    <strong class="hl-tag" style="color: blue">/**
     * override this method to supply the option data for select, radio and checkbox.
     */</strong>
    <em><span class="hl-annotation" style="color: gray">@Override</span></em>
    <span class="hl-keyword">protected</span> List&lt;FormFieldPrepareRenderer&gt; retrieveFieldPrepareRenderers(String renderTargetStep, Object form) {
        List&lt;FormFieldPrepareRenderer&gt; list = <span class="hl-keyword">new</span> LinkedList&lt;&gt;();

        list.add(<span class="hl-keyword">new</span> SelectPrepareRenderer(PersonForm.<span class="hl-keyword">class</span>, <span class="hl-string">"bloodtype"</span>).setOptionData(BloodType.asOptionValueMap));

        list.add(<span class="hl-keyword">new</span> RadioPrepareRenderer(PersonForm.<span class="hl-keyword">class</span>, <span class="hl-string">"sex"</span>).setOptionData(SEX.asOptionValueMap));

        list.add(<span class="hl-keyword">new</span> CheckboxPrepareRenderer(PersonForm.<span class="hl-keyword">class</span>, <span class="hl-string">"language"</span>).setOptionData(Language.asOptionValueMap));

        <span class="hl-keyword">return</span> list;
    }
}

        </pre>
      </div></div><br class="example-break">
      <p>Developers are required to override the retrieveFieldPrepareRenderers method to supply extra data for field rendering, 
            commonly the list of option data is required.</p>
      <p>SelectPrepareRenderer can be used to afford option list for select element, RadioPrepareRenderer and CheckboxPrepareRenderer
            can be used for radio and checbox input element.</p>
      <p>Finally, do not forget to put your snippet declaration in your template file.</p>
      <div class="example"><a name="d5e501"></a><p class="title"><b>Example&nbsp;8.15.&nbsp;Declare snippet in form template</b></p><div class="example-contents">
        
        <pre class="programlisting">

<span class="hl-tag">&lt;form</span> <span class="hl-attribute">method</span>=<span class="hl-value">"post"</span> <span class="hl-attribute">afd:render</span>=<span class="hl-value">"form.SingleInputFormSnippet"</span><span class="hl-tag">&gt;</span>
<span class="hl-tag">&lt;/form&gt;</span>

        </pre>
      </div></div><br class="example-break">
      <p>Basically, until now we have gotten a workable form flow implementation. There is only one thing left that is validation which
            will be described in the next section.</p>
    </div>
    <div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="d5e505"></a>8.1.5.&nbsp;Validation</h3></div></div></div>
      
      <p>Asta4D allows any validation mechanism to be integrated and supports Bean Validation 1.1(JSR349 and JSR303) by default. We will explain
            how to use the built-in Bean Validation mechanism in this section. The later section will introduce how to customize the validation.</p>
      <p>To use Bean Validation, just simply add validation annotations to your form POJO as following:</p>
      <div class="example"><a name="d5e509"></a><p class="title"><b>Example&nbsp;8.16.&nbsp;Declare validation annotations</b></p><div class="example-contents">
        
        <pre class="programlisting">

<em><span class="hl-annotation" style="color: gray">@NotBlank</span></em>
<em><span class="hl-annotation" style="color: gray">@Size(max = 6)</span></em>
<span class="hl-keyword">public</span> String getName() {
    <span class="hl-keyword">return</span> name;
}

<span class="hl-keyword">public</span> <span class="hl-keyword">void</span> setName(String name) {
    <span class="hl-keyword">this</span>.name = name;
}

<em><span class="hl-annotation" style="color: gray">@Max(45)</span></em>
<em><span class="hl-annotation" style="color: gray">@NotNull</span></em>
<span class="hl-keyword">public</span> Integer getAge() {
    <span class="hl-keyword">return</span> age;
}

        </pre>
      </div></div><br class="example-break">
      <p>More details of Bean Validation can be found at <a class="ulink" href="http://beanvalidation.org/" target="_top">Bean Validation</a>. 
            We are also using Hibernate Validator as the implementation(the only existing one in the earth currently). See details at
            <a class="ulink" href="http://hibernate.org/validator/" target="_top">Hibernate Validator</a>.</p>
      <p>The validation will be invoked before the calling of method updateForm, if there is any validation error, the page will be
            forwarded to the step specified by "step-failed" which is usually the input page, and the validation error message will be
            rendered to page too. More details about validation message rendering will be introduced in later sections.</p>
    </div>
  </div>
  <div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d5e516"></a>8.2.&nbsp;Customize behaviours</h2></div></div></div><div class="toc"><p><b>Table of Contents</b></p><dl class="toc"><dt><span class="sect2"><a href="#d5e518">8.2.1. Cascade form POJO and array field</a></span></dt><dt><span class="sect2"><a href="#d5e520">8.2.2. Customize form flow definition</a></span></dt><dt><span class="sect2"><a href="#d5e523">8.2.3. Customize form field annotation</a></span></dt><dt><span class="sect2"><a href="#d5e525">8.2.4. Customize validation</a></span></dt><dt><span class="sect2"><a href="#d5e527">8.2.5. Customize message rendering</a></span></dt></dl></div>
    
    <div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="d5e518"></a>8.2.1.&nbsp;Cascade form POJO and array field</h3></div></div></div>
      
    </div>
    <div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="d5e520"></a>8.2.2.&nbsp;Customize form flow definition</h3></div></div></div>
      
      <p>(Include about how to implement multiple input steps)</p>
    </div>
    <div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="d5e523"></a>8.2.3.&nbsp;Customize form field annotation</h3></div></div></div>
      
    </div>
    <div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="d5e525"></a>8.2.4.&nbsp;Customize validation</h3></div></div></div>
      
    </div>
    <div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="d5e527"></a>8.2.5.&nbsp;Customize message rendering</h3></div></div></div>
      
    </div>

  </div>
  
</div>
    <div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="chapter-best-practice"></a>9.&nbsp;Best practice</h2></div></div></div>
  
  
  <p>In this chapter, we will introduce the best practice of Asta4D from our own experiences. There are some conventions and assumption in this chapter, 
        absolutely there are always special cases which are out of our assumption, however you can break any rules to handle your special cases, we only
        discuss the common cases in this chapter.
  </p>
  
  <div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="division-responsibilities"></a>9.1.&nbsp;Division of responsibilities between request handler and snippet</h2></div></div></div><div class="toc"><p><b>Table of Contents</b></p><dl class="toc"><dt><span class="sect2"><a href="#do-update-by-request-handler">9.1.1. Do update by request handler</a></span></dt><dt><span class="sect2"><a href="#normalize-page-condition">9.1.2. Normalize page condition by request handler</a></span></dt><dd><dl><dt><span class="sect3"><a href="#url-of-unique-resource-id">The URL of current page represents the unique resource id of an entity(resource)</a></span></dt><dt><span class="sect3"><a href="#url-of-search-condition-for-list">The URL of current page represents a search condition which can be used to retrieve a list of entities(resources)</a></span></dt></dl></dd></dl></div>
  
  <div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="do-update-by-request-handler"></a>9.1.1.&nbsp;Do update by request handler</h3></div></div></div>
    
    <p>MUST do all the operations with side effect at request handler side, that is so we called isolating side effect.</p>
    <p>NEVER do any operations with side effect at snippet side.</p>
  </div>
  <div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="normalize-page-condition"></a>9.1.2.&nbsp;Normalize page condition by request handler</h3></div></div></div><div class="toc"><p><b>Table of Contents</b></p><dl class="toc"><dt><span class="sect3"><a href="#url-of-unique-resource-id">The URL of current page represents the unique resource id of an entity(resource)</a></span></dt><dt><span class="sect3"><a href="#url-of-search-condition-for-list">The URL of current page represents a search condition which can be used to retrieve a list of entities(resources)</a></span></dt></dl></div>
      
      <p>It is a little bit difficult to explain this rule. For a page, we assume that there are always only 2 types of pages. Let us see how we 
            should divide our logic between the request handler and snippet.
      </p>
      <div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="url-of-unique-resource-id"></a>The URL of current page represents the unique resource id of an entity(resource)</h4></div></div></div>
        
        <div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
              <p>request handler</p>
              <div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem">
                      <p>Retrieve the entity(resource) from back-end storage(usually the db) by given id which is specified by the URL</p>
                  </li><li class="listitem">
                      <p>Decide how/what to response</p>
                      <div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: square; "><li class="listitem">
                              <p>(for example)If the target entity does not exist, return a 404 to the client</p>
                          </li><li class="listitem">
                              <p>(for example)If the target entity has been changed/migrated to another entity, return a 301 to the client</p>
                          </li><li class="listitem">
                              <p>(usually)Save the entity to Context and then forward to the target html template</p>
                          </li></ul></div>
                  </li></ul></div>
            </li><li class="listitem">
              <p>snippet</p>
              <div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem">
                      <p>Retrieve the saved entity(resource) from Context(by @ContextData)</p>
                  </li><li class="listitem">
                      <p>Perform other necessary query for rendering</p>
                  </li></ul></div>
            </li></ul></div>
      </div>
      <div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="url-of-search-condition-for-list"></a>The URL of current page represents a search condition which can be used to retrieve a list of entities(resources)</h4></div></div></div>
        
        <div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
              <p>request handler</p>
              <div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem">
                      <p>For simple cases, a request handler is not necessary</p> 
                      <p>Because the snippet can retrieve the condition by @ContextData directly.
                            However we recommend to declare a POJO to represent your search condition for a little bit complicated situations.
                      </p>
                      <div class="example"><a name="d5e574"></a><p class="title"><b>Example&nbsp;9.1.&nbsp;Snippet handling a search condition POJO</b></p><div class="example-contents">
                          
                          <pre class="programlisting">

<em><span class="hl-annotation" style="color: gray">@ContextDataSet</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> Condition{
 
  <em><span class="hl-annotation" style="color: gray">@QueryParam</span></em>
  <span class="hl-keyword">private</span> String queryword;
 
  <span class="hl-keyword">public</span> String getQueryword(){
    <span class="hl-keyword">return</span> queryword;
  } 
}

                                </pre>
                                <pre class="programlisting">

<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> MySnippet{
 
  <em><span class="hl-annotation" style="color: gray">@ContextData</span></em>
  <span class="hl-keyword">private</span> Condition condition;
  
}

                          </pre>
                      </div></div><br class="example-break">
                  </li><li class="listitem">
                      <p>Normalize the search condition POJO</p>
                      <p>In some complicated situations, you may need to retrieve the POJO in request handler then do some necessary normalization. After the
                            POJO was normalized, you should save it into Context to pass to snippet.
                      </p>
                      <div class="example"><a name="d5e581"></a><p class="title"><b>Example&nbsp;9.2.&nbsp;Normalize the search condition POJO</b></p><div class="example-contents">
                          
                          <pre class="programlisting">

<em><span class="hl-annotation" style="color: gray">@ContextDataSet(singletonInContext=true)</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> MyHandler{

  <span class="hl-keyword">public</span> <span class="hl-keyword">static</span> <span class="hl-keyword">final</span> String SEARCH_CONDITION = <span class="hl-string">"SEARCH_CONDITION#MyHandler"</span>;
 
  <em><span class="hl-annotation" style="color: gray">@RequestHandler</span></em>
  <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> handle(Condition condition){
    <span class="hl-comment">//do some normalization here</span>
    ...
    <span class="hl-comment">//This is not necessary</span>
    <span class="hl-comment">//Context.getCurrentThreadContext().setData(SEARCH_CONDITION, condition);</span>
  } 
}

                          </pre>
                          <pre class="programlisting">

<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> MySnippet{
 
  <em><span class="hl-annotation" style="color: gray">@ContextData</span></em>
  <span class="hl-keyword">private</span> Condition condition;
  
}

                          </pre>
                          <em><span class="remark">There is a trick that if we define a ContextDataSet's singletonInContext to true, there will be only on single instance in the context, 
                          thus we do not need to declare the name of ContextData even we stored the POJO by name at the handler side. Even that you do not need to save the
                          condition POJO explicitly since it is the single instance in the Context.</span></em>
                      </div></div><br class="example-break">
                  </li></ul></div>
            </li><li class="listitem">
              <p>snippet</p>
              <div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem">
                      <p>Retrieve the saved search condition POJO from Context(by @ContextData) or simply declare the search condition as its own fields(by @ContextData)</p>
                  </li><li class="listitem">
                      <p>Perform the query by given search condition to retrieve the list of entities(resources)</p>
                  </li><li class="listitem">
                      <p>Perform other necessary query for rendering</p>
                  </li></ul></div>
            </li></ul></div>
      </div>
    </div>
  </div>
  
  <div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="common-usage-form-flow"></a>9.2.&nbsp;Common usage of form flow</h2></div></div></div>
    
    <p class="remark"><em><span class="remark">To be written.</span></em></p>
  </div>

  <div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="best-snippet-way"></a>9.3.&nbsp;The best way of implementing a snippet</h2></div></div></div><div class="toc"><p><b>Table of Contents</b></p><dl class="toc"><dt><span class="sect2"><a href="#perform-queries-simple">9.3.1. Perform queries as simple as possible</a></span></dt><dt><span class="sect2"><a href="#make-use-of-parallelRowRender">9.3.2. Make use of ParallelRowRender</a></span></dt><dt><span class="sect2"><a href="#cache-data">9.3.3. Cache your data</a></span></dt><dt><span class="sect2"><a href="#avoid-duplicated-query">9.3.4. Avoid duplicated query</a></span></dt><dt><span class="sect2"><a href="#prepare-snippet-instance">9.3.5. Prepare snippet instance(set default value) by InitializableSnippet</a></span></dt><dt><span class="sect2"><a href="#selector-x-convention">9.3.6. "x-" convention selector</a></span></dt><dt><span class="sect2"><a href="#remove-rather-than-add">9.3.7. Remove contents rather than add contents for conditional rendering</a></span></dt></dl></div>
    
    <div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="perform-queries-simple"></a>9.3.1.&nbsp;Perform queries as simple as possible</h3></div></div></div>
      
      <p>We encourage developers to retrieve the data at the place where the data is required rather than retrieve a complicated data structure which holds all the necessary
            data for the whole page rendering in bulk. We make a convention that there are only 4 type of return value in our service layer(where the queries are performed exactly):
      </p>
      <div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
              <p>a single entity which is usually the POJO for ORMAP</p>
          </li><li class="listitem">
              <p>an list of entities' ids(not the entities themselves)</p>
          </li><li class="listitem">
              <p>a count of some aggregation queries</p>
          </li><li class="listitem">
              <p>a map as &lt;id, count&gt; of some aggregation queries</p>
          </li></ul></div>
      <p>In the implementation of render methods, we always retrieve the entity instance one by one even we are rendering a list of entity
            (exactly we only have a list of entities' ids). For the concern about performance, see the later description of cache. However, there must be some 
            situations that we cannot be satisfied with the performance by retrieving data in a too small granularity. We handle these cases as following steps:
      </p>
      <div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
            <p>Ask yourself, is it true that the granularity of data retrieving is the bottleneck of current performance issue.</p>
        </li><li class="listitem">
            <p>Ask your team members to confirm the bottleneck again.</p>
        </li><li class="listitem">
            <p>Implement a query method which returns a map as &lt;id, entity&gt; in bulk, then retrieve the entity from the map in the list rendering.</p>
        </li><li class="listitem">
            <p>If there is still a performance issue, ask yourself and ask your team members to confirm the bottleneck again.</p>
        </li><li class="listitem">
            <p>Build a query to retrieve all necessary data in bulk then return a complicated data structure from the query method just like what we are used to do
                  in the traditional MVC mode.</p>
        </li></ul></div>
      <p>In fact, the complicated data structures are rare in our system and most of our cases can be satisfied with the basic ORMAP entities.</p>
    </div>
    <div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="make-use-of-parallelRowRender"></a>9.3.2.&nbsp;Make use of ParallelRowRender</h3></div></div></div>
      
      <p>The ParallelRowRender splits the rendering action to threads with the size of rendered list. If there are some heavy operations in the list rendering, 
            ParallelRowRender is a good option to reduce the time of rendering.</p>
    </div>
    <div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="cache-data"></a>9.3.3.&nbsp;Cache your data</h3></div></div></div>
      
      <p>Since we are encouraging developers to retrieve data by a small granularity, the cache is very important to the system. Especially we often retrieve entities one by one
      in the list rendering, the cache of entities is the most important thing for performance. As a matter of fact, we can use the cache more effective because of the small 
      data granularity.</p>
    </div>
    <div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="avoid-duplicated-query"></a>9.3.4.&nbsp;Avoid duplicated query</h3></div></div></div>
      
      <p>An frequently asked question is how to avoid duplicated query in the snippet class. That is actually an problem since we encourage the developers perform queries at 
      the place where the data is required. We have the following options to combat this issue:</p>
      <div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
              <p>Global query lock via AOP</p>
              <p>This is the first option that we recommend for query heavy systems and exactly what we did in our system before we moved to saas architecture. We split all the real 
              queries to a service layer then perform a global lock for all the equal calling parameters on the same method. We use spring as our IOC container and simply add the 
              lock logic by the spring's AOP mechanism.</p>
          </li><li class="listitem">
              <p>ContextBindData</p>
              <p>For the lighter systems, ContextBindData would be a good choice for most situations. The get method of ContextBindData will be executed only once in the current
                    Context. See the detail of ContextBindData at <a class="xref" href="#vi-ContextDataFinder" title="12.2.3.&nbsp;ContextDataFinder">Section&nbsp;12.2.3, &#8220;ContextDataFinder&#8221;</a>.
              </p>
              <p>ContextBindData can also be used as a graceful simple wrapping mechanism for data retrieving at snippet layer. Developers can declare the common queries of a snippet
                    class as ContextBindData fields of it.
              </p>
          </li><li class="listitem">
              <p>InitializableSnippet</p>
              <p>A snippt class can also implement an interface called InitializableSnippet. The init() method of a snippet which implements the InitializableSnippet will be
                    called once after the snippet instance is created. Developer can do some prepare work for rendering by this mechanism such as performing common queries. 
                    However, performing query in init() method is not recommended but everything is by your choice.
              </p>
              <p class="remark"><em><span class="remark">In multiple thread rendering, the snippet classes may still be instantiated multiple times. There is no warranty about it.
              </span></em></p>
          </li></ul></div>
    </div>
    <div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="prepare-snippet-instance"></a>9.3.5.&nbsp;Prepare snippet instance(set default value) by InitializableSnippet</h3></div></div></div>
      
      <p>As we mentioned above, InitializableSnippet can be used to do some initialization work after the snippet instance is created. We do not recommend to perform common
            queries in init() method of InitializableSnippet, but the InitializableSnippet interface is still a good option for preparing a snippet instance.</p>
      <p>The classical usage of InitializableSnippet is that we can set default value of declared @ContextData fields if some of them are set to null.</p>
    </div>
    <div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="selector-x-convention"></a>9.3.6.&nbsp;"x-" convention selector</h3></div></div></div>
      
      <p>Though we can use various selectors to render data into the template file, we recommend to use css class name selector in common cases, which affords the best
      compatibility to the frond-end refactoring. We also made a convention which is called "x-" convention. we will always add a css class started with "x-" to the data rendering
      target, which tells the front-end guys try their best to keep the compatibility against the "x-" marked elements when they are refactoring the html sources.</p>
      <p>Although we always use "x-" convention to render our data, there are still some acceptable exceptions in our practice:</p>
      <div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
              <p>use "a" directly when rendering the link to the "href" attribute</p>
          </li><li class="listitem">
              <p>use "img" directly when rendering the link to the "src" attribute</p>
          </li><li class="listitem">
              <p>use "li" directly when rendering a list</p>
              <p class="remark"><em><span class="remark">This one is controversial, some of our members argue that we should use "x-" instead of direct "li" selector.</span></em></p>
          </li></ul></div>
    </div>
    <div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="remove-rather-than-add"></a>9.3.7.&nbsp;Remove contents rather than add contents for conditional rendering</h3></div></div></div>
      
      <p>Sometimes we need to do conditional rendering. For instance, we assume that there are two tabs which can be switched by different query parameter, a possible way is 
      to create the target tab contents dynamically at snippet side as following:</p>
      <div class="example"><a name="d5e666"></a><p class="title"><b>Example&nbsp;9.3.&nbsp;create contents dynamically</b></p><div class="example-contents">
          
          <pre class="programlisting">

<span class="hl-keyword">public</span> Renderer render(<span class="hl-keyword">int</span> id){
    Element elem = null;
    <span class="hl-keyword">if</span>(id == <span class="hl-number">0</span>){
        elem = ElementUtil.ParseAsSingle(<span class="hl-string">"&lt;div&gt;"</span> + id + <span class="hl-string">"&lt;/div&gt;"</span>);
    }<span class="hl-keyword">else</span>{
        elem = ElementUtil.ParseAsSingle(<span class="hl-string">"&lt;div class="</span>great<span class="hl-string">"&gt;"</span> + id + <span class="hl-string">"&lt;/div&gt;"</span>);
    }
    <span class="hl-keyword">return</span> Renderer.create(<span class="hl-string">".x-target"</span>, elem);
}

          </pre>
      </div></div><br class="example-break">
      <p>Apparently there is bad smell in above example, we generate DOM element at snippet side, which makes front-end refactoring difficult. The recommended way is to write all
      the possible contents in template file and remove the unnecessary ones in snippet.</p>
      <div class="example"><a name="d5e670"></a><p class="title"><b>Example&nbsp;9.4.&nbsp;remove redundant contents</b></p><div class="example-contents">
          
          <pre class="programlisting">

<span class="hl-keyword">public</span> Renderer render(<span class="hl-keyword">int</span> id){
    Renderer renderer = Renderer.create();
    <span class="hl-comment">//remove the clear mark</span>
    renderer.add(<span class="hl-string">".x-target-"</span> + id, <span class="hl-string">"-class"</span>, <span class="hl-string">"x-clear"</span>);
    <span class="hl-comment">//then clear the left ones which is not necessary</span>
    renderer.add(<span class="hl-string">".x-clear"</span>, Clear);
    <span class="hl-keyword">return</span> renderer;
}

            </pre>
            <pre class="programlisting">

<span class="hl-tag">&lt;div</span> <span class="hl-attribute">class</span>=<span class="hl-value">"x-target-0 x-clear"</span><span class="hl-tag">&gt;</span>0<span class="hl-tag">&lt;div&gt;</span>
<span class="hl-tag">&lt;div</span> <span class="hl-attribute">class</span>=<span class="hl-value">"x-target-1 x-clear"</span><span class="hl-tag">&gt;</span>1<span class="hl-tag">&lt;div&gt;</span>

          </pre>
      </div></div><br class="example-break">
    </div>
  </div>

</div>
  </div>  

  <div class="part"><div class="titlepage"><div><div><h1 class="title"><a name="asta4d-reference"></a>Part&nbsp;III.&nbsp;Reference</h1></div></div></div>
    
    <div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="chapter-detail-template"></a>10.&nbsp;Details of Template</h2></div></div></div>
  
  
  <div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d5e678"></a>10.1.&nbsp;Supported tags</h2></div></div></div><div class="toc"><p><b>Table of Contents</b></p><dl class="toc"><dt><span class="sect2"><a href="#d5e681">10.1.1. afd:extension</a></span></dt><dt><span class="sect2"><a href="#d5e693">10.1.2. afd:block</a></span></dt><dt><span class="sect2"><a href="#d5e722">10.1.3. afd:embed</a></span></dt><dt><span class="sect2"><a href="#d5e736">10.1.4. afd:snippet</a></span></dt><dt><span class="sect2"><a href="#d5e759">10.1.5. afd:group</a></span></dt><dt><span class="sect2"><a href="#d5e767">10.1.6. afd:comment</a></span></dt><dt><span class="sect2"><a href="#d5e775">10.1.7. afd:msg</a></span></dt></dl></div>
    
    
    <div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="d5e681"></a>10.1.1.&nbsp;afd:extension</h3></div></div></div>
      
      <p>A "afd:extension" tag declares the relationship of inheritance between child template and parent template.</p>
      <div class="example"><a name="d5e684"></a><p class="title"><b>Example&nbsp;10.1.&nbsp;child.html</b></p><div class="example-contents">
      <pre class="programlisting">

<span class="hl-tag">&lt;afd:extension</span> <span class="hl-attribute">parent</span>=<span class="hl-value">"parent.html"</span><span class="hl-tag">&gt;</span>   

...

<span class="hl-tag">&lt;/afd:extension&gt;</span>   

      </pre>
      </div></div><br class="example-break">
      <div class="variablelist"><p class="title"><b>Attributes:</b></p><dl class="variablelist"><dt><span class="term">parent</span></dt><dd>
            <p>Identifies the parent template file of the current template.</p>
          </dd></dl></div>
    </div>
    <div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="d5e693"></a>10.1.2.&nbsp;afd:block</h3></div></div></div>
      
      <p>A "afd:block" tag declares a referenceable block in the template file. Child template file can reference the
      blocks in parent template by the same tag "afd:block" with extra action declaration: append, insert, override.
      </p>
      <div class="example"><a name="d5e696"></a><p class="title"><b>Example&nbsp;10.2.&nbsp;parent.html</b></p><div class="example-contents">
      <pre class="programlisting">

<span class="hl-tag">&lt;html&gt;</span>   
    <span class="hl-tag">&lt;head&gt;</span>   
        <span class="hl-tag">&lt;afd:block</span> <span class="hl-attribute">id</span>=<span class="hl-value">"block1"</span><span class="hl-tag">&gt;</span>   
            <span class="hl-tag">&lt;link</span> <span class="hl-attribute">href</span>=<span class="hl-value">"parent1.css"</span> <span class="hl-attribute">rel</span>=<span class="hl-value">"stylesheet"</span> <span class="hl-attribute">type</span>=<span class="hl-value">"text/css"</span><span class="hl-tag"> /&gt;</span>   
        <span class="hl-tag">&lt;/afd:block&gt;</span>   
           
        <span class="hl-tag">&lt;afd:block</span> <span class="hl-attribute">id</span>=<span class="hl-value">"block2"</span><span class="hl-tag">&gt;</span>   
            <span class="hl-tag">&lt;link</span> <span class="hl-attribute">href</span>=<span class="hl-value">"parent2.css"</span> <span class="hl-attribute">rel</span>=<span class="hl-value">"stylesheet"</span> <span class="hl-attribute">type</span>=<span class="hl-value">"text/css"</span><span class="hl-tag"> /&gt;</span>   
        <span class="hl-tag">&lt;/afd:block&gt;</span>   
  
        <span class="hl-tag">&lt;title&gt;</span>extension sample<span class="hl-tag">&lt;/title&gt;</span>   
    <span class="hl-tag">&lt;/head&gt;</span>   
    <span class="hl-tag">&lt;body&gt;</span>   
        <span class="hl-tag">&lt;afd:block</span> <span class="hl-attribute">id</span>=<span class="hl-value">"content"</span><span class="hl-tag">&gt;</span>content<span class="hl-tag">&lt;/afd:block&gt;</span>   
    <span class="hl-tag">&lt;/body&gt;</span>   
<span class="hl-tag">&lt;/html&gt;</span> 

      </pre>
      </div></div><br class="example-break">
      <div class="example"><a name="d5e699"></a><p class="title"><b>Example&nbsp;10.3.&nbsp;child.html</b></p><div class="example-contents">
      <pre class="programlisting">

<span class="hl-tag">&lt;afd:extension</span> <span class="hl-attribute">parent</span>=<span class="hl-value">"parent.html"</span><span class="hl-tag">&gt;</span>   

    <span class="hl-tag">&lt;afd:block</span> <span class="hl-attribute">append</span>=<span class="hl-value">"block1"</span><span class="hl-tag">&gt;</span>   
        <span class="hl-tag">&lt;link</span> <span class="hl-attribute">href</span>=<span class="hl-value">"child1.css"</span> <span class="hl-attribute">rel</span>=<span class="hl-value">"stylesheet"</span> <span class="hl-attribute">type</span>=<span class="hl-value">"text/css"</span><span class="hl-tag"> /&gt;</span>   
    <span class="hl-tag">&lt;/afd:block&gt;</span>   
  
    <span class="hl-tag">&lt;afd:block</span> <span class="hl-attribute">insert</span>=<span class="hl-value">"block2"</span><span class="hl-tag">&gt;</span>   
        <span class="hl-tag">&lt;link</span> <span class="hl-attribute">href</span>=<span class="hl-value">"child2.css"</span> <span class="hl-attribute">rel</span>=<span class="hl-value">"stylesheet"</span> <span class="hl-attribute">type</span>=<span class="hl-value">"text/css"</span><span class="hl-tag"> /&gt;</span>   
    <span class="hl-tag">&lt;/afd:block&gt;</span>   
  
    <span class="hl-tag">&lt;afd:block</span> <span class="hl-attribute">override</span>=<span class="hl-value">"content"</span><span class="hl-tag">&gt;</span>   
        <span class="hl-tag">&lt;div&gt;</span>hello<span class="hl-tag">&lt;/div&gt;</span>   
    <span class="hl-tag">&lt;/afd:block&gt;</span>   
  
<span class="hl-tag">&lt;/afd:extension&gt;</span>

      </pre>
      </div></div><br class="example-break">
      <div class="variablelist"><p class="title"><b>Attributes:</b></p><dl class="variablelist"><dt><span class="term">id</span></dt><dd>
            <p>The referenceable id of a block.</p>
          </dd><dt><span class="term">append</span></dt><dd>
            <p>
            Append all the children of current tag to the tail of the parent's block which id equals the declared
            value of the append attribute.
            </p>
          </dd><dt><span class="term">insert</span></dt><dd>
            <p>
            Insert all the children of current tag to the head of the parent's block which id equals the declared
            value of the insert attribute.
            </p>
          </dd><dt><span class="term">override</span></dt><dd>
            <p>
            Override the parent's block which id equals the declared value of the override attribute by all the
            children of current tag.
            </p>
          </dd></dl></div>
      <p class="remark"><em><span class="remark">The result of merging the above two files by Asta4D's template engine can be found at <a class="xref" href="#chapter-Inheritable-template" title="2.&nbsp;Flexible template">Chapter&nbsp;2, <i>Flexible template</i></a>.</span></em></p>
    </div>
    <div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="d5e722"></a>10.1.3.&nbsp;afd:embed</h3></div></div></div>
      
      <p>A "afd:embed" tag declares an action of extracting and inserting an external file's content to the site where
      the "afd:embed" tag is declared.</p>
      <div class="example"><a name="d5e725"></a><p class="title"><b>Example&nbsp;10.4.&nbsp;child.html</b></p><div class="example-contents">
      <pre class="programlisting">

<span class="hl-tag">&lt;afd:extension</span> <span class="hl-attribute">parent</span>=<span class="hl-value">"parent.html"</span><span class="hl-tag">&gt;</span>   
  
    <span class="hl-tag">&lt;afd:block</span> <span class="hl-attribute">override</span>=<span class="hl-value">"content "</span><span class="hl-tag">&gt;</span>   
        <span class="hl-tag">&lt;div&gt;</span>hello<span class="hl-tag">&lt;/div&gt;</span>   
        <span class="hl-tag">&lt;afd:embed</span> <span class="hl-attribute">target</span>=<span class="hl-value">"/templates/embed.html"</span><span class="hl-tag"> &gt;</span><span class="hl-tag">&lt;/afd:embed&gt;</span>   
    <span class="hl-tag">&lt;/afd:block&gt;</span>   
  
<span class="hl-tag">&lt;/afd:extension&gt;</span>  

      </pre>
      </div></div><br class="example-break">
      <div class="variablelist"><p class="title"><b>Attributes:</b></p><dl class="variablelist"><dt><span class="term">target</span></dt><dd>
            <p>The path of which file should be included at the declaration site.</p>
          </dd></dl></div>
      <p class="remark"><em><span class="remark">In the embed target file, afd:block can also be used to append/insert/override the blocks in source template.
      Samples and the merging result can be found at <a class="xref" href="#chapter-Inheritable-template" title="2.&nbsp;Flexible template">Chapter&nbsp;2, <i>Flexible template</i></a>.
      </span></em></p>
    </div>
    <div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="d5e736"></a>10.1.4.&nbsp;afd:snippet</h3></div></div></div>
      
      <p>A "afd:snippet" tag declares an Java class which assumes the duty of rendering data to the html snippet contained
      by the declaring tag.</p>
      <div class="example"><a name="d5e739"></a><p class="title"><b>Example&nbsp;10.5.&nbsp;</b></p><div class="example-contents">
      <pre class="programlisting">

<span class="hl-tag">&lt;afd:snippet</span> <span class="hl-attribute">render</span>=<span class="hl-value">"SimpleSnippet:setProfile"</span><span class="hl-tag">&gt;</span>  
    <span class="hl-tag">&lt;p</span> <span class="hl-attribute">id</span>=<span class="hl-value">"name"</span><span class="hl-tag">&gt;</span>name:<span class="hl-tag">&lt;span&gt;</span>dummy name<span class="hl-tag">&lt;/span&gt;</span><span class="hl-tag">&lt;/p&gt;</span>  
    <span class="hl-tag">&lt;p</span> <span class="hl-attribute">id</span>=<span class="hl-value">"age"</span><span class="hl-tag">&gt;</span>age:<span class="hl-tag">&lt;span&gt;</span>0<span class="hl-tag">&lt;/span&gt;</span><span class="hl-tag">&lt;/p&gt;</span>  
<span class="hl-tag">&lt;/afd:snippet&gt;</span>

      </pre>
      </div></div><br class="example-break">
      <div class="variablelist"><p class="title"><b>Attributes:</b></p><dl class="variablelist"><dt><span class="term">render</span></dt><dd>
            <p>The snippet class name and render method name by format:&lt;class name&gt;:&lt;method name&gt;, the class name
            and the method name are split by colon. If the method name is omitted, the default method name "render" will be used.
            </p>
          </dd><dt><span class="term">parallel</span></dt><dd>
            <p>A snippet tag with "parallel" attribute will be executed in a separated thread from the main thread of current
            http request. It is not necessary to assign a value to this attribute.
            </p>
          </dd><dt><span class="term">clear</span></dt><dd>
            <p>A snippet tag with "clear" attribute will not be executed and will be removed from the final output page. This
            is useful for disabling certain contents temporarily in certain situations such as debug. It is not necessary to assign
            a value to this attribute.
            </p>
          </dd></dl></div>
      <p>
      There is an alternative way to declare a snippet by "afd:render" attribute.
      </p>
      <div class="example"><a name="d5e756"></a><p class="title"><b>Example&nbsp;10.6.&nbsp;</b></p><div class="example-contents">
      <pre class="programlisting">

<span class="hl-tag">&lt;div</span> <span class="hl-attribute">afd:render</span>=<span class="hl-value">"SimpleSnippet:setProfile"</span><span class="hl-tag">&gt;</span>  
    <span class="hl-tag">&lt;p</span> <span class="hl-attribute">id</span>=<span class="hl-value">"name"</span><span class="hl-tag">&gt;</span>name:<span class="hl-tag">&lt;span&gt;</span>dummy name<span class="hl-tag">&lt;/span&gt;</span><span class="hl-tag">&lt;/p&gt;</span>  
    <span class="hl-tag">&lt;p</span> <span class="hl-attribute">id</span>=<span class="hl-value">"age"</span><span class="hl-tag">&gt;</span>age:<span class="hl-tag">&lt;span&gt;</span>0<span class="hl-tag">&lt;/span&gt;</span><span class="hl-tag">&lt;/p&gt;</span>  
<span class="hl-tag">&lt;/div&gt;</span>

      </pre>
      </div></div><br class="example-break">
      <p>By the same way, "afd:paralell" and "afd:clear" can be used on arbitrary html tags which will be treated as the same as
      a "afd:snippet" tag. Note that "afd:paralell" will not be available except the "afd:render" is declared too, but the 
      "afd:clear" will be always available even there is no declaration of "afd:render" on the html tag.
      </p>
    </div>
    <div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="d5e759"></a>10.1.5.&nbsp;afd:group</h3></div></div></div>
      
      <p>A "afd:group" tag declares a referenceable DOM element for back-end Java snippet class. It is useful to reference certain
      text without wrapping html tag or combine a group of coordinate html tags as a single node.</p>
      <div class="example"><a name="d5e762"></a><p class="title"><b>Example&nbsp;10.7.&nbsp;</b></p><div class="example-contents">
      <pre class="programlisting">


<span class="hl-tag">&lt;p&gt;</span>We found <span class="hl-tag">&lt;afd:group</span> <span class="hl-attribute">id</span>=<span class="hl-value">"item-count"</span><span class="hl-tag">&gt;</span>3<span class="hl-tag">&lt;/afd:group&gt;</span> matched items in our database.<span class="hl-tag">&lt;/p&gt;</span> 

<span class="hl-tag">&lt;afd:group</span> <span class="hl-attribute">id</span>=<span class="hl-value">"list-item"</span><span class="hl-tag">&gt;</span>
  <span class="hl-tag">&lt;div</span> <span class="hl-attribute">id</span>=<span class="hl-value">"title"</span><span class="hl-tag">&gt;</span>the title<span class="hl-tag">&lt;/div&gt;</span>
  <span class="hl-tag">&lt;div</span> <span class="hl-attribute">id</span>=<span class="hl-value">"content"</span><span class="hl-tag">&gt;</span>the content<span class="hl-tag">&lt;/div&gt;</span>
<span class="hl-tag">&lt;/afd:group&gt;</span>


      </pre>
      </div></div><br class="example-break">
      <div class="variablelist"><p class="title"><b>Attributes:</b></p><em><span class="remark">None.</span></em><dl class="variablelist"></dl></div>
    </div>
    <div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="d5e767"></a>10.1.6.&nbsp;afd:comment</h3></div></div></div>
      
      <p>A "afd:comment" tag declares a comment block in the template files and it will be removed after rendering.</p>
      <div class="example"><a name="d5e770"></a><p class="title"><b>Example&nbsp;10.8.&nbsp;</b></p><div class="example-contents">
      <pre class="programlisting">


<span class="hl-tag">&lt;afd:comment&gt;</span>This is comment<span class="hl-tag">&lt;/afd:comment&gt;</span>

<span class="hl-tag">&lt;afd:comment&gt;</span>
  <span class="hl-tag">&lt;div&gt;</span>This is comment too.<span class="hl-tag">&lt;/div&gt;</span>
<span class="hl-tag">&lt;/afd:comment&gt;</span>


      </pre>
      </div></div><br class="example-break">
      <div class="variablelist"><p class="title"><b>Attributes:</b></p><em><span class="remark">None.</span></em><dl class="variablelist"></dl></div>
    </div>
    <div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="d5e775"></a>10.1.7.&nbsp;afd:msg</h3></div></div></div>
      
      <p>A "afd:msg" tag declares a message managed in external files. This tag is mainly designed for i18n support, but
      it also can be used as a simple string replacer. Please see <a class="xref" href="#chapter-detail-i18n" title="15.&nbsp;i18n">Chapter&nbsp;15, <i>i18n</i></a> for more details.</p>
      <div class="example"><a name="d5e779"></a><p class="title"><b>Example&nbsp;10.9.&nbsp;</b></p><div class="example-contents">
      <pre class="programlisting">

<span class="hl-tag">&lt;afd:msg</span> <span class="hl-attribute">key</span>=<span class="hl-value">"search.result.count"</span><span class="hl-tag">&gt;</span><span class="hl-tag">&lt;/afd:message&gt;</span>

      </pre>
      </div></div><br class="example-break">
      <div class="variablelist"><p class="title"><b>Attributes:</b></p><dl class="variablelist"><dt><span class="term">key</span></dt><dd>
            <p>The message key which should can be found in the configured message file.</p>
          </dd></dl></div>
    </div>
  </div>
  <div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d5e787"></a>10.2.&nbsp;Additional</h2></div></div></div>
    
    <div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
        <p>HTML5 convention</p>
        <p>
        Asta4D's template engine does only support html5, which relies on the underline library <a class="ulink" href="http://jsoup.org" target="_top">jsoup(verion 1.6.3)</a>.
        jsoup implements the <a class="ulink" href="http://whatwg.org/html" target="_top">WHATWG HTML5</a> specification and requires compliance from the target file.
        jsoup can fix some cases of breaking specification but you would still get unexpected result for certain cases. Basically, you should take care
        of the following things:
        </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><p>All tags and attributes are converted to lower case.</p></li><li class="listitem"><p>Self closed tags such as &lt;div /&gt; or &lt;afd:embed target="embed.html" /&gt; is not legal.</p></li><li class="listitem"><p>There are some tags that the parser "ensures".For example a &lt;tbody&gt; tag must be the first tag inside &lt;table&gt;, which
          breas the following example:</p>
            <div class="example"><a name="d5e802"></a><p class="title"><b>Example&nbsp;10.10.&nbsp;</b></p><div class="example-contents">
            <pre class="programlisting">

<span class="hl-tag">&lt;table&gt;</span>
<span class="hl-tag">&lt;afd:snippet</span> <span class="hl-attribute">render</span>=<span class="hl-value">"ListSnippet"</span><span class="hl-tag">&gt;</span>
<span class="hl-tag">&lt;tr&gt;</span><span class="hl-tag">&lt;td&gt;</span><span class="hl-tag">&lt;/td&gt;</span><span class="hl-tag">&lt;/tr&gt;</span>
<span class="hl-tag">&lt;/afd:snippet&gt;</span>
<span class="hl-tag">&lt;/table&gt;</span> 

            </pre>
            </div></div><br class="example-break">
            <p>But it can be replaced by the following:</p>
            <div class="example"><a name="d5e805"></a><p class="title"><b>Example&nbsp;10.11.&nbsp;</b></p><div class="example-contents">
            <pre class="programlisting">

<span class="hl-tag">&lt;table&gt;</span>
<span class="hl-tag">&lt;tr</span> <span class="hl-attribute">afd:render</span>=<span class="hl-value">"ListSnippet"</span><span class="hl-tag">&gt;</span><span class="hl-tag">&lt;td&gt;</span><span class="hl-tag">&lt;/td&gt;</span><span class="hl-tag">&lt;/tr&gt;</span>
<span class="hl-tag">&lt;/table&gt;</span> 

            </pre>
            </div></div><br class="example-break">
          </li></ul></div><p>
        </p>
      </li><li class="listitem">
        <p>body convention</p>
        <p>When a child template file uses "afd:extension" to declare its parent template, only the body part(all the 
        children of the body except the body tag itself) of the child template will be processed by the template engine 
        and the parts out of body will be ignored simply. The same convention is applied to the embed target file. The 
        following two sample will not cause different results by Asta4D.</p>
        <div class="example"><a name="d5e810"></a><p class="title"><b>Example&nbsp;10.12.&nbsp;child.html without body tag:</b></p><div class="example-contents">
        <pre class="programlisting">

<span class="hl-tag">&lt;afd:extension</span> <span class="hl-attribute">parent</span>=<span class="hl-value">"parent.html"</span><span class="hl-tag">&gt;</span>   
  
    <span class="hl-tag">&lt;afd:block</span> <span class="hl-attribute">override</span>=<span class="hl-value">"content "</span><span class="hl-tag">&gt;</span>   
        <span class="hl-tag">&lt;div&gt;</span>hello<span class="hl-tag">&lt;/div&gt;</span>   
        <span class="hl-tag">&lt;afd:embed</span> <span class="hl-attribute">target</span>=<span class="hl-value">"/templates/embed.html"</span><span class="hl-tag"> &gt;</span><span class="hl-tag">&lt;/afd:embed&gt;</span>   
    <span class="hl-tag">&lt;/afd:block&gt;</span>   
  
<span class="hl-tag">&lt;/afd:extension&gt;</span>  

        </pre>
        </div></div><br class="example-break">
        <div class="example"><a name="child-with-body-tag"></a><p class="title"><b>Example&nbsp;10.13.&nbsp;child.html with body tag:</b></p><div class="example-contents">
        <pre class="programlisting">

<span class="hl-tag">&lt;html&gt;</span>
<span class="hl-tag">&lt;head&gt;</span>
<span class="hl-tag">&lt;meta</span> <span class="hl-attribute">charset</span>=<span class="hl-value">"UTF-8"</span><span class="hl-tag">&gt;</span>
<span class="hl-tag">&lt;/head&gt;</span>
<span class="hl-tag">&lt;body&gt;</span>
<span class="hl-tag">&lt;afd:extension</span> <span class="hl-attribute">parent</span>=<span class="hl-value">"parent.html"</span><span class="hl-tag">&gt;</span>   
  
    <span class="hl-tag">&lt;afd:block</span> <span class="hl-attribute">override</span>=<span class="hl-value">"content "</span><span class="hl-tag">&gt;</span>   
        <span class="hl-tag">&lt;div&gt;</span>hello<span class="hl-tag">&lt;/div&gt;</span>   
        <span class="hl-tag">&lt;afd:embed</span> <span class="hl-attribute">target</span>=<span class="hl-value">"/templates/embed.html"</span><span class="hl-tag"> &gt;</span><span class="hl-tag">&lt;/afd:embed&gt;</span>   
    <span class="hl-tag">&lt;/afd:block&gt;</span>   
  
<span class="hl-tag">&lt;/afd:extension&gt;</span>
<span class="hl-tag">&lt;/body&gt;</span>
<span class="hl-tag">&lt;/html&gt;</span>  

        </pre>
        </div></div><br class="example-break">
        <p>
        This convention can be used for editor compatibility in case of your prefer html editor requires correct meta information
        (We add charset="UTF-8" to all of our template files for this reason). Note that this convention is only available on extended
        child template file or embedded target file, the parts out of body tag will be processed normally in the parent template file
        which is as a root template without further parent.
        </p>
        <p>
        Further, explicit parameter information can be commented at body tag in parameterizable embed target file for better source
        readability.
        </p>
        <div class="example"><a name="embed-with-parameter-declaring"></a><p class="title"><b>Example&nbsp;10.14.&nbsp;embed.html</b></p><div class="example-contents">
          <pre class="programlisting">

<span class="hl-tag">&lt;html&gt;</span>
<span class="hl-tag">&lt;head&gt;</span><span class="hl-tag">&lt;meta</span> <span class="hl-attribute">charset</span>=<span class="hl-value">"UTF-8"</span><span class="hl-tag">&gt;</span><span class="hl-tag">&lt;/head&gt;</span>
<span class="hl-tag">&lt;body</span> <span class="hl-attribute">itemsize</span>=<span class="hl-value">"{Integer}"</span> <span class="hl-attribute">itemlist</span>=<span class="hl-value">"{List}"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;afd:block</span> <span class="hl-attribute">append</span>=<span class="hl-value">"block1"</span><span class="hl-tag">&gt;</span>   
        <span class="hl-tag">&lt;link</span> <span class="hl-attribute">href</span>=<span class="hl-value">"embed.css"</span> <span class="hl-attribute">rel</span>=<span class="hl-value">"stylesheet"</span> <span class="hl-attribute">type</span>=<span class="hl-value">"text/css"</span><span class="hl-tag"> /&gt;</span>   
    <span class="hl-tag">&lt;/afd:block&gt;</span>   
    <span class="hl-tag">&lt;div&gt;</span>good embed<span class="hl-tag">&lt;/div&gt;</span>   
<span class="hl-tag">&lt;/body&gt;</span>
<span class="hl-tag">&lt;/html&gt;</span>

          </pre>
          <p>
            In <a class="xref" href="#embed-with-parameter-declaring" title="Example&nbsp;10.14.&nbsp;embed.html">Example&nbsp;10.14, &#8220;embed.html&#8221;</a>, we put some "strange" information in the body tag, which suggests that
            when this file is embedded, it requires an Integer parameter named "itemsize" and a List parameter named "itemlist". Note
            that such declaration can only be regarded as a hint for source reader and there is no warranty about any parameter check.
            You should consider it as a sample of how you can make interesting use of the body convention.
          </p>
        </div></div><br class="example-break">
        <br>
      </li><li class="listitem">
        <p>"afd" name space</p>
        <p>The "afd" name space is configured as the default name space of Asta4D's special tags. This name space can be
        changed by Configuration#setTagNameSpace.</p>
        <br>
      </li><li class="listitem">
        <p>TemplateResolver</p>
        <p>Asta4D searches certain template file by configured TemplateResolver. There are three pre-implemented TemplateResolver:
        FileTemplateResolver, ClasspathTemplateResolver and WebApplicationTemplateResolver. The default configured WebApplicationTemplateResolver
        will search template files with awareness of servlet container. The FileTemplateResolver and ClasspathTemplateResolver
        can be used for test purpose, you can also provide your own TemplateResolver for special search mechanism.
        </p>
      </li></ul></div>
  </div>

</div>
    <div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="chapter-detail-snippet"></a>11.&nbsp;Details of snippet class</h2></div></div></div>
  
  
  <div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d5e833"></a>11.1.&nbsp;Rendering APIs</h2></div></div></div><div class="toc"><p><b>Table of Contents</b></p><dl class="toc"><dt><span class="sect2"><a href="#d5e837">11.1.1. Create and add Renderer instance</a></span></dt><dt><span class="sect2"><a href="#css-selector">11.1.2. CSS Selector</a></span></dt><dt><span class="sect2"><a href="#d5e1057">11.1.3. Render text</a></span></dt><dt><span class="sect2"><a href="#d5e1065">11.1.4. Render DOM attribution</a></span></dt><dt><span class="sect2"><a href="#d5e1102">11.1.5. Clear an Element</a></span></dt><dt><span class="sect2"><a href="#d5e1109">11.1.6. Render raw Element</a></span></dt><dt><span class="sect2"><a href="#d5e1116">11.1.7. Arbitrary rendering for an Element</a></span></dt><dt><span class="sect2"><a href="#d5e1126">11.1.8. Recursive rendering</a></span></dt><dt><span class="sect2"><a href="#d5e1131">11.1.9. Debug renderer</a></span></dt><dt><span class="sect2"><a href="#d5e1137">11.1.10. Missing selector warning</a></span></dt><dt><span class="sect2"><a href="#d5e1145">11.1.11. List rendering</a></span></dt></dl></div>
    
    <p>Asta4D provides various rendering APIs to help developers render value to the page. By those APIs, developer can render
    text under a DOM element, set the attribute value for a DOM element, also can convert a list data to a list of DOM element,
    and also other various manipulation on DOM elements.
    </p>
    
    <div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="d5e837"></a>11.1.1.&nbsp;Create and add Renderer instance</h3></div></div></div>
      
      <p>There are almost same two sets of overloaded methods: create and add. The create methods are static and can be
      used to create a Renderer instance. The add methods are instance methods and can be used to add a implicitly created
      Renderer instance to an existing Renderer instance. Both of the create and add methods return the created Renderer
      instance therefore chain invoking can be performed as well.</p>
      <div class="example"><a name="d5e840"></a><p class="title"><b>Example&nbsp;11.1.&nbsp;</b></p><div class="example-contents">
        <pre class="programlisting">


Renderer renderer = Renderer.create(<span class="hl-string">"#someId"</span>, <span class="hl-string">"xyz"</span>).add(<span class="hl-string">"sometag"</span>, <span class="hl-string">"hello"</span>);
renderer.add(<span class="hl-string">".someclass"</span>, <span class="hl-string">"abc"</span>).add(<span class="hl-string">".someclass2"</span>, <span class="hl-string">"abc2"</span>);

Renderer renderer2 = Renderer.create(<span class="hl-string">"#someId2"</span>, <span class="hl-string">"xyz2"</span>);
Renderer renderer3 = Renderer.create(<span class="hl-string">"#someId3"</span>, <span class="hl-string">"xyz3"</span>);

<span class="hl-comment">//add renderer2 and renderer3 to renderer</span>
renderer.add(renderer2);
renderer.add(renderer3);

        </pre>
      </div></div><br class="example-break">
      <p>Note that the order of a Renderer instance being added is significant but the target instance which a Renderer
      is added to has no effect on the rendering order. In the following example, "add renderer2 to renderer then add renderer3 to renderer2"
      is completely equal to "add renderer2 and renderer3 to renderer" at above example.
      </p>
      <div class="example"><a name="d5e843"></a><p class="title"><b>Example&nbsp;11.2.&nbsp;</b></p><div class="example-contents">
        <pre class="programlisting">


<span class="hl-comment">//add renderer2 to renderer then add renderer3 to renderer2</span>
renderer.add(renderer2);
renderer2.add(renderer3);


        </pre>
      </div></div><br class="example-break">
      <p>The following is equal too:</p>
      <div class="example"><a name="d5e846"></a><p class="title"><b>Example&nbsp;11.3.&nbsp;</b></p><div class="example-contents">
        <pre class="programlisting">


<span class="hl-comment">//add renderer3 to renderer2 then add renderer2 to renderer</span>
renderer2.add(renderer3);
renderer.add(renderer2);


        </pre>
      </div></div><br class="example-break">
      <p>A instance of Renderer should not be considered as a single rendering declaration only, A instance of Renderer is exactly a
      rendering chain holder, you can call add method on any instance of the chain but the added Renderer instance will be always added
      to the tail of the chain. If the added Renderer instance is holding over than one Renderer instance in its own chain, the held chain
      will be added to the tail of the chain of the target Renderer.</p>
      
      <p>There is also a non-parameter create method which can by used to create a "do nothing" Renderer for source convenience. In our
      practice, we write the following line at the beginning of most of our snippet methods.</p>
      <div class="example"><a name="d5e850"></a><p class="title"><b>Example&nbsp;11.4.&nbsp;</b></p><div class="example-contents">
        <pre class="programlisting">

Renderer renderer = Renderer.create();

        </pre>
      </div></div><br class="example-break">
      
      <p>In following sections, we will introduce add method only, but you should remember that there should be a equal create method for most
      cases. You can also read the Java doc of Renderer for more details.</p>
    </div>
    <div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="css-selector"></a>11.1.2.&nbsp;CSS Selector</h3></div></div></div>
      
      <p>Asta4D is using a modified version of <a class="ulink" href="http://jsoup.org/" target="_top">jsoup library</a> to afford CSS selector function.
      Currently, we support the following selectors:
      </p>
      
      <div class="table"><a name="d5e857"></a><p class="title"><b>Table&nbsp;11.1.&nbsp;Supported selectors</b></p><div class="table-contents">
      <table summary="Supported selectors" style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col align="left" class="c1"><col align="left" class="c2"><col align="left" class="c3"></colgroup><thead><tr><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">Pattern</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">Matches</th><th style="border-bottom: 0.5pt solid ; " align="left">Example</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">*</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">any element</td><td style="border-bottom: 0.5pt solid ; " align="left">*</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">tag</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">elements with the given tag name</td><td style="border-bottom: 0.5pt solid ; " align="left">div</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">ns|E</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">elements of type E in the namespace ns</td><td style="border-bottom: 0.5pt solid ; " align="left">fb|name finds &lt;fb:name&gt; elements</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">#id</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">elements with attribute ID of "id"</td><td style="border-bottom: 0.5pt solid ; " align="left">div#wrap, #logo</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">.class</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">elements with a class name of "class"</td><td style="border-bottom: 0.5pt solid ; " align="left">div.left, .result</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">[attr]</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">elements with an attribute named "attr" (with any value)</td><td style="border-bottom: 0.5pt solid ; " align="left">a[href], [title]</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">[^attrPrefix]</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">elements with an attribute name starting with "attrPrefix". Use to find elements with HTML5 datasets</td><td style="border-bottom: 0.5pt solid ; " align="left">[^data-], div[^data-]</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">[attr=val]</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">elements with an attribute named "attr", and value equal to "val"</td><td style="border-bottom: 0.5pt solid ; " align="left">img[width=500], a[rel=nofollow]</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">[attr^=valPrefix]</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">elements with an attribute named "attr", and value starting with "valPrefix"</td><td style="border-bottom: 0.5pt solid ; " align="left">a[href^=http:]</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">[attr$=valSuffix]</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">elements with an attribute named "attr", and value ending with "valSuffix"</td><td style="border-bottom: 0.5pt solid ; " align="left">img[src$=.png]</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">[attr*=valContaining]</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">elements with an attribute named "attr", and value containing "valContaining"</td><td style="border-bottom: 0.5pt solid ; " align="left">a[href*=/search/]</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">[attr~=regex]</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">elements with an attribute named "attr", and value matching the regular expression</td><td style="border-bottom: 0.5pt solid ; " align="left">img[src~=(?i)\\.(png|jpe?g)]</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">The above may be combined in any order</td><td style="border-bottom: 0.5pt solid ; " align="left">div.header[title]</td></tr><tr><td style="border-bottom: 0.5pt solid ; " rowspan="2" colspan="3" align="center" valign="bottom"><span class="emphasis"><em>Combinators</em></span></td></tr><tr><!-- This row intentionally left blank --></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">E F</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">an F element descended from an E element</td><td style="border-bottom: 0.5pt solid ; " align="left">div a, .logo h1</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">E &gt; F</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">an F direct child of E</td><td style="border-bottom: 0.5pt solid ; " align="left">ol &gt; li</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">E + F</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">an F element immediately preceded by sibling E</td><td style="border-bottom: 0.5pt solid ; " align="left">li + li, div.head + div</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">E ~ F</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">an F element preceded by sibling E</td><td style="border-bottom: 0.5pt solid ; " align="left">h1 ~ p</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">E, F, G</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">all matching elements E, F, or G</td><td style="border-bottom: 0.5pt solid ; " align="left">a[href], div, h3</td></tr><tr><td style="border-bottom: 0.5pt solid ; " rowspan="2" colspan="3" align="center" valign="bottom"><span class="emphasis"><em>Pseudo selectors</em></span></td></tr><tr><!-- This row intentionally left blank --></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">:lt(n)</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">elements whose sibling index is less than n</td><td style="border-bottom: 0.5pt solid ; " align="left">td:lt(3) finds the first 2 cells of each row</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">:gt(n)</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">elements whose sibling index is greater than n</td><td style="border-bottom: 0.5pt solid ; " align="left">td:gt(1) finds cells after skipping the first two</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">:eq(n)</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">elements whose sibling index is equal to n</td><td style="border-bottom: 0.5pt solid ; " align="left">td:eq(0) finds the first cell of each row</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">:has(selector)</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">elements that contains at least one element matching the selector</td><td style="border-bottom: 0.5pt solid ; " align="left">div:has(p) finds divs that contain p elements</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">:not(selector)</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">elements that do not match the selector. See also Elements.not(String)</td><td style="border-bottom: 0.5pt solid ; " align="left">
            <p>div:not(.logo) finds all divs that do not have the "logo" class.</p>
            <p>div:not(:has(div)) finds divs that do not contain divs.</p>
          </td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">:contains(text)</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">elements that contains the specified text. The search is case insensitive. The text may appear in the found element, or any of its descendants.</td><td style="border-bottom: 0.5pt solid ; " align="left">p:contains(jsoup) finds p elements containing the text "jsoup".</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">:matches(regex)</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">elements whose text matches the specified regular expression. The text may appear in the found element, or any of its descendants.</td><td style="border-bottom: 0.5pt solid ; " align="left">td:matches(\\d+) finds table cells containing digits. div:matches((?i)login) finds divs containing the text, case insensitively.</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">:containsOwn(text)</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">elements that directly contains the specified text. The search is case insensitive. The text must appear in the found element, not any of its descendants.</td><td style="border-bottom: 0.5pt solid ; " align="left">p:containsOwn(jsoup) finds p elements with own text "jsoup".</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">:matchesOwn(regex)</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">elements whose own text matches the specified regular expression. The text must appear in the found element, not any of its descendants.</td><td style="border-bottom: 0.5pt solid ; " align="left">td:matchesOwn(\\d+) finds table cells directly containing digits. div:matchesOwn((?i)login) finds divs containing the text, case insensitively.</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">The above may be combined in any order and with other selectors</td><td style="border-bottom: 0.5pt solid ; " align="left">.light:contains(name):eq(0)</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left">&nbsp;</td></tr><tr><td style="border-bottom: 0.5pt solid ; " rowspan="2" colspan="3" align="center" valign="bottom"><span class="emphasis"><em>Structural pseudo selectors</em></span></td></tr><tr><!-- This row intentionally left blank --></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">:root</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">The element that is the root of the document. In HTML, this is the html element. In a snippet method, this is the element where the current snippet method is declared. In a recursive Renderer, this is the target element which the current renderer is applied to.</td><td style="border-bottom: 0.5pt solid ; " align="left">:root</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">:nth-child(an+b)</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">elements that have an+b-1 siblings before it in the document tree, for any positive integer or zero value of n, and has a parent element. For values of a and b greater than zero, this effectively divides the element's children into groups of a elements (the last group taking the remainder), and selecting the bth element of each group. For example, this allows the selectors to address every other row in a table, and could be used to alternate the color of paragraph text in a cycle of four. The a and b values must be integers (positive, negative, or zero). The index of the first child of an element is 1.
          In addition to this, :nth-child() can take odd and even as arguments instead. odd has the same signification as 2n+1, and even has the same signification as 2n.</td><td style="border-bottom: 0.5pt solid ; " align="left">tr:nth-child(2n+1) finds every odd row of a table. :nth-child(10n-1) the 9th, 19th, 29th, etc, element. li:nth-child(5) the 5h li</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">:nth-last-child(an+b)</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">elements that have an+b-1 siblings after it in the document tree. Otherwise like :nth-child()</td><td style="border-bottom: 0.5pt solid ; " align="left">tr:nth-last-child(-n+2) the last two rows of a table</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">:nth-of-type(an+b)</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">pseudo-class notation represents an element that has an+b-1 siblings with the same expanded element name before it in the document tree, for any zero or positive integer value of n, and has a parent element</td><td style="border-bottom: 0.5pt solid ; " align="left">img:nth-of-type(2n+1)</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">:nth-last-of-type(an+b)</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">pseudo-class notation represents an element that has an+b-1 siblings with the same expanded element name after it in the document tree, for any zero or positive integer value of n, and has a parent element</td><td style="border-bottom: 0.5pt solid ; " align="left">img:nth-last-of-type(2n+1)</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">:first-child</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">elements that are the first child of some other element.</td><td style="border-bottom: 0.5pt solid ; " align="left">div &gt; p:first-child</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">:last-child</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">elements that are the last child of some other element.</td><td style="border-bottom: 0.5pt solid ; " align="left">ol &gt; li:last-child</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">:first-of-type</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">elements that are the first sibling of its type in the list of children of its parent element</td><td style="border-bottom: 0.5pt solid ; " align="left">dl dt:first-of-type</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">:last-of-type</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">elements that are the last sibling of its type in the list of children of its parent element</td><td style="border-bottom: 0.5pt solid ; " align="left">tr &gt; td:last-of-type</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">:only-child</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">elements that have a parent element and whose parent element hasve no other element children</td><td style="border-bottom: 0.5pt solid ; " align="left">&nbsp;</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">:only-of-type</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">an element that has a parent element and whose parent element has no other element children with the same expanded element name</td><td style="border-bottom: 0.5pt solid ; " align="left">&nbsp;</td></tr><tr><td style="border-right: 0.5pt solid ; " align="left">:empty</td><td style="border-right: 0.5pt solid ; " align="left">elements that have no children at all</td><td style="" align="left">&nbsp;</td></tr></tbody></table>
      </div></div><br class="table-break">
      <p class="remark"><em><span class="remark">Note: Because of the internal implementation of how to perform Renderer on target element, there may be unexpected temporary elements to be added into the 
              Current DOM tree, which will be removed safely at the final stage of page production but may cause the structural pseudo selectors work incorrectly
              (However, the :root selector can still work well).
      </span></em></p>
      
    </div>
    <div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="d5e1057"></a>11.1.3.&nbsp;Render text</h3></div></div></div>
      
      <p>add(String selector, String value) can be used to render a text under the element specified by given selector.
      All child nodes of the target element specified by selector will be emptied and the given String value will be rendered as a single
      text node of the target element.</p>
      <div class="example"><a name="d5e1060"></a><p class="title"><b>Example&nbsp;11.5.&nbsp;</b></p><div class="example-contents">
        <pre class="programlisting">

renderer.add(<span class="hl-string">"#someId"</span>, <span class="hl-string">"xyz"</span>);

        </pre>
      </div></div><br class="example-break">
      <p>Long/long, Integer/int, Boolean/boolean will be treated as text rendering too.</p>
      <div class="example"><a name="d5e1063"></a><p class="title"><b>Example&nbsp;11.6.&nbsp;</b></p><div class="example-contents">
        <pre class="programlisting">

renderer.add(<span class="hl-string">"#someIdForLong"</span>, <span class="hl-number">123L</span>);
renderer.add(<span class="hl-string">"#someIdForInt"</span>, <span class="hl-number">123</span>);
renderer.add(<span class="hl-string">"#someIdForBool"</span>, true);

        </pre>
      </div></div><br class="example-break">
    </div>
    <div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="d5e1065"></a>11.1.4.&nbsp;Render DOM attribution</h3></div></div></div>
      
      <p>add(String selector, String attr, String value) can be used to render attribute value of a DOM element. There are some rules will
      be applied for the pattern of specified "attr" and "value":</p>
      <div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
          <p>add("+class", value)</p>
          <p>call addClass(value) on target Element, null value will be treated as "null".</p>
        </li><li class="listitem">
          <p>add("-class", value)</p>
          <p>call removeClass(value) on target Element, null value will be treated as "null".</p>
        </li><li class="listitem">
          <p>add("class", value)</p>
          <p>call attr("class", value) on target Element if value is not null, for a null value, removeAttr("class") will be called.</p>
        </li><li class="listitem">
          <p>add("anyattr", value)</p>
          <p>call attr("anyattr", value) on target Element if value is not null, for a null value, removeAttr("anyattr") will be called.</p>
        </li><li class="listitem">
          <p>add("anyattr", SpecialRenderer.Clear)</p>
          <p>call removeAttr("anyattr") on target Element.</p>
        </li><li class="listitem">
          <p>add("+anyattr", value)</p>
          <p>call attr("anyattr", value) on target Element if value is not null, for a null value, removeAttr("anyattr") will be called.</p>
        </li><li class="listitem">
          <p>add("+anyattr", SpecialRenderer.Clear)</p>
          <p>call removeAttr("anyattr") on target Element.</p>
        </li><li class="listitem">
          <p>add("-anyattr", value)</p>
          <p>call removeAttr("anyattr") on target Element.</p>
        </li></ul></div>
      
      <p>There is also an add method for attribution rendering that accepts arbitrary data as Object type: add(String selector, String attr, Object value).
      When the "value" is specified as a non-string value and the "attr" is specified as "+class" or "-class", A IllegalArgumentException will be thrown.
      When an arbitrary Object value is rendered to attribute by such method, an internal object reference id will be rendered to the target attribute
      instead of the original object since it cannot be treated as attribute string value directly. The object reference id can be used by variable injection
      for the nested snippet rendering. See the following example, we pass a Date instance to the nested snippet method:
      </p>
      
      <div class="example"><a name="d5e1094"></a><p class="title"><b>Example&nbsp;11.7.&nbsp;</b></p><div class="example-contents">
        <pre class="programlisting">

<span class="hl-tag">&lt;div</span> <span class="hl-attribute">afd:render</span>=<span class="hl-value">"MySnippet:outer"</span><span class="hl-tag">&gt;</span>
  <span class="hl-tag">&lt;div</span> <span class="hl-attribute">id</span>=<span class="hl-value">"inner"</span> <span class="hl-attribute">afd:render</span>=<span class="hl-value">"MySnippet:inner"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;span</span> <span class="hl-attribute">id</span>=<span class="hl-value">"current-date"</span><span class="hl-tag">&gt;</span><span class="hl-tag">&lt;/span&gt;</span>
  <span class="hl-tag">&lt;/div&gt;</span>
<span class="hl-tag">&lt;/div&gt;</span>

        </pre>
        <pre class="programlisting">

<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> MySnippet{

    <span class="hl-keyword">public</span> Renderer outer(){
        <span class="hl-keyword">return</span> Renderer.create(<span class="hl-string">"#innder"</span>, <span class="hl-string">"now"</span>, <span class="hl-keyword">new</span> Date());
    }
    
    <span class="hl-keyword">public</span> Renderer inner(Date now){
        <span class="hl-keyword">return</span> Renderer.create(<span class="hl-string">"#current-date"</span>, now);
    }
}

        </pre>
      </div></div><br class="example-break">
      
      <p>This mechanism can be used for parametrized embedding too. Parameters can be specified by attribution rendering 
      in the snippet method of parent template file and can be retrieved by the snippet method of child template file as same
      as the above example.
      </p>
      
      <div class="example"><a name="d5e1098"></a><p class="title"><b>Example&nbsp;11.8.&nbsp;</b></p><div class="example-contents">
        <pre class="programlisting">

<span class="hl-comment">&lt;!-- parent template --&gt;</span>
<span class="hl-tag">&lt;div</span> <span class="hl-attribute">afd:render</span>=<span class="hl-value">"MySnippet:outer"</span><span class="hl-tag">&gt;</span>
  <span class="hl-tag">&lt;afd:embed</span> <span class="hl-attribute">id</span>=<span class="hl-value">"inner"</span> <span class="hl-attribute">target</span>=<span class="hl-value">"child.html"</span><span class="hl-tag">&gt;</span><span class="hl-tag">&lt;/afd:embed&gt;</span>
<span class="hl-tag">&lt;/div&gt;</span>

        </pre>
        <pre class="programlisting">

<span class="hl-comment">&lt;!-- child template --&gt;</span>
  <span class="hl-tag">&lt;div</span> <span class="hl-attribute">afd:render</span>=<span class="hl-value">"MySnippet:embed"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;span</span> <span class="hl-attribute">id</span>=<span class="hl-value">"current-date"</span><span class="hl-tag">&gt;</span><span class="hl-tag">&lt;/span&gt;</span>
  <span class="hl-tag">&lt;/div&gt;</span>

        </pre>
        <pre class="programlisting">

<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> MySnippet{

    <span class="hl-keyword">public</span> Renderer outer(){
        <span class="hl-keyword">return</span> Renderer.create(<span class="hl-string">"#innder"</span>, <span class="hl-string">"now"</span>, <span class="hl-keyword">new</span> Date());
    }
    
    <span class="hl-keyword">public</span> Renderer embed(Date now){
        <span class="hl-keyword">return</span> Renderer.create(<span class="hl-string">"#current-date"</span>, now);
    }
}

        </pre>
      </div></div><br class="example-break">
      
    </div>
    <div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="d5e1102"></a>11.1.5.&nbsp;Clear an Element</h3></div></div></div>
      
      <p>On all the rendering methods, if the specified value is null, the target element will be removed. And there is also
      an enumeration value of SpecialRenderer.Clear which can be used to declare a remove operation for an element too.</p>
      <div class="example"><a name="d5e1105"></a><p class="title"><b>Example&nbsp;11.9.&nbsp;</b></p><div class="example-contents">
        <pre class="programlisting">

<span class="hl-comment">//if the String value is null, the target element will be removed</span>
String txt = null;
Renderer.create(<span class="hl-string">"#someId"</span>, txt);

        </pre>
        <pre class="programlisting">

<span class="hl-keyword">import</span> <span class="hl-keyword">static</span> com.astamuse.asta4d.render.SpecialRenderer.Clear

Renderer.create(<span class="hl-string">"#someId"</span>, Clear);

        </pre>
      </div></div><br class="example-break">
      <p class="remark"><em><span class="remark">Note that on the attribute rendering methods, if null value or SpecialRenderer.Clear are specified, as we mentioned in
      the previous section, the target attribute will be removed and the target element will remain.</span></em></p>
    </div>
    <div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="d5e1109"></a>11.1.6.&nbsp;Render raw Element</h3></div></div></div>
      
      <p>An existing DOM element can be replaced by a new element by specifying the new element as the rendering value. The new element
      can be generated by DOM APIs or simply parsed from raw html source.</p>
      <div class="example"><a name="d5e1112"></a><p class="title"><b>Example&nbsp;11.10.&nbsp;</b></p><div class="example-contents">
        <pre class="programlisting">


Renderer renderer = Renderer.create();

Element ul = <span class="hl-keyword">new</span> Element(Tag.valueOf(<span class="hl-string">"ul"</span>), <span class="hl-string">""</span>);
List&lt;Node&gt; lis = <span class="hl-keyword">new</span> ArrayList&lt;&gt;();
ul.appendChild(<span class="hl-keyword">new</span> Element(Tag.valueOf(<span class="hl-string">"li"</span>), <span class="hl-string">""</span>).appendText(<span class="hl-string">"This text is created by snippet.(1)"</span>));
ul.appendChild(<span class="hl-keyword">new</span> Element(Tag.valueOf(<span class="hl-string">"li"</span>), <span class="hl-string">""</span>).appendText(<span class="hl-string">"This text is created by snippet.(2)"</span>));
ul.appendChild(<span class="hl-keyword">new</span> Element(Tag.valueOf(<span class="hl-string">"li"</span>), <span class="hl-string">""</span>).appendText(<span class="hl-string">"This text is created by snippet.(3)"</span>));

renderer.add(<span class="hl-string">"#someId"</span>, ul);

String html = <span class="hl-string">"&lt;a href=\"https://github.com/astamuse/asta4d\"&gt;asta4d hp&lt;/a&gt;"</span>;
renderer.add(<span class="hl-string">"#hp-link"</span>, ElementUtil.parseAsSingle(html));


        </pre>
      </div></div><br class="example-break">
      
      <p>There are several utility methods in ElementUtil that can help you operate DOM easier.</p>
      <p class="remark"><em><span class="remark">ElementUtil#parseAsSingle would cause potential cross-site issues, so take care of it and make sure that you have escaped
      all the raw html source correctly. Since Asta4D has provided plenty of rendering methods, you should try your best to avoid
      create element from raw html source. If you have to do something on raw element level, your first option should be DOM APIs
      and parsing raw html source should be your last alternative.</span></em></p>
    </div>
    <div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="d5e1116"></a>11.1.7.&nbsp;Arbitrary rendering for an Element</h3></div></div></div>
      
      <p>Sometimes you will want to access the rendering target on raw element level and Asta4D allow you access the rendering
      target element by the interface of ElementSetter. ElementSetter asks the implementation of a callback method "set(Element elem)".
      As a matter of fact, the text rendering and attribute rendering are achieved by built-in implementation of ElementSetter(TextSetter
      and AttributeSetter).There is also another built-in ElementSetter implementation called ChildReplacer which can replace the children of rendering target
      by given element.</p>
      
      <div class="example"><a name="d5e1119"></a><p class="title"><b>Example&nbsp;11.11.&nbsp;source of ChildReplacer</b></p><div class="example-contents">
        <pre class="programlisting">


<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> ChildReplacer <span class="hl-keyword">implements</span> ElementSetter {

    <span class="hl-keyword">private</span> Element newChild;

    <strong class="hl-tag" style="color: blue">/**
     * Constructor
     * 
     * @param newChild
     *            the new child node
     */</strong>
    <span class="hl-keyword">public</span> ChildReplacer(Element newChild) {
        <span class="hl-keyword">this</span>.newChild = newChild;
    }

    <em><span class="hl-annotation" style="color: gray">@Override</span></em>
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> set(Element elem) {
        elem.empty();
        elem.appendChild(newChild);
    }
}

        </pre>
      </div></div><br class="example-break">
      <p>You can regard the built-in TextSetter, AttributeSetter and ChildReplacer as
      reference implementation in case of you need implement your own ElementSetter. Following example shows how to use ChildReplacer
      or declare an anonymous class for ElementSetter on rendering.</p>
      
      <div class="example"><a name="d5e1123"></a><p class="title"><b>Example&nbsp;11.12.&nbsp;</b></p><div class="example-contents">
        <pre class="programlisting">


Renderer renderer = Renderer.create();

renderer.add(<span class="hl-string">"#someId"</span>, <span class="hl-keyword">new</span> ChildReplacer(ElementUtil.parseAsSingle(<span class="hl-string">"&lt;div&gt;aaa&lt;/div&gt;"</span>)));

renderer.add(<span class="hl-string">"#someNode"</span>, <span class="hl-keyword">new</span> ElementSetter(){
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> set(Element elem) {
        <span class="hl-keyword">if</span>(elem.tagName().equals(<span class="hl-string">"div"</span>)){
            elem.addClass(<span class="hl-string">"someClass);
</span>        }
    }
});


        </pre>
      </div></div><br class="example-break">

      <p class="remark"><em><span class="remark">On element level, you can also parse element by Element#html(String html) method which will also cause potential
      cross-site issues. As same as the raw element rendering, parsing raw html source should be your last alternative.</span></em></p>
    </div>
    <div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="d5e1126"></a>11.1.8.&nbsp;Recursive rendering</h3></div></div></div>
      
      <p>For a snippet method, the returned Renderer will be applied to the target element which declares the current snippet method.
      In the returned Renderer chain, you can also specify recursive Renderer which is only applied to the element specified by given
      CSS selector.</p>
      <div class="example"><a name="d5e1129"></a><p class="title"><b>Example&nbsp;11.13.&nbsp;</b></p><div class="example-contents">
        <pre class="programlisting">

Renderer.create(<span class="hl-string">"#someId"</span>, Renderer.create(<span class="hl-string">"a"</span>, <span class="hl-string">"href"</span>, <span class="hl-string">"https://github.com/astamuse/asta4d"</span>));

        </pre>
      </div></div><br class="example-break">
    </div>
    <div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="d5e1131"></a>11.1.9.&nbsp;Debug renderer</h3></div></div></div>
      
      <p>Because the Renderer is applied after your snippet method finished, it is difficult to debug if there is something wrong. Asta4D
      affords rendering debug function too. There are two overloaded debug method, one accepts a log message only and another accepts a log
      message and a selector. The debug renderer will output the current status of rendering target element to log file, if the selector is
      not specified, the whole rendering target of current snippet method will be output, if the selector is specified, only the matched child
      elements will be output. Log level can be configured by "com.astamuse.asta4d.render.DebugRenderer".</p>
      <div class="example"><a name="d5e1134"></a><p class="title"><b>Example&nbsp;11.14.&nbsp;</b></p><div class="example-contents">
        <pre class="programlisting">


<span class="hl-comment">//the whole target rendering target will be output before and after</span>

renderer.addDebugger(<span class="hl-string">"before render value"</span>);

renderer.add(<span class="hl-string">"#someId"</span>, value);

renderer.addDebugger(<span class="hl-string">"after render value"</span>);


<span class="hl-comment">//only the a tag element will be output before and after</span>

renderer.addDebugger(<span class="hl-string">"before render value for link"</span>, <span class="hl-string">"a"</span>);

renderer.add(<span class="hl-string">"a"</span>, <span class="hl-string">"href"</span>, url);

renderer.addDebugger(<span class="hl-string">"after render value for link"</span>, <span class="hl-string">"a"</span>);


        </pre>
        <em><span class="remark">If you specified a selector on debugger but do not get any output, it usually means you specified wrong selector or the target
        element has been removed by previous rendering or outer snippet rendering.</span></em>
      </div></div><br class="example-break">
    </div>
    <div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="d5e1137"></a>11.1.10.&nbsp;Missing selector warning</h3></div></div></div>
      
      <p>If your specified selector on rendering method cannot match any element, Asta4D will output a warning message to log as <em><span class="remark">"There is no element 
      found for selector [#someId] at [ com.astamuse.asta4d.test.render.RenderingTest$TestRender.classAttrSetting(RenderingTest.java:73) ], if it is 
      deserved, try Renderer#disableMissingSelectorWarning() to disable this message and Renderer#enableMissingSelectorWarning could enable this 
      warning again in your renderer chain"</span></em>.</p>
      <p>Note that the place where the missing selector declared is output to log too, which is disabled by default since it is expensive on production
      environment. You can enable the source row number output by Configuration#setSaveCallstackInfoOnRendererCreation.</p>
      <p>Sometimes, the missing selector may be designed by your logic, you can disable the warning message on your rendering chain temporarily as
      following:</p>
      <div class="example"><a name="d5e1143"></a><p class="title"><b>Example&nbsp;11.15.&nbsp;</b></p><div class="example-contents">
        <pre class="programlisting">


renderer.disableMissingSelectorWarning();

renderer.add(<span class="hl-string">"#notExistsId"</span>, <span class="hl-string">"abc"</span>);

renderer.enableMissingSelectorWarning();

        </pre>
      </div></div><br class="example-break">
    </div>
    <div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="d5e1145"></a>11.1.11.&nbsp;List rendering</h3></div></div></div>
      
      <p>Asta4D does not only allow you to rendering single value to an element, but also allow you to duplicate elements by list data, which is
      usually used to perform list rendering. java.lang.Iterable of String/Integer/Long/Boolean can be rendered directly as text rendering:</p>
      
      <div class="example"><a name="d5e1148"></a><p class="title"><b>Example&nbsp;11.16.&nbsp;</b></p><div class="example-contents">
        <pre class="programlisting">


Renderer renderer = Renderer.create();

renderer.add(<span class="hl-string">"#strList"</span>, Arrays.asList(<span class="hl-string">"a"</span>, <span class="hl-string">"b"</span>, <span class="hl-string">"c"</span>));

renderer.add(<span class="hl-string">"#intList"</span>, Arrays.asList(<span class="hl-number">1</span>, <span class="hl-number">2</span>, <span class="hl-number">3</span>));

renderer.add(<span class="hl-string">"#longList"</span>, Arrays.asList(<span class="hl-number">1L</span>, <span class="hl-number">2L</span>, <span class="hl-number">3L</span>));

renderer.add(<span class="hl-string">"#boolList"</span>, Arrays.asList(true, false, true));


        </pre>
      </div></div><br class="example-break">
      <p>On list rendering, the matched element will be duplicated times as the size of the list and the value will be rendered to each duplicated element. You
      can also perform complex rendering for arbitrary list data by RowConvertor:</p>
      
      <div class="example"><a name="d5e1151"></a><p class="title"><b>Example&nbsp;11.17.&nbsp;</b></p><div class="example-contents">
        <pre class="programlisting">


render.add(<span class="hl-string">"#someIdForRenderer"</span>, Arrays.asList(<span class="hl-number">123</span>, <span class="hl-number">456</span>, <span class="hl-number">789</span>), <span class="hl-keyword">new</span> RowConvertor&lt;Integer, Renderer&gt;() {
    <em><span class="hl-annotation" style="color: gray">@Override</span></em>
    <span class="hl-keyword">public</span> Renderer convert(<span class="hl-keyword">int</span> rowIndex, Integer obj) {
        <span class="hl-keyword">return</span> Renderer.create(<span class="hl-string">"#id"</span>, <span class="hl-string">"id-"</span> + obj).add(<span class="hl-string">"#otherId"</span>, <span class="hl-string">"otherId-"</span> + obj);
    }
});


        </pre>
      </div></div><br class="example-break">
      <p>Since we will return Renderer in most cases, the RowConvertor can be replaced by RowRenderer which can omit the type
      declaration of Renderer:</p>
      <div class="example"><a name="d5e1154"></a><p class="title"><b>Example&nbsp;11.18.&nbsp;</b></p><div class="example-contents">
        <pre class="programlisting">


render.add(<span class="hl-string">"#someIdForRenderer"</span>, Arrays.asList(<span class="hl-number">123</span>, <span class="hl-number">456</span>, <span class="hl-number">789</span>), <span class="hl-keyword">new</span> RowRenderer&lt;Integer&gt;() {
    <em><span class="hl-annotation" style="color: gray">@Override</span></em>
    <span class="hl-keyword">public</span> Renderer convert(<span class="hl-keyword">int</span> rowIndex, Integer obj) {
        <span class="hl-keyword">return</span> Renderer.create(<span class="hl-string">"#id"</span>, <span class="hl-string">"id-"</span> + obj).add(<span class="hl-string">"#otherId"</span>, <span class="hl-string">"otherId-"</span> + obj);
    }
});


        </pre>
      </div></div><br class="example-break">
      <p>The returned Renderer by RowConvertor/RowRenderer will be applied to each duplicated element by the given list data.</p>
      
      <p>On list rendering, the rendering method accepts java.lang.Iterable rather than java.util.List, which afford more flexibilities to
      developers. Note that if the given iterable is empty, the target element will be duplicated 0 times, which means the target element
      will be removed.</p>
      
      <p>Asta4D also afford parallel list rendering for you, simply use ParallelRowConvertor/ParallelRowRenderer instead of
      RowConvertor/RowRenderer:</p>
      
      <div class="example"><a name="d5e1159"></a><p class="title"><b>Example&nbsp;11.19.&nbsp;</b></p><div class="example-contents">
        <pre class="programlisting">


render.add(<span class="hl-string">"#someIdForRenderer"</span>, Arrays.asList(<span class="hl-number">123</span>, <span class="hl-number">456</span>, <span class="hl-number">789</span>), <span class="hl-keyword">new</span> ParallelRowRenderer&lt;Integer&gt;() {
    <em><span class="hl-annotation" style="color: gray">@Override</span></em>
    <span class="hl-keyword">public</span> Renderer convert(<span class="hl-keyword">int</span> rowIndex, Integer obj) {
        <span class="hl-keyword">return</span> Renderer.create(<span class="hl-string">"#id"</span>, <span class="hl-string">"id-"</span> + obj).add(<span class="hl-string">"#otherId"</span>, <span class="hl-string">"otherId-"</span> + obj);
    }
});


        </pre>
      </div></div><br class="example-break">
      
      <p>The parallel list rendering ability is provided by an utility class called ListConvertUtil which basically provides various
      transform methods for list data conversion like the map function in Scala/Java8. <em><span class="remark">For Java8, lambda and stream api support will
      be added in future.</span></em></p>
      
      <p>The ListConvertUtil uses a thread pool to perform parallel transforming, the size of pool can be configured by
      Configuration#listExecutorFactory#setPoolSize. There is also an import configuration of ParallelRecursivePolicy. When perform the parallel
      list transforming recursively, thread dead lock would potentially occur, so you have to choose a policy to handle this case:</p>
      
      <div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
          <p>EXCEPTION</p>
          <p>When recursive parallel list transforming is identified, throw an RuntimeException.</p>
        </li><li class="listitem">
          <p>CURRENT_THREAD</p>
          <p>When recursive parallel list transforming is identified, the child transforming will be performed in the same thread of
          parent transforming without picking up an usable thread from pool.</p>
        </li><li class="listitem">
          <p>NEW_THREAD</p>
          <p>When recursive parallel list transforming is identified, the child transforming will be performed in a newly generated
          thread out of the configured thread pool, the generated thread will be finished immediately after the child transforming
          finished.</p>
        </li></ul></div>
      
      <p>We recommend EXCEPTION or CURRENT_THREAD and the default is EXCEPTION.</p>
      
    </div>
  </div>
  
  <div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d5e1175"></a>11.2.&nbsp;Other things about snippet and rendering</h2></div></div></div><div class="toc"><p><b>Table of Contents</b></p><dl class="toc"><dt><span class="sect2"><a href="#d5e1177">11.2.1. Nested snippet</a></span></dt><dt><span class="sect2"><a href="#d5e1185">11.2.2. InitializableSnippet</a></span></dt><dt><span class="sect2"><a href="#d5e1191">11.2.3. Component rendering</a></span></dt><dt><span class="sect2"><a href="#d5e1205">11.2.4. SnippetInterceptor</a></span></dt><dt><span class="sect2"><a href="#d5e1207">11.2.5. SnippetExtractor</a></span></dt><dt><span class="sect2"><a href="#d5e1209">11.2.6. SnippetResolver</a></span></dt><dt><span class="sect2"><a href="#d5e1211">11.2.7. SnippetInvoker</a></span></dt></dl></div>
    
    <div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="d5e1177"></a>11.2.1.&nbsp;Nested snippet</h3></div></div></div>
      
      <p>Snippet can be declared recursively.There is a convention that the outer snippet will always be executed on a prior order.</p>
      <div class="example"><a name="d5e1180"></a><p class="title"><b>Example&nbsp;11.20.&nbsp;</b></p><div class="example-contents">
      <pre class="programlisting">

<span class="hl-tag">&lt;div</span> <span class="hl-attribute">afd:render</span>=<span class="hl-value">"OuterSnippet"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;div</span> <span class="hl-attribute">id</span>=<span class="hl-value">"inner"</span> <span class="hl-attribute">afd:render</span>=<span class="hl-value">"InnerSnippet"</span><span class="hl-tag">&gt;</span>  
        <span class="hl-tag">&lt;p</span> <span class="hl-attribute">id</span>=<span class="hl-value">"name"</span><span class="hl-tag">&gt;</span>name:<span class="hl-tag">&lt;span&gt;</span>dummy name<span class="hl-tag">&lt;/span&gt;</span><span class="hl-tag">&lt;/p&gt;</span>  
        <span class="hl-tag">&lt;p</span> <span class="hl-attribute">id</span>=<span class="hl-value">"age"</span><span class="hl-tag">&gt;</span>age:<span class="hl-tag">&lt;span&gt;</span>0<span class="hl-tag">&lt;/span&gt;</span><span class="hl-tag">&lt;/p&gt;</span>  
    <span class="hl-tag">&lt;/div&gt;</span>
<span class="hl-tag">&lt;/div&gt;</span>

      </pre>
      </div></div><br class="example-break">
      <p>In the above example, the "InnerSnippet" will be executed after the "OuterSnippet" has been executed, which also means you can
      configure the inner snippet dynamically.</p>
      <div class="example"><a name="d5e1183"></a><p class="title"><b>Example&nbsp;11.21.&nbsp;</b></p><div class="example-contents">
      <pre class="programlisting">

<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> OuterSnippet{

    <span class="hl-keyword">public</span> Renderer render(){
        <span class="hl-keyword">return</span> Renderer.create(<span class="hl-string">"#inner"</span>, <span class="hl-string">"hasprofile"</span>, <span class="hl-string">"true"</span>);
    }

}

<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> InnerSnippet{

    <span class="hl-keyword">public</span> Renderer render(bool hasprofile){
        <span class="hl-keyword">if</span>(hasprofile){
            <span class="hl-keyword">return</span> Renderer.create(<span class="hl-string">"#name span"</span>, <span class="hl-string">"Bob"</span>).add(<span class="hl-string">"#age span"</span>, <span class="hl-number">27</span>);
        }<span class="hl-keyword">else</span>{
            <span class="hl-keyword">return</span> Renderer.create(<span class="hl-string">"*"</span>, Clear);
        }
    }

}

      </pre>
      </div></div><br class="example-break">
    </div>
    <div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="d5e1185"></a>11.2.2.&nbsp;InitializableSnippet</h3></div></div></div>
      
      <p>The snippet class instance is singleton in request scope and will be created at the first time a snippet is required. 
      After the snippet class instance has been created, field value injection will be applied to the created instance once(About
      detail of value injection, see the later chapter). After all the field has been injected, the framework will check whether
      the current class implements the "InitializableSnippet" interface, if true, the init method of InitializableSnippet will
      be invoked once.</p>
      <div class="example"><a name="d5e1188"></a><p class="title"><b>Example&nbsp;11.22.&nbsp;</b></p><div class="example-contents">
      <pre class="programlisting">

<span class="hl-keyword">public</span> <span class="hl-keyword">static</span> <span class="hl-keyword">class</span> InitSnippet <span class="hl-keyword">implements</span> InitializableSnippet {

    <em><span class="hl-annotation" style="color: gray">@ContextData</span></em>
    <span class="hl-keyword">private</span> String value;

    <span class="hl-keyword">private</span> String resolvedValue;

    <em><span class="hl-annotation" style="color: gray">@Override</span></em>
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> init() <span class="hl-keyword">throws</span> SnippetInvokeException {
        resolvedValue = value + <span class="hl-string">"-resolved"</span>;
    }
}

      </pre>
      </div></div><br class="example-break">
      <p>In the above example, the field "value" will be injected after the instance is created, then the init method will be
      applied to finish the complete initialization logic of the snippet class.</p>
    </div>
    <div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="d5e1191"></a>11.2.3.&nbsp;Component rendering</h3></div></div></div>
      
      <p>For the view first policy, we will treat the template files as first class things. The embed file mechanism allow you
      separate some view blocks as independent components at template file layer. There is also a snippet class level mechanism that
      afford you the same ability as embed file, which is called "Component".</p>
      <p>Why we need "Component"? The embed file can only be include statically, but the "Component" is an extendible Java class
      which can be configured by arbitrary Java code and polymorphism can be easily performed too. Basically, The "Component" mechanism
      can help developer to build independent view component easier than static embed file.</p>

      <p>The constructor of Component accepts a string value as an embed file path or an instance of Element, and also an
      optional AttributesRequire can be specified to provide some initialization parameters as same as the parametrized embedding
      introduced in the previous section.</p>
      <div class="example"><a name="d5e1196"></a><p class="title"><b>Example&nbsp;11.23.&nbsp;constructors of Component</b></p><div class="example-contents">
      <pre class="programlisting">

    <span class="hl-keyword">public</span> Component(Element elem, AttributesRequire attrs) <span class="hl-keyword">throws</span> Exception {
        ...
    }

    <span class="hl-keyword">public</span> Component(Element elem) <span class="hl-keyword">throws</span> Exception {
        ...
    }

    <span class="hl-keyword">public</span> Component(String path, AttributesRequire attrs) <span class="hl-keyword">throws</span> Exception {
        ...
    }

    <span class="hl-keyword">public</span> Component(String path) <span class="hl-keyword">throws</span> Exception {
        ...
    }

      </pre>
      </div></div><br class="example-break">
      
      <div class="example"><a name="d5e1199"></a><p class="title"><b>Example&nbsp;11.24.&nbsp;render a component</b></p><div class="example-contents">
      <pre class="programlisting">

<span class="hl-keyword">public</span> Renderer render(<span class="hl-keyword">final</span> String ctype) <span class="hl-keyword">throws</span> Exception {
    <span class="hl-keyword">return</span> Renderer.create(<span class="hl-string">"span"</span>, <span class="hl-keyword">new</span> Component(<span class="hl-string">"/ComponentRenderingTest_component.html"</span>, <span class="hl-keyword">new</span> AttributesRequire() {
        <em><span class="hl-annotation" style="color: gray">@Override</span></em>
        <span class="hl-keyword">protected</span> <span class="hl-keyword">void</span> prepareAttributes() {
            <span class="hl-keyword">this</span>.add(<span class="hl-string">"value"</span>, ctype);
        }

    }));
}

      </pre>
      <p>In this example, the target element specified by the selector "span" will be completely replaced by the result of 
      Component#toElement().</p>
      </div></div><br class="example-break">
      
      <p>Commonly, we do not render a component as above example, we usually extend from Component and expose a constructor
      with business initialization parameters or supply a group of business initialization methods, by which we can build an
      independent view component simply.</p>
      
      <p>Further, Component also has a "toHtml" method which will return the html source of the component rendering result.
      This method can be used by ajax request to acquire a dynamically rendered component.</p>
    </div>

    <div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="d5e1205"></a>11.2.4.&nbsp;SnippetInterceptor</h3></div></div></div>
      
    </div>
    <div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="d5e1207"></a>11.2.5.&nbsp;SnippetExtractor</h3></div></div></div>
      
    </div>
    <div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="d5e1209"></a>11.2.6.&nbsp;SnippetResolver</h3></div></div></div>
      
    </div>
    <div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="d5e1211"></a>11.2.7.&nbsp;SnippetInvoker</h3></div></div></div>
      
    </div>
  </div>
</div>
    <div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="chapter-detail-var-injection"></a>12.&nbsp;Variable injection</h2></div></div></div>
  
  
  <div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="vi-context"></a>12.1.&nbsp;Context</h2></div></div></div><div class="toc"><p><b>Table of Contents</b></p><dl class="toc"><dt><span class="sect2"><a href="#d5e1217">12.1.1. Context/WebApplicationContext</a></span></dt><dt><span class="sect2"><a href="#vi-scope">12.1.2. Scope</a></span></dt><dt><span class="sect2"><a href="#vi-ContextBindData">12.1.3. ContextBindData</a></span></dt></dl></div>
    
    <div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="d5e1217"></a>12.1.1.&nbsp;Context/WebApplicationContext</h3></div></div></div>
      
      <p>Asta4D use "Context" to manage data life cycle. The "Context" in asta4d-core supplies the basic data management mechanism
      and the WebApplicationContext from asta4d-web afford more powerful extending for web application development. Commonly, we will
      only use WebApplicationContext in our application. There are two ways to retrieve an instance of WebApplicationContext.</p>
      <div class="example"><a name="d5e1220"></a><p class="title"><b>Example&nbsp;12.1.&nbsp;Retrieve an instance of WebApplicationContext by static method</b></p><div class="example-contents">
      <pre class="programlisting">

WebApplicationContext context = Context.getCurrentThreadContext();

      </pre>
      </div></div><br class="example-break">
      <div class="example"><a name="d5e1223"></a><p class="title"><b>Example&nbsp;12.2.&nbsp;Retrieve an instance of WebApplicationContext by injection</b></p><div class="example-contents">
      <pre class="programlisting">

<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> PageSnippet {

    <span class="hl-keyword">public</span> Renderer render(WebApplicationContext context) {
        ...
    }
}

      </pre>
      </div></div><br class="example-break">
      
      <p>As the name of "getCurrentThreadContext" suggested, the context is managed per thread, and also that the context will be
      initialized before every http request is processed and will be cleared after every http request process has finished.</p>
      
      <p>WebApplicationContext affords several methods to retrieving raw servlet apis and other helpful information:</p>
      <div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
          <p>getRequest</p>
          <p>Return the HttpServletRequest instance of current request.</p>
        </li><li class="listitem">
          <p>getResponse</p>
          <p>Return the HttpServletResponse instance of current request.</p>
        </li><li class="listitem">
          <p>getServletContext</p>
          <p>Return the ServletContext instance of current request.</p>
        </li><li class="listitem">
          <p>getAccessURI</p>
          <p>Return the rewritten url of current request. For details about URL rewritting, see later chapter.</p>
        </li></ul></div>
    </div>
    <div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="vi-scope"></a>12.1.2.&nbsp;Scope</h3></div></div></div>
      
      
      <p>The context provides a mechanism to manage data by scopes. There are only 3 scopes supplied by asta4d-core's
      Context, but the WebApplicationContext from asta4d-web supply more scopes to help web application development.</p>
      
      <div class="variablelist"><p class="title"><b>Available scopes(with the constant name):</b></p><dl class="variablelist"><dt><span class="term">global(SCOPE_GLOBAL)</span></dt><dd>
            <p>The data saved in global scope can be accessed cross all the contexts, you can treat it as a static object pool.
            </p>
          </dd><dt><span class="term">default(SCOPE_DEFAULT)</span></dt><dd>
            <p>The data saved in default scope can only be access by the current context.
            </p>
          </dd><dt><span class="term">element attribute(SCOPE_ATTR)</span></dt><dd>
            <p>This scope is related to snippet rendering. An element attribute scope is a wrapping of element attribute. When you
            try to retrieve data from element attribute scope, the attribute of current rendering target element will be checked and the
            corresponding attribute value will be returned, further, if there is no corresponding attribute in the current rendering target
            element's attributes, all the parents of current rendering target element will be checked recursively.
            </p>
          </dd><dt><span class="term">request(SCOPE_REQUEST)</span></dt><dd>
            <p>The data saved in default scope can only be access in the current http request process. Note that the request scope is
            simply delegated to the default scope and it is different from servlet api's http request attribute.
            </p>
          </dd><dt><span class="term">path var(SCOPE_PATHVAR)</span></dt><dd>
            <p>Path var scope represents the variables declared in url rules.
            </p>
          </dd><dt><span class="term">query parameter(SCOPE_QUERYPARAM)</span></dt><dd>
            <p>Query parameter scope represents the query parameters specified at the part after question mark in an url.</p>
          </dd><dt><span class="term">session(SCOPE_SESSION)</span></dt><dd>
            <p>Session scope represents the data saved in http session.</p>
          </dd><dt><span class="term">header(SCOPE_HEADER)</span></dt><dd>
            <p>Session scope represents the header data from a http request.</p>
          </dd><dt><span class="term">cookie(SCOPE_COOKIE)</span></dt><dd>
            <p>Cookie scope represents the cookie data from a http request.</p>
          </dd><dt><span class="term">flash(SCOPE_FLASH)</span></dt><dd>
            <p>Asta4D affords a mechanism to allow pass data to the redirected http request, which is called flash data.</p>
          </dd></dl></div>

      <p>Normally, the data saved in context can be accessed by variable injection. If you need get data manually, you can do it as
      following:</p>      
      <div class="example"><a name="d5e1287"></a><p class="title"><b>Example&nbsp;12.3.&nbsp;Retrieve data from context</b></p><div class="example-contents">
      <pre class="programlisting">

WebApplicationContext context = Context.getCurrentThreadContext();

<span class="hl-comment">//from default scope</span>
Integer count = context.get(<span class="hl-string">"saved-count"</span>);

<span class="hl-comment">//from session</span>
Integer sessionCount = context.get(WebApplicationContext.SCOPE_SESSION, <span class="hl-string">"saved-count"</span>);

      </pre>
      </div></div><br class="example-break">

      <p>You can implement your own customized scope or afford you customized implementation for existing scopes. You need extend from
      WebApplicationContext then override the method called "createMapForScope".<em><span class="remark">(If you only want to split your data from default scope, you
      can simply specify a new scope name and a new scope will be created automatically, the created scope's life cycle is as the same as
      default scope)</span></em>
      </p>
      
      <div class="example"><a name="d5e1292"></a><p class="title"><b>Example&nbsp;12.4.&nbsp;Customized memcached drived session management</b></p><div class="example-contents">
      <pre class="programlisting">

<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> MyContext <span class="hl-keyword">extends</span> WebApplicationContext {
    <em><span class="hl-annotation" style="color: gray">@Override</span></em>
    <span class="hl-keyword">protected</span> ContextMap createMapForScope(String scope) {
        ContextMap map = null;
        <span class="hl-keyword">switch</span> (scope) {
        <span class="hl-keyword">case</span> SCOPE_SESSION: {
            HttpServletRequest request = getRequest();
            map = <span class="hl-keyword">new</span> MemcachedSessionMap(request);
        <span class="hl-keyword">default</span>:
            map = <span class="hl-keyword">super</span>.createMapForScope(scope);
        }
        <span class="hl-keyword">return</span> map;
    }
}

      </pre>
      </div></div><br class="example-break">
      <p>See later chapter of Asta4dServerlet for how to configure Asta4D to use the customized Context implementation instead of the
      default WebApplicationContext.</p>
    </div>
    
    <div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="vi-ContextBindData"></a>12.1.3.&nbsp;ContextBindData</h3></div></div></div>
      
      <p>Since all the data query logic are performed at snippet class, we will want to avoid duplicated query on same page
      rendering. The recommended solution is caching your query result by cache library such as ehcache. But Asta4D also affords
      you an alternative solution for some simple cases, which is called ContextBindData.</p>
      
      <p>ContextBindData can be treated as a lazy load instance field for Java class. It is warranted that a ContextBindData
      will be initialized only once in a same Asta4D context and it will only be initialized when you first call it. There are 
      some exceptions for the warranty about initializing only once, we will explain them later.</p>
      
      <div class="example"><a name="d5e1300"></a><p class="title"><b>Example&nbsp;12.5.&nbsp;</b></p><div class="example-contents">
      <pre class="programlisting">

<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> PageSnippet {
    
    <em><span class="hl-annotation" style="color: gray">@ContextData</span></em>
    <span class="hl-keyword">private</span> <span class="hl-keyword">int</span> count;

    <span class="hl-keyword">private</span> ContextBindData&lt;Integer&gt; data = <span class="hl-keyword">new</span> ContextBindData&lt;Integer&gt;(true) {
        <em><span class="hl-annotation" style="color: gray">@Override</span></em>
        <span class="hl-keyword">protected</span> Integer buildData() {
            <span class="hl-keyword">return</span> count + <span class="hl-number">1</span>;
        }

    };

    <span class="hl-keyword">public</span> Renderer render() {
        <span class="hl-keyword">return</span> Renderer.create(<span class="hl-string">"*"</span>, data.get());
    }
}

      </pre>
      </div></div><br class="example-break">
      
      <p>You should have noticed that we pass a "true" to the constructor of ContextBindData, which means we require the warranty
      that it should be only initialize once in the current context. If we pass nothing or pass a "false" to the constructor, the buildData
      method may be invoked multiple times in multi-thread rendering, but which is faster than warranted initialization simply because
      of skipping the multi-thread lock process.</p>
      
      <p>Again, we recommend to use cache library to avoid duplicated query, but you can use ContextBindData as a simple, light weight
      alternative. See detail of <a class="xref" href="#best-snippet-way" title="9.3.&nbsp;The best way of implementing a snippet">Section&nbsp;9.3, &#8220;The best way of implementing a snippet&#8221;</a>.</p>
      
    </div>
  </div>
  
  <div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="vi-injection"></a>12.2.&nbsp;Injection</h2></div></div></div><div class="toc"><p><b>Table of Contents</b></p><dl class="toc"><dt><span class="sect2"><a href="#vi-contextdata">12.2.1. @ContextData</a></span></dt><dt><span class="sect2"><a href="#vi-contextdataset">12.2.2. @ContextDataSet</a></span></dt><dt><span class="sect2"><a href="#vi-ContextDataFinder">12.2.3. ContextDataFinder</a></span></dt><dt><span class="sect2"><a href="#d5e1396">12.2.4. DataConvertor</a></span></dt><dt><span class="sect2"><a href="#d5e1398">12.2.5. ContextDataHolder</a></span></dt></dl></div>
    
    <div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="vi-contextdata"></a>12.2.1.&nbsp;@ContextData</h3></div></div></div>
      
      <p>All fields annotated by @ContextData in a snippet class will be initialized/injected automatically when the snippet class instance is initialized.
      Further, even the method parameters of snippet rendering method and request handle method are automatically injected, you can still customize the injection
      by extra @ContextData annotation.</p>
      
      <p>Note that there are something different between field injection and method parameter injection. The fields of snippet class without @ContextData will 
      not be injected, but method parameters will be always injected even without @ContextData.</p>
      
      <div class="variablelist"><p class="title"><b>Available configurations of @ContextData:</b></p><dl class="variablelist"><dt><span class="term">name</span></dt><dd>
            <p>The name of saved data in context. If it is not specified, the field name or parameter name will be used(This requires that you reverse the parameter names
            when compile).
            </p>
          </dd><dt><span class="term">scope</span></dt><dd>
            <p>The scope of saved data in context. If it is no specified, Asta4D will try to search the data in all the scopes by a predefined order:</p>
              <div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">
                  <p>element attribute(SCOPE_ATTR)</p>
                </li><li class="listitem">
                  <p>path var(SCOPE_PATHVAR)</p>
                </li><li class="listitem">
                  <p>query parameter(SCOPE_QUERYPARAM)</p>
                </li><li class="listitem">
                  <p>flash(SCOPE_FLASH)</p>
                </li><li class="listitem">
                  <p>cookie(SCOPE_COOKIE)</p>
                </li><li class="listitem">
                  <p>hearder(SCOPE_HEADER)</p>
                </li><li class="listitem">
                  <p>request/default(SCOPE_REQUEST/SCOPE_DEFAULT)</p>
                </li><li class="listitem">
                  <p>session(SCOPE_SESSION)</p>
                </li><li class="listitem">
                  <p>global(SCOPE_GLOBAL)</p>
                </li></ol></div>
              <p>This order can be configured via WebApplicationContextDataFinder#setDataSearchScopeOrder.See details at <a class="xref" href="#vi-ContextDataFinder" title="12.2.3.&nbsp;ContextDataFinder">Section&nbsp;12.2.3, &#8220;ContextDataFinder&#8221;</a></p>
          </dd><dt><span class="term">typeUnMatch</span></dt><dd>
            <p>The policy of how to handle the unmatched type on data conversion. The default action is throw Exception and another two value of "DEFAULT_VALUE" and "DEFAULT_VALUE_AND_TRACE"
            can be specified.
            </p>
          </dd></dl></div>
      
      <p>There are several scope specified annotations can be used as convenience.</p>
      
      <div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
          <p>@SessionData</p>
        </li><li class="listitem">
          <p>@QueryParam</p>
        </li><li class="listitem">
          <p>@PathVar</p>
        </li><li class="listitem">
          <p>@HeaderData</p>
        </li><li class="listitem">
          <p>@CookieData</p>
        </li><li class="listitem">
          <p>@FlashData</p>
        </li></ul></div>
      
      <p class="remark"><em><span class="remark">All the above annotation have the same configurable items with the original @ContextData annotation except being fixed with according data scope.</span></em></p>

    </div>
    <div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="vi-contextdataset"></a>12.2.2.&nbsp;@ContextDataSet</h3></div></div></div>
      
      <p>A pojo class annotated by @ContextDataSet will be treated as a variable holder. If the type of a snippet class field or a method parameter is a class annotated by
      @ContextDataSet, when Asta4D do injection, a new instance will be created at first, then all the fields of current instance will be scanned and all the fields annotated by
      @ContextData will be injected as same as the snippet class field injection. @ContextDataSet can be used to allocate all of the form data into one single instance as a
      convenience.</p>
      <div class="example"><a name="d5e1364"></a><p class="title"><b>Example&nbsp;12.6.&nbsp;</b></p><div class="example-contents">
      <pre class="programlisting">

<em><span class="hl-annotation" style="color: gray">@ContextDataSet</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">static</span> <span class="hl-keyword">class</span> MySet {

    <em><span class="hl-annotation" style="color: gray">@ContextData</span></em>
    <span class="hl-keyword">private</span> <span class="hl-keyword">long</span> f1;

    <em><span class="hl-annotation" style="color: gray">@ContextData</span></em>
    <span class="hl-keyword">private</span> String f2;

    <span class="hl-keyword">public</span> <span class="hl-keyword">long</span> getF1() {
        <span class="hl-keyword">return</span> f1;
    }
    
    <span class="hl-keyword">public</span> String getF2() {
        <span class="hl-keyword">return</span> f2;
    }
}

<span class="hl-keyword">public</span> <span class="hl-keyword">static</span> <span class="hl-keyword">class</span> MySnippet {

    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> render(MySet holder) {
    }

}

<span class="hl-keyword">public</span> <span class="hl-keyword">static</span> <span class="hl-keyword">class</span> MySnippet2 {

    <em><span class="hl-annotation" style="color: gray">@ContextData</span></em>
    <span class="hl-keyword">private</span> MySet holder;

    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> render() {
    }

}




      </pre>
      <p>Note that even you declared @ContextDataSet on the class, you still need to declare the @ContextData on the field declaration. For method parameter, it is not necessary
      since all the parameters are injected automatically. Further, for a declared @ContextDataSet, you still need to declare @ContextData on every field you want to be injected.</p>
      </div></div><br class="example-break">
      
      <div class="variablelist"><p class="title"><b>Available configurations of @ContextData:</b></p><dl class="variablelist"><dt><span class="term">singletonInContext</span></dt><dd>
            <p>A boolean value to indicate that whether the target ContextDataSet should be singleton in a single context life cycle. The default value is false, which means a new instance
            would be created at every time when a ConextDataSet is required to inject.
            </p>
          </dd><dt><span class="term">factory</span></dt><dd>
            <p>A factory class can be used to indicate how to create an instance of ContextDataSet. The default factory will call Class#newInstance() to create a new instance of ContextDataSet.
            </p>
          </dd></dl></div>
      
    </div>
    <div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="vi-ContextDataFinder"></a>12.2.3.&nbsp;ContextDataFinder</h3></div></div></div>
      
      <p>Asta4D search data in context by pre configured ContextDataFinder implementation. The default implementation is WebApplicationContextDataFinder. You can supply your own
      search mechanism by implementing the ContextDataFinder interface or extending from WebApplicationContextDataFinder. WebApplicationContextDataFinder defines the scope search
      order if scope is not specified, and also returns some special data by hard coding type check:</p>
      
      <div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
          <p>Context/WebApplicationContext</p>
        </li><li class="listitem">
          <p>ResourceBundleHelper</p>
        </li><li class="listitem">
          <p>ParamMapResourceBundleHelper</p>
        </li><li class="listitem">
          <p>HttpServletRequest</p>
        </li><li class="listitem">
          <p>HttpServletResponse</p>
        </li><li class="listitem">
          <p>ServletContext</p>
        </li><li class="listitem">
          <p>UrlMappingRule</p>
        </li></ul></div>
      
      <p>The first 3 types are afforded by the parent class of WebApplicationContextDataFinder: DefaultContextDataFinder. To supply your own logic, you can override the 
      findDataInContext method and the WebApplicationContextDataFinder's source can be treated as reference implementation.</p>
      
    </div>
    <div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="d5e1396"></a>12.2.4.&nbsp;DataConvertor</h3></div></div></div>
      
    </div>
    <div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="d5e1398"></a>12.2.5.&nbsp;ContextDataHolder</h3></div></div></div>
      
    </div>
  </div>
</div>
    <div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="chapter-detail-url-rule"></a>13.&nbsp;URL rule</h2></div></div></div>
  
  
  <div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="rule-apis"></a>13.1.&nbsp;Rule apis</h2></div></div></div><div class="toc"><p><b>Table of Contents</b></p><dl class="toc"><dt><span class="sect2"><a href="#UrlMappingRuleInitializer">13.1.1. UrlMappingRuleInitializer</a></span></dt><dt><span class="sect2"><a href="#d5e1452">13.1.2. Handy rules</a></span></dt></dl></div>
    
    <div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="UrlMappingRuleInitializer"></a>13.1.1.&nbsp;UrlMappingRuleInitializer</h3></div></div></div>
      
      <p>All the url mapping rules can be supplied by implementing the UrlMappingRuleInitializer interface which can be configured by 
      WebApplicationConfiguration#setUrlMappingRuleInitializer.</p>
      
      <p>UrlMappingRuleInitializer's initUrlMappingRules method does not return configured rules directly, it supply a UrlMappingRuleHelper
      instance by parameter instead. The UrlMappingRuleHelper afford a group of methods to help developers build url mapping rules.</p>
      
      <p>UrlMappingRuleHelper allows add new rule by add methods, which will be discussed in next section, let us see the global configuration
      methods of UrlMappingRuleHelper at first.</p>

      <div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
          <p>addDefaultRequestHandler(Object... handlerList)</p>
        </li><li class="listitem">
          <p>addDefaultRequestHandler(String attribute, Object... handlerList)</p>
          <br>
          <p>There are two overloaded methods of addDefaultRequestHandler. Added request handlers without attribute declaration will be applied 
          to all the rules and the ones with attribute declaration will be applied to therules with same attribute only.
          </p>
          <br>
        </li><li class="listitem">
          <p>addGlobalForward(Object result, String targetPath)</p>
        </li><li class="listitem">
          <p>addGlobalForward(Object result, String targetPath, int status) </p>
          <br>
          <p>There are two overloaded methods of addGlobalForward. The one with status parameter can customize the http response code with specified
          status code or the default code 200 will be returned to client.</p>
          <br>
        </li><li class="listitem">
          <p>addGlobalRedirect(Object result, String targetPath) </p>
          <br>
          <p>A global redirect result mapping can be declared. There is a convention about the format of target path(the normal redirect on special rules follows
          the same convention):</p>
          <div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem">
              <p>common url string("http://www.example.com/somepage.html")</p>
              <p>The target url will be redirected as temporary(code 302).</p>
            </li><li class="listitem">
              <p>common url string with prefix("301:http://www.example.com/somepage.html")</p>
              <p>The target url will be redirected as specified code by the prefix. 301 or 302 are acceptable and "p" or "t" can be used to represent "permanent"
              or "temporary" as well(which means "301:http://www.example.com/somepage.html" equals to "p:http://www.example.com/somepage.html").</p>
            </li></ul></div>
          <br>
        </li><li class="listitem">
          <p>addRequestHandlerInterceptor(Object... interceptorList)</p>
        </li><li class="listitem">
          <p>addRequestHandlerInterceptor(String attribute, Object... interceptorList)</p>
          <p><em><span class="remark">The request handler interceptor is need to be clarified more in the implementation. We skip the description at present.</span></em></p>
          <br>
        </li><li class="listitem">
          <p>registerRestTransformer(ResultTransformer transformer)</p>
        </li><li class="listitem">
          <p>registerJsonTransformer(ResultTransformer transformer)</p>
          <p>The returned value of a request handler which is declared as json at rule will be transformed to standard json string, and developers can still
                register a customized result transformer to generate the response by the own way. Further, even the framework will do nothing on the returned value
                of a handler if which is declared on a rest rule, developer can still use "registerRestTransformer" to add customized result transforming on a rule
                declared as rest.</p>
          <br>
        </li><li class="listitem">
          <p>setDefaultMethod(HttpMethod defaultMethod) </p>
          <p>The default matching http method for url patterns without http method specified. The default value is GET.</p>
        </li></ul></div>
    </div>
    <div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="d5e1452"></a>13.1.2.&nbsp;Handy rules</h3></div></div></div>
      
      <p>There several add methods from UrlMappingRuleHelper which can be used to add new url rules. According to the certain being called add method, different
      interface which is called handy rules will be returned for further declaration. Further, all the methods of the returned handy rule interface will return different
      interface according to the certain method you are calling, it is complex to describe which interface will be returned on certain case, basically we suppose that 
      the code auto completion function of you editor would help you to know what you can do in the next step.  All of these handy rules and their methods can be treated
      as a group of DSL to help you build your own url rules for your site. We will describe all the available methods at following regardless of which certain interface
      it belongs to. After that, we will also describe the basic rule of how the returned handy rules change.</p>
      
      <div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
          <p>add(String sourcePath)</p>
        </li><li class="listitem">
          <p>add(String sourcePath, String targetPath) </p>
        </li><li class="listitem">
          <p>add(HttpMethod method, String sourcePath) </p>
        </li><li class="listitem">
          <p>add(HttpMethod method, String sourcePath, String targetPath)</p>
          <br>
          <p>Add a new url rule. If the http method is not specified. the configured default method(see above setDefaultMethod) will be specified by default. If you
          want the sourcePath is matched to all the http methods, null can be specified. The targetPath should be a template file path or a redirect target url string
          with prefix "redirect:", the part after prefix "redirect:" follows the convention of redirect string format introduced in global redirect configuration.
          </p>
          <br>
        </li><li class="listitem">
          <p>id(String id)</p>
          <br>
          <p>One added rule can be identified by a unique id.
          </p>
          <br>
        </li><li class="listitem">
          <p>reMapTo(String ruleId)</p>
          <br>
          <p>Multi url patterns can be mapped to the same rule by reMapTo method. See following sample:
          </p>
          <div class="example"><a name="d5e1476"></a><p class="title"><b>Example&nbsp;13.1.&nbsp;Remap the rule to a existing rule</b></p><div class="example-contents">
          <pre class="programlisting">

    rules.add(<span class="hl-string">"/app/"</span>, <span class="hl-string">"/templates/index.html"</span>).id(<span class="hl-string">"index-page"</span>);
    
    rules.add(<span class="hl-string">"/app/index"</span>).reMapTo(<span class="hl-string">"index-page"</span>);
    
    rules.add(<span class="hl-string">"/app/handler"</span>).id(<span class="hl-string">"app-handler"</span>)
         .handler(LoginHandler.<span class="hl-keyword">class</span>)
         .handler(EchoHandler.<span class="hl-keyword">class</span>)
         .forward(LoginFailure.<span class="hl-keyword">class</span>, <span class="hl-string">"/templates/error.html"</span>)
         .forward(<span class="hl-string">"/templates/success.html"</span>);
    
    rules.add(<span class="hl-string">"/app/ex-handler"</span>).reMapTo(<span class="hl-string">"app-handler"</span>).attribute(<span class="hl-string">"ex-handler"</span>);
        

          </pre>
          <p>In above sample, "/app/index" will be treated as same as the rule identified as "index-page" which sourc path is "/app/". Aslo the "/app/ex-handler"
          will be configured as same as "/app/handler" with its special attribute configuration "ex-handler". Special path variable and priority can be configured to
          remapped rules as well.</p>
          </div></div><br class="example-break">
          <br>
        </li><li class="listitem">
          <p>attribute(String attribute)</p>
          <br>
          <p>Multi attributes can be configured to a rule. The attributes can be used by global rule configurations to add certain extra operations on certain urls
          which is attributed by certain attribute.
          </p>
          <br>
        </li><li class="listitem">
          <p>var(String key, Object value)</p>
          <br>
          <p>Static path variables can be configured by this method, that can be accessed by context's path var scope and also can be automatically injected to snippets
          or request handlers.
          </p>
          <br>
        </li><li class="listitem">
          <p>handler(Object... handlerList)</p>
          <br>
          <p>Request handlers can be configured by this methods. Multi request handlers are acceptable and the details about multi request handlers will be explained in
          later section.</p>
          <p>The parameter of handler method can be arbitrary type: an instance of java.lang.Class or an arbitrary instance.  The framework explains received parameters by
          the implementation of DeclareInstanceResolver configured by WebApplicationConfiguration. The default implementation provided by framework follows the following rules
          to explain the declaration of request handler:</p>
            <div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">
                <p>If an instance of java.lang.Class is specified, the instance of request handler will be created by invoke "newInstance()"
                on the specified Class.</p>
              </li><li class="listitem">
                <p>If a string is specified, the string will be treated as a class name and an instance of java.lang.Class will be created by 
                calling "Class#forName", then the instance of request handler will be created by invoke "newInstance()" on the created Class.</p>
              </li><li class="listitem">
                <p>The specified parameter will be treated as a request handler directly if it is neither a Class nor a string. By this rule,
                it is interesting that we can declare an anonymous class as a request handler:</p>
                <div class="example"><a name="d5e1503"></a><p class="title"><b>Example&nbsp;13.2.&nbsp;</b></p><div class="example-contents">
                  <pre class="programlisting">

rules.add(<span class="hl-string">"/app/handler"</span>)  
     .handler(<span class="hl-keyword">new</span> Object(){  
        <em><span class="hl-annotation" style="color: gray">@RequestHandler</span></em>  
        <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> handle(){  
            <span class="hl-comment">//  </span>
        }  
     }); 

                  </pre>
                </div></div><br class="example-break">
              </li></ol></div>
            <p class="remark"><em><span class="remark">The asta4d-spring package also provides a resolver based on Spring IOC container, the request handler instance will be retrieved by
            passing the specified parameter to the "Context#getBean" method of spring container. See details of integration of Spring IOC.</span></em></p>
          <br>
        </li><li class="listitem">
          <p>forward(String targetPath)</p>
        </li><li class="listitem">
          <p>forward(String targetPath, int status)</p>
        </li><li class="listitem">
          <p>forward(Object result, String targetPath)</p>
        </li><li class="listitem">
          <p>forward(Object result, String targetPath, int status)</p>
          <br>
          <p>The request will be forwarded to the target template file with specified status code. The result parameter will be used to match the result from 
          request handler(if there is any request handler configured for current rule).About result matching, see details in next section.
          </p>
          <br>
        </li><li class="listitem">
          <p>redirect(String targetPath)</p>
        </li><li class="listitem">
          <p>redirect(Object result, String targetPath)</p>
          <br>
          <p>As the same as forward, the request will be redirected(301/302) to the target path. The target path string follows the convention  of redirect string 
          format introduced in global redirect configuration.
          </p>
          <br>
        </li><li class="listitem">
          <p>json()</p>
          <br>
          <p>The result of request handler will be converted to a json string and be returned the client with MIME type "application/json".
          </p>
          <br>
        </li><li class="listitem">
          <p>rest()</p>
          <br>
          <p>This method does nothing for the current url by default, but declared as a hint that suggests the current rule will act as a restful api and will return customized
          response which would be head only response in many cases.
          </p>
          <br>
        </li></ul></div>
    </div>
  </div>
  
  <div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d5e1535"></a>13.2.&nbsp;Request handler result process</h2></div></div></div><div class="toc"><p><b>Table of Contents</b></p><dl class="toc"><dt><span class="sect2"><a href="#d5e1538">13.2.1. Content provider</a></span></dt><dt><span class="sect2"><a href="#d5e1540">13.2.2. Result transforming</a></span></dt><dt><span class="sect2"><a href="#d5e1542">13.2.3. Request handler chain</a></span></dt></dl></div>
    
    <p>This section will describe some internal mechanism of how asta4d handle the result from a request handler. Especially for the part of result transforming, which is not
    necessary for normal development but can help you understand how the request handler chain works.</p>
    <div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="d5e1538"></a>13.2.1.&nbsp;Content provider</h3></div></div></div>
      
    </div>
    <div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="d5e1540"></a>13.2.2.&nbsp;Result transforming</h3></div></div></div>
      
    </div>
    <div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="d5e1542"></a>13.2.3.&nbsp;Request handler chain</h3></div></div></div>
      
    </div>
  </div>

</div>
    <div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="chapter-detail-form-flow"></a>14.&nbsp;details of form flow</h2></div></div></div>
  
  <p class="remark"><em><span class="remark">To be written.</span></em></p>
</div>
    <div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="chapter-detail-i18n"></a>15.&nbsp;i18n</h2></div></div></div>
  
  
  <div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="i18n-message"></a>15.1.&nbsp;message stringization</h2></div></div></div><div class="toc"><p><b>Table of Contents</b></p><dl class="toc"><dt><span class="sect2"><a href="#i18n-I18nMessageHelper">15.1.1. I18nMessageHelper</a></span></dt><dt><span class="sect2"><a href="#i18n-MessagePatternRetriever">15.1.2. MessagePatternRetriever</a></span></dt><dt><span class="sect2"><a href="#i18n-default-locale-decision">15.1.3. Default locale</a></span></dt><dt><span class="sect2"><a href="#i18n-afd-msg">15.1.4. afd:msg</a></span></dt></dl></div>
    
    <p>Asta4D affords basic i18n support by a built-in I18nMessageHelper. I18nMessageHelper requires a MessagePatternRetriever implementation 
      to retrieve message by key. There is also a default implementation JDKResourceBundleMessagePatternRetriever which uses the JDK's built-in 
      resource bundle mechanism. 
    </p>
    <div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="i18n-I18nMessageHelper"></a>15.1.1.&nbsp;I18nMessageHelper</h3></div></div></div>
      
      <p>I18nMessageHelper is an abstract classes which affords the basic interface for handling messages:</p>
      <div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
            <p>getMessage(String key)</p>
            <br>
        </li><li class="listitem">
            <p>getMessage(Locale locale, String key);</p>
            <br>
        </li><li class="listitem">
            <p>getMessageWithDefault(String key, Object defaultPattern)</p>
            <p>return defaultPattern#toString() if message not found</p>
            <br>
        </li><li class="listitem">
            <p>getMessageWithDefault(Locale locale, String key, Object defaultPattern)</p>
            <p>return defaultPattern#toString() if message not found</p>
            <br>
        </li></ul></div>

      <p>There are also two extended classes from I18nMessageHelper, which afford more flexible message functionalities especially about formatting message by given parameters. 
            Configuration#setI18nMessageHelper can be used to customized which helper you want to use. The default is OrderedParamI18nMessageHelper.
            (<em><span class="remark">I18nMessageHelperTypeAssistant#getConfiguredMappedHelper and I18nMessageHelperTypeAssistant#getConfiguredOrderedHelper can be used to retrieve a type safe 
              configured helper.</span></em>)
      </p>

      <div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
            <p>MappedParamI18nMessageHelper</p>
            <p>Allow format message by a given parameter map, A MappedValueFormatter is required to supply concrete formatting style and the default is
                  ApacheStrSubstitutorFormatter which uses StrSubstitutor from Apache Common lang3.</p>
            <br>
        </li><li class="listitem">
            <p>OrderedParamI18nMessageHelper(default)</p>
            <p> Allow format message by a given parameter array. A OrderedValueFormatter is required to supply concrete formatting style and the default is 
                   JDKMessageFormatFormatter which uses JDK's MessageFormat to format message string.</p>
            <br>
        </li></ul></div>
      
      <p>There are several value formatter can be used by the above helpers. Notice that The MappedParamI18nMessageHelper requires implementation of MappedValueFormatter and the 
            OrderedParamI18nMessageHelper requires implementation of OrderedValueFormatter.
      </p>
      
      <div class="table"><a name="d5e1582"></a><p class="title"><b>Table&nbsp;15.1.&nbsp;Built-in value formatters</b></p><div class="table-contents">
      <table summary="Built-in value formatters" style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col align="left" class="c1"><col align="left" class="c2"><col align="left" class="c3"><col align="left" class="c4"></colgroup><thead><tr><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">formatter</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">interface</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">Description</th><th style="border-bottom: 0.5pt solid ; " align="left">Example</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">ApacheStrSubstitutorFormatter(default)</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">MappedValueFormatter</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">Use Apache Commons Lang's <a class="ulink" href="http://commons.apache.org/proper/commons-lang/javadocs/api-release/org/apache/commons/lang3/text/StrSubstitutor.html#replace(java.lang.CharSequence)" target="_top">
          StrSubstitutor#replace</a> to format messages. Use "{" and "}" to represent variables place holder.</td><td style="border-bottom: 0.5pt solid ; " align="left">"There are {count} items in the {item-name} list."</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">JDKMessageFormatFormatter(default)</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">OrderedValueFormatter</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">Use JDK's <a class="ulink" href="http://docs.oracle.com/javase/7/docs/api/java/text/MessageFormat.html#format(java.lang.String, java.lang.Object...)" target="_top">
          MessageFormat#format</a> to format messages.</td><td style="border-bottom: 0.5pt solid ; " align="left">"There are {1} items in the {2} list."</td></tr><tr><td style="border-right: 0.5pt solid ; " align="left">SymbolPlaceholderFormatter</td><td style="border-right: 0.5pt solid ; " align="left">OrderedValueFormatter</td><td style="border-right: 0.5pt solid ; " align="left">Use JDK's <a class="ulink" href="http://docs.oracle.com/javase/7/docs/api/java/lang/String.html#format(java.lang.String, java.lang.Object...)" target="_top">
          String#format</a> to format messages.</td><td style="" align="left">"There are %d items in the %s list."</td></tr></tbody></table>
      </div></div><br class="table-break">

    </div>
    <div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="i18n-MessagePatternRetriever"></a>15.1.2.&nbsp;MessagePatternRetriever</h3></div></div></div>
      
      <p>The I18nMessageHelper requires a MessagePatternRetriever implementation to retrieve message by key. There is a default implementation 
            JDKResourceBundleMessagePatternRetriever which uses the JDK's built-in resource bundle mechanism. The base name of resource bundle
            files can be specified by JDKResourceBundleMessagePatternRetriever#setResourceNames which accepts a list of base name. The configured resource bundles will be passed to JDK's
            <a class="ulink" href="http://docs.oracle.com/javase/7/docs/api/java/util/ResourceBundle.html#getBundle(java.lang.String, java.util.Locale, java.lang.ClassLoader)" target="_top">
            ResourceBundle#getBundle(String baseName, Locale locale, ClassLoader loader)</a> to retrieve messages.
      </p>

      <p>As the implementation of JDKResourceBundleMessagePatternRetriever, if the given locale is null, the default locale decision mechanism will be performed. 
            See <a class="xref" href="#i18n-default-locale-decision" title="15.1.3.&nbsp;Default locale">Section&nbsp;15.1.3, &#8220;Default locale&#8221;</a>.</p>

      <p>Further, the JDKResourceBundleMessagePatternRetriever accepts ResourceBundleFactory to allow customize how to retrieve a resource bundle. The default is        
            CharsetResourceBundleFactory which allows specify the encoding of message bundle files. Another built-in implementation is the LatinEscapingResourceBundleFactory,
            as the name suggests, the message files must be escaped by JDK's standard mechanism(via native2ascii).
      </p>
    </div>
    <div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="i18n-default-locale-decision"></a>15.1.3.&nbsp;Default locale</h3></div></div></div>
      
      <p>The default locale will be decided by the following order and stop at the first non-null returned value.</p>
      <div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">
            <p>Context.getCurrentThreadContext().getCurrentLocale()</p>
        </li><li class="listitem">
            <p>Locale.getDefault()</p>
        </li><li class="listitem">
            <p>Locale.ROOT</p>
        </li></ol></div>
      <p class="remark"><em><span class="remark">Since the Locale.getDefault() will return the local machine's locale by default, you may need to override the default locale to ROOT at the staring of 
              your web application.</span></em></p>
    </div>
    <div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="i18n-afd-msg"></a>15.1.4.&nbsp;afd:msg</h3></div></div></div>
      
      <p>"afd:msg" tag can be used to declare an i18n aware message in a template file. The basic usage is as following:</p>
      <pre class="programlisting">

<span class="hl-tag">&lt;section&gt;</span>
    <span class="hl-tag">&lt;article&gt;</span>
        <span class="hl-tag">&lt;div</span> <span class="hl-attribute">class</span>=<span class="hl-value">"panel panel-default"</span><span class="hl-tag">&gt;</span><span class="hl-tag">&lt;div</span> <span class="hl-attribute">class</span>=<span class="hl-value">"panel-body"</span><span class="hl-tag">&gt;</span>
            <span class="hl-comment">&lt;!-- the inner html will be treated as default message if the key is not found in message bundle --&gt;</span>
            <span class="hl-tag">&lt;afd:msg</span> <span class="hl-attribute">id</span>=<span class="hl-value">"notexistingkey"</span> <span class="hl-attribute">key</span>=<span class="hl-value">"sample.notexistingkey"</span> <span class="hl-attribute">p0</span>=<span class="hl-value">"parameter works as well."</span><span class="hl-tag">&gt;</span>text here to be treated as default message.{0}<span class="hl-tag">&lt;/afd:msg&gt;</span><span class="hl-tag">&lt;br/&gt;</span>
        <span class="hl-tag">&lt;/div&gt;</span><span class="hl-tag">&lt;/div&gt;</span>
        
        <span class="hl-tag">&lt;div</span> <span class="hl-attribute">class</span>=<span class="hl-value">"panel panel-default"</span><span class="hl-tag">&gt;</span><span class="hl-tag">&lt;div</span> <span class="hl-attribute">class</span>=<span class="hl-value">"panel-body"</span><span class="hl-tag">&gt;</span>
            <span class="hl-comment">&lt;!-- simply specify parameters on tag --&gt;</span>
            <span class="hl-tag">&lt;afd:msg</span> <span class="hl-attribute">id</span>=<span class="hl-value">"peoplecount"</span> <span class="hl-attribute">key</span>=<span class="hl-value">"sample.peoplecount"</span> <span class="hl-attribute">p0</span>=<span class="hl-value">"4"</span><span class="hl-tag">&gt;</span>dummy text<span class="hl-tag">&lt;/afd:msg&gt;</span><span class="hl-tag">&lt;br/&gt;</span>
            <span class="hl-tag">&lt;afd:msg</span> <span class="hl-attribute">id</span>=<span class="hl-value">"peoplecount"</span> <span class="hl-attribute">key</span>=<span class="hl-value">"sample.peoplecount"</span> <span class="hl-attribute">p0</span>=<span class="hl-value">"7"</span> <span class="hl-attribute">locale</span>=<span class="hl-value">"ja_JP"</span><span class="hl-tag">&gt;</span>dummy text<span class="hl-tag">&lt;/afd:msg&gt;</span><span class="hl-tag">&lt;br/&gt;</span>
        <span class="hl-tag">&lt;/div&gt;</span><span class="hl-tag">&lt;/div&gt;</span>
        
        <span class="hl-tag">&lt;div</span> <span class="hl-attribute">class</span>=<span class="hl-value">"panel panel-default"</span><span class="hl-tag">&gt;</span><span class="hl-tag">&lt;div</span> <span class="hl-attribute">class</span>=<span class="hl-value">"panel-body"</span><span class="hl-tag">&gt;</span>
            <span class="hl-comment">&lt;!-- the parameter can be rendered by snippet too --&gt;</span>
            <span class="hl-tag">&lt;afd:snippet</span> <span class="hl-attribute">render</span>=<span class="hl-value">"ComplicatedSnippet:setMsgParam"</span><span class="hl-tag">&gt;</span>
                <span class="hl-tag">&lt;afd:msg</span> <span class="hl-attribute">id</span>=<span class="hl-value">"peoplecount"</span> <span class="hl-attribute">key</span>=<span class="hl-value">"sample.peoplecount"</span> <span class="hl-attribute">p0</span>=<span class="hl-value">"4"</span><span class="hl-tag">&gt;</span>dummy text<span class="hl-tag">&lt;/afd:msg&gt;</span><span class="hl-tag">&lt;br/&gt;</span>
                <span class="hl-tag">&lt;afd:msg</span> <span class="hl-attribute">id</span>=<span class="hl-value">"peoplecount"</span> <span class="hl-attribute">key</span>=<span class="hl-value">"sample.peoplecount"</span> <span class="hl-attribute">p0</span>=<span class="hl-value">"7"</span> <span class="hl-attribute">locale</span>=<span class="hl-value">"ja_JP"</span><span class="hl-tag">&gt;</span>dummy text<span class="hl-tag">&lt;/afd:msg&gt;</span><span class="hl-tag">&lt;br/&gt;</span>
            <span class="hl-tag">&lt;/afd:snippet&gt;</span>
        <span class="hl-tag">&lt;/div&gt;</span><span class="hl-tag">&lt;/div&gt;</span>
        
        <span class="hl-tag">&lt;div</span> <span class="hl-attribute">class</span>=<span class="hl-value">"panel panel-default"</span><span class="hl-tag">&gt;</span><span class="hl-tag">&lt;div</span> <span class="hl-attribute">class</span>=<span class="hl-value">"panel-body"</span><span class="hl-tag">&gt;</span>
            <span class="hl-comment">&lt;!-- attribute started with "@" will be treated as a key --&gt;</span>
            <span class="hl-tag">&lt;afd:msg</span> <span class="hl-attribute">id</span>=<span class="hl-value">"weatherreport"</span> <span class="hl-attribute">key</span>=<span class="hl-value">"sample.weatherreport"</span> <span class="hl-attribute">@p0</span>=<span class="hl-value">"sample.weatherreport.sunny"</span><span class="hl-tag">&gt;</span>&#22825;&#27671;<span class="hl-tag">&lt;/afd:msg&gt;</span><span class="hl-tag">&lt;br/&gt;</span>
            <span class="hl-tag">&lt;afd:msg</span> <span class="hl-attribute">id</span>=<span class="hl-value">"weatherreport"</span> <span class="hl-attribute">key</span>=<span class="hl-value">"sample.weatherreport"</span> <span class="hl-attribute">@p0</span>=<span class="hl-value">"sample.weatherreport.sunny"</span> <span class="hl-attribute">locale</span>=<span class="hl-value">"ja_JP"</span><span class="hl-tag">&gt;</span>&#22825;&#27671;<span class="hl-tag">&lt;/afd:msg&gt;</span><span class="hl-tag">&lt;br/&gt;</span>
        <span class="hl-tag">&lt;/div&gt;</span><span class="hl-tag">&lt;/div&gt;</span>
        
        <span class="hl-tag">&lt;div</span> <span class="hl-attribute">class</span>=<span class="hl-value">"panel panel-default"</span><span class="hl-tag">&gt;</span><span class="hl-tag">&lt;div</span> <span class="hl-attribute">class</span>=<span class="hl-value">"panel-body"</span><span class="hl-tag">&gt;</span>
            <span class="hl-comment">&lt;!-- attribute started with "#" will be treated as a sub key of current key, thus sample.weatherreport.sunny will be searched --&gt;</span>
            <span class="hl-tag">&lt;afd:msg</span> <span class="hl-attribute">id</span>=<span class="hl-value">"weatherreport"</span> <span class="hl-attribute">key</span>=<span class="hl-value">"sample.weatherreport"</span> <span class="hl-attribute">#p0</span>=<span class="hl-value">"rain"</span><span class="hl-tag">&gt;</span>&#22825;&#27671;<span class="hl-tag">&lt;/afd:msg&gt;</span><span class="hl-tag">&lt;br/&gt;</span>
            <span class="hl-tag">&lt;afd:msg</span> <span class="hl-attribute">id</span>=<span class="hl-value">"weatherreport"</span> <span class="hl-attribute">key</span>=<span class="hl-value">"sample.weatherreport"</span> <span class="hl-attribute">#p0</span>=<span class="hl-value">"rain"</span> <span class="hl-attribute">locale</span>=<span class="hl-value">"ja_JP"</span><span class="hl-tag">&gt;</span>&#22825;&#27671;<span class="hl-tag">&lt;/afd:msg&gt;</span><span class="hl-tag">&lt;br/&gt;</span>
        <span class="hl-tag">&lt;/div&gt;</span><span class="hl-tag">&lt;/div&gt;</span>
        
        <span class="hl-tag">&lt;div</span> <span class="hl-attribute">class</span>=<span class="hl-value">"panel panel-default"</span><span class="hl-tag">&gt;</span><span class="hl-tag">&lt;div</span> <span class="hl-attribute">class</span>=<span class="hl-value">"panel-body"</span><span class="hl-tag">&gt;</span>
            <span class="hl-comment">&lt;!-- treat message as text --&gt;</span>
            <span class="hl-tag">&lt;afd:msg</span> <span class="hl-attribute">key</span>=<span class="hl-value">"sample.textUrl"</span><span class="hl-tag">&gt;</span><span class="hl-tag">&lt;/afd:msg&gt;</span><span class="hl-tag">&lt;br/&gt;</span>
            
            <span class="hl-comment">&lt;!-- treat message as html --&gt;</span>
            <span class="hl-tag">&lt;afd:msg</span> <span class="hl-attribute">key</span>=<span class="hl-value">"sample.htmlUrl"</span><span class="hl-tag">&gt;</span><span class="hl-tag">&lt;/afd:msg&gt;</span><span class="hl-tag">&lt;br/&gt;</span>
            
            <span class="hl-comment">&lt;!-- treat message as text even it begins with html: --&gt;</span>
            <span class="hl-tag">&lt;afd:msg</span> <span class="hl-attribute">key</span>=<span class="hl-value">"sample.escapedUrl"</span><span class="hl-tag">&gt;</span><span class="hl-tag">&lt;/afd:msg&gt;</span><span class="hl-tag">&lt;br/&gt;</span>
        <span class="hl-tag">&lt;/div&gt;</span><span class="hl-tag">&lt;/div&gt;</span>
    <span class="hl-tag">&lt;/article&gt;</span>
<span class="hl-tag">&lt;/section&gt;</span>

      </pre>
      <pre class="programlisting">

<span class="hl-keyword">public</span> Renderer setMsgParam() {
    Renderer render = Renderer.create();
    render.add(<span class="hl-string">"#peoplecount"</span>, <span class="hl-string">"p0"</span>, <span class="hl-number">15</span>);
    <span class="hl-keyword">return</span> render;
}

    </pre>
    <p>There are something need to be explained:</p>
      <div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
            <p>default message</p>
            <p>As commented in the source, the inner content of "afd:msg" will be treated as default message in case of the message of specified key cannot be found. 
                  Note that the default message will be formatted by specified parameters too.</p>
            <p>This mechanism can also be used as a simple text replacing mechanism in the html template file in case of necessity.</p>
            <br>
        </li><li class="listitem">
            <p>parameter name</p>
            <p>If the configured I18nMessageHelper is MappedParamI18nMessageHelper, the attribute names of current "afd:msg" element will be treated as parameter names directly.
                  And if the configured I18nMessageHelper is OrderedParamI18nMessageHelper which is the default one, the attribute names started with single "p" and following with
                  0-started numbers will be treated as the values of parameter value array.</p>
            <br>
        </li><li class="listitem">
            <p>recursive parameter</p>
            <p>The attributes which name started with "@" or "#" will be treated as recursive message's key. The different between "@" and "#" is that the "@" will be treated as a
                  complete key but the "#" will be treated as a sub key of current message key.</p>
            <br>
        </li><li class="listitem">
            <p>parameter value</p>
            <p>The value of attributes can be specified directly in the html template file, also can be rendered by a snippet as in the above example.</p>
            <br>
        </li><li class="listitem">
            <p>locale</p>
            <p>Locale can be specified explicitly by ISO 639 locale string, if not, the default locale decision mechanism will be performed. 
                 See <a class="xref" href="#i18n-default-locale-decision" title="15.1.3.&nbsp;Default locale">Section&nbsp;15.1.3, &#8220;Default locale&#8221;</a>.</p>
            <br>
        </li></ul></div>
    </div>
  </div>
  
  <div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="i18n-file-search"></a>15.2.&nbsp;file search order</h2></div></div></div>
    
    <p>The built-in template resolver and static resource handler can match the target file name with awareness of locale. The match locale will be decided by the default locale
          decision mechanism(See <a class="xref" href="#i18n-default-locale-decision" title="15.1.3.&nbsp;Default locale">Section&nbsp;15.1.3, &#8220;Default locale&#8221;</a>). After the locale is decided, for example, for a locale as Locale("fr", "CA", "UNIX") to search a 
          html template file "index.html", the target file will be searched by following order:</p>
    <div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">
            <p>index_fr_CA_UNIX.html</p>
        </li><li class="listitem">
            <p>index_fr_CA.html</p>
        </li><li class="listitem">
            <p>index_fr.html</p>
        </li><li class="listitem">
            <p>index.html</p>
        </li></ol></div>
    <p>For the static resource files such as js, css, jpg, etc. will be searched by the same order as well.</p>
  </div>
</div>
    <div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="overview"></a>16.&nbsp;Asta4dServlet and configuration</h2></div></div></div>
  
  
  <div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d5e1677"></a>16.1.&nbsp;Asta4dServlet</h2></div></div></div>
    
    <p>All the http requests are handled by Asta4dServlet which allows developers to override several methods to customize
    its actions. The web.xml would be like following:</p>
    <div class="example"><a name="d5e1680"></a><p class="title"><b>Example&nbsp;16.1.&nbsp;</b></p><div class="example-contents">
      <pre class="programlisting">

<span class="hl-directive" style="color: maroon">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="hl-tag">&lt;web-app</span> <span class="hl-attribute">version</span>=<span class="hl-value">"2.5"</span> <span class="hl-attribute">xmlns</span>=<span class="hl-value">"http://java.sun.com/xml/ns/javaee"</span>
    <span class="hl-attribute">xmlns:xsi</span>=<span class="hl-value">"http://www.w3.org/2001/XMLSchema-instance"</span>
    <span class="hl-attribute">xsi:schemaLocation</span>=<span class="hl-value">"http://java.sun.com/xml/ns/javaee http://java.sun.com/xml/ns/javaee/web-app_2_5.xsd"</span><span class="hl-tag">&gt;</span>

    <span class="hl-comment">&lt;!-- standalone without spring --&gt;</span>
    <span class="hl-tag">&lt;servlet&gt;</span>
        <span class="hl-tag">&lt;servlet-name&gt;</span>Asta4D Servlet<span class="hl-tag">&lt;/servlet-name&gt;</span>
        <span class="hl-tag">&lt;servlet-class&gt;</span>com.astamuse.asta4d.web.servlet.Asta4dServlet<span class="hl-tag">&lt;/servlet-class&gt;</span>
        <span class="hl-tag">&lt;load-on-startup&gt;</span>1<span class="hl-tag">&lt;/load-on-startup&gt;</span>
    <span class="hl-tag">&lt;/servlet&gt;</span>

    <span class="hl-tag">&lt;servlet-mapping&gt;</span>
        <span class="hl-tag">&lt;servlet-name&gt;</span>Asta4D Servlet<span class="hl-tag">&lt;/servlet-name&gt;</span>
        <span class="hl-tag">&lt;url-pattern&gt;</span>/<span class="hl-tag">&lt;/url-pattern&gt;</span>
    <span class="hl-tag">&lt;/servlet-mapping&gt;</span>
<span class="hl-tag">&lt;/web-app&gt;</span>


      </pre>
    </div></div><br class="example-break">
    
    <p>The following methods can be overridden:</p>
    <div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
        <p>createConfiguration()</p>
        <p>Overriding this methods allows developers to configure the framework by code. </p>
        <div class="example"><a name="d5e1687"></a><p class="title"><b>Example&nbsp;16.2.&nbsp;</b></p><div class="example-contents">
          <pre class="programlisting">

    <em><span class="hl-annotation" style="color: gray">@Override</span></em>
    <span class="hl-keyword">protected</span> WebApplicationConfiguration createConfiguration() {
        WebApplicationConfiguration conf = <span class="hl-keyword">super</span>.createConfiguration();
        
        conf.setSnippetResolver(<span class="hl-keyword">new</span> DefaultSnippetResolver() {

            <em><span class="hl-annotation" style="color: gray">@Override</span></em>
            <span class="hl-keyword">protected</span> Object createInstance(String snippetName) <span class="hl-keyword">throws</span> SnippetNotResovlableException {
                <span class="hl-keyword">return</span> <span class="hl-keyword">super</span>.createInstance(<span class="hl-string">"com.astamuse.asta4d.sample.snippet."</span> + snippetName);
            }

        });
        
        conf.setUrlMappingRuleInitializer(<span class="hl-keyword">new</span> UrlRules());
        
        conf.getPageInterceptorList().add(<span class="hl-keyword">new</span> SamplePageInterceptor());
        
        <span class="hl-keyword">return</span> conf;
    }

          </pre>
        </div></div><br class="example-break">
      </li><li class="listitem">
        <p>service()</p>
        <p>Developers can intercept the http request by overriding this method. The following example shows how to rewrite the access url by adding pre request logic:</p>
        <div class="example"><a name="d5e1692"></a><p class="title"><b>Example&nbsp;16.3.&nbsp;</b></p><div class="example-contents">
          <pre class="programlisting">

    <em><span class="hl-annotation" style="color: gray">@Override</span></em>
    <span class="hl-keyword">protected</span> <span class="hl-keyword">void</span> service() <span class="hl-keyword">throws</span> Exception {
        WebApplicationContext context = Context.getCurrentThreadContext();
        HttpServletRequest request = context.getRequest();
        String requestURI = request.getRequestURI();
        <span class="hl-keyword">if</span> (requestURI.startsWith(<span class="hl-string">"/abc/"</span>)) {
            context.setAccessURI(requestURI.substring(<span class="hl-number">5</span>));
        }
        <span class="hl-keyword">super</span>.service();
    }

          </pre>
        </div></div><br class="example-break">
        <p>Request time measuring can be performed too:</p>
        <div class="example"><a name="d5e1695"></a><p class="title"><b>Example&nbsp;16.4.&nbsp;</b></p><div class="example-contents">
          <pre class="programlisting">

    <em><span class="hl-annotation" style="color: gray">@Override</span></em>
    <span class="hl-keyword">protected</span> <span class="hl-keyword">void</span> service() <span class="hl-keyword">throws</span> Exception {
        <span class="hl-keyword">long</span> startTime = System.currentTimeMillis();
        <span class="hl-keyword">try</span> {
            <span class="hl-keyword">super</span>.service();
        } <span class="hl-keyword">finally</span> {
            <span class="hl-keyword">long</span> endTime = System.currentTimeMillis();
            System.out.println(<span class="hl-string">"request time:"</span> + (endTime - startTime));
        }
    }

          </pre>
        </div></div><br class="example-break">
      </li><li class="listitem">
        <p>createAsta4dContext()</p>
        <p>Overriding this methods allows developers to afford customized Context implementation.</p>
      </li><li class="listitem">
        <p>createConfigurationInitializer()</p>
        <p>Overriding this methods allows developers to customize the configuration file initialization logic. See details at next section.</p>
      </li></ul></div>
  </div>
  
  <div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d5e1703"></a>16.2.&nbsp;Configuration file</h2></div></div></div>
    
    <p>In the previous section, we introduced that Asta4D can be configured by overriding createConfiguration() method and we also introduced a method called 
    createConfigurationInitializer which allows customize the configuration file initialization logic. Asta4D allows to be configured by an extra configuration file
    which will be analyzed by the created configuration initializer. </p>
    
    <p>The default implementation of configuration initializer will seek the configuration file by following order:</p>
    <div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">
        <p>Calling retrievePossibleConfigurationFileNames(Overridable) to retrieve all possible configuration file names which could be an array of String. The default value
        is "asta4d.conf.properties" only.</p>
      </li><li class="listitem">
        <p>Search all the possible names in classpath by order. The first found one will be used.</p>
      </li><li class="listitem">
        <p>If there is no configuration file found in classpath, calling retrieveConfigurationFileNameKey(Overridable) to get a key. The default key is "asta4d.conf".</p>
      </li><li class="listitem">
        <p>Retrieve the value of key retrieve in previous step by the order as: ServletConfig, JDNI Context, System properties.</p>
      </li><li class="listitem">
        <p>If there is a value found in the previous step, open a file as configuration file by treating the found value as a file path.</p>
      </li></ol></div>
    <p>As mentioned above, the two methods of retrievePossibleConfigurationFileNames and retrieveConfigurationFileNameKey can be overridden to customize configuration
    file name and the file path can be also configured by the key "asta4d.conf" at servlet mapping configuration(ServletConfig), JDNI configuration(JDNI context) or command 
    line parameter(System properties).</p>
    
    <p>Further, the default implementation does only support the format of configuration file as Java standard properties file. All the configured key/value will be treated
    as setXXX method calling on WebApplicationConfiguration instance. The key can be a dot split string which will be treated as recursive property accessing on 
    WebApplicationConfiguration instance.</p>
    <div class="example"><a name="d5e1720"></a><p class="title"><b>Example&nbsp;16.5.&nbsp;</b></p><div class="example-contents">
      <pre class="programlisting">

<span class="hl-attribute">urlMappingRuleInitializer</span>=com.astamuse.asta4d.sample.UrlRules

<span class="hl-attribute">cacheEnable</span>=false

<span class="hl-attribute">snippetExecutorFactory.threadName</span>=asta4d-sample-snippet
<span class="hl-attribute">snippetExecutorFactory.poolSize</span>=100

<span class="hl-attribute">listExecutorFactory.threadName</span>=asta4d-sample-list
<span class="hl-attribute">listExecutorFactory.poolSize</span>=100

      </pre>
    </div></div><br class="example-break">
    <p>The above configuration equals to the following source:</p>
    <div class="example"><a name="d5e1723"></a><p class="title"><b>Example&nbsp;16.6.&nbsp;</b></p><div class="example-contents">
      <pre class="programlisting">

WebApplicationConfiguration conf = <span class="hl-keyword">super</span>.createConfiguration();

conf.setUrlMappingRuleInitializer(<span class="hl-keyword">new</span> UrlRules());

conf.setCacheEnable(false);

((DefaultExecutorServiceFactory) conf.getSnippetExecutorFactory()).setThreadName(<span class="hl-string">"asta4d-sample-snippet"</span>);
((DefaultExecutorServiceFactory) conf.getSnippetExecutorFactory()).setPoolSize(<span class="hl-number">100</span>);

((DefaultExecutorServiceFactory) conf.getListExecutorFactory()).setThreadName(<span class="hl-string">"asta4d-sample-list"</span>);
((DefaultExecutorServiceFactory) conf.getListExecutorFactory()).setPoolSize(<span class="hl-number">100</span>);

      </pre>
    </div></div><br class="example-break">
    
    <p>All the configurable items can be found at <a class="ulink" href="http://astamuse.github.io/asta4d/javadoc/0.14.5.1-SNAPSHOT/com/astamuse/asta4d/web/WebApplicationConfiguration.html" target="_top">JavaDoc</a>.</p>
  </div>
  
</div>
    <div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="chapter-integration-spring"></a>17.&nbsp;Integration with Spring</h2></div></div></div>
  
  
  <div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="integrate-spring-ioc"></a>17.1.&nbsp;Integrate with Spring IOC</h2></div></div></div>
    
    <p>Asta4D can be integrated with any dependency injection mechanism. We will introduce how to integrate with Spring IOC 
    as example.</p>
    <p>There is a package called asta4d-spring which supplies reference implementation to show how to integrate a DI container 
    to Asta4D. Firstly, as an alternative for Asta4dServlet introduced in the  previous chapter, SpringInitializableServlet can be 
    used to initialize Spring configuration automatically. The web.xml file should be like following:</p>
    
    <div class="example"><a name="d5e1733"></a><p class="title"><b>Example&nbsp;17.1.&nbsp;</b></p><div class="example-contents">
      <pre class="programlisting">

<span class="hl-directive" style="color: maroon">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="hl-tag">&lt;web-app</span> <span class="hl-attribute">version</span>=<span class="hl-value">"2.5"</span> <span class="hl-attribute">xmlns</span>=<span class="hl-value">"http://java.sun.com/xml/ns/javaee"</span>
    <span class="hl-attribute">xmlns:xsi</span>=<span class="hl-value">"http://www.w3.org/2001/XMLSchema-instance"</span>
    <span class="hl-attribute">xsi:schemaLocation</span>=<span class="hl-value">"http://java.sun.com/xml/ns/javaee http://java.sun.com/xml/ns/javaee/web-app_2_5.xsd"</span><span class="hl-tag">&gt;</span>

    <span class="hl-comment">&lt;!-- integrate with spring --&gt;</span>
    <span class="hl-tag">&lt;servlet&gt;</span>
        <span class="hl-tag">&lt;servlet-name&gt;</span>Asta4D Servlet<span class="hl-tag">&lt;/servlet-name&gt;</span>
        <span class="hl-tag">&lt;servlet-class&gt;</span>com.astamuse.asta4d.misc.spring.SpringInitializableServlet<span class="hl-tag">&lt;/servlet-class&gt;</span>
        <span class="hl-tag">&lt;init-param&gt;</span>
            <span class="hl-tag">&lt;param-name&gt;</span>contextConfigLocation<span class="hl-tag">&lt;/param-name&gt;</span>
            <span class="hl-tag">&lt;param-value&gt;</span>classpath:spring/configuration.xml<span class="hl-tag">&lt;/param-value&gt;</span>
        <span class="hl-tag">&lt;/init-param&gt;</span>
        <span class="hl-tag">&lt;load-on-startup&gt;</span>1<span class="hl-tag">&lt;/load-on-startup&gt;</span>
    <span class="hl-tag">&lt;/servlet&gt;</span>

    <span class="hl-tag">&lt;servlet-mapping&gt;</span>
        <span class="hl-tag">&lt;servlet-name&gt;</span>Asta4D Servlet<span class="hl-tag">&lt;/servlet-name&gt;</span>
        <span class="hl-tag">&lt;url-pattern&gt;</span>/<span class="hl-tag">&lt;/url-pattern&gt;</span>
    <span class="hl-tag">&lt;/servlet-mapping&gt;</span>

<span class="hl-tag">&lt;/web-app&gt;</span>

      </pre>
    </div></div><br class="example-break">
    <p>Secondly, the WebApplicationConfiguration instance should be declared as a bean in spring with additional Spring special
    configurations:</p>
    <div class="example"><a name="d5e1736"></a><p class="title"><b>Example&nbsp;17.2.&nbsp;</b></p><div class="example-contents">
      <pre class="programlisting">

<span class="hl-directive" style="color: maroon">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"asta4dConfiguration"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"com.astamuse.asta4d.web.WebApplicationConfiguration"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"snippetResolver"</span><span class="hl-tag">&gt;</span>
            <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"com.astamuse.asta4d.misc.spring.SpringManagedSnippetResolver"</span><span class="hl-tag">/&gt;</span>
        <span class="hl-tag">&lt;/property&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"instanceResolverList"</span><span class="hl-tag">&gt;</span>
            <span class="hl-tag">&lt;list&gt;</span>
                <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"com.astamuse.asta4d.misc.spring.SpringManagedInstanceResolver"</span><span class="hl-tag">/&gt;</span>
            <span class="hl-tag">&lt;/list&gt;</span>
        <span class="hl-tag">&lt;/property&gt;</span>
    <span class="hl-tag">&lt;/bean&gt;</span>

      </pre>
      <em><span class="remark">The SpringManagedSnippetResolver will retrieve snippet instance from Spring container and the SpringManagedInstanceResolver
      will also retrieve request handler instance from Spring container. Further the SpringManagedSnippetResolver will treat the snippet
      name in html template files as bean id.</span></em>
    </div></div><br class="example-break">
    <p>The following example shows a full image of Spring's configuration for Asta4D:</p>
    <div class="example"><a name="d5e1740"></a><p class="title"><b>Example&nbsp;17.3.&nbsp;</b></p><div class="example-contents">
      <pre class="programlisting">

<span class="hl-directive" style="color: maroon">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"asta4dConfiguration"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"com.astamuse.asta4d.web.WebApplicationConfiguration"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"snippetResolver"</span><span class="hl-tag">&gt;</span>
            <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"com.astamuse.asta4d.misc.spring.SpringManagedSnippetResolver"</span><span class="hl-tag">/&gt;</span>
        <span class="hl-tag">&lt;/property&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"instanceResolverList"</span><span class="hl-tag">&gt;</span>
            <span class="hl-tag">&lt;list&gt;</span>
                <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"com.astamuse.asta4d.misc.spring.SpringManagedInstanceResolver"</span><span class="hl-tag">/&gt;</span>
            <span class="hl-tag">&lt;/list&gt;</span>
        <span class="hl-tag">&lt;/property&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"pageInterceptorList"</span><span class="hl-tag">&gt;</span>
            <span class="hl-tag">&lt;list&gt;</span>
                <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"com.astamuse.asta4d.sample.interceptor.SamplePageInterceptor"</span><span class="hl-tag">/&gt;</span>
            <span class="hl-tag">&lt;/list&gt;</span>
        <span class="hl-tag">&lt;/property&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"snippetInvoker"</span><span class="hl-tag">&gt;</span>
            <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"snippetInvoker"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"com.astamuse.asta4d.snippet.DefaultSnippetInvoker"</span><span class="hl-tag">&gt;</span>
                <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"snippetInterceptorList"</span><span class="hl-tag">&gt;</span>
                    <span class="hl-tag">&lt;list&gt;</span>
                        <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"com.astamuse.asta4d.sample.interceptor.SampleSnippetInterceptor"</span><span class="hl-tag">/&gt;</span>
                    <span class="hl-tag">&lt;/list&gt;</span>
                <span class="hl-tag">&lt;/property&gt;</span>
            <span class="hl-tag">&lt;/bean&gt;</span>        
        <span class="hl-tag">&lt;/property&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"urlMappingRuleInitializer"</span><span class="hl-tag">&gt;</span>
            <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"com.astamuse.asta4d.sample.UrlRules"</span><span class="hl-tag">/&gt;</span>
        <span class="hl-tag">&lt;/property&gt;</span>
    <span class="hl-tag">&lt;/bean&gt;</span>
    
    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"ComplicatedSnippet"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"com.astamuse.asta4d.sample.snippet.ComplicatedSnippet"</span> <span class="hl-attribute">scope</span>=<span class="hl-value">"prototype"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"FormSnippet"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"com.astamuse.asta4d.sample.snippet.FormSnippet"</span> <span class="hl-attribute">scope</span>=<span class="hl-value">"prototype"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"SimpleSnippet"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"com.astamuse.asta4d.sample.snippet.SimpleSnippet"</span> <span class="hl-attribute">scope</span>=<span class="hl-value">"prototype"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"ShowCodeSnippet"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"com.astamuse.asta4d.sample.snippet.ShowCodeSnippet"</span> <span class="hl-attribute">scope</span>=<span class="hl-value">"prototype"</span><span class="hl-tag">/&gt;</span>
    
    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"com.astamuse.asta4d.sample.handler.LoginHandler"</span><span class="hl-tag">/&gt;</span>

      </pre>
      <em><span class="remark">Note that Asta4D always treats snippet instance as singleton per request for field injection on snippet, 
      so the scope of snippet beans should be "prototype" basically except there is no field injection in snippet
      implementation. For the request handlers, "prototype" is not necessary since there is no field injection on
      request handler.</span></em>
    </div></div><br class="example-break">
  </div>
  
  <div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="integrate-spring-mvc"></a>17.2.&nbsp;Integrate with Spring MVC</h2></div></div></div>
    
    <p>Asta4D's template engine can be integrated to Spring MVC as view solution too. The following configuration shows how:</p>
    <div class="example"><a name="d5e1746"></a><p class="title"><b>Example&nbsp;17.4.&nbsp;</b></p><div class="example-contents">
      <pre class="programlisting">

    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"com.astamuse.asta4d.misc.spring.mvc.Asta4dTemplateInitializer"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"com.astamuse.asta4d.misc.spring.mvc.SpringWebPageViewResolver"</span><span class="hl-tag">/&gt;</span>

      </pre>
    </div></div><br class="example-break">

  </div>

  
</div>
  </div>  
  
</div></body></html>