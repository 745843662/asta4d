<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
   <title>16.&nbsp;Asta4dServlet and configuration</title><link rel="stylesheet" type="text/css" href="css/manual-multipage.css"><meta name="generator" content="DocBook XSL Stylesheets V1.79.1"><meta name="keywords" content="java, view first, web framework"><link rel="home" href="index.html" title="Asta4D Framework User Guide"><link rel="up" href="asta4d-reference.html" title="Part&nbsp;III.&nbsp;Reference"><link rel="prev" href="chapter-detail-i18n.html" title="15.&nbsp;i18n"><link rel="next" href="chapter-integration-spring.html" title="17.&nbsp;Integration with Spring"></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">16.&nbsp;Asta4dServlet and configuration</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="chapter-detail-i18n.html">Prev</a>&nbsp;</td><th width="60%" align="center">Part&nbsp;III.&nbsp;Reference</th><td width="20%" align="right">&nbsp;<a accesskey="n" href="chapter-integration-spring.html">Next</a></td></tr></table><hr></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="overview"></a>16.&nbsp;Asta4dServlet and configuration</h2></div></div></div>
  
  
  <div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d5e1717"></a>16.1.&nbsp;Asta4dServlet</h2></div></div></div>
    
    <p>All the http requests are handled by Asta4dServlet which allows developers to override several methods to customize
    its actions. The web.xml would be like following:</p>
    <div class="example"><a name="d5e1720"></a><p class="title"><b>Example&nbsp;16.1.&nbsp;</b></p><div class="example-contents">
      <pre class="programlisting">

<span class="hl-directive" style="color: maroon">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="hl-tag">&lt;web-app</span> <span class="hl-attribute">version</span>=<span class="hl-value">"2.5"</span> <span class="hl-attribute">xmlns</span>=<span class="hl-value">"http://java.sun.com/xml/ns/javaee"</span>
    <span class="hl-attribute">xmlns:xsi</span>=<span class="hl-value">"http://www.w3.org/2001/XMLSchema-instance"</span>
    <span class="hl-attribute">xsi:schemaLocation</span>=<span class="hl-value">"http://java.sun.com/xml/ns/javaee http://java.sun.com/xml/ns/javaee/web-app_2_5.xsd"</span><span class="hl-tag">&gt;</span>

    <span class="hl-comment">&lt;!-- standalone without spring --&gt;</span>
    <span class="hl-tag">&lt;servlet&gt;</span>
        <span class="hl-tag">&lt;servlet-name&gt;</span>Asta4D Servlet<span class="hl-tag">&lt;/servlet-name&gt;</span>
        <span class="hl-tag">&lt;servlet-class&gt;</span>com.astamuse.asta4d.web.servlet.Asta4dServlet<span class="hl-tag">&lt;/servlet-class&gt;</span>
        <span class="hl-tag">&lt;load-on-startup&gt;</span>1<span class="hl-tag">&lt;/load-on-startup&gt;</span>
    <span class="hl-tag">&lt;/servlet&gt;</span>

    <span class="hl-tag">&lt;servlet-mapping&gt;</span>
        <span class="hl-tag">&lt;servlet-name&gt;</span>Asta4D Servlet<span class="hl-tag">&lt;/servlet-name&gt;</span>
        <span class="hl-tag">&lt;url-pattern&gt;</span>/<span class="hl-tag">&lt;/url-pattern&gt;</span>
    <span class="hl-tag">&lt;/servlet-mapping&gt;</span>
<span class="hl-tag">&lt;/web-app&gt;</span>


      </pre>
    </div></div><br class="example-break">
    
    <p>The following methods can be overridden:</p>
    <div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
        <p>createConfiguration()</p>
        <p>Overriding this methods allows developers to configure the framework by code. </p>
        <div class="example"><a name="d5e1727"></a><p class="title"><b>Example&nbsp;16.2.&nbsp;</b></p><div class="example-contents">
          <pre class="programlisting">

    <em><span class="hl-annotation" style="color: gray">@Override</span></em>
    <span class="hl-keyword">protected</span> WebApplicationConfiguration createConfiguration() {
        WebApplicationConfiguration conf = <span class="hl-keyword">super</span>.createConfiguration();
        
        conf.setSnippetResolver(<span class="hl-keyword">new</span> DefaultSnippetResolver() {

            <em><span class="hl-annotation" style="color: gray">@Override</span></em>
            <span class="hl-keyword">protected</span> Object createInstance(String snippetName) <span class="hl-keyword">throws</span> SnippetNotResovlableException {
                <span class="hl-keyword">return</span> <span class="hl-keyword">super</span>.createInstance(<span class="hl-string">"com.astamuse.asta4d.sample.snippet."</span> + snippetName);
            }

        });
        
        conf.setUrlMappingRuleInitializer(<span class="hl-keyword">new</span> UrlRules());
        
        conf.getPageInterceptorList().add(<span class="hl-keyword">new</span> SamplePageInterceptor());
        
        <span class="hl-keyword">return</span> conf;
    }

          </pre>
        </div></div><br class="example-break">
      </li><li class="listitem">
        <p>service()</p>
        <p>Developers can intercept the http request by overriding this method. The following example shows how to rewrite the access url by adding pre request logic:</p>
        <div class="example"><a name="d5e1732"></a><p class="title"><b>Example&nbsp;16.3.&nbsp;</b></p><div class="example-contents">
          <pre class="programlisting">

    <em><span class="hl-annotation" style="color: gray">@Override</span></em>
    <span class="hl-keyword">protected</span> <span class="hl-keyword">void</span> service() <span class="hl-keyword">throws</span> Exception {
        WebApplicationContext context = Context.getCurrentThreadContext();
        HttpServletRequest request = context.getRequest();
        String requestURI = request.getRequestURI();
        <span class="hl-keyword">if</span> (requestURI.startsWith(<span class="hl-string">"/abc/"</span>)) {
            context.setAccessURI(requestURI.substring(<span class="hl-number">5</span>));
        }
        <span class="hl-keyword">super</span>.service();
    }

          </pre>
        </div></div><br class="example-break">
        <p>Request time measuring can be performed too:</p>
        <div class="example"><a name="d5e1735"></a><p class="title"><b>Example&nbsp;16.4.&nbsp;</b></p><div class="example-contents">
          <pre class="programlisting">

    <em><span class="hl-annotation" style="color: gray">@Override</span></em>
    <span class="hl-keyword">protected</span> <span class="hl-keyword">void</span> service() <span class="hl-keyword">throws</span> Exception {
        <span class="hl-keyword">long</span> startTime = System.currentTimeMillis();
        <span class="hl-keyword">try</span> {
            <span class="hl-keyword">super</span>.service();
        } <span class="hl-keyword">finally</span> {
            <span class="hl-keyword">long</span> endTime = System.currentTimeMillis();
            System.out.println(<span class="hl-string">"request time:"</span> + (endTime - startTime));
        }
    }

          </pre>
        </div></div><br class="example-break">
      </li><li class="listitem">
        <p>createAsta4dContext()</p>
        <p>Overriding this methods allows developers to afford customized Context implementation.</p>
      </li><li class="listitem">
        <p>createConfigurationInitializer()</p>
        <p>Overriding this methods allows developers to customize the configuration file initialization logic. See details at next section.</p>
      </li></ul></div>
  </div>
  
  <div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d5e1743"></a>16.2.&nbsp;Configuration file</h2></div></div></div>
    
    <p>In the previous section, we introduced that Asta4D can be configured by overriding createConfiguration() method and we also introduced a method called 
    createConfigurationInitializer which allows customize the configuration file initialization logic. Asta4D allows to be configured by an extra configuration file
    which will be analyzed by the created configuration initializer. </p>
    
    <p>The default implementation of configuration initializer will seek the configuration file by following order:</p>
    <div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">
        <p>Calling retrievePossibleConfigurationFileNames(Overridable) to retrieve all possible configuration file names which could be an array of String. The default value
        is "asta4d.conf.properties" only.</p>
      </li><li class="listitem">
        <p>Search all the possible names in classpath by order. The first found one will be used.</p>
      </li><li class="listitem">
        <p>If there is no configuration file found in classpath, calling retrieveConfigurationFileNameKey(Overridable) to get a key. The default key is "asta4d.conf".</p>
      </li><li class="listitem">
        <p>Retrieve the value of key retrieve in previous step by the order as: ServletConfig, JDNI Context, System properties.</p>
      </li><li class="listitem">
        <p>If there is a value found in the previous step, open a file as configuration file by treating the found value as a file path.</p>
      </li></ol></div>
    <p>As mentioned above, the two methods of retrievePossibleConfigurationFileNames and retrieveConfigurationFileNameKey can be overridden to customize configuration
    file name and the file path can be also configured by the key "asta4d.conf" at servlet mapping configuration(ServletConfig), JDNI configuration(JDNI context) or command 
    line parameter(System properties).</p>
    
    <p>Further, the default implementation does only support the format of configuration file as Java standard properties file. All the configured key/value will be treated
    as setXXX method calling on WebApplicationConfiguration instance. The key can be a dot split string which will be treated as recursive property accessing on 
    WebApplicationConfiguration instance.</p>
    <div class="example"><a name="d5e1760"></a><p class="title"><b>Example&nbsp;16.5.&nbsp;</b></p><div class="example-contents">
      <pre class="programlisting">

<span class="hl-attribute">urlMappingRuleInitializer</span>=com.astamuse.asta4d.sample.UrlRules

<span class="hl-attribute">cacheEnable</span>=false

<span class="hl-attribute">snippetExecutorFactory.threadName</span>=asta4d-sample-snippet
<span class="hl-attribute">snippetExecutorFactory.poolSize</span>=100

<span class="hl-attribute">listExecutorFactory.threadName</span>=asta4d-sample-list
<span class="hl-attribute">listExecutorFactory.poolSize</span>=100

      </pre>
    </div></div><br class="example-break">
    <p>The above configuration equals to the following source:</p>
    <div class="example"><a name="d5e1763"></a><p class="title"><b>Example&nbsp;16.6.&nbsp;</b></p><div class="example-contents">
      <pre class="programlisting">

WebApplicationConfiguration conf = <span class="hl-keyword">super</span>.createConfiguration();

conf.setUrlMappingRuleInitializer(<span class="hl-keyword">new</span> UrlRules());

conf.setCacheEnable(false);

((DefaultExecutorServiceFactory) conf.getSnippetExecutorFactory()).setThreadName(<span class="hl-string">"asta4d-sample-snippet"</span>);
((DefaultExecutorServiceFactory) conf.getSnippetExecutorFactory()).setPoolSize(<span class="hl-number">100</span>);

((DefaultExecutorServiceFactory) conf.getListExecutorFactory()).setThreadName(<span class="hl-string">"asta4d-sample-list"</span>);
((DefaultExecutorServiceFactory) conf.getListExecutorFactory()).setPoolSize(<span class="hl-number">100</span>);

      </pre>
    </div></div><br class="example-break">
    
    <p>All the configurable items can be found at <a class="ulink" href="http://astamuse.github.io/asta4d/javadoc/0.14.5.1-SNAPSHOT/com/astamuse/asta4d/web/WebApplicationConfiguration.html" target="_top">JavaDoc</a>.</p>
  </div>
  
</div><div class="navfooter"><hr><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="chapter-detail-i18n.html">Prev</a>&nbsp;</td><td width="20%" align="center"><a accesskey="u" href="asta4d-reference.html">Up</a></td><td width="40%" align="right">&nbsp;<a accesskey="n" href="chapter-integration-spring.html">Next</a></td></tr><tr><td width="40%" align="left" valign="top">15.&nbsp;i18n&nbsp;</td><td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td><td width="40%" align="right" valign="top">&nbsp;17.&nbsp;Integration with Spring</td></tr></table></div></body></html>